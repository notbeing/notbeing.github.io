{"version":3,"mappings":"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AQ,GACV,cAEA,OAA4B,YAK1B,KACK,CAAAzlB,EAAA0lB,EAAAC,KACH,CACA,GAAUF,GAAA,KAAAzlB,EAC0D,SAClE,CACF,GAAAylB,GAAA,cAAA1S,KAAA,eAAA2S,CAAA,EACF,kBAAAC,CACF,CAEO,KAEU,qBAEf,gBAEA,uBAAa,EACb,WACA,cACA,aAAc,EACd,sBAAoB,MACpB,eACA,kBAAe,GACf,cAAS,GACT,aAAO,GACP,QAAWJ,GAAA,SAEX,kCACuB,iBACvB,EACE,qBAAkB,GAClB,UACA,iBAAc,GACd,aAAc,0BACL,QACL,aAAU,CACV,MAAS,CACT,SAAQ,GACR,WACF,UACO,WACL,EACA,MAAS,CACT,SAAQ,GACR,WACF,UACM,WACJ,EACA,KAAS,CACT,SAAQ,GACR,WACF,UACF,WACiB,CACf,EACA,gBAAe,CACf,EAAQ,uBACN,cAAqB,QACrB,QACF,uBACgB,qBAChB,EACA,eAAyB,QACzB,eAAmC,SACnC,wBAAmC,IACrC,oCACU,mCACR,EACA,SAAkB,CAClB,QAAM,MACR,oBACO,OACL,EACA,MAAK,CACP,WACQ,QACiF,OACvF,CACFK,GAAA,mEACAA,GAAO,wEACP,EACE,MAAO,SACT,eACA,QACA,EACE,WAAKX,GAAA,EACL,SAAY,CACZ,OACA,WAAiB,GACjB,KAAe,GACf,gBAAS,GACT,cAAyB,GACzB,QAAmB,GACnB,wBAAe,GACf,kBAAO,GACP,iBACA,MAAa,GACb,eAAK,GACL,YAAU,GACV,IAAe,GACf,SAAgB,GAChB,cAAO,GACT,kBACc,QAChB,EACA,aAAgB,EACd,EACA,eAAO,CACP,SACA,MAAe,GACb,aAAO,EACP,cAAO,CACP,MAAO,EACT,eAEA,EACF,QACA,QACA,EACA,cACA,4BAA0B,GAC1B,qBAAiB,GACjB,WAAoB,IACpB,eAAc,GACZ,kBAAY,GACd,2BAEA,EACA,sBAAgB,GAChB,WAAc,EACZ,cAAQ,GACR,cACA,MAAS,GACT,gBACA,WACF,cACF,kBCvWwB,EAEtB,SAAQY,GAAcC,EAACC,EAAA,CACjBD,IAAA,MAAQ,KAAM,EAAG,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","names":["MAIN_DOMAINS","DEFAULT_BACKGROUND_SLUG","threads","App","blurActiveElement","cancelEvent","event","IS_TOUCH_SUPPORTED","ctx","USER_AGENT","IS_APPLE","IS_ANDROID","IS_CHROMIUM","CHROMIUM_VERSION","IS_APPLE_MOBILE","IS_SAFARI","IS_FIREFOX","IS_MOBILE_SAFARI","IS_MOBILE","findUpClassName","el","className","fastRafCallbacks","fastRaf","callback","currentCallbacks","cb","fastRafConventionalCallbacks","processing","fastRafConventional","i","rafPromise","fastRafPromise","resolve","doubleRaf","fixSafariStickyInput","input","IS_STICKY_INPUT_BUGGED","key","startY","o","onTouchMove","e","touch","scrollable","y","scrolled","scrollTop","scrollHeight","clientHeight","nextScrollTop","lastFocusOutTimeStamp","fixSafariStickyInputFocusing","FontFamilyName","FontFamily","FontSize","FontWeight","FontFull","noop","pause","ms","TGICO_CLASS","_tgico","icon","texts","cache","fonts","loadFonts","types","promises","type","_texts","font","weights","weight","_promises","text","_a","_b","IS_EMOJI_SUPPORTED","makeWorkerURL","url","value","setWorkerProxy","workerHandler","target","args","w","toggleAttributePolyfill","name","force","NULL_PEER_ID","REPLIES_PEER_ID","REPLIES_HIDDEN_CHANNEL_ID","HIDDEN_PEER_ID","SERVICE_PEER_ID","MUTE_UNTIL","BOT_START_PARAM","MAX_FILE_SAVE_SIZE","THUMB_TYPE_FULL","TOPIC_COLORS","ATTACH_MENU_BOT_ICON_NAME","MESSAGE_ID_OFFSET","GENERAL_TOPIC_ID","CAN_HIDE_TOPIC","T_ME_PREFIXES","SEND_WHEN_ONLINE_TIMESTAMP","SERVER_IMAGE_MIME_TYPES","STARS_CURRENCY","FOLDER_ID_ALL","FOLDER_ID_ARCHIVE","REAL_FOLDERS","TEST_NO_STORIES","EventListenerBase","reuseResults","options","listenerObject","obj","l","listener","result","error","err","collectResults","arr","listeners","Modes","IS_BETA","DEBUG","MOUNT_CLASS_TO","tabId","indexOfAndSplice","array","item","idx","IS_SERVICE_WORKER","IS_WEB_WORKER","IS_WORKER","getWindowClients","postMessage","notifyServiceWorker","all","notifyWorker","CACHED_ERRORS","makeError","_logTimer","dT","LogTypes","LOG_LEVELS","IS_WEBKIT","STYLES_SUPPORTED","LOGGER_STYLES","methods","logger","prefix","ignoreDebugReset","style","originalPrefix","originalStyle","log","method","logType","newPrefix","level","acc","v","prefixCache","_type","prefix2","USE_LOCKS","SuperMessagePort","logSuffix","task","source","taskId","deferred","payload","previousResolve","ret","reject","pingResolve","newEvent","id","innerTask","resultTaskPayload","resultTask","ackTask","isPromise","cached","port","promise","lock","port2","portTasks","tasks","batchTask","ports","transfer","withAck","_void","interval","MTProtoMessagePort","RootScope","isNew","isPremium","status","settings","rootScope","deferredHelper","deferredPromise","_resolve","_reject","bindPromiseToDeferred","throttle","fn","shouldRunFirst","isPending","clear","_args","safeAssign","object","fromObject","_IDB","db","createNew","createIndexes","os","store","indexNames","indexName","index","createObjectStore","request","finished","calledNew","transaction","instance","preserve","storage","IDB","IDBStorage","storeName","entryName","isArray","objectStore","mode","perf","onError","timeout","onComplete","results","requests","r","waitForTransactionComplete","callbackResult","length","left","onRequestFinished","THROTTLE_TIME","_AppStorage","set","keys","values","useCache","p","onlyLocal","canUseStorage","saveLocal","enabled","clearWrite","names","AppStorage","DATABASE_STATE","StateStorage","stateStorage","deepEqual","x","ignoreKeys","ignoreSet","okok","ok","tx","capitalizeFirstLetter","string","SKIP_PROTOCOLS","matchUrlProtocol","protocol","originalString","ALPHA_CHARS_REG_EXP","ALPHA_NUMERIC_REG_EXP","DOMAIN_ADD_CHARS","URL_ALPHANUMERIC_REG_EXP_PART","URL_PROTOCOL_REG_EXP_PART","URL_REG_EXP","USERNAME_REG_EXP","TIMESTAMP_REG_EXP","BOT_COMMAND_REG_EXP","FULL_REG_EXP","emojiRegExp","EMAIL_REG_EXP","MARKDOWN_REG_EXP","SITE_HASHTAGS","MARKDOWN_ENTITIES","PASS_CONFLICTING_ENTITIES","PASS_SINGLE_CONFLICTING_ENTITIES","PHONE_NUMBER_REG_EXP","wrapUrl","unsafe","out","tgMeMatch","tgMatch","onclick","u","fullPath","path","setInnerHTML","elem","html","setDirection","getDirection","setBlankToAnchor","anchor","sharedConfig","equalFn","a","b","$PROXY","$TRACK","signalOptions","runEffects","runQueue","STALE","PENDING","UNOWNED","NO_INIT","Owner","Transition","ExternalSourceConfig","Listener","Updates","Effects","ExecCount","createRoot","detachedOwner","owner","unowned","current","root","updateFn","untrack","cleanNode","runUpdates","createSignal","setter","writeSignal","readSignal","createComputed","c","createComputation","updateComputation","createRenderEffect","createEffect","runUserEffects","createReaction","onInvalidate","tracking","createMemo","createResource","pSource","pFetcher","pOptions","fetcher","pr","initP","scheduled","resolved","dynamic","contexts","setValue","setError","track","trigger","state","setState","loadEnd","completeLoad","read","SuspenseContext","load","refetching","lookup","castError","s","batch","on","deps","prevValue","defer","prevInput","onMount","onCleanup","getListener","getOwner","runWithOwner","prev","prevListener","handleError","startTransition","t","setTransPending","useTransition","transPending","createContext","defaultValue","createProvider","useContext","context","children","memo","resolveChildren","updates","lookUpstream","sSlot","node","isComp","TransitionRunning","markDownstream","time","runComputation","nextValue","init","pure","ancestors","wait","res","completeUpdates","queue","runTop","userLength","ignore","obs","n","props","FALLBACK","dispose","d","mapArray","list","mapFn","items","mapped","disposers","len","newItems","j","newLen","newIndices","newIndicesNext","temp","tempdisposers","tempIndexes","start","end","newEnd","indexes","disposer","mapper","createComponent","Comp","trueFn","_","property","receiver","resolveSource","resolveSources","mergeProps","sources","proxy","propTraps","defined","sourceKeys","sourcesMap","desc","definedKeys","splitProps","blocked","k","otherObject","propName","isDefaultDesc","objects","objectIndex","For","fallback","Show","keyed","condition","child","narrowedError","langPack","UNSUPPORTED_LANG_PACK_KEY","I18n","I18n2","setRTL","rtl","setLangCode","langCode","getCacheLangPack","cacheLangPackPromise","langPack2","applyLangPack","loadLocalLangPack","updateAmPm","dateTimeFormat","getDateTimeFormat","date","amText","pmText","setTimeFormat","format2","haveToUpdate","cachedDateTimeFormats","element","IntlDateElement","defaultCode","__vitePreload","lang","langSign","countries","strings","strings2","formatLocalStrings","saveLangPack","web","managers","getStrings","pushTo","getLangPack","loadLangPack","langPack1","localLangPack1","localLangPack2","_Intl","currentLangCode","pluralRules","langPackKey","country","pushNextArgument","indexHolder","arg","str","regExp","lastIndex","p1","p2","p3","p4","offset","superFormatter","wrappedUrl","formatted","match","plain","format","IntlElementBase","IntlElement","json","hours","i18n","i18n2","i18n_2","i18n_","_i18n2","_i18n","I18n$1","joinElementsWith","elements","joiner","isLast","join","useLast","joined","isAnyChat","peerId","isUser","isChat","newMethod","originMethod","bufferConcats","tmp","lastLength","onFinally","reason","WebpWorkerController","data","fileName","bytes","convertPromise","webpWorkerController","LocalStorage","stringified","lastError","_LocalStorageController","LocalStorageController","sessionStorage","isSwipingBackSafari","AppNavigationController","hash","wasIndex","good","single","appNavigationController","AppRuntimeManager","appRuntimeManager","copy","clonedObj","prop","IS_SHARED_WORKER_SUPPORTED","FOCUS_EVENT_NAME","IdleController","idle","idleController","CHECK_INSTANCE_INTERVAL","DEACTIVATE_TIMEOUT","MULTIPLE_TABS_THRESHOLD","IS_MULTIPLE_TABS_SUPPORTED","newInstance","curInstance","build","apiManagerProxy","singleInstance","clearMessageId","messageId","toServer","getServerMessageId","PING_PUSH_INTERVAL","reg","subscription","ACTIONS_LANG_MAP","action","successful","newSettings","subscriptionObj","mid","script","tsNow","seconds","canRedirect","curValue","ts","loadScript","IS_WEBRTC_SUPPORTED","CAN_USE_TRANSFERABLES","CAN_USE_TRANSFERABLES$1","IS_CANVAS_FILTER_SUPPORTED","IS_GEOLOCATION_SUPPORTED","IS_GROUP_CALL_SUPPORTED","IS_WEBP_SUPPORTED","IMAGE_MIME_TYPES_SUPPORTED","possible","mime","img","supported","IMAGE_MIME_TYPES_SUPPORTED_PROMISE","mimeTypes","video","IS_WEBM_SUPPORTED","IS_MOV_SUPPORTED","MEDIA_MIME_TYPES_SUPPORTED","IS_PARALLAX_SUPPORTED","IS_SCREEN_SHARING_SUPPORTED","IS_VIBRATE_SUPPORTED","IS_OPUS_SUPPORTED","audio","extension","renderer","IS_APPLE_MX","IS_APPLE_MX$1","IS_LIVE_STREAM_SUPPORTED","ENVIRONMENT","IS_CALL_SUPPORTED","VIDEO_MIME_TYPES_SUPPORTED","getTimeFormat","offsetWidth","arrays","nextRandomUint","bits","randomLong","STATE_VERSION$1","BUILD$1","DEFAULT_THEME","baseTheme","highlightingColor","makeDefaultAppTheme","compareVersion","v1","v2","s1","v22","s2","v12","isObject","initObject","currentObject","onReplace","previousKey","ignorePaths","_path","validateInitObject","recordPromise","description","recordPromiseBound","REFRESH_EVERY","STATE_VERSION","STATE_INIT","BUILD","ALL_KEYS","REFRESH_KEYS","loadStateInner","totalPerf","pushedKeys","pushToState","replaceState","_state","auth","stateId","sessionBuild","authKeyFingerprint","baseDcAuthKey","shiftedWebKAuth","resetStorages","resetState","preserveKeys","_authKeyFingerprint","autoDownloadSettings","oldTypes","mediaType","peerTypeSettings","peerType","missingKey","oldVersion","migrated","oldThemes","oldTheme","oldBackground","newTheme","getColorFromHex","hex","wallPaper","wallPaperSettings","colors","changed","theme","newVersion","loadState","OpusDecodeController","typedArray","keepAlive","kill","pages","withWaveform","dataBlob","apiManagerProxy$1","opusDecodeController","CryptoMessagePort","sendPortIndex","cryptoMessagePort","toArray","mimeType","blobConstruct","blobParts","safeMimeType","blobSafeMimeType","MemoryWriter","size","saveFileCallback","part","newBytes","endOffset","saveToStorage","blob","parts","dbName","_CacheStorageController","response","rejected","fileSize","toggleStorages","CacheStorageController","ServiceMessagePort","ServiceWorkerURL","joinDeepPath","splitDeepPath","DEEP_PATH_JOINER","deleteIfUndefined","splitted","lastObject","lastKey","getFileNameByLocation","location","ext","FILENAME_JOINER","geoPoint","isWebFileLocation","getThumbKey","media","generateEmptyThumb","getStickerThumbKey","docId","toneIndex","smth","isLegacyMessageId","$RAW","$NODE","$HAS","$SELF","wrap$1","proxyTraps$1","isWrappable","proto","unwrap","unwrapped","getNodes","symbol","nodes","getNode","proxyDescriptor$1","trackSelf","ownKeys","tracked","setProperty","deleting","mergeStoreNode","updateArray","next","updatePath","traversed","partType","from","to","by","createStore","unwrappedStore","wrappedStore","setStore","$ROOT","parent","merge","previous","keyVal","applyState","targetKeys","previousKeys","reconcile","_setAppState","appState","useAppState","sort","ids","createMemoOrReturn","valueOrGetter","usePeer","peerId2","useChat","chatId","chatId2","reconcilePeer","peer","reconcilePeers","peers","ApiManagerProxy","mirror","setDeepProperty","message","groupedId","_mid","previousMessage","map","setAppStateSilent","storageTask","language","toClear","telegramMeWebManager","webPushApiManager","cacheName","iframe","onFinish","onLoad","serviceWorker","registration","FIX_KEY","swfix","controller","worker","get","pathnameSplitted","originals","originalUrl","createWorker","attachWorkerToPort","worker2","constructor","firstWorker","messagePort","stateResult","thumbSize","reaction","callbackify","availableReactions","availableReaction","message2","minMid","mids","userId","saved","photo","overwrite","appConfig","isPremiumPurchaseBlocked","DEBUG_MANAGER_REQUESTS","createProxy","ack","createProxyProxy","proxied2","proxied","getProxiedManagers","clamp","min","max","rgbToHsv","g","h","hsvToRgb","f","rgbaToHsla","hslaToString","hsla","hslaToRgba","hue2rgb","q2","q","hslaStringToRgba","alpha","val","hexaToRgba","hexa","hexToRgb","hexaToHsla","rgba","rgbaToHexa","hslaStringToHexa","hslaStringToHex","mixColors","color1","color2","computePerceivedBrightness","color","getAverageColor","getAccentColor","baseHsv","baseColor","elementColor","hsvTemp3","hsvTemp4","dist","changeColorAccent","accentHsv","isDarkTheme","colorHsv","origBrightness","newBrightness","newColor","fallbackAmount","changeBrightness","amount","getHexColorFromTelegramColor","getRgbColorFromTelegramColor","getColorsFromWallPaper","rgbaToRgb","bg","calculateLuminance","rgb","getTextColor","luminance","calculateOpacity","targetContrast","targetTextLuminance","adaptiveOpacity","calcImageInBox","imageW","imageH","boxW","boxH","noZoom","makeMediaSize","boxedImageW","boxedImageH","MediaSize","height","width","boxSize","fitted","ScreenSize2","ScreenSize","MOBILE_SIZE","MEDIUM_SIZE","LARGE_SIZE","CUSTOM_EMOJI_SIZE","ESG_CUSTOM_EMOJI_SIZE","EMOJI_STATUS_SIZE","MediaSizes","innerWidth","activeScreen","wasScreen","mediaSizes","CustomProperties","night","customProperties","createUnifiedSignal","args2","getter","WindowSize","windowSize","LiteMode","liteMode","colorMap","coordinates","themeColorElem","darkModeMediaQuery","checkDarkMode","highlightingRgba","silent","isNight","theme2","wasApplied","reverse","transition","endRadius","appliedColors","_options","appColorMap","lightenAlpha","darkenAlpha","mixColor","saveToCache","appColor","lightenedRgb","darkenedHsla","properties","name2","currentTheme","themes","themeSettings","themeSettings2","newAppTheme","hsvTemp1","baseColors","hsvTemp2","newAccentHex","newAccentRgb","applyAppColor","finalize","messageLightenAlpha","baseMessageColor","myMessagesAccent","nextColor","baseMessageOutBackgroundColor","accentColor2","newMessageOutBackgroundColor","messageOutBackgroundColorHsl","themePropertiesMap","themeParams","themeController","OverlayCounter","overlayCounter","parseUriParams","uri","parseUriParamsLine","line","params","cacheInstallPrompt","deferredPrompt","outcome","getInstallPrompt","months","days","monthsLocalized","daysLocalized","ONE_DAY","ONE_DAY_MINUTES","ONE_WEEK_MINUTES","getWeekDays","getMonths","getWeekNumber","dayNum","yearStart","formatDate","today","formatDateAccordingToTodayNew","now","timestamp","formatFullSentTimeRaw","diff","dateEl","formatTimeOptions","formatFullSentTime","capitalize","noToday","timeEl","fragment","formatTime","fullYear","formatMonthsDuration","months2","bold","isYears","minYear","yearPattern","anyLetterRegExp","monthPattern","monthYearOrDayPattern","yearOrDayAndMonthPattern","shortDate","longDate","numberOfDaysEachMonth","query","dates","haystack","year","month","day","minDate","maxDate","dayOfWeek","getDayOfWeek","distance","currentDay","formatWeekLong","matches","g1","g2","k1","selectedYear","createForMonthYear","createForDayMonth","g3","currentYear","formatterYearMax","getMonth","formatterMonthYear","validDateForMonth","isLeapYear","formatterDayMonth","fillTipDates","USE_NATIVE_SCROLL","USE_CUSTOM_SCROLL","IS_OVERLAY_SCROLL_SUPPORTED","manifest","setViewportVH","lastVH","vh","setVH","preparePrint","chat","chatClone","bubbles","bubblesInner","printable","removePrint","toggleResizeMode","wasTabId","IS_INSTALL_PROMPT_SUPPORTED","langPromise","stateResult2","fillLocalizedDates","fadeInWhenFontsReady","authState","urlSearchParams","placeholder","telegramMeWebManager$1","webPushApiManager$1","meModule","pushModule","pagePromise"],"ignoreList":[27],"sources":["../src/config/app.ts","../src/helpers/dom/blurActiveElement.ts","../src/helpers/dom/cancelEvent.ts","../src/environment/touchSupport.ts","../src/environment/ctx.ts","../src/environment/userAgent.ts","../src/helpers/dom/findUpClassName.ts","../src/helpers/schedulers.ts","../src/helpers/dom/fixSafariStickyInput.ts","../src/helpers/dom/fixSafariStickyInputFocusing.ts","../src/config/font.ts","../src/helpers/noop.ts","../src/helpers/schedulers/pause.ts","../src/helpers/tgico.ts","../src/helpers/dom/loadFonts.ts","../src/environment/emojiSupport.ts","../src/helpers/setWorkerProxy.ts","../src/helpers/dom/toggleAttributePolyfill.ts","../src/lib/mtproto/mtproto_config.ts","../src/helpers/eventListenerBase.ts","../src/config/modes.ts","../src/config/debug.ts","../src/config/tabId.ts","../src/helpers/array/indexOfAndSplice.ts","../src/helpers/context.ts","../src/helpers/makeError.ts","../src/helpers/dT.ts","../src/lib/logger.ts","../src/lib/mtproto/superMessagePort.ts","../src/lib/mtproto/mtprotoMessagePort.ts","../src/lib/rootScope.ts","../src/helpers/cancellablePromise.ts","../src/helpers/schedulers/throttle.ts","../src/helpers/object/safeAssign.ts","../src/lib/files/idb.ts","../src/lib/storage.ts","../src/config/databases/state.ts","../src/lib/stateStorage.ts","../src/helpers/object/deepEqual.ts","../src/helpers/string/capitalizeFirstLetter.ts","../src/lib/richTextProcessor/matchUrlProtocol.ts","../src/vendor/emoji/regex.ts","../src/lib/richTextProcessor/index.ts","../src/lib/richTextProcessor/wrapUrl.ts","../src/helpers/dom/setInnerHTML.ts","../src/lib/richTextProcessor/setBlankToAnchor.ts","../src/vendor/solid/dist/solid.js","../src/lib/langPack.ts","../src/lib/appManagers/utils/peers/isAnyChat.ts","../src/lib/appManagers/utils/peers/isUser.ts","../src/helpers/peerIdPolyfill.ts","../src/helpers/bytes/bufferConcats.ts","../src/lib/polyfill.ts","../src/lib/webp/webpWorkerController.ts","../src/lib/localStorage.ts","../src/lib/sessionStorage.ts","../src/helpers/dom/isSwipingBackSafari.ts","../src/components/appNavigationController.ts","../src/lib/appManagers/appRuntimeManager.ts","../src/helpers/object/copy.ts","../src/environment/sharedWorkerSupport.ts","../src/helpers/idleController.ts","../src/lib/mtproto/singleInstance.ts","../src/lib/appManagers/utils/messageId/clearMessageId.ts","../src/lib/appManagers/utils/messageId/getServerMessageId.ts","../src/lib/mtproto/webPushApiManager.ts","../src/helpers/dom/loadScript.ts","../src/helpers/tsNow.ts","../src/lib/mtproto/telegramMeWebManager.ts","../src/environment/webrtcSupport.ts","../src/environment/callSupport.ts","../src/environment/canUseTransferables.ts","../src/environment/canvasFilterSupport.ts","../src/environment/geolocationSupport.ts","../src/environment/groupCallSupport.ts","../src/environment/webpSupport.ts","../src/environment/imageMimeTypesSupport.ts","../src/environment/videoSupport.ts","../src/environment/videoMimeTypesSupport.ts","../src/environment/parallaxSupport.ts","../src/environment/screenSharingSupport.ts","../src/environment/vibrateSupport.ts","../src/environment/opusSupport.ts","../src/environment/appleMx.ts","../src/environment/liveStreamSupport.ts","../src/environment/index.ts","../src/helpers/getTimeFormat.ts","../src/helpers/random.ts","../src/config/state.ts","../src/helpers/compareVersion.ts","../src/helpers/object/isObject.ts","../src/helpers/object/validateInitObject.ts","../src/helpers/recordPromise.ts","../src/lib/appManagers/utils/state/loadState.ts","../src/lib/opusDecodeController.ts","../src/lib/crypto/cryptoMessagePort.ts","../src/helpers/array/toArray.ts","../src/helpers/blob/blobSafeMimeType.ts","../src/helpers/blob/blobConstruct.ts","../src/lib/files/memoryWriter.ts","../src/lib/files/cacheStorage.ts","../src/helpers/toggleStorages.ts","../src/lib/serviceWorker/serviceMessagePort.ts","../src/helpers/object/setDeepProperty.ts","../src/helpers/fileName.ts","../src/lib/appManagers/utils/webFiles/isWebFileLocation.ts","../src/lib/storages/utils/thumbs/getThumbKey.ts","../src/lib/storages/utils/thumbs/generateEmptyThumb.ts","../src/lib/storages/utils/thumbs/getStickerThumbKey.ts","../src/helpers/callbackify.ts","../src/lib/appManagers/utils/messageId/isLegacyMessageId.ts","../src/vendor/solid/store/dist/store.js","../src/stores/appState.ts","../src/helpers/object/getObjectKeysAndSort.ts","../src/stores/peers.ts","../src/lib/mtproto/mtprotoworker.ts","../src/lib/appManagers/getProxiedManagers.ts","../src/helpers/number/clamp.ts","../src/helpers/color.ts","../src/helpers/calcImageInBox.ts","../src/helpers/mediaSize.ts","../src/helpers/mediaSizes.ts","../src/helpers/dom/customProperties.ts","../src/helpers/solid/createUnifiedSignal.ts","../src/helpers/windowSize.ts","../src/helpers/liteMode.ts","../src/helpers/themeController.ts","../src/helpers/overlayCounter.ts","../src/helpers/string/parseUriParams.ts","../src/environment/installPrompt.ts","../src/helpers/dom/installPrompt.ts","../src/helpers/date.ts","../src/environment/overlayScrollSupport.ts","../src/index.ts"],"sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport type {TrueDcId} from '../types';\r\n\r\nexport const MAIN_DOMAINS = ['web.telegram.org', 'webk.telegram.org'];\r\nexport const DEFAULT_BACKGROUND_SLUG = 'pattern';\r\n\r\nconst threads = Math.min(4, navigator.hardwareConcurrency ?? 4);\r\n\r\nconst App = {\r\n  id: +import.meta.env.VITE_API_ID,\r\n  hash: import.meta.env.VITE_API_HASH,\r\n  version: import.meta.env.VITE_VERSION,\r\n  versionFull: import.meta.env.VITE_VERSION_FULL,\r\n  build: +import.meta.env.VITE_BUILD,\r\n  langPackVersion: '5.5.8',\r\n  langPack: 'webk',\r\n  langPackCode: 'en',\r\n  domains: MAIN_DOMAINS,\r\n  baseDcId: 2 as TrueDcId,\r\n  isMainDomain: MAIN_DOMAINS.includes(location.hostname),\r\n  suffix: 'K',\r\n  threads,\r\n  cryptoWorkers: threads\r\n};\r\n\r\nif(App.isMainDomain) { // use Webogram credentials then\r\n  App.id = 2496;\r\n  App.hash = '8da85b0d5bfe62527e5b244c209159c3';\r\n}\r\n\r\nexport default App;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function blurActiveElement() {\r\n  if((document.activeElement as HTMLInputElement)?.blur) {\r\n    (document.activeElement as HTMLInputElement).blur();\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nexport default function cancelEvent(event?: Event) {\r\n  event ||= window.event;\r\n  if(event) {\r\n    // 'input' event will have cancelable=false, but we still need to preventDefault\r\n    // if(!event.cancelable) {\r\n    //   return false;\r\n    // }\r\n\r\n    // @ts-ignore\r\n    event = event.originalEvent || event;\r\n\r\n    try {\r\n      if(event.stopPropagation) event.stopPropagation();\r\n      if(event.preventDefault) event.preventDefault();\r\n      event.returnValue = false;\r\n      event.cancelBubble = true;\r\n    } catch(err) {}\r\n  }\r\n\r\n  return false;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// @ts-ignore\r\nconst IS_TOUCH_SUPPORTED = ('ontouchstart' in window) || (window.DocumentTouch && document instanceof DocumentTouch)/*  || true */;\r\nexport default IS_TOUCH_SUPPORTED;\r\n","const ctx = typeof(window) !== 'undefined' ? window : self;\r\n\r\nexport default ctx;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport ctx from './ctx';\r\n\r\nexport const USER_AGENT = navigator ? navigator.userAgent : null;\r\nexport const IS_APPLE = navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i) !== -1;\r\nexport const IS_ANDROID = navigator.userAgent.toLowerCase().indexOf('android') !== -1;\r\nexport const IS_CHROMIUM = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);\r\nexport const CHROMIUM_VERSION = (() => {\r\n  try {\r\n    return +navigator.userAgent.match(/Chrom(?:e|ium)\\/(.+?)(?:\\s|\\.)/)[1];\r\n  } catch(err) {\r\n  }\r\n})();\r\n\r\n// https://stackoverflow.com/a/58065241\r\nexport const IS_APPLE_MOBILE = (/iPad|iPhone|iPod/.test(navigator.platform) ||\r\n  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) &&\r\n  !(ctx as any).MSStream;\r\n\r\nexport const IS_SAFARI = !!('safari' in ctx) || !!(USER_AGENT && (/\\b(iPad|iPhone|iPod)\\b/.test(USER_AGENT) || (!!USER_AGENT.match('Safari') && !USER_AGENT.match('Chrome'))))/*  || true */;\r\nexport const IS_FIREFOX = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\r\n\r\nexport const IS_MOBILE_SAFARI = IS_SAFARI && IS_APPLE_MOBILE;\r\n\r\nexport const IS_MOBILE = (navigator.maxTouchPoints === undefined || navigator.maxTouchPoints > 0) && navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i) != -1;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// export function findUpClassName<T>(el: any, className: string): T;\r\nexport default function findUpClassName(el: EventTarget | {closest: (selector: string) => any}, className: string): HTMLElement {\r\n  return (el as any).closest('.' + className);\r\n  /* if(el.classList.contains(className)) return el; // 03.02.2020\r\n\r\n  while(el.parentElement) {\r\n    el = el.parentElement;\r\n    if(el.classList.contains(className))\r\n      return el;\r\n  }\r\n  return null; */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// * Jolly Cobra's schedulers\r\nimport {NoneToVoidFunction} from '../types';\r\n\r\n/*\r\nexport function throttleWithTickEnd<F extends AnyToVoidFunction>(fn: F) {\r\n  return throttleWith(onTickEnd, fn);\r\n}\r\n\r\nexport function throttleWithNow<F extends AnyToVoidFunction>(fn: F) {\r\n  return throttleWith(runNow, fn);\r\n}\r\n\r\nexport function onTickEnd(cb: NoneToVoidFunction) {\r\n  Promise.resolve().then(cb);\r\n}\r\n\r\nfunction runNow(fn: NoneToVoidFunction) {\r\n  fn();\r\n} */\r\n\r\nlet fastRafCallbacks: NoneToVoidFunction[] | undefined;\r\nexport function fastRaf(callback: NoneToVoidFunction) {\r\n  if(!fastRafCallbacks) {\r\n    fastRafCallbacks = [callback];\r\n\r\n    requestAnimationFrame(() => {\r\n      const currentCallbacks = fastRafCallbacks!;\r\n      fastRafCallbacks = undefined;\r\n      currentCallbacks.forEach((cb) => cb());\r\n    });\r\n  } else {\r\n    fastRafCallbacks.push(callback);\r\n  }\r\n}\r\n\r\nlet fastRafConventionalCallbacks: NoneToVoidFunction[] | undefined, processing = false;\r\nexport function fastRafConventional(callback: NoneToVoidFunction) {\r\n  if(!fastRafConventionalCallbacks) {\r\n    fastRafConventionalCallbacks = [callback];\r\n\r\n    requestAnimationFrame(() => {\r\n      processing = true;\r\n      for(let i = 0; i < fastRafConventionalCallbacks.length; ++i) {\r\n        fastRafConventionalCallbacks[i]();\r\n      }\r\n\r\n      fastRafConventionalCallbacks = undefined;\r\n      processing = false;\r\n    });\r\n  } else if(processing) {\r\n    callback();\r\n  } else {\r\n    fastRafConventionalCallbacks.push(callback);\r\n  }\r\n}\r\n\r\nlet rafPromise: Promise<void>;\r\nexport function fastRafPromise() {\r\n  if(rafPromise) return rafPromise;\r\n\r\n  rafPromise = new Promise<void>((resolve) => fastRaf(() => resolve()));\r\n  rafPromise.then(() => {\r\n    rafPromise = undefined;\r\n  });\r\n\r\n  return rafPromise;\r\n}\r\n\r\nexport function doubleRaf() {\r\n  return new Promise<void>((resolve) => {\r\n    fastRaf(() => {\r\n      fastRaf(resolve);\r\n    });\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {doubleRaf} from '../schedulers';\r\n\r\nexport default function fixSafariStickyInput(input: HTMLElement) {\r\n  input.style.transform = 'translateY(-99999px)';\r\n  /* input.style.position = 'fixed';\r\n  input.style.top = '-99999px';\r\n  input.style.left = '0'; */\r\n  input.focus();\r\n\r\n  // setTimeout(() => {\r\n  doubleRaf().then(() => {\r\n    // fastSmoothScroll(findUpClassName(input, 'scrollable-y') || window as any, document.activeElement as HTMLElement, 'start', 4, undefined, FocusDirection.Static);\r\n    /* input.style.position = '';\r\n    input.style.top = ''; */\r\n    input.style.transform = '';\r\n    // fastSmoothScroll(findUpClassName(input, 'scrollable-y') || window as any, document.activeElement as HTMLElement, 'start', 4, undefined, FocusDirection.Static);\r\n\r\n    /* setTimeout(() => {\r\n      fastSmoothScroll(findUpClassName(input, 'scrollable-y') || window as any, document.activeElement as HTMLElement, 'start', 4);\r\n    }, 50); */\r\n  });\r\n  // }, 0);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from '../../environment/touchSupport';\r\nimport {IS_MOBILE, IS_SAFARI} from '../../environment/userAgent';\r\nimport findUpClassName from './findUpClassName';\r\nimport fixSafariStickyInput from './fixSafariStickyInput';\r\n\r\nexport const IS_STICKY_INPUT_BUGGED = IS_SAFARI && IS_MOBILE && IS_TOUCH_SUPPORTED && false;\r\n\r\nif(IS_STICKY_INPUT_BUGGED) {\r\n  const key: 'clientY' | 'pageY' = 'clientY';\r\n  let startY = 0;\r\n  const o = {capture: true, passive: false};\r\n  const onTouchMove = (e: TouchEvent) => {\r\n    const touch = e.touches[0];\r\n\r\n    // console.log('touchmove y', touch[key], startY);\r\n\r\n    const scrollable = findUpClassName(touch.target, 'scrollable-y');\r\n    if(scrollable) {\r\n      const y = touch[key];\r\n      const scrolled = startY - y;\r\n\r\n      /* if(y < startY) {\r\n        startY = y;\r\n      } */\r\n\r\n      const scrollTop = scrollable.scrollTop;\r\n      const scrollHeight = scrollable.scrollHeight;\r\n      const clientHeight = scrollable.clientHeight;\r\n      const nextScrollTop = scrollTop ? Math.round(scrollTop + scrollable.clientHeight + scrolled) : scrollTop + scrolled;\r\n      // const needCancel = scrollHeight !== clientHeight ? (scrollTop && diff <= 1) || (scrollTop - diff) < 0 : true;\r\n      const needCancel = scrollHeight === clientHeight || nextScrollTop >= scrollHeight || nextScrollTop <= 0;\r\n      if(needCancel) {\r\n        e.preventDefault();\r\n      }\r\n\r\n      // console.log('touchmove with scrollable', scrollTop, startY, scrolled, nextScrollTop, needCancel, e.cancelable);\r\n    } else {\r\n      e.preventDefault();\r\n\r\n      // console.log('touchmove no scrollable', e, touch);\r\n    }\r\n\r\n    // if(e.target === document.documentElement || e.target === document.body) e.preventDefault();\r\n  };\r\n\r\n  // let el = document.createElement('div');\r\n  // document.body.prepend(el);\r\n  // let a = 0;\r\n\r\n  // let hasFocus = false;\r\n  let lastFocusOutTimeStamp = 0;\r\n  document.addEventListener('focusin', (e) => {\r\n    if(!(e.target as HTMLElement).classList.contains('is-sticky-input-bugged') || (e.timeStamp - lastFocusOutTimeStamp) < 50/*  && document.activeElement === input */) {\r\n      return;\r\n    }\r\n\r\n    // console.log('focusin', e, e.timeStamp);\r\n\r\n    // hasFocus = true;\r\n    // document.body.classList.add('is-keyboard-opened');\r\n\r\n    // el.innerText = 'focusin ' + ++a;\r\n\r\n    /* a < 2 &&  */fixSafariStickyInput(e.target as HTMLElement);\r\n\r\n    document.addEventListener('touchmove', onTouchMove, o);\r\n    document.addEventListener('touchstart', (e) => {\r\n      if(e.touches.length > 1) return;\r\n      const touchStart = e.touches[0];\r\n\r\n      startY = touchStart[key];\r\n    });\r\n  }, {passive: true});\r\n\r\n  document.addEventListener('focusout', (e) => {\r\n    // console.log('focusout', e, e.timeStamp);\r\n    document.removeEventListener('touchmove', onTouchMove, o);\r\n\r\n    lastFocusOutTimeStamp = e.timeStamp;\r\n\r\n    // el.innerText = 'focusout ' + ++a;\r\n\r\n    // if(hasFocus) {\r\n    //   hasFocus = false;\r\n    //   document.body.classList.remove('is-keyboard-opened');\r\n    // }\r\n  }, {passive: true});\r\n\r\n  document.addEventListener('visibilitychange', () => {\r\n    // console.log('window visibilitychange');\r\n    if(document.activeElement &&\r\n      document.activeElement.classList.contains('is-sticky-input-bugged') &&\r\n      (document.activeElement as HTMLElement).blur) {\r\n      fixSafariStickyInput(document.activeElement as HTMLElement);\r\n    }\r\n\r\n    /* blurActiveElement();\r\n    window.scrollTo(0, 0);\r\n    setVH(); */\r\n  }, {passive: true});\r\n}\r\n\r\nexport default function fixSafariStickyInputFocusing(input: HTMLElement) {\r\n  if(!IS_STICKY_INPUT_BUGGED) return;\r\n  input.classList.add('is-sticky-input-bugged');\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport const FontFamilyName = 'Roboto';\r\nexport const FontFamily = FontFamilyName + ', -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Oxygen-Sans, Ubuntu, Cantarell, \"Helvetica Neue\", sans-serif';\r\nexport const FontSize = '16px';\r\nexport const FontWeight = '400';\r\nexport const FontFull = `${FontWeight} ${FontSize} ${FontFamily}`;\r\n","export default function noop() {}\r\n","export default function pause(ms: number) {\r\n  return new Promise<void>((resolve) => {\r\n    setTimeout(resolve, ms);\r\n  });\r\n}\r\n","export const TGICO_CLASS = 'tgico';\r\nexport default function tgico(icon: Icon) {\r\n  return [TGICO_CLASS, _tgico(icon)];\r\n}\r\n\r\nexport function _tgico(icon: Icon) {\r\n  return TGICO_CLASS + '-' + icon;\r\n}\r\n\r\nexport function tgico_(icon: Icon) {\r\n  return tgico(icon).join(' ');\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {FontFamilyName} from '../../config/font';\r\nimport noop from '../noop';\r\nimport pause from '../schedulers/pause';\r\nimport {TGICO_CLASS} from '../tgico';\r\n\r\nconst texts = ['b', ''];\r\ntype FontType = 'text' | 'icons' | 'monospace';\r\n\r\nconst cache: {\r\n  [key: string]: {\r\n    [text: string]: Promise<any>\r\n  }\r\n} = {};\r\n\r\nconst fonts: {[type in FontType]: string} = {\r\n  text: FontFamilyName,\r\n  icons: TGICO_CLASS,\r\n  monospace: 'Roboto Mono'\r\n};\r\n\r\nexport default function loadFonts(types: {[type in FontType]?: string[] | 'all'} = {\r\n  text: texts,\r\n  icons: undefined,\r\n  monospace: texts\r\n}): Promise<any> {\r\n  if(!('fonts' in document)) {\r\n    return Promise.resolve();\r\n  }\r\n\r\n  const promises: Promise<any>[] = [];\r\n  for(const type in types) {\r\n    let _texts = types[type as FontType];\r\n    if(_texts === 'all') {\r\n      _texts = texts;\r\n    }\r\n\r\n    const font = fonts[type as FontType];\r\n    const weights = type === 'icons' ? [500] : [400, 500];\r\n    for(const weight of weights) {\r\n      const _promises = (_texts || [undefined]).map((text) => {\r\n        const key = [weight, '1rem', font].join(' ');\r\n        const promise = (cache[key] ??= {})[text || ''] ??= document.fonts.load(key, text);\r\n        return promise;\r\n      });\r\n      promises.push(..._promises);\r\n    }\r\n  }\r\n\r\n  return Promise.race([\r\n    Promise.all(promises).catch(noop),\r\n    pause(1000)\r\n  ]);\r\n}\r\n","const IS_EMOJI_SUPPORTED = navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i) !== -1/*  && false *//*  || true */;\r\n\r\nexport default IS_EMOJI_SUPPORTED;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport function makeWorkerURL(url: string | URL) {\r\n  if(!(url instanceof URL)) {\r\n    url = new URL(url + '', location.href);\r\n  }\r\n\r\n  if(location.search && url.protocol !== 'blob:') {\r\n    const params = new URLSearchParams(location.search);\r\n    params.forEach((value, key) => {\r\n      (url as URL).searchParams.set(key, value);\r\n    });\r\n  }\r\n\r\n  // exclude useless params\r\n  (url as URL).searchParams.delete('swfix');\r\n\r\n  return url;\r\n}\r\n\r\nexport default function setWorkerProxy() {\r\n  // * hook worker constructor to set search parameters (test, debug, etc)\r\n  const workerHandler = {\r\n    construct(target: any, args: any) {\r\n      args[0] = makeWorkerURL(args[0]);\r\n      return new target(...args);\r\n    }\r\n  };\r\n\r\n  [\r\n    Worker,\r\n    typeof(SharedWorker) !== 'undefined' && SharedWorker\r\n  ].filter(Boolean).forEach((w) => {\r\n    window[w.name as any] = new Proxy(w, workerHandler);\r\n  });\r\n}\r\n\r\nsetWorkerProxy();\r\n","export default function toggleAttributePolyfill() {\r\n  if(!Element.prototype.toggleAttribute) {\r\n    Element.prototype.toggleAttribute = function(name, force) {\r\n      if(force !== void 0) force = !!force;\r\n\r\n      if(this.hasAttribute(name)) {\r\n        if(force) return true;\r\n\r\n        this.removeAttribute(name);\r\n        return false;\r\n      }\r\n      if(force === false) return false;\r\n\r\n      this.setAttribute(name, '');\r\n      return true;\r\n    };\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {MyDialogFilter} from '../storages/filters';\r\n\r\n/**\r\n * Legacy Webogram's format, don't change dcID to camelCase. date is timestamp\r\n */\r\nexport type UserAuth = {dcID: number | string, date: number, id: PeerId};\r\nexport type REAL_FOLDER_ID = 0 | 1;\r\n\r\nexport const NULL_PEER_ID: PeerId = 0;\r\nexport const REPLIES_PEER_ID: PeerId = 1271266957;\r\nexport const REPLIES_HIDDEN_CHANNEL_ID: ChatId = 777;\r\nexport const HIDDEN_PEER_ID: PeerId = 2666000;\r\nexport const SERVICE_PEER_ID: PeerId = 777000;\r\nexport const MUTE_UNTIL = 0x7FFFFFFF;\r\nexport const BOT_START_PARAM = '';\r\nexport const MAX_FILE_SAVE_SIZE = 20 * 1024 * 1024;\r\nexport const THUMB_TYPE_FULL = '';\r\nexport const TOPIC_COLORS = [0x6FB9F0, 0xFFD67E, 0xCB86DB, 0x8EEE98, 0xFF93B2, 0xFB6F5F];\r\nexport const ATTACH_MENU_BOT_ICON_NAME = 'default_static';\r\nexport const MESSAGE_ID_OFFSET = 0x100000000;\r\nexport const GENERAL_TOPIC_ID = MESSAGE_ID_OFFSET + 1;\r\nexport const CAN_HIDE_TOPIC = false;\r\nexport const T_ME_PREFIXES = new Set(['web', 'k', 'z', 'a']);\r\nexport const SEND_WHEN_ONLINE_TIMESTAMP = 0x7FFFFFFE;\r\nexport const SERVER_IMAGE_MIME_TYPES = new Set(['image/jpeg', 'image/png', 'image/bmp', 'image/gif']);\r\nexport const STARS_CURRENCY = 'XTR';\r\n\r\nexport const FOLDER_ID_ALL: REAL_FOLDER_ID = 0;\r\nexport const FOLDER_ID_ARCHIVE: REAL_FOLDER_ID = 1;\r\nexport const REAL_FOLDERS: Set<number> = new Set([FOLDER_ID_ALL, FOLDER_ID_ARCHIVE]);\r\nexport const START_LOCAL_ID = Math.max(...Array.from(REAL_FOLDERS)) + 1 as MyDialogFilter['localId'];\r\n\r\nexport const TEST_NO_STORIES = false;\r\nexport const TEST_NO_SAVED = false;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// import { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport type {ArgumentTypes, SuperReturnType} from '../types';\r\n\r\n// class EventSystem {\r\n//   wm: WeakMap<any, Record<any, Set<any>>> = new WeakMap();\r\n\r\n//   add(target: any, event: any, listener: any) {\r\n//     let listeners = this.wm.get(target);\r\n//     if (listeners === undefined) {\r\n//         listeners = {};\r\n//     }\r\n//     let listenersForEvent = listeners[event];\r\n//     if (listenersForEvent === undefined) {\r\n//         listenersForEvent = new Set();\r\n//     }\r\n//     listenersForEvent.add(listener);\r\n//     listeners[event] = listenersForEvent;\r\n//     //target.addEventListener(event, listener);\r\n//     this.wm.set(target, listeners);\r\n//   };\r\n\r\n//   remove(target: any, event: any, listener: any) {\r\n//     let listeners = this.wm.get(target);\r\n//     if (!listeners) return;\r\n//     let listenersForEvent = listeners[event];\r\n//     if (!listenersForEvent) return;\r\n//     listenersForEvent.delete(listener);\r\n//   };\r\n\r\n//   /* fire(target, event) {\r\n//      let listeners = this.wm.get(target);\r\n//      if (!listeners) return;\r\n//      let listenersForEvent = listeners[event];\r\n//      if (!listenersForEvent) return;\r\n//      for (let handler of handlers) {\r\n//          setTimeout(handler, 0, event, target); // we use a setTimeout here because we want event triggering to be asynchronous.\r\n//      }\r\n//   }; */\r\n// }\r\n\r\n// console.log = () => {};\r\n\r\n// const e = new EventSystem();\r\n// MOUNT_CLASS_TO.e = e;\r\n\r\nexport type EventListenerListeners = Record<string, Function>;\r\n// export type EventListenerListeners = Record<string, (...args: any[]) => any>;\r\n// export type EventListenerListeners = {[name in string]: Function};\r\n\r\n/**\r\n * Better not to remove listeners during setting\r\n * Should add listener callback only once\r\n */\r\n\r\ntype ListenerObject<T> = {callback: T, options: boolean | AddEventListenerOptions};\r\n\r\n// type EventLitenerCallback<T> = (data: T) =>\r\n// export default class EventListenerBase<Listeners extends {[name: string]: Function}> {\r\nexport default class EventListenerBase<Listeners extends EventListenerListeners> {\r\n  protected listeners: Partial<{\r\n    [k in keyof Listeners]: Set<ListenerObject<Listeners[k]>>\r\n  }>;\r\n  protected listenerResults: Partial<{\r\n    [k in keyof Listeners]: ArgumentTypes<Listeners[k]>\r\n  }>;\r\n\r\n  private reuseResults: boolean;\r\n\r\n  constructor(reuseResults?: boolean) {\r\n    this._constructor(reuseResults);\r\n  }\r\n\r\n  public _constructor(reuseResults?: boolean): any {\r\n    this.reuseResults = reuseResults;\r\n    this.listeners = {};\r\n    this.listenerResults = {};\r\n  }\r\n\r\n  public addEventListener<T extends keyof Listeners>(name: T, callback: Listeners[T], options?: boolean | AddEventListenerOptions) {\r\n    const listenerObject: ListenerObject<Listeners[T]> = {callback, options};\r\n    (this.listeners[name] ??= new Set()).add(listenerObject); // ! add before because if you don't, you won't be able to delete it from callback\r\n\r\n    if(this.listenerResults.hasOwnProperty(name)) {\r\n      callback(...this.listenerResults[name]);\r\n\r\n      if((options as AddEventListenerOptions)?.once) {\r\n        this.listeners[name].delete(listenerObject);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // e.add(this, name, {callback, once});\r\n  }\r\n\r\n  public addMultipleEventsListeners(obj: {\r\n    [name in keyof Listeners]?: Listeners[name]\r\n  }) {\r\n    for(const i in obj) {\r\n      this.addEventListener(i, obj[i]);\r\n    }\r\n  }\r\n\r\n  public removeEventListener<T extends keyof Listeners>(\r\n    name: T,\r\n    callback: Listeners[T],\r\n    options?: boolean | AddEventListenerOptions\r\n  ) {\r\n    if(this.listeners[name]) {\r\n      for(const l of this.listeners[name]) {\r\n        if(l.callback === callback) {\r\n          this.listeners[name].delete(l);\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    // e.remove(this, name, callback);\r\n  }\r\n\r\n  protected invokeListenerCallback<T extends keyof Listeners, L extends ListenerObject<any>>(\r\n    name: T,\r\n    listener: L,\r\n    ...args: ArgumentTypes<L['callback']>\r\n  ) {\r\n    let result: any, error: any;\r\n    try {\r\n      result = listener.callback(...args);\r\n    } catch(err) {\r\n      error = err;\r\n      // console.error('listener callback error', err);\r\n    }\r\n\r\n    if((listener.options as AddEventListenerOptions)?.once) {\r\n      this.removeEventListener(name, listener.callback);\r\n    }\r\n\r\n    if(error) {\r\n      throw error;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  private _dispatchEvent<T extends keyof Listeners>(\r\n    name: T,\r\n    collectResults: boolean,\r\n    ...args: ArgumentTypes<Listeners[T]>\r\n  ) {\r\n    if(this.reuseResults) {\r\n      this.listenerResults[name] = args;\r\n    }\r\n\r\n    const arr: Array<SuperReturnType<Listeners[typeof name]>> = collectResults && [];\r\n\r\n    const listeners = this.listeners[name];\r\n    if(listeners) {\r\n      for(const listener of listeners) {\r\n        const result = this.invokeListenerCallback(name, listener, ...args);\r\n        if(arr) {\r\n          arr.push(result);\r\n        }\r\n      }\r\n    }\r\n\r\n    return arr;\r\n  }\r\n\r\n  public dispatchResultableEvent<T extends keyof Listeners>(name: T, ...args: ArgumentTypes<Listeners[T]>) {\r\n    return this._dispatchEvent(name, true, ...args);\r\n  }\r\n\r\n  // * must be protected, but who cares\r\n  public dispatchEvent<L extends EventListenerListeners = Listeners, T extends keyof L = keyof L>(\r\n    name: T,\r\n    ...args: ArgumentTypes<L[T]>\r\n  ) {\r\n    // @ts-ignore\r\n    this._dispatchEvent(name, false, ...args);\r\n  }\r\n\r\n  public cleanup() {\r\n    this.listeners = {};\r\n    this.listenerResults = {};\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport type {TransportType} from '../lib/mtproto/dcConfigurator';\r\n\r\nconst Modes = {\r\n  test: location.search.indexOf('test=1') > 0/*  || true */,\r\n  debug: location.search.indexOf('debug=1') > 0,\r\n  http: false,\r\n  ssl: true, // location.search.indexOf('ssl=1') > 0 || location.protocol === 'https:' && location.search.indexOf('ssl=0') === -1,\r\n  asServiceWorker: !!import.meta.env.VITE_MTPROTO_SW,\r\n  transport: 'websocket' as TransportType,\r\n  noSharedWorker: location.search.indexOf('noSharedWorker=1') > 0,\r\n  multipleTransports: !!(import.meta.env.VITE_MTPROTO_AUTO && import.meta.env.VITE_MTPROTO_HAS_HTTP && import.meta.env.VITE_MTPROTO_HAS_WS)\r\n};\r\n\r\nif(import.meta.env.VITE_MTPROTO_HAS_HTTP) {\r\n  const httpOnly = Modes.http = location.search.indexOf('http=1') > 0;\r\n  if(httpOnly) {\r\n    Modes.multipleTransports = false;\r\n  }\r\n}\r\n\r\n// * start with HTTP first\r\nif(Modes.multipleTransports) {\r\n  Modes.http = true;\r\n}\r\n\r\nif(Modes.http) {\r\n  Modes.transport = 'https';\r\n}\r\n\r\nexport default Modes;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Modes from './modes';\r\n\r\nexport const IS_BETA = import.meta.env.DEV;\r\nexport const DEBUG = (IS_BETA || Modes.debug)/*  && false */;\r\nconst ctx: any = typeof(window) !== 'undefined' ? window : self;\r\nexport const MOUNT_CLASS_TO: any = DEBUG || true/*  && false */ ? ctx : {};\r\nexport default DEBUG;\r\n\r\n// let m = DEBUG;\r\n/* if(!DEBUG) {\r\n  ctx.sandpitTurtle = () => {\r\n    //if(!m) {\r\n      for(let i in MOUNT_CLASS_TO) {\r\n        ctx[i] = MOUNT_CLASS_TO[i];\r\n      }\r\n      //m = true;\r\n    //}\r\n\r\n    //DEBUG = !DEBUG;\r\n  };\r\n} */\r\n\r\n/* export const superDebug = (object: any, key: string) => {\r\n  var d = object[key];\r\n  var beforeStr = '', afterStr = '';\r\n  for(var r of d) {\r\n    beforeStr += r.before.hex + '\\n';\r\n    afterStr += r.after.hex + '\\n';\r\n  }\r\n\r\n  beforeStr = beforeStr.trim();\r\n  afterStr = afterStr.trim();\r\n  //var beforeStr = d.map((r) => r.before.hex).join('\\n');\r\n  //var afterStr = d.map((r) => r.after.hex).join('\\n');\r\n\r\n  var dada = (name: string, str: string) => {\r\n    var a = document.createElement('a');\r\n    a.target = '_blank';\r\n    a.download = name + '.txt';\r\n    a.href = URL.createObjectURL(new Blob([str], {\r\n      type: 'text/plain'\r\n    }));\r\n    document.body.append(a);\r\n    a.click();\r\n  };\r\n\r\n  dada(key + '_' + 'before', beforeStr);\r\n  dada(key + '_' + 'after', afterStr);\r\n}\r\n\r\nMOUNT_CLASS_TO.superDebug = superDebug; */\r\n","const tabId = Date.now() % Math.random() * 100000000 | 0;\r\nexport default tabId;\r\n","export default function indexOfAndSplice<T>(array: Array<T>, item: T) {\r\n  const idx = array.indexOf(item);\r\n  const spliced = idx === -1 ? undefined : array.splice(idx, 1);\r\n  return spliced?.[0];\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n//  SW      TRUE\r\nexport const IS_SERVICE_WORKER = typeof ServiceWorkerGlobalScope !== 'undefined' && self instanceof ServiceWorkerGlobalScope;\r\nexport const IS_WEB_WORKER = typeof WorkerGlobalScope !== 'undefined' && self instanceof WorkerGlobalScope && !IS_SERVICE_WORKER;\r\nexport const IS_WORKER = IS_WEB_WORKER || IS_SERVICE_WORKER;\r\n\r\nexport const getWindowClients = () => {\r\n  return (self as any as ServiceWorkerGlobalScope)\r\n  .clients\r\n  .matchAll({includeUncontrolled: false, type: 'window'});\r\n};\r\n\r\nexport const getLastWindowClient = () => getWindowClients().then((windowClients) => windowClients.slice(-1)[0]);\r\n\r\nconst postMessage = (listener: WindowClient | DedicatedWorkerGlobalScope, ...args: any[]) => {\r\n  try {\r\n    // @ts-ignore\r\n    listener.postMessage(...args);\r\n  } catch(err) {\r\n    console.error('[worker] postMessage error:', err, args);\r\n  }\r\n};\r\n\r\nconst notifyServiceWorker = (all: boolean, ...args: any[]) => {\r\n  getWindowClients().then((listeners) => {\r\n    if(!listeners.length) {\r\n      // console.trace('no listeners?', self, listeners);\r\n      return;\r\n    }\r\n\r\n    listeners.slice(all ? 0 : -1).forEach((listener) => {\r\n      postMessage(listener, ...args);\r\n    });\r\n  });\r\n};\r\n\r\nconst notifyWorker = (...args: any[]) => {\r\n  postMessage(self as any as DedicatedWorkerGlobalScope, ...args);\r\n};\r\n\r\nconst noop = () => {};\r\n\r\nexport const notifySomeone = IS_SERVICE_WORKER ? notifyServiceWorker.bind(null, false) : (IS_WEB_WORKER ? notifyWorker : noop);\r\nexport const notifyAll = IS_SERVICE_WORKER ? notifyServiceWorker.bind(null, true) : (IS_WEB_WORKER ? notifyWorker : noop);\r\n","const CACHED_ERRORS: {[key in Error['type']]?: ApiError} = {};\r\nexport default function makeError(type: Error['type']) {\r\n  return CACHED_ERRORS[type] ??= {\r\n    type\r\n  };\r\n}\r\n","const _logTimer = Date.now();\r\nexport default function dT() {\r\n  return '[' + ((Date.now() - _logTimer) / 1000).toFixed(3) + ']';\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport DEBUG from '../config/debug';\r\nimport {IS_FIREFOX, IS_SAFARI} from '../environment/userAgent';\r\nimport {IS_SERVICE_WORKER, IS_WEB_WORKER} from '../helpers/context';\r\nimport dT from '../helpers/dT';\r\n\r\nexport enum LogTypes {\r\n  None = 0,\r\n  Error = 1,\r\n  Warn = 2,\r\n  Log = 4,\r\n  Debug = 8\r\n};\r\n\r\nexport const LOG_LEVELS = [LogTypes.None, LogTypes.Error, LogTypes.Warn, LogTypes.Log, LogTypes.Debug];\r\n\r\nconst IS_WEBKIT = IS_SAFARI || IS_FIREFOX;\r\n\r\n// let getCallerFunctionNameFromLine: (line: string) => string;\r\n// if(IS_WEBKIT) {\r\n//   getCallerFunctionNameFromLine = (line) => {\r\n//     const splitted = line.split('@');\r\n//     return splitted[0];\r\n//   };\r\n// } else {\r\n//   getCallerFunctionNameFromLine = (line: string) => {\r\n//     const splitted = line.trim().split(' ');\r\n//     if(splitted.length === 3) {\r\n//       return splitted[1].slice(splitted[1].lastIndexOf('.') + 1);\r\n//     }\r\n//   };\r\n// }\r\n\r\nconst STYLES_SUPPORTED = !IS_WEBKIT;\r\n// const LINE_INDEX = IS_WEBKIT ? 2 : 3;\r\n\r\n// function getCallerFunctionName() {\r\n//   const stack = new Error().stack;\r\n//   const lines = stack.split('\\n');\r\n//   const line = lines[LINE_INDEX] || lines[lines.length - 1];\r\n//   // const match = line.match(/\\.([^\\.]+?)\\s/);\r\n//   // line = match ? match[1] : line.trim();\r\n//   const caller = getCallerFunctionNameFromLine(line) || '<anonymous>';\r\n//   return '[' + caller + ']';\r\n// }\r\n\r\nexport const LOGGER_STYLES = {\r\n  reset: '\\x1b[0m',\r\n  bright: '\\x1b[1m',\r\n  dim: '\\x1b[2m',\r\n  underscore: '\\x1b[4m',\r\n  blink: '\\x1b[5m',\r\n  reverse: '\\x1b[7m',\r\n  hidden: '\\x1b[8m',\r\n  // Foreground (text) colors\r\n  fg: {\r\n    black: '\\x1b[30m',\r\n    red: '\\x1b[31m',\r\n    green: '\\x1b[32m',\r\n    yellow: '\\x1b[33m',\r\n    blue: '\\x1b[34m',\r\n    magenta: '\\x1b[35m',\r\n    cyan: '\\x1b[36m',\r\n    white: '\\x1b[37m'\r\n  },\r\n  // Background colors\r\n  bg: {\r\n    black: '\\x1b[40m',\r\n    red: '\\x1b[41m',\r\n    green: '\\x1b[42m',\r\n    yellow: '\\x1b[43m',\r\n    blue: '\\x1b[44m',\r\n    magenta: '\\x1b[45m',\r\n    cyan: '\\x1b[46m',\r\n    white: '\\x1b[47m'\r\n  }\r\n};\r\n\r\nexport type Logger = {\r\n  (...args: any[]): void;\r\n  warn(...args: any[]): void;\r\n  info(...args: any[]): void;\r\n  error(...args: any[]): void;\r\n  trace(...args: any[]): void;\r\n  debug(...args: any[]): void;\r\n  assert(...args: any[]): void;\r\n  // log(...args: any[]): void;\r\n  group(...args: any[]): void;\r\n  groupCollapsed(...args: any[]): void;\r\n  groupEnd(...args: any[]): void;\r\n  setPrefix(newPrefix: string): void;\r\n  setLevel(level: 0 | 1 | 2 | 3 | 4): void;\r\n  bindPrefix(prefix: string, type?: LogTypes): Logger;\r\n};\r\n\r\nconst methods: ['debug' | 'info' | 'warn' | 'error' | 'assert' | 'trace'/*  | 'log' */ | 'group' | 'groupCollapsed' | 'groupEnd', LogTypes][] = [\r\n  ['debug', LogTypes.Debug],\r\n  ['info', LogTypes.Log],\r\n  ['warn', LogTypes.Warn],\r\n  ['error', LogTypes.Error],\r\n  ['assert', LogTypes.Error],\r\n  ['trace', LogTypes.Log],\r\n  ['group', LogTypes.Log],\r\n  ['groupCollapsed', LogTypes.Log],\r\n  ['groupEnd', LogTypes.Log]\r\n  // [\"log\", LogTypes.Log]\r\n];\r\n\r\nexport function logger(prefix: string, type: LogTypes = LogTypes.Log | LogTypes.Warn | LogTypes.Error, ignoreDebugReset = false, style = ''): Logger {\r\n  let originalPrefix: string;\r\n  if(!DEBUG && !ignoreDebugReset/*  || true */) {\r\n    type = LogTypes.Error;\r\n  }\r\n\r\n  if(!STYLES_SUPPORTED) {\r\n    style = '';\r\n  } else if(!style) {\r\n    if(IS_SERVICE_WORKER) style = LOGGER_STYLES.fg.yellow;\r\n    else if(IS_WEB_WORKER) style = LOGGER_STYLES.fg.cyan;\r\n  }\r\n\r\n  const originalStyle = style;\r\n  if(style) style = `%s ${style}%s`;\r\n  else style = '%s';\r\n\r\n  // level = LogLevels.log | LogLevels.warn | LogLevels.error | LogLevels.debug\r\n\r\n  const log: Logger = function(...args: any[]) {\r\n    return type & LogTypes.Log && console.log(style, dT(), prefix, /* getCallerFunctionName(), */ ...args);\r\n  } as any;\r\n\r\n  methods.forEach(([method, logType]) => {\r\n    log[method] = function(...args: any[]) {\r\n      return type & logType && console[method](style, dT(), prefix, /* getCallerFunctionName(), */ ...args);\r\n    };\r\n  });\r\n\r\n  log.setPrefix = function(newPrefix: string) {\r\n    originalPrefix = newPrefix;\r\n    prefix = '[' + newPrefix + ']';\r\n  };\r\n\r\n  log.setPrefix(prefix);\r\n\r\n  log.setLevel = function(level: 0 | 1 | 2 | 3 | 4) {\r\n    type = LOG_LEVELS.slice(0, level + 1).reduce((acc, v) => acc | v, 0) as any;\r\n  };\r\n\r\n  const prefixCache: {[prefix: string]: Logger} = {};\r\n  log.bindPrefix = function(prefix: string, _type = type) {\r\n    return prefixCache[prefix] ??= logger(\r\n      // `${originalPrefix}] ${LOGGER_STYLES.fg.magenta}[${prefix}`,\r\n      `${originalPrefix}] ${STYLES_SUPPORTED && originalStyle ? LOGGER_STYLES.reset : ''}[${prefix}`,\r\n      // `${originalPrefix}] [${prefix}`,\r\n      _type,\r\n      ignoreDebugReset,\r\n      // originalStyle || LOGGER_STYLES.reset\r\n      originalStyle\r\n      // LOGGER_STYLES.reset\r\n    );\r\n  };\r\n\r\n  return log;\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport DEBUG from '../../config/debug';\r\nimport tabId from '../../config/tabId';\r\nimport ctx from '../../environment/ctx';\r\nimport indexOfAndSplice from '../../helpers/array/indexOfAndSplice';\r\nimport {IS_WORKER} from '../../helpers/context';\r\nimport EventListenerBase from '../../helpers/eventListenerBase';\r\nimport makeError from '../../helpers/makeError';\r\nimport {Awaited, WorkerTaskTemplate, WorkerTaskVoidTemplate} from '../../types';\r\nimport {logger} from '../logger';\r\n\r\ntype SuperMessagePortTask = WorkerTaskTemplate & {\r\n  transfer?: Transferable[]\r\n};\r\n\r\ninterface InvokeTask extends SuperMessagePortTask {\r\n  type: 'invoke',\r\n  payload: WorkerTaskVoidTemplate & {withAck?: boolean, void?: boolean}\r\n}\r\n\r\ninterface ResultTask extends SuperMessagePortTask {\r\n  type: 'result',\r\n  payload: {\r\n    taskId: number,\r\n    result?: any,\r\n    error?: any\r\n  }\r\n}\r\n\r\ninterface AckTask extends SuperMessagePortTask {\r\n  type: 'ack',\r\n  payload: {\r\n    cached: boolean,\r\n    taskId: number\r\n    result?: any,\r\n    error?: any,\r\n  }\r\n}\r\n\r\ninterface PingTask extends SuperMessagePortTask {\r\n  type: 'ping'\r\n}\r\n\r\ninterface PongTask extends SuperMessagePortTask {\r\n  type: 'pong'\r\n}\r\n\r\ninterface BatchTask extends SuperMessagePortTask {\r\n  type: 'batch',\r\n  payload: Task[]\r\n}\r\n\r\ninterface CloseTask extends SuperMessagePortTask {\r\n  type: 'close'\r\n}\r\n\r\n// interface OpenTask extends SuperMessagePortTask {\r\n//   type: 'open'\r\n// }\r\n\r\ninterface LockTask extends SuperMessagePortTask {\r\n  type: 'lock',\r\n  payload: string\r\n}\r\n\r\ntype Task = InvokeTask | ResultTask | AckTask | PingTask | PongTask | BatchTask | CloseTask/*  | OpenTask */ | LockTask;\r\ntype TaskMap = {\r\n  [type in Task as type['type']]?: (task: Extract<Task, type>, source: MessageEventSource, event: MessageEvent<any>) => void | Promise<any>\r\n};\r\n\r\nexport type AckedResult<T> = {\r\n  cached: boolean,\r\n  result: Promise<T>\r\n};\r\n// export type AckedResult<T> = {\r\n//   cached: true,\r\n//   result: T\r\n// } | {\r\n//   cached: false,\r\n//   result: Promise<T>\r\n// };\r\n\r\ntype ListenPort = WindowProxy | MessagePort | ServiceWorker | Worker | ServiceWorkerContainer;\r\ntype SendPort = Pick<MessageEventSource, 'postMessage'>/* WindowProxy | MessagePort | ServiceWorker | Worker */;\r\n\r\nexport type MessageListenPort = ListenPort;\r\nexport type MessageSendPort = SendPort;\r\n\r\ntype ListenerCallback = (payload: any, source: MessageEventSource, event: MessageEvent<any>) => any;\r\ntype Listeners = Record<string, ListenerCallback>;\r\n\r\nconst USE_LOCKS = true;\r\nconst USE_BATCHING = true;\r\n\r\n// const PING_INTERVAL = DEBUG && false ? 0x7FFFFFFF : 5000;\r\n// const PING_TIMEOUT = DEBUG && false ? 0x7FFFFFFF : 10000;\r\n\r\nexport default class SuperMessagePort<\r\n  Workers extends Listeners,\r\n  Masters extends Listeners,\r\n  IsMaster extends boolean,\r\n  Receive extends Listeners = IsMaster extends true ? Masters : Workers,\r\n  Send extends Listeners = IsMaster extends true ? Workers : Masters\r\n> extends EventListenerBase<Receive> {\r\n  protected listenPorts: Array<ListenPort>;\r\n  protected sendPorts: Array<SendPort>;\r\n  protected pingResolves: Map<SendPort, () => void>;\r\n\r\n  protected taskId: number;\r\n  protected awaiting: {\r\n    [id: number]: {\r\n      resolve: any,\r\n      reject: any,\r\n      taskType: string,\r\n      port?: SendPort\r\n    }\r\n  };\r\n  protected pending: Map<SendPort, Task[]>;\r\n\r\n  protected log: ReturnType<typeof logger>;\r\n  protected debug: boolean;\r\n  protected releasingPending: boolean;\r\n\r\n  protected processTaskMap: TaskMap;\r\n\r\n  protected onPortDisconnect: (source: MessageEventSource) => void;\r\n  // protected onPortConnect: (source: MessageEventSource) => void;\r\n\r\n  protected heldLocks: Map<SendPort, {resolve: () => void, id: string}>;\r\n  protected requestedLocks: Map<string, SendPort>;\r\n\r\n  constructor(protected logSuffix?: string) {\r\n    super(false);\r\n\r\n    this.listenPorts = [];\r\n    this.sendPorts = [];\r\n    this.pingResolves = new Map();\r\n    this.taskId = 0;\r\n    this.awaiting = {};\r\n    this.pending = new Map();\r\n    this.log = logger('MP' + (logSuffix ? '-' + logSuffix : ''));\r\n    this.debug = DEBUG;\r\n    this.heldLocks = new Map();\r\n    this.requestedLocks = new Map();\r\n\r\n    this.processTaskMap = {\r\n      result: this.processResultTask,\r\n      ack: this.processAckTask,\r\n      invoke: this.processInvokeTask,\r\n      ping: this.processPingTask,\r\n      pong: this.processPongTask,\r\n      close: this.processCloseTask,\r\n      // open: this.processOpenTask,\r\n      lock: this.processLockTask,\r\n      batch: this.processBatchTask\r\n    };\r\n  }\r\n\r\n  public setOnPortDisconnect(callback: (source: MessageEventSource) => void) {\r\n    this.onPortDisconnect = callback;\r\n  }\r\n\r\n  // public setOnPortConnect(callback: (source: MessageEventSource) => void) {\r\n  //   this.onPortConnect = callback;\r\n  // }\r\n\r\n  public attachPort(port: MessageEventSource) {\r\n    this.attachListenPort(port);\r\n    this.attachSendPort(port);\r\n  }\r\n\r\n  public attachListenPort(port: ListenPort) {\r\n    this.listenPorts.push(port);\r\n    port.addEventListener('message', this.onMessage as any);\r\n  }\r\n\r\n  public attachSendPort(port: SendPort) {\r\n    this.log.warn('attaching send port');\r\n\r\n    (port as MessagePort).start?.();\r\n\r\n    this.sendPorts.push(port);\r\n    // this.sendPing(port);\r\n\r\n    // const task = this.createTask('open', undefined);\r\n    // this.postMessage(port, task);\r\n\r\n    if(typeof(window) !== 'undefined' && USE_LOCKS) {\r\n      if('locks' in navigator) {\r\n        const id = ['lock', tabId, this.logSuffix || '', Math.random() * 0x7FFFFFFF | 0].join('-');\r\n        this.log.warn('created lock', id);\r\n        const promise = new Promise<void>((resolve) => this.heldLocks.set(port, {resolve, id}))\r\n        .then(() => this.heldLocks.delete(port));\r\n        navigator.locks.request(id, () => {\r\n          this.resendLockTask(port);\r\n          return promise;\r\n        });\r\n      } else {\r\n        window.addEventListener('beforeunload', () => {\r\n          const task = this.createTask('close', undefined);\r\n          this.postMessage(undefined, task);\r\n        });\r\n      }\r\n    }\r\n\r\n    this.releasePending();\r\n  }\r\n\r\n  public resendLockTask(port: SendPort) {\r\n    const lock = this.heldLocks.get(port);\r\n    if(!lock) {\r\n      return;\r\n    }\r\n\r\n    this.pushTask(this.createTask('lock', lock.id), port);\r\n  }\r\n\r\n  // ! Can't rely on ping because timers can be suspended\r\n  // protected sendPing(port: SendPort, loop = IS_WORKER) {\r\n  //   let timeout: number;\r\n  //   const promise = new Promise<void>((resolve, reject) => {\r\n  //     this.pingResolves.set(port, resolve);\r\n  //     this.pushTask(this.createTask('ping', undefined), port);\r\n\r\n  //     timeout = ctx.setTimeout(() => {\r\n  //       reject();\r\n  //     }, PING_TIMEOUT);\r\n  //   });\r\n\r\n  //   promise.then(() => {\r\n  //     // this.log('got pong');\r\n\r\n  //     clearTimeout(timeout);\r\n  //     this.pingResolves.delete(port);\r\n\r\n  //     if(loop) {\r\n  //       this.sendPingWithTimeout(port);\r\n  //     }\r\n  //   }, () => {\r\n  //     this.pingResolves.delete(port);\r\n  //     this.detachPort(port);\r\n  //   });\r\n  // }\r\n\r\n  // protected sendPingWithTimeout(port: SendPort, timeout = PING_INTERVAL) {\r\n  //   ctx.setTimeout(() => {\r\n  //     if(!this.sendPorts.includes(port)) {\r\n  //       return;\r\n  //     }\r\n\r\n  //     this.sendPing(port);\r\n  //   }, timeout);\r\n  // }\r\n\r\n  public detachPort(port: ListenPort) {\r\n    this.log.warn('disconnecting port');\r\n\r\n    indexOfAndSplice(this.listenPorts, port);\r\n    indexOfAndSplice(this.sendPorts, port as any);\r\n\r\n    port.removeEventListener?.('message', this.onMessage as any);\r\n    (port as MessagePort).close?.();\r\n\r\n    this.onPortDisconnect?.(port as any);\r\n\r\n    const heldLock = this.heldLocks.get(port as SendPort);\r\n    heldLock?.resolve();\r\n\r\n    const error = makeError('PORT_DISCONNECTED');\r\n    for(const id in this.awaiting) {\r\n      const task = this.awaiting[id];\r\n      if(task.port === port) {\r\n        task.reject(error);\r\n        delete this.awaiting[id];\r\n      }\r\n    }\r\n  }\r\n\r\n  protected postMessage(port: SendPort | SendPort[], task: Task) {\r\n    const ports = Array.isArray(port) ? port : (port ? [port] : this.sendPorts);\r\n    ports.forEach((port) => {\r\n      if(import.meta.env.MODE === 'test') {\r\n        return;\r\n      }\r\n\r\n      port.postMessage(task, task.transfer as any);\r\n    });\r\n  }\r\n\r\n  protected onMessage = (event: MessageEvent) => {\r\n    const task: Task = event.data;\r\n    // this.log('got message', task);\r\n\r\n    const source: MessageEventSource = event.source || event.currentTarget as any; // can have no source\r\n\r\n    // @ts-ignore\r\n    this.processTaskMap[task.type](task, source, event);\r\n  };\r\n\r\n  protected async releasePending() {\r\n    // return;\r\n\r\n    if(/* !this.listenPorts.length || !this.sendPorts.length ||  */this.releasingPending) {\r\n      return;\r\n    }\r\n\r\n    this.releasingPending = true;\r\n    // const perf = performance.now();\r\n\r\n    if(USE_BATCHING) {\r\n      await Promise.resolve();\r\n    }\r\n    // await pause(0);\r\n\r\n    this.debug && this.log.debug('releasing tasks, length:', this.pending.size/* , performance.now() - perf */);\r\n\r\n    this.pending.forEach((portTasks, port) => {\r\n      let tasks: Task[] = portTasks;\r\n      if(USE_BATCHING) {\r\n        let batchTask: BatchTask;\r\n        tasks = [];\r\n        portTasks.forEach((task) => {\r\n          if(task.transfer) {\r\n            batchTask = undefined;\r\n            tasks.push(task);\r\n          } else {\r\n            if(!batchTask) {\r\n              batchTask = this.createTask('batch', []);\r\n              tasks.push(batchTask);\r\n            }\r\n\r\n            batchTask.payload.push(task);\r\n          }\r\n        });\r\n      }\r\n\r\n      const ports = port ? [port] : this.sendPorts;\r\n      if(!ports.length) {\r\n        return;\r\n      }\r\n\r\n      tasks.forEach((task) => {\r\n        // if(USE_BATCHING && task.type === 'batch') {\r\n        //   this.log(`batching ${task.payload.length} tasks`);\r\n        // }\r\n\r\n        try {\r\n          // if(IS_SERVICE_WORKER && !port) {\r\n          //   notifyAll(task);\r\n          // } else {\r\n          this.postMessage(ports, task);\r\n          // }\r\n        } catch(err) {\r\n          this.log.error('postMessage error:', err, task, ports);\r\n        }\r\n      });\r\n\r\n      this.pending.delete(port);\r\n    });\r\n\r\n    this.debug && this.log.debug('released tasks');\r\n\r\n    this.releasingPending = false;\r\n  }\r\n\r\n  protected processResultTask = (task: ResultTask) => {\r\n    const {taskId, result, error} = task.payload;\r\n    const deferred = this.awaiting[taskId];\r\n    if(!deferred) {\r\n      return;\r\n    }\r\n\r\n    this.debug && this.log.debug('done', deferred.taskType, result, error);\r\n    'error' in task.payload ? deferred.reject(error) : deferred.resolve(result);\r\n    delete this.awaiting[taskId];\r\n  };\r\n\r\n  protected processAckTask = (task: AckTask) => {\r\n    const payload = task.payload;\r\n    const deferred = this.awaiting[payload.taskId];\r\n    if(!deferred) {\r\n      return;\r\n    }\r\n\r\n    // * will finish the init promise with incoming result\r\n    const previousResolve: (acked: AckedResult<any>) => void = deferred.resolve;\r\n    // const previousReject = deferred.reject;\r\n\r\n    // if(payload.cached) {\r\n    //   if('result' in payload) {\r\n    //     previousResolve({\r\n    //       cached: true,\r\n    //       result: payload.result\r\n    //     });\r\n    //   } else {\r\n    //     previousReject(payload.error);\r\n    //   }\r\n    // } else {\r\n    //   const ret: AckedResult<any> = {\r\n    //     cached: false,\r\n    //     result: new Promise((resolve, reject) => {\r\n    //       deferred.resolve = resolve;\r\n    //       deferred.reject = reject;\r\n    //     })\r\n    //   };\r\n\r\n    //   previousResolve(ret);\r\n    // }\r\n\r\n    const ret: AckedResult<any> = {\r\n      cached: payload.cached,\r\n      result: payload.cached ? ('result' in payload ? Promise.resolve(payload.result) : Promise.reject(payload.error)) : new Promise((resolve, reject) => {\r\n        deferred.resolve = resolve;\r\n        deferred.reject = reject;\r\n      })\r\n    };\r\n\r\n    previousResolve(ret);\r\n\r\n    if(payload.cached) {\r\n      delete this.awaiting[payload.taskId];\r\n    }\r\n  };\r\n\r\n  protected processPingTask = (task: PingTask, source: MessageEventSource, event: MessageEvent) => {\r\n    this.pushTask(this.createTask('pong', undefined), event.source);\r\n  };\r\n\r\n  protected processPongTask = (task: PongTask, source: MessageEventSource, event: MessageEvent) => {\r\n    const pingResolve = this.pingResolves.get(source);\r\n    if(pingResolve) {\r\n      this.pingResolves.delete(source);\r\n      pingResolve();\r\n    }\r\n  };\r\n\r\n  protected processCloseTask = (task: CloseTask, source: MessageEventSource, event: MessageEvent) => {\r\n    this.detachPort(source);\r\n  };\r\n\r\n  protected processBatchTask = (task: BatchTask, source: MessageEventSource, event: MessageEvent) => {\r\n    if(!USE_BATCHING) {\r\n      return;\r\n    }\r\n\r\n    const newEvent: MessageEvent = {data: event.data, source: event.source, currentTarget: event.currentTarget} as any;\r\n    task.payload.forEach((task) => {\r\n      // @ts-ignore\r\n      newEvent.data = task;\r\n      this.onMessage(newEvent);\r\n    });\r\n  };\r\n\r\n  // * it's just an 'open' callback, DO NOT attach port from here\r\n  // protected processOpenTask = (task: OpenTask, source: MessageEventSource, event: MessageEvent) => {\r\n  //   this.onPortConnect?.(source);\r\n  // };\r\n\r\n  protected processLockTask = (task: LockTask, source: MessageEventSource, event: MessageEvent) => {\r\n    const id = task.payload;\r\n    if(this.requestedLocks.has(id)) {\r\n      return;\r\n    }\r\n\r\n    this.requestedLocks.set(id, source);\r\n    navigator.locks.request(id, () => {\r\n      this.processCloseTask(undefined, source, undefined);\r\n      this.requestedLocks.delete(id);\r\n    });\r\n  };\r\n\r\n  protected processInvokeTask = async(task: InvokeTask, source: MessageEventSource, event: MessageEvent) => {\r\n    const id = task.id;\r\n    const innerTask = task.payload;\r\n\r\n    let resultTaskPayload: ResultTask['payload'];\r\n    let resultTask: ResultTask, ackTask: AckTask;\r\n    if(!innerTask.void) {\r\n      resultTaskPayload = {taskId: id};\r\n      resultTask = this.createTask('result', resultTaskPayload);\r\n    }\r\n\r\n    if(innerTask.withAck) {\r\n      ackTask = this.createTask('ack', {\r\n        taskId: id,\r\n        cached: true\r\n      });\r\n    }\r\n\r\n    let isPromise: boolean;\r\n    try {\r\n      const listeners = this.listeners[innerTask.type];\r\n      if(!listeners?.size) {\r\n        throw new Error('no listener');\r\n      }\r\n\r\n      const listener = listeners.values().next().value;\r\n\r\n      // @ts-ignore\r\n      let result = this.invokeListenerCallback(innerTask.type, listener, innerTask.payload, source, event);\r\n      if(innerTask.void) {\r\n        return;\r\n      }\r\n\r\n      isPromise = result instanceof Promise;\r\n\r\n      if(ackTask) {\r\n        const cached = !isPromise;\r\n        ackTask.payload.cached = cached;\r\n        if(cached) ackTask.payload.result = result;\r\n        this.pushTask(ackTask, source);\r\n\r\n        if(cached) {\r\n          return;\r\n        }\r\n      }\r\n\r\n      if(isPromise) {\r\n        result = await result;\r\n      }\r\n\r\n      resultTaskPayload.result = result;\r\n    } catch(error) {\r\n      this.log.error('worker task error:', error, task);\r\n      if(innerTask.void) {\r\n        return;\r\n      }\r\n\r\n      if(ackTask && ackTask.payload.cached) {\r\n        ackTask.payload.error = error;\r\n        this.pushTask(ackTask, source);\r\n        return;\r\n      }\r\n\r\n      resultTaskPayload.error = error;\r\n    }\r\n\r\n    this.pushTask(resultTask, source);\r\n  };\r\n\r\n  protected createTask<T extends Task['type'], K extends Task = Parameters<TaskMap[T]>[0]>(type: T, payload: K['payload'], transfer?: Transferable[]): K {\r\n    return {\r\n      type,\r\n      payload,\r\n      id: this.taskId++,\r\n      transfer\r\n    } as K;\r\n  }\r\n\r\n  protected createInvokeTask(type: string, payload: any, withAck?: boolean, _void?: boolean, transfer?: Transferable[]): InvokeTask {\r\n    return this.createTask('invoke', {\r\n      type,\r\n      payload,\r\n      withAck,\r\n      void: _void\r\n    }, transfer);\r\n  }\r\n\r\n  protected pushTask(task: Task, port?: SendPort) {\r\n    let tasks = this.pending.get(port);\r\n    if(!tasks) {\r\n      this.pending.set(port, tasks = []);\r\n    }\r\n\r\n    tasks.push(task);\r\n    this.releasePending();\r\n  }\r\n\r\n  public invokeVoid<T extends keyof Send>(type: T, payload: Parameters<Send[T]>[0], port?: SendPort, transfer?: Transferable[]) {\r\n    const task = this.createInvokeTask(type as string, payload, undefined, true, transfer);\r\n    this.pushTask(task, port);\r\n  }\r\n\r\n  public invoke<T extends keyof Send>(type: T, payload: Parameters<Send[T]>[0], withAck?: false, port?: SendPort, transfer?: Transferable[]): Promise<Awaited<ReturnType<Send[T]>>>;\r\n  public invoke<T extends keyof Send>(type: T, payload: Parameters<Send[T]>[0], withAck?: true, port?: SendPort, transfer?: Transferable[]): Promise<AckedResult<Awaited<ReturnType<Send[T]>>>>;\r\n  public invoke<T extends keyof Send>(type: T, payload: Parameters<Send[T]>[0], withAck?: boolean, port?: SendPort, transfer?: Transferable[]) {\r\n    this.debug && this.log.debug('start', type, payload);\r\n\r\n    let task: InvokeTask;\r\n    const promise = new Promise<Awaited<ReturnType<Send[T]>>>((resolve, reject) => {\r\n      task = this.createInvokeTask(type as string, payload, withAck, undefined, transfer);\r\n      this.awaiting[task.id] = {resolve, reject, taskType: type as string, port};\r\n      this.pushTask(task, port);\r\n    });\r\n\r\n    if(IS_WORKER) {\r\n      promise.finally(() => {\r\n        clearInterval(interval);\r\n      });\r\n\r\n      const interval = ctx.setInterval(() => {\r\n        this.log.error('task still has no result', task, port);\r\n      }, 60e3);\r\n    } else if(false) {\r\n      // let timedOut = false;\r\n      const startTime = Date.now();\r\n      promise.finally(() => {\r\n        const elapsedTime = Date.now() - startTime;\r\n        if(elapsedTime >= TIMEOUT) {\r\n          this.log.error(`task was processing ${Date.now() - startTime}ms`, task.payload.payload, port);\r\n        }/*  else {\r\n          clearTimeout(timeout);\r\n        } */\r\n      });\r\n\r\n      const TIMEOUT = 10;\r\n      // const timeout = ctx.setTimeout(() => {\r\n      //   timedOut = true;\r\n      //   // this.log.error(`task is processing more than ${TIMEOUT} milliseconds`, task, port);\r\n      // }, TIMEOUT);\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public invokeExceptSource<T extends keyof Send>(type: T, payload: Parameters<Send[T]>[0], source?: SendPort) {\r\n    const ports = this.sendPorts.slice();\r\n    indexOfAndSplice(ports, source);\r\n\r\n    ports.forEach((target) => {\r\n      this.invokeVoid(type, payload, target);\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport type {getEnvironment} from '../../environment/utils';\r\nimport type loadState from '../appManagers/utils/state/loadState';\r\nimport type {StoragesResults} from '../appManagers/utils/storages/loadStorages';\r\nimport type {LocalStorageProxyTask} from '../localStorage';\r\nimport type {Awaited} from '../../types';\r\nimport type {Mirrors, MirrorTaskPayload, NotificationBuildTaskPayload, TabState} from './mtprotoworker';\r\nimport type toggleStorages from '../../helpers/toggleStorages';\r\nimport SuperMessagePort from './superMessagePort';\r\n\r\nexport type MTProtoManagerTaskPayload = {name: string, method: string, args: any[]};\r\n\r\ntype MTProtoBroadcastEvent = {\r\n  event: (payload: {name: string, args: any[]}, source: MessageEventSource) => void\r\n};\r\n\r\nexport default class MTProtoMessagePort<Master extends boolean = true> extends SuperMessagePort<{\r\n  environment: (environment: ReturnType<typeof getEnvironment>) => void,\r\n  crypto: (payload: {method: string, args: any[]}) => Promise<any>,\r\n  state: (payload: {userId: UserId} & Awaited<ReturnType<typeof loadState>> & {storagesResults?: StoragesResults}) => void,\r\n  manager: (payload: MTProtoManagerTaskPayload) => any,\r\n  toggleStorages: (payload: {enabled: boolean, clearWrite: boolean}) => ReturnType<typeof toggleStorages>,\r\n  serviceWorkerOnline: (online: boolean) => void,\r\n  serviceWorkerPort: (payload: void, source: MessageEventSource, event: MessageEvent) => void,\r\n  cryptoPort: (payload: void, source: MessageEventSource, event: MessageEvent) => void,\r\n  createObjectURL: (blob: Blob) => string,\r\n  tabState: (payload: TabState, source: MessageEventSource) => void,\r\n  createProxyWorkerURLs: (payload: {originalUrl: string, blob: Blob}) => string[],\r\n} & MTProtoBroadcastEvent, {\r\n  convertWebp: (payload: {fileName: string, bytes: Uint8Array}) => Promise<Uint8Array>,\r\n  convertOpus: (payload: {fileName: string, bytes: Uint8Array}) => Promise<Uint8Array>,\r\n  localStorageProxy: (payload: LocalStorageProxyTask['payload']) => Promise<any>,\r\n  mirror: (payload: MirrorTaskPayload) => void,\r\n  notificationBuild: (payload: NotificationBuildTaskPayload) => void,\r\n  receivedServiceMessagePort: (payload: void) => void,\r\n  // hello: () => void\r\n} & MTProtoBroadcastEvent, Master> {\r\n  private static INSTANCE: MTProtoMessagePort;\r\n\r\n  constructor() {\r\n    super('MTPROTO');\r\n\r\n    MTProtoMessagePort.INSTANCE = this;\r\n\r\n    MOUNT_CLASS_TO && (MOUNT_CLASS_TO.mtprotoMessagePort = this);\r\n  }\r\n\r\n  public static getInstance<Master extends boolean>() {\r\n    return this.INSTANCE as MTProtoMessagePort<Master>;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {Message, StickerSet, Update, NotifyPeer, PeerNotifySettings, PollResults, Poll, WebPage, GroupCall, GroupCallParticipant, ReactionCount, MessagePeerReaction, PhoneCall, Config, Reaction, AttachMenuBot, PeerSettings, StoryItem, PeerStories, SavedDialog, SavedReactionTag} from '../layer';\r\nimport type {Dialog, ForumTopic, MessagesStorageKey, MyMessage} from './appManagers/appMessagesManager';\r\nimport type {MyDialogFilter} from './storages/filters';\r\nimport type {AnyDialog, Folder} from './storages/dialogs';\r\nimport type {UserTyping} from './appManagers/appProfileManager';\r\nimport type {MyDraftMessage} from './appManagers/appDraftsManager';\r\nimport type {ConnectionStatusChange} from './mtproto/connectionStatus';\r\nimport type {GroupCallId} from './appManagers/appGroupCallsManager';\r\nimport type {AppManagers} from './appManagers/managers';\r\nimport type {State} from '../config/state';\r\nimport type {Progress} from './appManagers/appDownloadManager';\r\nimport type {CallId} from './appManagers/appCallsManager';\r\nimport type {MyDocument} from './appManagers/appDocsManager';\r\nimport type {MTAppConfig} from './mtproto/appConfig';\r\nimport type StoriesCacheType from './appManagers/utils/stories/cacheType';\r\nimport type {StoriesListPosition} from './appManagers/appStoriesManager';\r\nimport {NULL_PEER_ID, UserAuth} from './mtproto/mtproto_config';\r\nimport EventListenerBase from '../helpers/eventListenerBase';\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport MTProtoMessagePort from './mtproto/mtprotoMessagePort';\r\nimport {IS_WORKER} from '../helpers/context';\r\nimport {RtmpCallInstance} from './calls/rtmpCallsController';\r\n\r\nexport type BroadcastEvents = {\r\n  'chat_full_update': ChatId,\r\n  'chat_update': ChatId,\r\n  'chat_toggle_forum': {chatId: ChatId, enabled: boolean},\r\n  'chat_participant': Update.updateChannelParticipant,\r\n  'chat_participation': {chatId: ChatId, left: boolean},\r\n  'chat_requests': {requestsPending: number, recentRequesters: UserId[], chatId: ChatId}\r\n\r\n  'channel_update': ChatId,\r\n\r\n  'user_update': UserId,\r\n  'user_auth': UserAuth,\r\n  'user_full_update': UserId,\r\n\r\n  'attach_menu_bot': AttachMenuBot,\r\n\r\n  'emoji_status_change': void,\r\n\r\n  'peer_pinned_messages': {peerId: PeerId, mids?: number[], pinned?: boolean, unpinAll?: true},\r\n  'peer_pinned_hidden': {peerId: PeerId, maxId: number},\r\n  'peer_typings': {peerId: PeerId, threadId?: number, typings: UserTyping[]},\r\n  'peer_block': {peerId: PeerId, blocked?: boolean, blockedMyStoriesFrom?: boolean},\r\n  'peer_title_edit': {peerId: PeerId, threadId?: number},\r\n  'peer_bio_edit': PeerId,\r\n  'peer_deleted': PeerId, // left chat, deleted user dialog, left channel\r\n  'peer_full_update': PeerId,\r\n  'peer_settings': {peerId: PeerId, settings: PeerSettings},\r\n  'peer_stories': {peerId: PeerId, available: boolean},\r\n  'peer_stories_hidden': {peerId: PeerId, hidden: boolean},\r\n\r\n  'filter_delete': MyDialogFilter,\r\n  'filter_update': MyDialogFilter,\r\n  'filter_new': MyDialogFilter,\r\n  'filter_order': number[],\r\n  'filter_joined': MyDialogFilter,\r\n\r\n  'folder_unread': Omit<Folder, 'dialogs' | 'dispatchUnreadTimeout'>,\r\n\r\n  'dialog_draft': {peerId: PeerId, dialog: Dialog | ForumTopic, drop: boolean, draft: MyDraftMessage | undefined},\r\n  'dialog_unread': {peerId: PeerId, dialog: Dialog | ForumTopic},\r\n  'dialog_flush': {peerId: PeerId, dialog: Dialog},\r\n  'dialog_drop': AnyDialog,\r\n  'dialog_migrate': {migrateFrom: PeerId, migrateTo: PeerId},\r\n  // 'dialog_top': Dialog,\r\n  'dialog_notify_settings': Dialog | ForumTopic,\r\n  // 'dialog_order': {dialog: Dialog, pos: number},\r\n  'dialogs_multiupdate': Map<PeerId, {dialog?: Dialog, topics?: Map<number, ForumTopic>, saved?: Map<PeerId, SavedDialog>}>,\r\n\r\n  'history_append': {storageKey: MessagesStorageKey, message: Message.message},\r\n  'history_update': {storageKey: MessagesStorageKey, message: MyMessage, sequential?: boolean},\r\n  'history_reply_markup': {peerId: PeerId},\r\n  'history_multiappend': MyMessage,\r\n  // 'history_delete': {peerId: PeerId, msgs: Map<number, {savedPeerId?: PeerId}>},\r\n  'history_delete': {peerId: PeerId, msgs: Set<number>},\r\n  'history_forbidden': PeerId,\r\n  'history_reload': PeerId,\r\n  'history_count': {historyKey: string, count: number},\r\n  'history_delete_key': {historyKey: string, mid: number},\r\n  // 'history_request': void,\r\n\r\n  'message_edit': {storageKey: MessagesStorageKey, peerId: PeerId, mid: number, message: MyMessage},\r\n  'message_sent': {storageKey: MessagesStorageKey, tempId: number, tempMessage: any, mid: number, message: MyMessage},\r\n  'message_error': {storageKey: MessagesStorageKey, peerId: PeerId, tempId: number, error: ApiError},\r\n  'message_transcribed': {peerId: PeerId, mid: number, text: string, pending?: boolean},\r\n  'messages_views': {peerId: PeerId, mid: number, views: number}[],\r\n  'messages_reactions': {message: Message.message, changedResults: ReactionCount[], removedResults: ReactionCount[]}[],\r\n  'messages_pending': void,\r\n  'messages_read': void,\r\n  'messages_downloaded': {peerId: PeerId, mids: number[]},\r\n  'messages_media_read': {peerId: PeerId, mids: number[]},\r\n\r\n  'story_update': {peerId: PeerId, story: StoryItem, modifiedPinned?: boolean, modifiedArchive?: boolean, modifiedPinnedToTop?: boolean},\r\n  'story_deleted': {peerId: PeerId, id: number},\r\n  'story_expired': {peerId: PeerId, id: number},\r\n  'story_new': {peerId: PeerId, story: StoryItem, cacheType: StoriesCacheType, maxReadId: number},\r\n  'stories_stories': PeerStories,\r\n  'stories_read': {peerId: PeerId, maxReadId: number},\r\n  'stories_downloaded': {peerId: PeerId, ids: number[]},\r\n  'stories_position': {peerId: PeerId, position: StoriesListPosition},\r\n\r\n  'replies_updated': Message.message,\r\n  'replies_short_update': Message.message,\r\n\r\n  'scheduled_new': Message.message,\r\n  'scheduled_delete': {peerId: PeerId, mids: number[]},\r\n\r\n  'grouped_edit': {peerId: PeerId, groupedId: string, deletedMids: number[], messages: Message.message[]},\r\n\r\n  'stickers_installed': StickerSet.stickerSet,\r\n  'stickers_deleted': StickerSet.stickerSet,\r\n  'stickers_updated': {type: 'recent' | 'faved', stickers: MyDocument[]},\r\n  'stickers_top': Long,\r\n  'stickers_order': {type: 'masks' | 'emojis' | 'stickers', order: Long[]},\r\n  'sticker_updated': {type: 'recent' | 'faved', document: MyDocument, faved: boolean},\r\n\r\n  'gifs_updated': MyDocument[],\r\n  'gif_updated': {document: MyDocument, saved: boolean},\r\n\r\n  'state_cleared': void,\r\n  'state_synchronized': void,\r\n  'state_synchronizing': void,\r\n\r\n  'contacts_update': UserId,\r\n  'avatar_update': {peerId: PeerId, threadId?: number},\r\n  'poll_update': {poll: Poll, results: PollResults},\r\n  'invalidate_participants': ChatId,\r\n  // 'channel_settings': {channelId: number},\r\n  'webpage_updated': {id: WebPage.webPage['id'], msgs: {peerId: PeerId, mid: number, isScheduled: boolean}[]},\r\n\r\n  'connection_status_change': ConnectionStatusChange,\r\n  'settings_updated': {key: string, value: any, settings: State['settings']},\r\n  'draft_updated': {peerId: PeerId, threadId: number, draft: MyDraftMessage | undefined, force?: boolean},\r\n\r\n  'background_change': void,\r\n\r\n  'privacy_update': Update.updatePrivacy,\r\n\r\n  'notify_settings': Update.updateNotifySettings,\r\n  'notify_peer_type_settings': {key: Exclude<NotifyPeer['_'], 'notifyPeer'>, settings: PeerNotifySettings},\r\n\r\n  'notification_reset': string,\r\n  'notification_cancel': string,\r\n\r\n  'language_change': string,\r\n\r\n  'theme_change': {x: number, y: number} | void,\r\n  'theme_changed': void,\r\n\r\n  'media_play': void,\r\n\r\n  'emoji_recent': {emoji: AppEmoji, deleted?: boolean},\r\n\r\n  'download_progress': Progress,\r\n  'document_downloading': DocId,\r\n  'document_downloaded': DocId,\r\n\r\n  'choosing_sticker': boolean\r\n\r\n  'group_call_update': GroupCall,\r\n  'group_call_participant': {groupCallId: GroupCallId, participant: GroupCallParticipant},\r\n  // 'group_call_video_track_added': {instance: GroupCallInstance}\r\n\r\n  'call_update': PhoneCall,\r\n  'call_signaling': {callId: CallId, data: Uint8Array},\r\n\r\n  'rtmp_call_update': RtmpCallInstance,\r\n\r\n  'quick_reaction': Reaction,\r\n\r\n  'service_notification': Update.updateServiceNotification,\r\n\r\n  'logging_out': void,\r\n\r\n  'payment_sent': {peerId: PeerId, mid: number, receiptMessage: Message.messageService},\r\n\r\n  'web_view_result_sent': Long,\r\n\r\n  'premium_toggle': boolean,\r\n  'premium_toggle_private': {isNew: boolean, isPremium: boolean},\r\n\r\n  'saved_tags': {savedPeerId: PeerId, tags: SavedReactionTag[]},\r\n  'saved_tags_clear': void,\r\n\r\n  'stars_balance': Long,\r\n\r\n  'file_speed_limited': {increaseTimes: number, isUpload: boolean},\r\n\r\n  'config': Config,\r\n  'app_config': MTAppConfig,\r\n  'managers_ready': void // ! inner\r\n};\r\n\r\nexport type BroadcastEventsListeners = {\r\n  [name in keyof BroadcastEvents]: (e: BroadcastEvents[name]) => void\r\n};\r\n\r\nexport class RootScope extends EventListenerBase<BroadcastEventsListeners> {\r\n  public myId: PeerId;\r\n  private connectionStatus: {[name: string]: ConnectionStatusChange};\r\n  public settings: State['settings'];\r\n  public managers: AppManagers;\r\n  public premium: boolean;\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    this.myId = NULL_PEER_ID;\r\n    this.connectionStatus = {};\r\n    this.premium = false;\r\n\r\n    this.addEventListener('user_auth', ({id}) => {\r\n      this.myId = id.toPeerId();\r\n    });\r\n\r\n    this.addEventListener('premium_toggle_private', ({isNew, isPremium}) => {\r\n      this.premium = isPremium;\r\n      if(!isNew) { // * only on change\r\n        this.dispatchEventSingle('premium_toggle', isPremium);\r\n      }\r\n    });\r\n\r\n    this.addEventListener('connection_status_change', (status) => {\r\n      this.connectionStatus[status.name] = status;\r\n    });\r\n\r\n    this.dispatchEvent = (e, ...args) => {\r\n      super.dispatchEvent(e, ...args);\r\n      MTProtoMessagePort.getInstance().invokeVoid('event', {name: e as string, args});\r\n    };\r\n\r\n    if(!IS_WORKER) {\r\n      this.addEventListener('settings_updated', ({settings}) => {\r\n        this.settings = settings;\r\n      });\r\n    }\r\n  }\r\n\r\n  public getConnectionStatus() {\r\n    return this.connectionStatus;\r\n  }\r\n\r\n  public getPremium() {\r\n    return this.premium;\r\n  }\r\n\r\n  public dispatchEventSingle(...args: any[]) {\r\n    // @ts-ignore\r\n    super.dispatchEvent(...args);\r\n  }\r\n}\r\n\r\nconst rootScope = new RootScope();\r\nMOUNT_CLASS_TO.rootScope = rootScope;\r\nexport default rootScope;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport noop from './noop';\r\n\r\nexport interface CancellablePromise<T> extends Promise<T> {\r\n  resolve?: (value: T) => void,\r\n  reject?: (...args: any[]) => void,\r\n  cancel?: (reason?: any) => void,\r\n\r\n  notify?: (...args: any[]) => void,\r\n  notifyAll?: (...args: any[]) => void,\r\n  lastNotify?: any,\r\n  listeners?: Array<(...args: any[]) => void>,\r\n  addNotifyListener?: (callback: (...args: any[]) => void) => void,\r\n\r\n  isFulfilled?: boolean,\r\n  isRejected?: boolean,\r\n\r\n  onFinish?: () => void,\r\n  _resolve?: (value: T) => void,\r\n  _reject?: (...args: any[]) => void\r\n}\r\n\r\nconst deferredHelper = {\r\n  isFulfilled: false,\r\n  isRejected: false,\r\n\r\n  notify: () => {},\r\n  notifyAll: function(...args: any[]) {\r\n    this.lastNotify = args;\r\n    this.listeners?.forEach((callback: any) => callback(...args));\r\n  },\r\n\r\n  addNotifyListener: function(callback: (...args: any[]) => void) {\r\n    if(this.lastNotify) {\r\n      callback(...this.lastNotify);\r\n    }\r\n\r\n    (this.listeners ??= []).push(callback);\r\n  },\r\n\r\n  resolve: function(value) {\r\n    if(this.isFulfilled || this.isRejected) return;\r\n\r\n    this.isFulfilled = true;\r\n    this._resolve(value);\r\n    this.onFinish();\r\n  },\r\n\r\n  reject: function(...args) {\r\n    if(this.isRejected || this.isFulfilled) return;\r\n\r\n    this.isRejected = true;\r\n    this._reject(...args);\r\n    this.onFinish();\r\n  },\r\n\r\n  onFinish: function() {\r\n    this.notify = this.notifyAll = this.lastNotify = null;\r\n    if(this.listeners) this.listeners.length = 0;\r\n\r\n    if(this.cancel) {\r\n      this.cancel = noop;\r\n    }\r\n  }\r\n} as CancellablePromise<any>;\r\n\r\nexport default function deferredPromise<T>() {\r\n  let resolve: (value: T) => void, reject: (...args: any[]) => void;\r\n  const deferred: CancellablePromise<T> = new Promise<T>((_resolve, _reject) => {\r\n    resolve = _resolve, reject = _reject;\r\n  });\r\n\r\n  Object.assign(deferred, deferredHelper);\r\n  deferred._resolve = resolve;\r\n  deferred._reject = reject;\r\n\r\n  return deferred;\r\n}\r\n\r\nexport function bindPromiseToDeferred<T>(promise: Promise<T>, deferred: CancellablePromise<T>) {\r\n  promise.then(deferred.resolve.bind(deferred), deferred.reject.bind(deferred));\r\n}\r\n\r\n(self as any).deferredPromise = deferredPromise;\r\n","// * Jolly Cobra's schedulers\r\n\r\nimport {AnyToVoidFunction} from '../../types';\r\n\r\nexport default function throttle<F extends AnyToVoidFunction>(\r\n  fn: F,\r\n  ms: number,\r\n  shouldRunFirst = true\r\n) {\r\n  let interval: number | null = null;\r\n  let isPending: boolean;\r\n  let args: Parameters<F>;\r\n\r\n  const clear = () => {\r\n    clearInterval(interval!);\r\n    interval = null;\r\n  };\r\n\r\n  const ret = (..._args: Parameters<F>) => {\r\n    isPending = true;\r\n    args = _args;\r\n\r\n    if(!interval) {\r\n      if(shouldRunFirst) {\r\n        isPending = false;\r\n        // @ts-ignore\r\n        fn(...args);\r\n      }\r\n\r\n      interval = setInterval(() => {\r\n        if(!isPending) {\r\n          clear();\r\n          return;\r\n        }\r\n\r\n        isPending = false;\r\n        // @ts-ignore\r\n        fn(...args);\r\n      }, ms) as any;\r\n    }\r\n  };\r\n\r\n  ret.clear = clear;\r\n\r\n  return ret;\r\n}\r\n","export default function safeAssign<T>(object: T, fromObject: any) {\r\n  if(fromObject) {\r\n    for(const i in fromObject) {\r\n      if(fromObject[i] !== undefined) {\r\n        // @ts-ignore\r\n        object[i] = fromObject[i];\r\n      }\r\n    }\r\n  }\r\n\r\n  return object;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport {Database} from '../../config/databases';\r\nimport Modes from '../../config/modes';\r\nimport makeError from '../../helpers/makeError';\r\nimport safeAssign from '../../helpers/object/safeAssign';\r\nimport {logger} from '../logger';\r\n\r\n/**\r\n * https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore/createIndex\r\n */\r\nexport type IDBIndex = {\r\n  indexName: string,\r\n  keyPath: string,\r\n  objectParameters: IDBIndexParameters\r\n};\r\n\r\nexport type IDBStore = {\r\n  name: string,\r\n  indexes?: IDBIndex[]\r\n};\r\n\r\nexport type IDBOptions = {\r\n  name?: string,\r\n  storeName: string,\r\n  stores?: IDBStore[],\r\n  version?: number\r\n};\r\n\r\nconst DEBUG = false;\r\n\r\nexport class IDB {\r\n  private static INSTANCES: IDB[] = [];\r\n  private openDbPromise: Promise<IDBDatabase>;\r\n  private db: IDBDatabase;\r\n  private storageIsAvailable: boolean;\r\n  private log: ReturnType<typeof logger>;\r\n  private name: string;\r\n  private version: number;\r\n  private stores: IDBStore[];\r\n\r\n  constructor(db: Database<any>) {\r\n    safeAssign(this, db);\r\n\r\n    if(Modes.test) {\r\n      this.name += '_test';\r\n    }\r\n\r\n    this.storageIsAvailable = true;\r\n    this.log = logger(['IDB', db.name].join('-'));\r\n    this.log('constructor');\r\n\r\n    this.openDatabase(true);\r\n\r\n    IDB.INSTANCES.push(this);\r\n  }\r\n\r\n  public isAvailable() {\r\n    return this.storageIsAvailable;\r\n  }\r\n\r\n  public openDatabase(createNew = false): Promise<IDBDatabase> {\r\n    if(this.openDbPromise && !createNew) {\r\n      return this.openDbPromise;\r\n    }\r\n\r\n    const createIndexes = (os: IDBObjectStore, store: IDBStore) => {\r\n      const indexNames = Array.from(os.indexNames);\r\n      for(const indexName of indexNames) {\r\n        os.deleteIndex(indexName);\r\n      }\r\n\r\n      if(!store.indexes?.length) {\r\n        return;\r\n      }\r\n\r\n      for(const index of store.indexes) {\r\n        if(os.indexNames.contains(index.indexName)) {\r\n          continue;\r\n        }\r\n\r\n        os.createIndex(index.indexName, index.keyPath, index.objectParameters);\r\n      }\r\n    };\r\n\r\n    const createObjectStore = (db: IDBDatabase, store: IDBStore) => {\r\n      const os = db.createObjectStore(store.name);\r\n      createIndexes(os, store);\r\n    };\r\n\r\n    try {\r\n      var request = indexedDB.open(this.name, this.version);\r\n\r\n      if(!request) {\r\n        return Promise.reject();\r\n      }\r\n    } catch(error) {\r\n      this.log.error('error opening db', (error as Error).message);\r\n      this.storageIsAvailable = false;\r\n      return Promise.reject(error);\r\n    }\r\n\r\n    let finished = false;\r\n    setTimeout(() => {\r\n      if(!finished) {\r\n        request.onerror(makeError('IDB_CREATE_TIMEOUT') as Event);\r\n      }\r\n    }, 3000);\r\n\r\n    return this.openDbPromise = new Promise<IDBDatabase>((resolve, reject) => {\r\n      request.onsuccess = (event) => {\r\n        finished = true;\r\n        const db = request.result;\r\n        let calledNew = false;\r\n\r\n        this.log('Opened');\r\n\r\n        db.onerror = (error) => {\r\n          this.storageIsAvailable = false;\r\n          this.log.error('Error creating/accessing IndexedDB database', error);\r\n          reject(error);\r\n        };\r\n\r\n        db.onclose = (e) => {\r\n          this.log.error('closed:', e);\r\n          !calledNew && this.openDatabase();\r\n        };\r\n\r\n        db.onabort = (e) => {\r\n          this.log.error('abort:', e);\r\n          const transaction = e.target as IDBTransaction;\r\n\r\n          this.openDatabase(calledNew = true);\r\n\r\n          if(transaction.onerror) {\r\n            transaction.onerror(e);\r\n          }\r\n\r\n          db.close();\r\n        };\r\n\r\n        db.onversionchange = (e) => {\r\n          this.log.error('onversionchange, lol?');\r\n        };\r\n\r\n        resolve(this.db = db);\r\n      };\r\n\r\n      request.onerror = (event) => {\r\n        finished = true;\r\n        this.storageIsAvailable = false;\r\n        this.log.error('Error creating/accessing IndexedDB database', event);\r\n        reject(event);\r\n      };\r\n\r\n      request.onupgradeneeded = (event) => {\r\n        finished = true;\r\n        this.log.warn('performing idb upgrade from', event.oldVersion, 'to', event.newVersion);\r\n\r\n        const target = event.target as IDBOpenDBRequest;\r\n        const db = target.result;\r\n        this.stores.forEach((store) => {\r\n          /* if(db.objectStoreNames.contains(store.name)) {\r\n            //if(event.oldVersion === 1) {\r\n              db.deleteObjectStore(store.name);\r\n            //}\r\n          } */\r\n\r\n          if(!db.objectStoreNames.contains(store.name)) {\r\n            createObjectStore(db, store);\r\n          } else {\r\n            const txn = target.transaction;\r\n            const os = txn.objectStore(store.name);\r\n            createIndexes(os, store);\r\n          }\r\n        });\r\n      };\r\n    });\r\n  }\r\n\r\n  public static create<T extends Database<any>>(db: T) {\r\n    return this.INSTANCES.find((instance) => instance.name === db.name) ?? new IDB(db);\r\n  }\r\n\r\n  public static closeDatabases(preserve?: IDB) {\r\n    this.INSTANCES.forEach((storage) => {\r\n      if(preserve && preserve === storage) {\r\n        return;\r\n      }\r\n\r\n      const db = storage.db;\r\n      if(db) {\r\n        db.onclose = () => {};\r\n        db.close();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nexport default class IDBStorage<T extends Database<any>, StoreName extends string = T['stores'][0]['name']> {\r\n  private log: ReturnType<typeof logger>;\r\n  private storeName: T['stores'][0]['name'];\r\n  private idb: IDB;\r\n\r\n  constructor(db: T, storeName: typeof db['stores'][0]['name']) {\r\n    this.storeName = storeName;\r\n    this.log = logger(['IDB', db.name, storeName].join('-'));\r\n    this.idb = IDB.create(db);\r\n  }\r\n\r\n  /**\r\n   * ! WARNING ! function requires at least one opened connection\r\n   */\r\n  /* public static clearObjectStores() {\r\n    const storage = this.STORAGES[0];\r\n    this.closeDatabases(storage);\r\n\r\n    const names = Array.from(storage.db.objectStoreNames);\r\n    const promises = names.map((name) => storage.clear(name));\r\n    return Promise.all(promises);\r\n  } */\r\n\r\n  /* public static deleteDatabase() {\r\n    this.closeDatabases();\r\n\r\n    const storages = this.STORAGES;\r\n    const dbNames = Array.from(new Set(storages.map((storage) => storage.name)));\r\n    const promises = dbNames.map((dbName) => {\r\n      return new Promise<void>((resolve, reject) => {\r\n        const deleteRequest = indexedDB.deleteDatabase(dbName);\r\n\r\n        deleteRequest.onerror = () => {\r\n          reject();\r\n        };\r\n\r\n        deleteRequest.onsuccess = () => {\r\n          resolve();\r\n        };\r\n      });\r\n    });\r\n\r\n    return Promise.all(promises);\r\n  } */\r\n\r\n  public delete(entryName: string | string[], storeName?: StoreName): Promise<void> {\r\n    // return Promise.resolve();\r\n    const isArray = Array.isArray(entryName);\r\n    if(!isArray) {\r\n      entryName = [].concat(entryName);\r\n    }\r\n\r\n    return this.getObjectStore('readwrite', (objectStore) => {\r\n      const promises = (entryName as string[]).map((entryName) => objectStore.delete(entryName));\r\n      return isArray ? promises : promises[0];\r\n    }, DEBUG ? 'delete: ' + (entryName as string[]).join(', ') : '', storeName);\r\n  }\r\n\r\n  public clear(storeName?: StoreName): Promise<void> {\r\n    return this.getObjectStore('readwrite', (objectStore) => objectStore.clear(), DEBUG ? 'clear' : '', storeName);\r\n  }\r\n\r\n  public save(entryName: string | string[], value: any | any[], storeName?: StoreName) {\r\n    // const handleError = (error: Error) => {\r\n    //   this.log.error('save: transaction error:', entryName, value, db, error, error && error.name);\r\n    //   if((!error || error.name === 'InvalidStateError')/*  && false */) {\r\n    //     setTimeout(() => {\r\n    //       this.save(entryName, value);\r\n    //     }, 2e3);\r\n    //   } else {\r\n    //     //console.error('IndexedDB saveFile transaction error:', error, error && error.name);\r\n    //   }\r\n    // };\r\n\r\n    const isArray = Array.isArray(entryName);\r\n    if(!isArray) {\r\n      entryName = [].concat(entryName);\r\n      value = [].concat(value);\r\n    }\r\n\r\n    return this.getObjectStore('readwrite', (objectStore) => {\r\n      const promises = (entryName as string[]).map((entryName, idx) => objectStore.put(value[idx], entryName));\r\n      return isArray ? promises : promises[0];\r\n    }, DEBUG ? 'save: ' + (entryName as string[]).join(', ') : '', storeName);\r\n  }\r\n\r\n  // public saveFile(fileName: string, blob: Blob | Uint8Array) {\r\n  //   //return Promise.resolve(blobConstruct([blob]));\r\n  //   if(!(blob instanceof Blob)) {\r\n  //     blob = blobConstruct(blob);\r\n  //   }\r\n\r\n  //   return this.save(fileName, blob);\r\n  // }\r\n\r\n  /* public saveFileBase64(db: IDBDatabase, fileName: string, blob: Blob | any): Promise<Blob> {\r\n    if(this.getBlobSize(blob) > 10 * 1024 * 1024) {\r\n      return Promise.reject();\r\n    }\r\n\r\n    if(!(blob instanceof Blob)) {\r\n      var safeMimeType = blobSafeMimeType(blob.type || 'image/jpeg');\r\n      var address = 'data:' + safeMimeType + ';base64,' + bytesToBase64(blob);\r\n      return this.storagePutB64String(db, fileName, address).then(() => {\r\n        return blob;\r\n      });\r\n    }\r\n\r\n    try {\r\n      var reader = new FileReader();\r\n    } catch (e) {\r\n      this.storageIsAvailable = false;\r\n      return Promise.reject();\r\n    }\r\n\r\n    let promise = new Promise<Blob>((resolve, reject) => {\r\n      reader.onloadend = () => {\r\n        this.storagePutB64String(db, fileName, reader.result as string).then(() => {\r\n          resolve(blob);\r\n        }, reject);\r\n      }\r\n\r\n      reader.onerror = reject;\r\n    });\r\n\r\n\r\n    try {\r\n      reader.readAsDataURL(blob);\r\n    } catch (e) {\r\n      this.storageIsAvailable = false;\r\n      return Promise.reject();\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public storagePutB64String(db: IDBDatabase, fileName: string, b64string: string) {\r\n    try {\r\n      var objectStore = db.transaction([this.storeName], 'readwrite')\r\n        .objectStore(this.storeName);\r\n      var request = objectStore.put(b64string, fileName);\r\n    } catch(error) {\r\n      this.storageIsAvailable = false;\r\n      return Promise.reject(error);\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      request.onsuccess = function(event) {\r\n        resolve();\r\n      };\r\n\r\n      request.onerror = reject;\r\n    });\r\n  }\r\n\r\n  public getBlobSize(blob: any) {\r\n    return blob.size || blob.byteLength || blob.length;\r\n  } */\r\n\r\n  public get<T>(entryName: string[], storeName?: StoreName): Promise<T[]>;\r\n  public get<T>(entryName: string, storeName?: StoreName): Promise<T>;\r\n  public get<T>(entryName: string | string[], storeName?: StoreName): Promise<T> | Promise<T[]> {\r\n    // return Promise.reject();\r\n\r\n    const isArray = Array.isArray(entryName);\r\n    if(!isArray) {\r\n      if(!entryName) {\r\n        return undefined;\r\n      }\r\n\r\n      entryName = [].concat(entryName);\r\n    } else if(!entryName.length) {\r\n      return Promise.resolve([]) as any;\r\n    }\r\n\r\n    return this.getObjectStore<T>('readonly', (objectStore) => {\r\n      const promises = (entryName as string[]).map((entryName) => objectStore.get(entryName));\r\n      return isArray ? promises : promises[0];\r\n    }, DEBUG ? 'get: ' + (entryName as string[]).join(', ') : '', storeName);\r\n  }\r\n\r\n  private getObjectStore<T>(\r\n    mode: IDBTransactionMode,\r\n    callback: (objectStore: IDBObjectStore) => IDBRequest | IDBRequest[],\r\n    log?: string,\r\n    storeName = this.storeName\r\n  ) {\r\n    let perf: number;\r\n\r\n    if(log) {\r\n      perf = performance.now();\r\n      this.log(log + ': start');\r\n    }\r\n\r\n    return this.idb.openDatabase().then((db) => {\r\n      return new Promise<T>((resolve, reject) => {\r\n        /* if(mode === 'readwrite') {\r\n          return;\r\n        } */\r\n\r\n        // * https://developer.chrome.com/blog/indexeddb-durability-mode-now-defaults-to-relaxed\r\n        const transaction = db.transaction([storeName], mode, {durability: 'relaxed'});\r\n\r\n        const onError = () => {\r\n          clearTimeout(timeout);\r\n          reject(transaction.error);\r\n        };\r\n\r\n        // let resolved = false;\r\n        const onComplete = (/* what: string */) => {\r\n          clearTimeout(timeout);\r\n\r\n          if(log) {\r\n            this.log(log + ': end', performance.now() - perf/* , what */);\r\n          }\r\n\r\n          // if(resolved) {\r\n          //   return;\r\n          // }\r\n\r\n          // resolved = true;\r\n          const results = requests.map((r) => r.result);\r\n          resolve(isArray ? results : results[0]);\r\n        };\r\n\r\n        transaction.onerror = onError;\r\n\r\n        // * have to wait while clearing or setting something\r\n        const waitForTransactionComplete = mode === 'readwrite';\r\n        if(waitForTransactionComplete) {\r\n          transaction.oncomplete = () => onComplete(/* 'transaction' */);\r\n        }\r\n\r\n        const timeout = setTimeout(() => {\r\n          this.log.error('transaction not finished', transaction, log);\r\n        }, 10000);\r\n\r\n        /* transaction.addEventListener('abort', (e) => {\r\n          //handleError();\r\n          this.log.error('IndexedDB: transaction abort!', transaction.error);\r\n        }); */\r\n\r\n        const callbackResult = callback(transaction.objectStore(storeName));\r\n\r\n        const isArray = Array.isArray(callbackResult);\r\n        const requests: IDBRequest[] = isArray ? callbackResult : [].concat(callbackResult) as any;\r\n\r\n        if(waitForTransactionComplete) {\r\n          return;\r\n        }\r\n\r\n        const length = requests.length;\r\n        let left = length;\r\n\r\n        const onRequestFinished = () => {\r\n          if(transaction.error) {\r\n            return;\r\n          }\r\n\r\n          if(!--left) {\r\n            onComplete(/* 'requests' */);\r\n          }\r\n        };\r\n\r\n        for(let i = 0; i < length; ++i) {\r\n          const request = requests[i];\r\n          request.onerror = onError;\r\n          request.onsuccess = onRequestFinished;\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  public getAll<T>(storeName?: StoreName): Promise<T[]> {\r\n    return this.getObjectStore<T[]>('readonly', (objectStore) => objectStore.getAll(), DEBUG ? 'getAll' : '', storeName);\r\n  }\r\n\r\n  /* public getAllKeys(): Promise<Array<string>> {\r\n    console.time('getAllEntries');\r\n    return this.openDatabase().then((db) => {\r\n      var objectStore = db.transaction([this.storeName], 'readonly')\r\n        .objectStore(this.storeName);\r\n      var request = objectStore.getAllKeys();\r\n\r\n      return new Promise((resolve, reject) => {\r\n        request.onsuccess = function(event) {\r\n          // @ts-ignore\r\n          var result = event.target.result;\r\n          resolve(result);\r\n          console.timeEnd('getAllEntries');\r\n        }\r\n\r\n        request.onerror = reject;\r\n      });\r\n    });\r\n  } */\r\n\r\n  /* public isFileExists(fileName: string): Promise<boolean> {\r\n    console.time('isFileExists');\r\n    return this.openDatabase().then((db) => {\r\n      var objectStore = db.transaction([this.storeName], 'readonly')\r\n        .objectStore(this.storeName);\r\n      var request = objectStore.openCursor(fileName);\r\n\r\n      return new Promise((resolve, reject) => {\r\n        request.onsuccess = function(event) {\r\n          // @ts-ignore\r\n          var cursor = event.target.result;\r\n          resolve(!!cursor);\r\n          console.timeEnd('isFileExists');\r\n        }\r\n\r\n        request.onerror = reject;\r\n      });\r\n    });\r\n  } */\r\n\r\n  /* public getFileWriter(fileName: string, mimeType: string) {\r\n    var fakeWriter = FileManager.getFakeFileWriter(mimeType, (blob) => {\r\n      return this.saveFile(fileName, blob);\r\n    });\r\n\r\n    return Promise.resolve(fakeWriter);\r\n  } */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport {Database} from '../config/databases';\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\n// import DATABASE_SESSION from \"../config/databases/session\";\r\nimport deferredPromise, {CancellablePromise} from '../helpers/cancellablePromise';\r\nimport {IS_WORKER} from '../helpers/context';\r\nimport throttle from '../helpers/schedulers/throttle';\r\n// import { WorkerTaskTemplate } from \"../types\";\r\nimport IDBStorage from './files/idb';\r\n\r\nfunction noop() {}\r\n\r\n/* export interface LocalStorageProxySetTask extends WorkerTaskTemplate {\r\n  type: 'localStorageProxy',\r\n  payload: {\r\n    type: 'set',\r\n    keys: string[],\r\n    values: any[]\r\n  }\r\n};\r\n\r\nexport interface LocalStorageProxyDeleteTask extends WorkerTaskTemplate {\r\n  type: 'localStorageProxy',\r\n  payload: {\r\n    type: 'delete',\r\n    keys: string[]\r\n  }\r\n}; */\r\n\r\nconst THROTTLE_TIME = 16;\r\n\r\n/* Storage extends {[name: string]: any} *//* Storage extends Record<string, any> */\r\nexport default class AppStorage<\r\n  Storage extends Record<string, any>,\r\n  T extends Database<any>\r\n> {\r\n  private static STORAGES: AppStorage<any, Database<any>>[] = [];\r\n  private storage: IDBStorage<T>;// new CacheStorageController('session');\r\n\r\n  // private cache: Partial<{[key: string]: Storage[typeof key]}> = {};\r\n  private cache: Partial<Storage> = {};\r\n  private useStorage: boolean;\r\n  private savingFreezed: boolean;\r\n\r\n  private getPromises: Map<keyof Storage, CancellablePromise<Storage[keyof Storage]>> = new Map();\r\n  private getThrottled: () => void;\r\n\r\n  private keysToSet: Set<keyof Storage> = new Set();\r\n  private saveThrottled: () => void;\r\n  private saveDeferred = deferredPromise<void>();\r\n\r\n  private keysToDelete: Set<keyof Storage> = new Set();\r\n  private deleteThrottled: () => void;\r\n  private deleteDeferred = deferredPromise<void>();\r\n\r\n  constructor(private db: T, private storeName: typeof db['stores'][number]['name']) {\r\n    this.storage = new IDBStorage<T>(db, storeName);\r\n\r\n    if(AppStorage.STORAGES.length) {\r\n      this.useStorage = AppStorage.STORAGES[0].useStorage;\r\n    } else {\r\n      this.useStorage = true;\r\n    }\r\n\r\n    this.savingFreezed = false;\r\n\r\n    AppStorage.STORAGES.push(this);\r\n\r\n    this.saveThrottled = throttle(async() => {\r\n      const deferred = this.saveDeferred;\r\n      this.saveDeferred = deferredPromise();\r\n\r\n      const set = this.keysToSet;\r\n      if(set.size) {\r\n        const keys = Array.from(set.values()) as string[];\r\n        set.clear();\r\n\r\n        const values = keys.map((key) => this.cache[key]);\r\n        try {\r\n          // console.log('setItem: will set', key/* , value */);\r\n          // await this.cacheStorage.delete(key); // * try to prevent memory leak in Chrome leading to 'Unexpected internal error.'\r\n          // await this.storage.save(key, new Response(value, {headers: {'Content-Type': 'application/json'}}));\r\n\r\n          /* if(db === DATABASE_SESSION && !('localStorage' in self)) { // * support legacy Webogram's localStorage\r\n            self.postMessage({\r\n              type: 'localStorageProxy',\r\n              payload: {\r\n                type: 'set',\r\n                keys,\r\n                values\r\n              }\r\n            } as LocalStorageProxySetTask);\r\n          } */\r\n\r\n          await this.storage.save(keys, values);\r\n          // console.log('setItem: have set', key/* , value */);\r\n        } catch(e) {\r\n          // this.useCS = false;\r\n          console.error('[AS]: set error:', e, keys, values);\r\n        }\r\n      }\r\n\r\n      deferred.resolve();\r\n\r\n      if(set.size) {\r\n        this.saveThrottled();\r\n      }\r\n    }, THROTTLE_TIME, false);\r\n\r\n    this.deleteThrottled = throttle(async() => {\r\n      const deferred = this.deleteDeferred;\r\n      this.deleteDeferred = deferredPromise();\r\n\r\n      const set = this.keysToDelete;\r\n      if(set.size) {\r\n        const keys = Array.from(set.values()) as string[];\r\n        set.clear();\r\n\r\n        try {\r\n          /* if(db === DATABASE_SESSION && !('localStorage' in self)) { // * support legacy Webogram's localStorage\r\n            self.postMessage({\r\n              type: 'localStorageProxy',\r\n              payload: {\r\n                type: 'delete',\r\n                keys\r\n              }\r\n            } as LocalStorageProxyDeleteTask);\r\n          } */\r\n\r\n          await this.storage.delete(keys);\r\n        } catch(e) {\r\n          console.error('[AS]: delete error:', e, keys);\r\n        }\r\n      }\r\n\r\n      deferred.resolve();\r\n\r\n      if(set.size) {\r\n        this.deleteThrottled();\r\n      }\r\n    }, THROTTLE_TIME, false);\r\n\r\n    this.getThrottled = throttle(async() => {\r\n      const keys = Array.from(this.getPromises.keys());\r\n\r\n      // const perf = performance.now();\r\n      this.storage.get(keys as string[]).then((values) => {\r\n        for(let i = 0, length = keys.length; i < length; ++i) {\r\n          const key = keys[i];\r\n          const deferred = this.getPromises.get(key);\r\n          if(deferred) {\r\n            // @ts-ignore\r\n            deferred.resolve(this.cache[key] = values[i]);\r\n            this.getPromises.delete(key);\r\n          }\r\n        }\r\n\r\n        // console.log('[AS]: get time', keys, performance.now() - perf);\r\n      }, (error: ApiError) => {\r\n        const ignoreErrors: Set<ErrorType> = new Set(['NO_ENTRY_FOUND', 'STORAGE_OFFLINE']);\r\n        if(!ignoreErrors.has(error.type)) {\r\n          this.useStorage = false;\r\n          console.error('[AS]: get error:', error, keys, storeName);\r\n        }\r\n\r\n        for(let i = 0, length = keys.length; i < length; ++i) {\r\n          const key = keys[i];\r\n          const deferred = this.getPromises.get(key);\r\n          if(deferred) {\r\n            // deferred.reject(error);\r\n            deferred.resolve(undefined);\r\n            this.getPromises.delete(key);\r\n          }\r\n        }\r\n      }).finally(() => {\r\n        if(this.getPromises.size) {\r\n          this.getThrottled();\r\n        }\r\n      });\r\n    }, THROTTLE_TIME, false);\r\n  }\r\n\r\n  public isAvailable() {\r\n    return this.useStorage;\r\n  }\r\n\r\n  public getCache() {\r\n    return this.cache;\r\n  }\r\n\r\n  public getFromCache<T extends keyof Storage>(key: T) {\r\n    return this.cache[key];\r\n  }\r\n\r\n  public setToCache(key: keyof Storage, value: Storage[typeof key]) {\r\n    return this.cache[key] = value;\r\n  }\r\n\r\n  public async get<T extends keyof Storage>(key: T, useCache = true): Promise<Storage[T]> {\r\n    if(this.cache.hasOwnProperty(key) && useCache) {\r\n      return this.getFromCache(key);\r\n    } else if(this.useStorage) {\r\n      const r = this.getPromises.get(key);\r\n      if(r) return r as any;\r\n\r\n      const p = deferredPromise<Storage[T]>();\r\n      this.getPromises.set(key, p as any);\r\n\r\n      this.getThrottled();\r\n\r\n      return p;\r\n    }/*  else {\r\n      throw 'something went wrong';\r\n    } */\r\n  }\r\n\r\n  public getAll() {\r\n    return this.storage.getAll().catch(() => []);\r\n  }\r\n\r\n  public set(obj: Partial<Storage>, onlyLocal = false) {\r\n    // console.log('storageSetValue', obj, callback, arguments);\r\n\r\n    const canUseStorage = this.useStorage && !onlyLocal && !this.savingFreezed;\r\n    for(const key in obj) {\r\n      if(obj.hasOwnProperty(key)) {\r\n        const value = obj[key];\r\n        this.setToCache(key, value);\r\n\r\n        // let perf = /* DEBUG */false ? performance.now() : 0;\r\n        // value = JSON.stringify(value);\r\n\r\n        // if(perf) {\r\n        //   let elapsedTime = performance.now() - perf;\r\n        //   if(elapsedTime > 10) {\r\n        //     console.warn('LocalStorage set: stringify time by JSON.stringify:', elapsedTime, key);\r\n        //   }\r\n        // }\r\n\r\n        /* perf = performance.now();\r\n        value = stringify(value);\r\n        console.log('LocalStorage set: stringify time by own stringify:', performance.now() - perf); */\r\n\r\n        if(canUseStorage) {\r\n          this.keysToSet.add(key);\r\n          this.keysToDelete.delete(key);\r\n          this.saveThrottled();\r\n        }\r\n      }\r\n    }\r\n\r\n    return canUseStorage ? this.saveDeferred : Promise.resolve();\r\n  }\r\n\r\n  public delete(key: keyof Storage, saveLocal = false) {\r\n    /* if(!this.cache.hasOwnProperty(key)) {\r\n      return;\r\n    } */\r\n\r\n    // ! it is needed here\r\n    key = '' + (key as string);\r\n\r\n    if(!saveLocal) {\r\n      delete this.cache[key];\r\n    }\r\n\r\n    if(this.useStorage) {\r\n      this.keysToSet.delete(key);\r\n      this.keysToDelete.add(key);\r\n      this.deleteThrottled();\r\n    }\r\n\r\n    return this.useStorage ? this.deleteDeferred : Promise.resolve();\r\n  }\r\n\r\n  public clear(saveLocal = false) {\r\n    if(!saveLocal) {\r\n      for(const i in this.cache) {\r\n        delete this.cache[i];\r\n      }\r\n    }\r\n\r\n    return this.storage.clear().catch(noop);\r\n  }\r\n\r\n  public static toggleStorage(enabled: boolean, clearWrite: boolean) {\r\n    return Promise.all(this.STORAGES.map((storage) => {\r\n      storage.useStorage = enabled;\r\n\r\n      if(!IS_WORKER || !clearWrite) {\r\n        return;\r\n      }\r\n\r\n      if(!enabled) {\r\n        storage.keysToSet.clear();\r\n        storage.keysToDelete.clear();\r\n        storage.getPromises.forEach((deferred) => deferred.resolve(undefined));\r\n        storage.getPromises.clear();\r\n        return storage.clear(true);\r\n      } else {\r\n        return storage.set(storage.cache);\r\n      }\r\n    })).catch(noop);\r\n  }\r\n\r\n  public static freezeSaving<T extends Database<any>>(callback: () => any, names: T['stores'][number]['name'][]) {\r\n    this.STORAGES.forEach((storage) => storage.savingFreezed = true);\r\n    try {\r\n      callback();\r\n    } catch(err) {\r\n      console.error('freezeSaving callback error:', err);\r\n    }\r\n    this.STORAGES.forEach((storage) => storage.savingFreezed = false);\r\n  }\r\n\r\n  /* public deleteDatabase() {\r\n    return IDBStorage.deleteDatabase().catch(noop);\r\n  } */\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.AppStorage = AppStorage);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {Database} from '.';\r\nimport type {IDBIndex} from '../../lib/files/idb';\r\n\r\nconst DATABASE_STATE: Database<'session' | 'stickerSets' | 'users' | 'chats' | 'messages' | 'dialogs'> = {\r\n  name: 'tweb',\r\n  version: 7,\r\n  stores: [{\r\n    name: 'session'\r\n  }, {\r\n    name: 'stickerSets'\r\n  }, {\r\n    name: 'users'\r\n  }, {\r\n    name: 'chats'\r\n  }, {\r\n    name: 'dialogs'\r\n    // indexes: [\r\n    //   ...(new Array(20 + 2).fill(0)).map((_, idx) => {\r\n    //     const name = `index_${idx}`;\r\n    //     const index: IDBIndex = {\r\n    //       indexName: name,\r\n    //       keyPath: name,\r\n    //       objectParameters: {}\r\n    //     };\r\n\r\n    //     return index\r\n    //   })\r\n    // ]\r\n  }, {\r\n    name: 'messages'\r\n  }]\r\n};\r\n\r\nexport default DATABASE_STATE;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {ChatSavedPosition} from './appManagers/appImManager';\r\nimport type {AppDraftsManager} from './appManagers/appDraftsManager';\r\nimport type {State} from '../config/state';\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport {LangPackDifference} from '../layer';\r\nimport AppStorage from './storage';\r\nimport DATABASE_STATE from '../config/databases/state';\r\n\r\nclass StateStorage extends AppStorage<{\r\n  chatPositions: {\r\n    [peerId_threadId: string]: ChatSavedPosition\r\n  },\r\n  langPack: LangPackDifference,\r\n  drafts: AppDraftsManager['drafts'],\r\n  user_auth: any, // support old webk format\r\n} & State, typeof DATABASE_STATE> {\r\n  constructor() {\r\n    super(DATABASE_STATE, 'session');\r\n  }\r\n}\r\n\r\nconst stateStorage = new StateStorage();\r\nMOUNT_CLASS_TO.stateStorage = stateStorage;\r\nexport default stateStorage;\r\n","/**\r\n * ignores `undefined` properties\r\n */\r\nexport default function deepEqual<T>(x: T, y: T, ignoreKeys?: (keyof T)[]): boolean {\r\n  const ignoreSet = ignoreKeys && new Set(ignoreKeys);\r\n  const okok = (obj: any) => Object.keys(obj).filter((key) => obj[key] !== undefined);\r\n  const ok = ignoreKeys ? (obj: any) => okok(obj).filter((key) => !ignoreSet.has(key as any)) : okok,\r\n    tx = typeof x,\r\n    ty = typeof y;\r\n  return x && y && tx === 'object' && tx === ty ? (\r\n    ok(x).length === ok(y).length &&\r\n      ok(x).every((key) => deepEqual((x as any)[key], (y as any)[key], ignoreKeys))\r\n  ) : (x === y);\r\n}\r\n","export default function capitalizeFirstLetter(string: string) {\r\n  return string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n","const SKIP_PROTOCOLS: Set<string> = new Set([\r\n  'javascript:'\r\n]);\r\nexport default function matchUrlProtocol(text: string) {\r\n  if(!text) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    const protocol = new URL(text).protocol;\r\n    if(SKIP_PROTOCOLS.has(protocol)) {\r\n      return null;\r\n    }\r\n\r\n    return protocol;\r\n  } catch(err) {\r\n    return null;\r\n  }\r\n}\r\n","// Copyright Twitter Inc. Licensed under MIT\r\n// https://github.com/twitter/twemoji-parser/blob/master/LICENSE.md\r\n\r\nconst originalString = '((?:\\ud83d\\udc68\\ud83c\\udffb\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udffc\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udffd\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udffe\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udfff\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffb\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffb\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffc\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffc\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffd\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffd\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffe\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffe\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udfff\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udfff\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83e\\uddd1\\ud83c\\udffb\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83e\\uddd1\\ud83c[\\udffc-\\udfff]|\\ud83e\\uddd1\\ud83c\\udffc\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83e\\uddd1\\ud83c[\\udffb\\udffd-\\udfff]|\\ud83e\\uddd1\\ud83c\\udffd\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83e\\uddd1\\ud83c[\\udffb\\udffc\\udffe\\udfff]|\\ud83e\\uddd1\\ud83c\\udffe\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udffd\\udfff]|\\ud83e\\uddd1\\ud83c\\udfff\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udffe]|\\ud83d\\udc68\\ud83c\\udffb\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udffb\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffc-\\udfff]|\\ud83d\\udc68\\ud83c\\udffc\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udffc\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffb\\udffd-\\udfff]|\\ud83d\\udc68\\ud83c\\udffd\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udffd\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffb\\udffc\\udffe\\udfff]|\\ud83d\\udc68\\ud83c\\udffe\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udffe\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udffd\\udfff]|\\ud83d\\udc68\\ud83c\\udfff\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\ud83c\\udfff\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udffe]|\\ud83d\\udc69\\ud83c\\udffb\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffb\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffb\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffc-\\udfff]|\\ud83d\\udc69\\ud83c\\udffb\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc69\\ud83c[\\udffc-\\udfff]|\\ud83d\\udc69\\ud83c\\udffc\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffc\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffc\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffb\\udffd-\\udfff]|\\ud83d\\udc69\\ud83c\\udffc\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc69\\ud83c[\\udffb\\udffd-\\udfff]|\\ud83d\\udc69\\ud83c\\udffd\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffd\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffd\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffb\\udffc\\udffe\\udfff]|\\ud83d\\udc69\\ud83c\\udffd\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc69\\ud83c[\\udffb\\udffc\\udffe\\udfff]|\\ud83d\\udc69\\ud83c\\udffe\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffe\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udffe\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udffd\\udfff]|\\ud83d\\udc69\\ud83c\\udffe\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udffd\\udfff]|\\ud83d\\udc69\\ud83c\\udfff\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udfff\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc69\\ud83c\\udfff\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc68\\ud83c[\\udffb-\\udffe]|\\ud83d\\udc69\\ud83c\\udfff\\u200d\\ud83e\\udd1d\\u200d\\ud83d\\udc69\\ud83c[\\udffb-\\udffe]|\\ud83e\\uddd1\\ud83c\\udffb\\u200d\\u2764\\ufe0f?\\u200d\\ud83e\\uddd1\\ud83c[\\udffc-\\udfff]|\\ud83e\\uddd1\\ud83c\\udffb\\u200d\\ud83e\\udd1d\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udfff]|\\ud83e\\uddd1\\ud83c\\udffc\\u200d\\u2764\\ufe0f?\\u200d\\ud83e\\uddd1\\ud83c[\\udffb\\udffd-\\udfff]|\\ud83e\\uddd1\\ud83c\\udffc\\u200d\\ud83e\\udd1d\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udfff]|\\ud83e\\uddd1\\ud83c\\udffd\\u200d\\u2764\\ufe0f?\\u200d\\ud83e\\uddd1\\ud83c[\\udffb\\udffc\\udffe\\udfff]|\\ud83e\\uddd1\\ud83c\\udffd\\u200d\\ud83e\\udd1d\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udfff]|\\ud83e\\uddd1\\ud83c\\udffe\\u200d\\u2764\\ufe0f?\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udffd\\udfff]|\\ud83e\\uddd1\\ud83c\\udffe\\u200d\\ud83e\\udd1d\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udfff]|\\ud83e\\uddd1\\ud83c\\udfff\\u200d\\u2764\\ufe0f?\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udffe]|\\ud83e\\uddd1\\ud83c\\udfff\\u200d\\ud83e\\udd1d\\u200d\\ud83e\\uddd1\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc68\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d\\udc68|\\ud83d\\udc69\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc8b\\u200d\\ud83d[\\udc68\\udc69]|\\ud83e\\udef1\\ud83c\\udffb\\u200d\\ud83e\\udef2\\ud83c[\\udffc-\\udfff]|\\ud83e\\udef1\\ud83c\\udffc\\u200d\\ud83e\\udef2\\ud83c[\\udffb\\udffd-\\udfff]|\\ud83e\\udef1\\ud83c\\udffd\\u200d\\ud83e\\udef2\\ud83c[\\udffb\\udffc\\udffe\\udfff]|\\ud83e\\udef1\\ud83c\\udffe\\u200d\\ud83e\\udef2\\ud83c[\\udffb-\\udffd\\udfff]|\\ud83e\\udef1\\ud83c\\udfff\\u200d\\ud83e\\udef2\\ud83c[\\udffb-\\udffe]|\\ud83d\\udc68\\u200d\\u2764\\ufe0f?\\u200d\\ud83d\\udc68|\\ud83d\\udc69\\u200d\\u2764\\ufe0f?\\u200d\\ud83d[\\udc68\\udc69]|\\ud83e\\uddd1\\u200d\\ud83e\\udd1d\\u200d\\ud83e\\uddd1|\\ud83d\\udc6b\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc6c\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc6d\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc8f\\ud83c[\\udffb-\\udfff]|\\ud83d\\udc91\\ud83c[\\udffb-\\udfff]|\\ud83e\\udd1d\\ud83c[\\udffb-\\udfff]|\\ud83d[\\udc6b-\\udc6d\\udc8f\\udc91]|\\ud83e\\udd1d)|(?:\\ud83d[\\udc68\\udc69]|\\ud83e\\uddd1)(?:\\ud83c[\\udffb-\\udfff])?\\u200d(?:\\u2695\\ufe0f?|\\u2696\\ufe0f?|\\u2708\\ufe0f?|\\ud83c[\\udf3e\\udf73\\udf7c\\udf84\\udf93\\udfa4\\udfa8\\udfeb\\udfed]|\\ud83d[\\udcbb\\udcbc\\udd27\\udd2c\\ude80\\ude92]|\\ud83e[\\uddaf-\\uddb3\\uddbc\\uddbd])|(?:\\ud83c[\\udfcb\\udfcc]|\\ud83d[\\udd74\\udd75]|\\u26f9)(?:(?:\\ud83c[\\udffb-\\udfff]|\\ufe0f?)\\u200d[\\u2640\\u2642]\\ufe0f?)|(?:\\ud83c[\\udfc3\\udfc4\\udfca]|\\ud83d[\\udc6e\\udc70\\udc71\\udc73\\udc77\\udc81\\udc82\\udc86\\udc87\\ude45-\\ude47\\ude4b\\ude4d\\ude4e\\udea3\\udeb4-\\udeb6]|\\ud83e[\\udd26\\udd35\\udd37-\\udd39\\udd3d\\udd3e\\uddb8\\uddb9\\uddcd-\\uddcf\\uddd4\\uddd6-\\udddd])(?:\\ud83c[\\udffb-\\udfff])?\\u200d[\\u2640\\u2642]\\ufe0f?|(?:\\ud83d\\udc68\\u200d\\ud83d\\udc68\\u200d\\ud83d\\udc66\\u200d\\ud83d\\udc66|\\ud83d\\udc68\\u200d\\ud83d\\udc68\\u200d\\ud83d\\udc67\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc68\\u200d\\ud83d\\udc69\\u200d\\ud83d\\udc66\\u200d\\ud83d\\udc66|\\ud83d\\udc68\\u200d\\ud83d\\udc69\\u200d\\ud83d\\udc67\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc69\\u200d\\ud83d\\udc69\\u200d\\ud83d\\udc66\\u200d\\ud83d\\udc66|\\ud83d\\udc69\\u200d\\ud83d\\udc69\\u200d\\ud83d\\udc67\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc68\\u200d\\ud83d\\udc66\\u200d\\ud83d\\udc66|\\ud83d\\udc68\\u200d\\ud83d\\udc67\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc68\\u200d\\ud83d\\udc68\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc68\\u200d\\ud83d\\udc69\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc69\\u200d\\ud83d\\udc66\\u200d\\ud83d\\udc66|\\ud83d\\udc69\\u200d\\ud83d\\udc67\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc69\\u200d\\ud83d\\udc69\\u200d\\ud83d[\\udc66\\udc67]|\\ud83c\\udff3\\ufe0f?\\u200d\\u26a7\\ufe0f?|\\ud83c\\udff3\\ufe0f?\\u200d\\ud83c\\udf08|\\ud83d\\ude36\\u200d\\ud83c\\udf2b\\ufe0f?|\\u2764\\ufe0f?\\u200d\\ud83d\\udd25|\\u2764\\ufe0f?\\u200d\\ud83e\\ude79|\\ud83c\\udff4\\u200d\\u2620\\ufe0f?|\\ud83d\\udc15\\u200d\\ud83e\\uddba|\\ud83d\\udc3b\\u200d\\u2744\\ufe0f?|\\ud83d\\udc41\\u200d\\ud83d\\udde8|\\ud83d\\udc68\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc69\\u200d\\ud83d[\\udc66\\udc67]|\\ud83d\\udc6f\\u200d\\u2640\\ufe0f?|\\ud83d\\udc6f\\u200d\\u2642\\ufe0f?|\\ud83d\\ude2e\\u200d\\ud83d\\udca8|\\ud83d\\ude35\\u200d\\ud83d\\udcab|\\ud83e\\udd3c\\u200d\\u2640\\ufe0f?|\\ud83e\\udd3c\\u200d\\u2642\\ufe0f?|\\ud83e\\uddde\\u200d\\u2640\\ufe0f?|\\ud83e\\uddde\\u200d\\u2642\\ufe0f?|\\ud83e\\udddf\\u200d\\u2640\\ufe0f?|\\ud83e\\udddf\\u200d\\u2642\\ufe0f?|\\ud83d\\udc08\\u200d\\u2b1b)|[#*0-9]\\ufe0f??\\u20e3|(?:[\\u2122\\u265f]\\ufe0f?)|(?:\\ud83c[\\udc04\\udd70\\udd71\\udd7e\\udd7f\\ude02\\ude1a\\ude2f\\ude37\\udf21\\udf24-\\udf2c\\udf36\\udf7d\\udf96\\udf97\\udf99-\\udf9b\\udf9e\\udf9f\\udfcd\\udfce\\udfd4-\\udfdf\\udff3\\udff5\\udff7]|\\ud83d[\\udc3f\\udc41\\udcfd\\udd49\\udd4a\\udd6f\\udd70\\udd73\\udd76-\\udd79\\udd87\\udd8a-\\udd8d\\udda5\\udda8\\uddb1\\uddb2\\uddbc\\uddc2-\\uddc4\\uddd1-\\uddd3\\udddc-\\uddde\\udde1\\udde3\\udde8\\uddef\\uddf3\\uddfa\\udecb\\udecd-\\udecf\\udee0-\\udee5\\udee9\\udef0\\udef3]|[\\u203c\\u2049\\u2139\\u2194-\\u2199\\u21a9\\u21aa\\u231a\\u231b\\u2328\\u23cf\\u23ed-\\u23ef\\u23f1\\u23f2\\u23f8-\\u23fa\\u24c2\\u25aa\\u25ab\\u25b6\\u25c0\\u25fb-\\u25fe\\u2600-\\u2604\\u260e\\u2611\\u2614\\u2615\\u2618\\u2620\\u2622\\u2623\\u2626\\u262a\\u262e\\u262f\\u2638-\\u263a\\u2640\\u2642\\u2648-\\u2653\\u2660\\u2663\\u2665\\u2666\\u2668\\u267b\\u267f\\u2692-\\u2697\\u2699\\u269b\\u269c\\u26a0\\u26a1\\u26a7\\u26aa\\u26ab\\u26b0\\u26b1\\u26bd\\u26be\\u26c4\\u26c5\\u26c8\\u26cf\\u26d1\\u26d3\\u26d4\\u26e9\\u26ea\\u26f0-\\u26f5\\u26f8\\u26fa\\u26fd\\u2702\\u2708\\u2709\\u270f\\u2712\\u2714\\u2716\\u271d\\u2721\\u2733\\u2734\\u2744\\u2747\\u2757\\u2763\\u2764\\u27a1\\u2934\\u2935\\u2b05-\\u2b07\\u2b1b\\u2b1c\\u2b50\\u2b55\\u3030\\u303d\\u3297\\u3299])(?:\\ufe0f?|(?!\\ufe0e))|(?:(?:\\ud83c[\\udfcb\\udfcc]|\\ud83d[\\udd74\\udd75\\udd90]|[\\u261d\\u26f7\\u26f9\\u270c\\u270d])(?:\\ufe0f?|(?!\\ufe0e))|(?:\\ud83c[\\udf85\\udfc2-\\udfc4\\udfc7\\udfca]|\\ud83d[\\udc42\\udc43\\udc46-\\udc50\\udc66-\\udc69\\udc6e\\udc70-\\udc78\\udc7c\\udc81-\\udc83\\udc85-\\udc87\\udcaa\\udd7a\\udd95\\udd96\\ude45-\\ude47\\ude4b-\\ude4f\\udea3\\udeb4-\\udeb6\\udec0\\udecc]|\\ud83e[\\udd0c\\udd0f\\udd18-\\udd1c\\udd1e\\udd1f\\udd26\\udd30-\\udd39\\udd3d\\udd3e\\udd77\\uddb5\\uddb6\\uddb8\\uddb9\\uddbb\\uddcd-\\uddcf\\uddd1-\\udddd\\udec3-\\udec5\\udef0-\\udef6]|[\\u270a\\u270b]))(?:\\ud83c[\\udffb-\\udfff])?|(?:\\ud83c\\udff4\\udb40\\udc67\\udb40\\udc62\\udb40\\udc65\\udb40\\udc6e\\udb40\\udc67\\udb40\\udc7f|\\ud83c\\udff4\\udb40\\udc67\\udb40\\udc62\\udb40\\udc73\\udb40\\udc63\\udb40\\udc74\\udb40\\udc7f|\\ud83c\\udff4\\udb40\\udc67\\udb40\\udc62\\udb40\\udc77\\udb40\\udc6c\\udb40\\udc73\\udb40\\udc7f|\\ud83c\\udde6\\ud83c[\\udde8-\\uddec\\uddee\\uddf1\\uddf2\\uddf4\\uddf6-\\uddfa\\uddfc\\uddfd\\uddff]|\\ud83c\\udde7\\ud83c[\\udde6\\udde7\\udde9-\\uddef\\uddf1-\\uddf4\\uddf6-\\uddf9\\uddfb\\uddfc\\uddfe\\uddff]|\\ud83c\\udde8\\ud83c[\\udde6\\udde8\\udde9\\uddeb-\\uddee\\uddf0-\\uddf5\\uddf7\\uddfa-\\uddff]|\\ud83c\\udde9\\ud83c[\\uddea\\uddec\\uddef\\uddf0\\uddf2\\uddf4\\uddff]|\\ud83c\\uddea\\ud83c[\\udde6\\udde8\\uddea\\uddec\\udded\\uddf7-\\uddfa]|\\ud83c\\uddeb\\ud83c[\\uddee-\\uddf0\\uddf2\\uddf4\\uddf7]|\\ud83c\\uddec\\ud83c[\\udde6\\udde7\\udde9-\\uddee\\uddf1-\\uddf3\\uddf5-\\uddfa\\uddfc\\uddfe]|\\ud83c\\udded\\ud83c[\\uddf0\\uddf2\\uddf3\\uddf7\\uddf9\\uddfa]|\\ud83c\\uddee\\ud83c[\\udde8-\\uddea\\uddf1-\\uddf4\\uddf6-\\uddf9]|\\ud83c\\uddef\\ud83c[\\uddea\\uddf2\\uddf4\\uddf5]|\\ud83c\\uddf0\\ud83c[\\uddea\\uddec-\\uddee\\uddf2\\uddf3\\uddf5\\uddf7\\uddfc\\uddfe\\uddff]|\\ud83c\\uddf1\\ud83c[\\udde6-\\udde8\\uddee\\uddf0\\uddf7-\\uddfb\\uddfe]|\\ud83c\\uddf2\\ud83c[\\udde6\\udde8-\\udded\\uddf0-\\uddff]|\\ud83c\\uddf3\\ud83c[\\udde6\\udde8\\uddea-\\uddec\\uddee\\uddf1\\uddf4\\uddf5\\uddf7\\uddfa\\uddff]|\\ud83c\\uddf4\\ud83c\\uddf2|\\ud83c\\uddf5\\ud83c[\\udde6\\uddea-\\udded\\uddf0-\\uddf3\\uddf7-\\uddf9\\uddfc\\uddfe]|\\ud83c\\uddf6\\ud83c\\udde6|\\ud83c\\uddf7\\ud83c[\\uddea\\uddf4\\uddf8\\uddfa\\uddfc]|\\ud83c\\uddf8\\ud83c[\\udde6-\\uddea\\uddec-\\uddf4\\uddf7-\\uddf9\\uddfb\\uddfd-\\uddff]|\\ud83c\\uddf9\\ud83c[\\udde6\\udde8\\udde9\\uddeb-\\udded\\uddef-\\uddf4\\uddf7\\uddf9\\uddfb\\uddfc\\uddff]|\\ud83c\\uddfa\\ud83c[\\udde6\\uddec\\uddf2\\uddf3\\uddf8\\uddfe\\uddff]|\\ud83c\\uddfb\\ud83c[\\udde6\\udde8\\uddea\\uddec\\uddee\\uddf3\\uddfa]|\\ud83c\\uddfc\\ud83c[\\uddeb\\uddf8]|\\ud83c\\uddfd\\ud83c\\uddf0|\\ud83c\\uddfe\\ud83c[\\uddea\\uddf9]|\\ud83c\\uddff\\ud83c[\\udde6\\uddf2\\uddfc]|\\ud83c[\\udccf\\udd8e\\udd91-\\udd9a\\udde6-\\uddff\\ude01\\ude32-\\ude36\\ude38-\\ude3a\\ude50\\ude51\\udf00-\\udf20\\udf2d-\\udf35\\udf37-\\udf7c\\udf7e-\\udf84\\udf86-\\udf93\\udfa0-\\udfc1\\udfc5\\udfc6\\udfc8\\udfc9\\udfcf-\\udfd3\\udfe0-\\udff0\\udff4\\udff8-\\udfff]|\\ud83d[\\udc00-\\udc3e\\udc40\\udc44\\udc45\\udc51-\\udc65\\udc6a\\udc6f\\udc79-\\udc7b\\udc7d-\\udc80\\udc84\\udc88-\\udc8e\\udc90\\udc92-\\udca9\\udcab-\\udcfc\\udcff-\\udd3d\\udd4b-\\udd4e\\udd50-\\udd67\\udda4\\uddfb-\\ude44\\ude48-\\ude4a\\ude80-\\udea2\\udea4-\\udeb3\\udeb7-\\udebf\\udec1-\\udec5\\uded0-\\uded2\\uded5-\\uded7\\udedd-\\udedf\\udeeb\\udeec\\udef4-\\udefc\\udfe0-\\udfeb\\udff0]|\\ud83e[\\udd0d\\udd0e\\udd10-\\udd17\\udd20-\\udd25\\udd27-\\udd2f\\udd3a\\udd3c\\udd3f-\\udd45\\udd47-\\udd76\\udd78-\\uddb4\\uddb7\\uddba\\uddbc-\\uddcc\\uddd0\\uddde-\\uddff\\ude70-\\ude74\\ude78-\\ude7c\\ude80-\\ude86\\ude90-\\udeac\\udeb0-\\udeba\\udec0-\\udec2\\uded0-\\uded9\\udee0-\\udee7]|[\\u23e9-\\u23ec\\u23f0\\u23f3\\u267e\\u26ce\\u2705\\u2728\\u274c\\u274e\\u2753-\\u2755\\u2795-\\u2797\\u27b0\\u27bf\\ue50a])|\\ufe0f)';\r\nexport default originalString;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport emojiRegExp from '../../vendor/emoji/regex';\r\nimport {MessageEntity} from '../../layer';\r\n\r\nconst EmojiHelper = {\r\n  emojiMap: (code: string) => { return code; },\r\n  shortcuts: [] as any,\r\n  emojis: [] as any\r\n};\r\n\r\nexport const ALPHA_CHARS_REG_EXP = 'a-z' +\r\n  '\\\\u00c0-\\\\u00d6\\\\u00d8-\\\\u00f6\\\\u00f8-\\\\u00ff' + // Latin-1\r\n  '\\\\u0100-\\\\u024f' + // Latin Extended A and B\r\n  '\\\\u0253\\\\u0254\\\\u0256\\\\u0257\\\\u0259\\\\u025b\\\\u0263\\\\u0268\\\\u026f\\\\u0272\\\\u0289\\\\u028b' + // IPA Extensions\r\n  '\\\\u02bb' + // Hawaiian\r\n  '\\\\u0300-\\\\u036f' + // Combining diacritics\r\n  '\\\\u1e00-\\\\u1eff' + // Latin Extended Additional (mostly for Vietnamese)\r\n  '\\\\u0400-\\\\u04ff\\\\u0500-\\\\u0527' + // Cyrillic\r\n  '\\\\u2de0-\\\\u2dff\\\\ua640-\\\\ua69f' + // Cyrillic Extended A/B\r\n  '\\\\u0591-\\\\u05bf\\\\u05c1-\\\\u05c2\\\\u05c4-\\\\u05c5\\\\u05c7' +\r\n  '\\\\u05d0-\\\\u05ea\\\\u05f0-\\\\u05f4' + // Hebrew\r\n  '\\\\ufb1d-\\\\ufb28\\\\ufb2a-\\\\ufb36\\\\ufb38-\\\\ufb3c\\\\ufb3e\\\\ufb40-\\\\ufb41' +\r\n  '\\\\ufb43-\\\\ufb44\\\\ufb46-\\\\ufb4f' + // Hebrew Pres. Forms\r\n  '\\\\u0610-\\\\u061a\\\\u0620-\\\\u065f\\\\u066e-\\\\u06d3\\\\u06d5-\\\\u06dc' +\r\n  '\\\\u06de-\\\\u06e8\\\\u06ea-\\\\u06ef\\\\u06fa-\\\\u06fc\\\\u06ff' + // Arabic\r\n  '\\\\u0750-\\\\u077f\\\\u08a0\\\\u08a2-\\\\u08ac\\\\u08e4-\\\\u08fe' + // Arabic Supplement and Extended A\r\n  '\\\\ufb50-\\\\ufbb1\\\\ufbd3-\\\\ufd3d\\\\ufd50-\\\\ufd8f\\\\ufd92-\\\\ufdc7\\\\ufdf0-\\\\ufdfb' + // Pres. Forms A\r\n  '\\\\ufe70-\\\\ufe74\\\\ufe76-\\\\ufefc' + // Pres. Forms B\r\n  '\\\\u200c' + // Zero-Width Non-Joiner\r\n  '\\\\u0e01-\\\\u0e3a\\\\u0e40-\\\\u0e4e' + // Thai\r\n  '\\\\u1100-\\\\u11ff\\\\u3130-\\\\u3185\\\\uA960-\\\\uA97F\\\\uAC00-\\\\uD7AF\\\\uD7B0-\\\\uD7FF' + // Hangul (Korean)\r\n  '\\\\u3003\\\\u3005\\\\u303b' + // Kanji/Han iteration marks\r\n  '\\\\uff21-\\\\uff3a\\\\uff41-\\\\uff5a' + // full width Alphabet\r\n  '\\\\uff66-\\\\uff9f' + // half width Katakana\r\n  '\\\\uffa1-\\\\uffdc'; // half width Hangul (Korean)\r\nexport const ALPHA_NUMERIC_REG_EXP = '0-9\\_' + ALPHA_CHARS_REG_EXP;\r\nexport const DOMAIN_ADD_CHARS = '\\u00b7';\r\n// Based on Regular Expression for URL validation by Diego Perini\r\nexport const URL_ALPHANUMERIC_REG_EXP_PART = '[' + ALPHA_CHARS_REG_EXP + '0-9]';\r\nexport const URL_PROTOCOL_REG_EXP_PART = '((?:https?|ftp)://|mailto:)?';\r\nexport const URL_REG_EXP = URL_PROTOCOL_REG_EXP_PART +\r\n  // user:pass authentication\r\n  '(?:' + URL_ALPHANUMERIC_REG_EXP_PART + '{1,64}(?::' + URL_ALPHANUMERIC_REG_EXP_PART + '{0,64})?@)?' +\r\n  '(?:' +\r\n  // sindresorhus/ip-regexp\r\n  '(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])(?:\\\\.(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])){3}' +\r\n  '|' +\r\n  // host name\r\n  URL_ALPHANUMERIC_REG_EXP_PART + '[' + ALPHA_CHARS_REG_EXP + DOMAIN_ADD_CHARS + '0-9\\-]{0,64}' +\r\n  // domain name\r\n  '(?:\\\\.' + URL_ALPHANUMERIC_REG_EXP_PART + '[' + ALPHA_CHARS_REG_EXP + DOMAIN_ADD_CHARS + '0-9\\-]{0,64}){0,10}' +\r\n  // TLD identifier\r\n  '(?:\\\\.(xn--[0-9a-z]{2,16}|[' + ALPHA_CHARS_REG_EXP + ']{2,24}))' +\r\n  ')' +\r\n  // port number\r\n  '(?::\\\\d{2,5})?' +\r\n  // resource path\r\n  '(?:/(?:\\\\S{0,255}[^\\\\s.;,(\\\\[\\\\]{}<>\"\\'])?)?';\r\nexport const URL_PROTOCOL_REG_EXP = new RegExp('^' + URL_PROTOCOL_REG_EXP_PART.slice(0, -1), 'i');\r\nexport const USERNAME_REG_EXP = '[a-zA-Z\\\\d_]{5,32}';\r\n// export const TIMESTAMP_REG_EXP = '(?:\\\\s|^)((?:\\\\d{1,2}:)?(?:[0-5]?[0-9]):(?:[0-5][0-9]))(?:\\\\s|$)';\r\nexport const TIMESTAMP_REG_EXP = '(?:\\\\s|^)((?:(\\\\d{1,2}):(?:[0-5]?[0-9])|(?:\\\\d{1,2}|\\\\d{3,})):(?:[0-5][0-9]))(?:\\\\s|$)';\r\nexport const BOT_COMMAND_REG_EXP = '\\\\/([a-zA-Z\\\\d_]{1,32})(?:@(' + USERNAME_REG_EXP + '))?(\\\\b|$)';\r\nexport const FULL_REG_EXP = new RegExp('(^| )(@)(' + USERNAME_REG_EXP + ')|(' + URL_REG_EXP + ')|(\\\\n)|(' + emojiRegExp + ')|(^|[\\\\s\\\\(\\\\]])(#[' + ALPHA_NUMERIC_REG_EXP + ']{2,64})|(^|\\\\s)' + BOT_COMMAND_REG_EXP + '|' + TIMESTAMP_REG_EXP + '', 'i');\r\nexport const EMAIL_REG_EXP = /^(([^<>()[\\]\\\\.,;:\\s@\\\"]+(\\.[^<>()[\\]\\\\.,;:\\s@\\\"]+)*)|(\\\".+\\\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;\r\n// const markdownTestRegExp = /[`_*@~]/;\r\nexport const MARKDOWN_REG_EXP = /(^|\\s|\\n)(````?)([\\s\\S]+?)(````?)([\\s\\n\\.,:?!;]|$)|(^|\\s|\\x01)(`|~~|\\*\\*|__|_-_|\\|\\|)([^\\n]+?)\\7([\\x01\\s\\.,:?!;]|$)|@(\\d+)\\s*\\((.+?)\\)|(\\[(.+?)\\]\\((.+?)\\))/m;\r\nexport const SITE_HASHTAGS: {[siteName: string]: string} = {\r\n  'Telegram': 'tg://search_hashtag?hashtag={1}',\r\n  'Twitter': 'https://twitter.com/hashtag/{1}',\r\n  'Instagram': 'https://instagram.com/explore/tags/{1}/',\r\n  'Google Plus': 'https://plus.google.com/explore/{1}'\r\n};\r\n\r\n// export const SITE_MENTIONS: {[siteName in 'Telegram' | 'Twitter' | 'Instagram' | 'GitHub']: string} = {\r\n//   Telegram: '#{1}',\r\n//   Twitter: 'https://twitter.com/{1}',\r\n//   Instagram: 'https://instagram.com/{1}/',\r\n//   GitHub: 'https://github.com/{1}'\r\n// };\r\n\r\nexport const MARKDOWN_ENTITIES: {[markdown: string]: MessageEntity['_']} = {\r\n  '`': 'messageEntityCode',\r\n  '``': 'messageEntityPre',\r\n  '**': 'messageEntityBold',\r\n  '__': 'messageEntityItalic',\r\n  '~~': 'messageEntityStrike',\r\n  '_-_': 'messageEntityUnderline',\r\n  '||': 'messageEntitySpoiler'\r\n};\r\n\r\nexport const MARKDOWN_ENTITIES_TYPES = new Set(Object.values(MARKDOWN_ENTITIES));\r\n\r\nexport const PASS_CONFLICTING_ENTITIES: Set<MessageEntity['_']> = new Set([\r\n  'messageEntityEmoji',\r\n  'messageEntityLinebreak',\r\n  'messageEntityCaret'\r\n]);\r\nexport const PASS_SINGLE_CONFLICTING_ENTITIES = new Set(PASS_CONFLICTING_ENTITIES);\r\nfor(const i in MARKDOWN_ENTITIES) {\r\n  PASS_CONFLICTING_ENTITIES.add(MARKDOWN_ENTITIES[i]);\r\n}\r\n\r\nexport const PHONE_NUMBER_REG_EXP = /^\\+\\d+$/;\r\n\r\nexport const LOCAL_ENTITIES = new Set<MessageEntity['_']>([\r\n  'messageEntityLinebreak',\r\n  'messageEntityCaret',\r\n  'messageEntityHighlight',\r\n  'messageEntityBotCommand',\r\n  'messageEntityTimestamp'\r\n]);\r\n\r\n/* export function parseEmojis(text: string) {\r\n  return text.replace(/:([a-z0-9\\-\\+\\*_]+?):/gi, function (all, shortcut) {\r\n    var emojiCode = EmojiHelper.shortcuts[shortcut]\r\n    if (emojiCode !== undefined) {\r\n      return EmojiHelper.emojis[emojiCode][0]\r\n    }\r\n    return all\r\n  })\r\n} */\r\n\r\n\r\n/* export function replaceUrlEncodings(urlWithEncoded: string) {\r\n  return urlWithEncoded.replace(/(%[A-Z\\d]{2})+/g, (str) => {\r\n    try {\r\n      return decodeURIComponent(str);\r\n    } catch (e) {\r\n      return str;\r\n    }\r\n  });\r\n} */\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type addAnchorListener from '../../helpers/addAnchorListener';\r\nimport {PHONE_NUMBER_REG_EXP} from '.';\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport matchUrlProtocol from './matchUrlProtocol';\r\nimport {T_ME_PREFIXES} from '../mtproto/mtproto_config';\r\n\r\nexport default function wrapUrl(url: string, unsafe?: number | boolean) {\r\n  if(!matchUrlProtocol(url)) {\r\n    url = 'https://' + url;\r\n  }\r\n\r\n  const out: {url: string, onclick?: Parameters<typeof addAnchorListener>[0]['name']} = {url};\r\n  let tgMeMatch, telescoPeMatch, tgMatch;\r\n  let onclick: typeof out['onclick'];\r\n  /* if(unsafe === 2) {\r\n    url = 'tg://unsafe_url?url=' + encodeURIComponent(url);\r\n  } else  */if((tgMeMatch = url.match(/^(?:https?:\\/\\/)?(?:(.+?)\\.)?(?:(?:web|k|z|a)\\.)?t(?:elegram)?\\.me(?:\\/(.+))?/))) {\r\n    const u = new URL(url);\r\n    let prefix = tgMeMatch[1];\r\n    if(prefix && T_ME_PREFIXES.has(tgMeMatch[1])) {\r\n      prefix = undefined;\r\n    }\r\n\r\n    if(prefix) {\r\n      u.pathname = prefix + (u.pathname === '/' ? '' : u.pathname);\r\n    }\r\n\r\n    const fullPath = u.pathname.slice(1);\r\n    const path = fullPath.split('/');\r\n\r\n    if(path[0] && path[0][0] === '$' && path[0].length > 1) {\r\n      onclick = 'invoice';\r\n    } else if(/^\\+/.test(fullPath) && !PHONE_NUMBER_REG_EXP.test(fullPath)) { // second regexp is for phone numbers (t.me/+38050...)\r\n      onclick = 'joinchat';\r\n    } else if(path[0]) switch(path[0]) {\r\n      case 'm':\r\n      case 'addlist':\r\n      case 'joinchat':\r\n      case 'addstickers':\r\n      case 'addemoji':\r\n      case 'voicechat':\r\n      case 'invoice':\r\n      case 'boost':\r\n      case 'giftcode':\r\n        if(path.length !== 1 && !prefix) {\r\n          onclick = path[0];\r\n          break;\r\n        }\r\n\r\n      default:\r\n        if(path.length <= 2 || path[1]?.match(/^\\d+(?:\\?(?:comment|thread)=\\d+)?$/) || path[1] === 's') {\r\n          onclick = 'im';\r\n          break;\r\n        }\r\n\r\n        break;\r\n    }\r\n  } else if((telescoPeMatch = url.match(/^(?:https?:\\/\\/)?telesco\\.pe\\/([^/?]+)\\/(\\d+)/))) {\r\n    onclick = 'im';\r\n  } else if((tgMatch = url.match(/tg:(?:\\/\\/)?(.+?)(?:\\?|$)/))) {\r\n    onclick = 'tg_' + tgMatch[1] as any;\r\n  }/*  else if(unsafe) {\r\n    url = 'tg://unsafe_url?url=' + encodeURIComponent(url);\r\n  } */\r\n\r\n  if(!(window as any)[onclick]) {\r\n    onclick = undefined;\r\n  }\r\n\r\n  out.onclick = onclick;\r\n  return out;\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.wrapUrl = wrapUrl);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// import I18n from '../../lib/langPack';\r\n\r\nexport default function setInnerHTML(elem: Element, html: string | DocumentFragment | Element) {\r\n  setDirection(elem);\r\n  if(html === undefined) {\r\n    elem.replaceChildren();\r\n  } else if(typeof(html) === 'string') {\r\n    if(!html) elem.replaceChildren();\r\n    else elem.textContent = html;\r\n  } else {\r\n    elem.replaceChildren(html);\r\n  }\r\n}\r\n\r\nexport function setDirection(elem: Element) {\r\n  // if(!I18n.isRTL) {\r\n  elem.setAttribute('dir', 'auto');\r\n  // }\r\n}\r\n\r\nexport function getDirection(): 'auto' {\r\n  return 'auto';\r\n}\r\n","export default function setBlankToAnchor(anchor: HTMLAnchorElement) {\r\n  anchor.target = '_blank';\r\n  anchor.rel = 'noopener noreferrer';\r\n  return anchor;\r\n}\r\n","let taskIdCounter = 1,\r\n  isCallbackScheduled = false,\r\n  isPerformingWork = false,\r\n  taskQueue = [],\r\n  currentTask = null,\r\n  shouldYieldToHost = null,\r\n  yieldInterval = 5,\r\n  deadline = 0,\r\n  maxYieldInterval = 300,\r\n  scheduleCallback = null,\r\n  scheduledCallback = null;\r\nconst maxSigned31BitInt = 1073741823;\r\nfunction setupScheduler() {\r\n  const channel = new MessageChannel(),\r\n    port = channel.port2;\r\n  scheduleCallback = () => port.postMessage(null);\r\n  channel.port1.onmessage = () => {\r\n    if (scheduledCallback !== null) {\r\n      const currentTime = performance.now();\r\n      deadline = currentTime + yieldInterval;\r\n      const hasTimeRemaining = true;\r\n      try {\r\n        const hasMoreWork = scheduledCallback(hasTimeRemaining, currentTime);\r\n        if (!hasMoreWork) {\r\n          scheduledCallback = null;\r\n        } else port.postMessage(null);\r\n      } catch (error) {\r\n        port.postMessage(null);\r\n        throw error;\r\n      }\r\n    }\r\n  };\r\n  if (navigator && navigator.scheduling && navigator.scheduling.isInputPending) {\r\n    const scheduling = navigator.scheduling;\r\n    shouldYieldToHost = () => {\r\n      const currentTime = performance.now();\r\n      if (currentTime >= deadline) {\r\n        if (scheduling.isInputPending()) {\r\n          return true;\r\n        }\r\n        return currentTime >= maxYieldInterval;\r\n      } else {\r\n        return false;\r\n      }\r\n    };\r\n  } else {\r\n    shouldYieldToHost = () => performance.now() >= deadline;\r\n  }\r\n}\r\nfunction enqueue(taskQueue, task) {\r\n  function findIndex() {\r\n    let m = 0;\r\n    let n = taskQueue.length - 1;\r\n    while (m <= n) {\r\n      const k = n + m >> 1;\r\n      const cmp = task.expirationTime - taskQueue[k].expirationTime;\r\n      if (cmp > 0) m = k + 1;else if (cmp < 0) n = k - 1;else return k;\r\n    }\r\n    return m;\r\n  }\r\n  taskQueue.splice(findIndex(), 0, task);\r\n}\r\nfunction requestCallback(fn, options) {\r\n  if (!scheduleCallback) setupScheduler();\r\n  let startTime = performance.now(),\r\n    timeout = maxSigned31BitInt;\r\n  if (options && options.timeout) timeout = options.timeout;\r\n  const newTask = {\r\n    id: taskIdCounter++,\r\n    fn,\r\n    startTime,\r\n    expirationTime: startTime + timeout\r\n  };\r\n  enqueue(taskQueue, newTask);\r\n  if (!isCallbackScheduled && !isPerformingWork) {\r\n    isCallbackScheduled = true;\r\n    scheduledCallback = flushWork;\r\n    scheduleCallback();\r\n  }\r\n  return newTask;\r\n}\r\nfunction cancelCallback(task) {\r\n  task.fn = null;\r\n}\r\nfunction flushWork(hasTimeRemaining, initialTime) {\r\n  isCallbackScheduled = false;\r\n  isPerformingWork = true;\r\n  try {\r\n    return workLoop(hasTimeRemaining, initialTime);\r\n  } finally {\r\n    currentTask = null;\r\n    isPerformingWork = false;\r\n  }\r\n}\r\nfunction workLoop(hasTimeRemaining, initialTime) {\r\n  let currentTime = initialTime;\r\n  currentTask = taskQueue[0] || null;\r\n  while (currentTask !== null) {\r\n    if (currentTask.expirationTime > currentTime && (!hasTimeRemaining || shouldYieldToHost())) {\r\n      break;\r\n    }\r\n    const callback = currentTask.fn;\r\n    if (callback !== null) {\r\n      currentTask.fn = null;\r\n      const didUserCallbackTimeout = currentTask.expirationTime <= currentTime;\r\n      callback(didUserCallbackTimeout);\r\n      currentTime = performance.now();\r\n      if (currentTask === taskQueue[0]) {\r\n        taskQueue.shift();\r\n      }\r\n    } else taskQueue.shift();\r\n    currentTask = taskQueue[0] || null;\r\n  }\r\n  return currentTask !== null;\r\n}\r\n\r\nconst sharedConfig = {\r\n  context: undefined,\r\n  registry: undefined\r\n};\r\nfunction setHydrateContext(context) {\r\n  sharedConfig.context = context;\r\n}\r\nfunction nextHydrateContext() {\r\n  return {\r\n    ...sharedConfig.context,\r\n    id: `${sharedConfig.context.id}${sharedConfig.context.count++}-`,\r\n    count: 0\r\n  };\r\n}\r\n\r\nconst equalFn = (a, b) => a === b;\r\nconst $PROXY = Symbol(\"solid-proxy\");\r\nconst $TRACK = Symbol(\"solid-track\");\r\nconst $DEVCOMP = Symbol(\"solid-dev-component\");\r\nconst signalOptions = {\r\n  equals: equalFn\r\n};\r\nlet ERROR = null;\r\nlet runEffects = runQueue;\r\nconst STALE = 1;\r\nconst PENDING = 2;\r\nconst UNOWNED = {\r\n  owned: null,\r\n  cleanups: null,\r\n  context: null,\r\n  owner: null\r\n};\r\nconst NO_INIT = {};\r\nvar Owner = null;\r\nlet Transition = null;\r\nlet Scheduler = null;\r\nlet ExternalSourceConfig = null;\r\nlet Listener = null;\r\nlet Updates = null;\r\nlet Effects = null;\r\nlet ExecCount = 0;\r\nfunction createRoot(fn, detachedOwner) {\r\n  const listener = Listener,\r\n    owner = Owner,\r\n    unowned = fn.length === 0,\r\n    current = detachedOwner === undefined ? owner : detachedOwner,\r\n    root = unowned ? UNOWNED : {\r\n      owned: null,\r\n      cleanups: null,\r\n      context: current ? current.context : null,\r\n      owner: current\r\n    },\r\n    updateFn = unowned ? fn : () => fn(() => untrack(() => cleanNode(root)));\r\n  Owner = root;\r\n  Listener = null;\r\n  try {\r\n    return runUpdates(updateFn, true);\r\n  } finally {\r\n    Listener = listener;\r\n    Owner = owner;\r\n  }\r\n}\r\nfunction createSignal(value, options) {\r\n  options = options ? Object.assign({}, signalOptions, options) : signalOptions;\r\n  const s = {\r\n    value,\r\n    observers: null,\r\n    observerSlots: null,\r\n    comparator: options.equals || undefined\r\n  };\r\n  const setter = value => {\r\n    if (typeof value === \"function\") {\r\n      if (Transition && Transition.running && Transition.sources.has(s)) value = value(s.tValue);else value = value(s.value);\r\n    }\r\n    return writeSignal(s, value);\r\n  };\r\n  return [readSignal.bind(s), setter];\r\n}\r\nfunction createComputed(fn, value, options) {\r\n  const c = createComputation(fn, value, true, STALE);\r\n  if (Scheduler && Transition && Transition.running) Updates.push(c);else updateComputation(c);\r\n}\r\nfunction createRenderEffect(fn, value, options) {\r\n  const c = createComputation(fn, value, false, STALE);\r\n  if (Scheduler && Transition && Transition.running) Updates.push(c);else updateComputation(c);\r\n}\r\nfunction createEffect(fn, value, options) {\r\n  runEffects = runUserEffects;\r\n  const c = createComputation(fn, value, false, STALE),\r\n    s = SuspenseContext && useContext(SuspenseContext);\r\n  if (s) c.suspense = s;\r\n  if (!options || !options.render) c.user = true;\r\n  Effects ? Effects.push(c) : updateComputation(c);\r\n}\r\nfunction createReaction(onInvalidate, options) {\r\n  let fn;\r\n  const c = createComputation(() => {\r\n      fn ? fn() : untrack(onInvalidate);\r\n      fn = undefined;\r\n    }, undefined, false, 0),\r\n    s = SuspenseContext && useContext(SuspenseContext);\r\n  if (s) c.suspense = s;\r\n  c.user = true;\r\n  return tracking => {\r\n    fn = tracking;\r\n    updateComputation(c);\r\n  };\r\n}\r\nfunction createMemo(fn, value, options) {\r\n  options = options ? Object.assign({}, signalOptions, options) : signalOptions;\r\n  const c = createComputation(fn, value, true, 0);\r\n  c.observers = null;\r\n  c.observerSlots = null;\r\n  c.comparator = options.equals || undefined;\r\n  if (Scheduler && Transition && Transition.running) {\r\n    c.tState = STALE;\r\n    Updates.push(c);\r\n  } else updateComputation(c);\r\n  return readSignal.bind(c);\r\n}\r\nfunction isPromise(v) {\r\n  return v && typeof v === \"object\" && \"then\" in v;\r\n}\r\nfunction createResource(pSource, pFetcher, pOptions) {\r\n  let source;\r\n  let fetcher;\r\n  let options;\r\n  if (arguments.length === 2 && typeof pFetcher === \"object\" || arguments.length === 1) {\r\n    source = true;\r\n    fetcher = pSource;\r\n    options = pFetcher || {};\r\n  } else {\r\n    source = pSource;\r\n    fetcher = pFetcher;\r\n    options = pOptions || {};\r\n  }\r\n  let pr = null,\r\n    initP = NO_INIT,\r\n    id = null,\r\n    loadedUnderTransition = false,\r\n    scheduled = false,\r\n    resolved = (\"initialValue\" in options),\r\n    dynamic = typeof source === \"function\" && createMemo(source);\r\n  const contexts = new Set(),\r\n    [value, setValue] = (options.storage || createSignal)(options.initialValue),\r\n    [error, setError] = createSignal(undefined),\r\n    [track, trigger] = createSignal(undefined, {\r\n      equals: false\r\n    }),\r\n    [state, setState] = createSignal(resolved ? \"ready\" : \"unresolved\");\r\n  if (sharedConfig.context) {\r\n    id = `${sharedConfig.context.id}${sharedConfig.context.count++}`;\r\n    let v;\r\n    if (options.ssrLoadFrom === \"initial\") initP = options.initialValue;else if (sharedConfig.load && (v = sharedConfig.load(id))) initP = v;\r\n  }\r\n  function loadEnd(p, v, error, key) {\r\n    if (pr === p) {\r\n      pr = null;\r\n      key !== undefined && (resolved = true);\r\n      if ((p === initP || v === initP) && options.onHydrated) queueMicrotask(() => options.onHydrated(key, {\r\n        value: v\r\n      }));\r\n      initP = NO_INIT;\r\n      if (Transition && p && loadedUnderTransition) {\r\n        Transition.promises.delete(p);\r\n        loadedUnderTransition = false;\r\n        runUpdates(() => {\r\n          Transition.running = true;\r\n          completeLoad(v, error);\r\n        }, false);\r\n      } else completeLoad(v, error);\r\n    }\r\n    return v;\r\n  }\r\n  function completeLoad(v, err) {\r\n    runUpdates(() => {\r\n      if (err === undefined) setValue(() => v);\r\n      setState(err !== undefined ? \"errored\" : resolved ? \"ready\" : \"unresolved\");\r\n      setError(err);\r\n      for (const c of contexts.keys()) c.decrement();\r\n      contexts.clear();\r\n    }, false);\r\n  }\r\n  function read() {\r\n    const c = SuspenseContext && useContext(SuspenseContext),\r\n      v = value(),\r\n      err = error();\r\n    if (err !== undefined && !pr) throw err;\r\n    if (Listener && !Listener.user && c) {\r\n      createComputed(() => {\r\n        track();\r\n        if (pr) {\r\n          if (c.resolved && Transition && loadedUnderTransition) Transition.promises.add(pr);else if (!contexts.has(c)) {\r\n            c.increment();\r\n            contexts.add(c);\r\n          }\r\n        }\r\n      });\r\n    }\r\n    return v;\r\n  }\r\n  function load(refetching = true) {\r\n    if (refetching !== false && scheduled) return;\r\n    scheduled = false;\r\n    const lookup = dynamic ? dynamic() : source;\r\n    loadedUnderTransition = Transition && Transition.running;\r\n    if (lookup == null || lookup === false) {\r\n      loadEnd(pr, untrack(value));\r\n      return;\r\n    }\r\n    if (Transition && pr) Transition.promises.delete(pr);\r\n    const p = initP !== NO_INIT ? initP : untrack(() => fetcher(lookup, {\r\n      value: value(),\r\n      refetching\r\n    }));\r\n    if (!isPromise(p)) {\r\n      loadEnd(pr, p, undefined, lookup);\r\n      return p;\r\n    }\r\n    pr = p;\r\n    if (\"value\" in p) {\r\n      if (p.status === \"success\") loadEnd(pr, p.value, undefined, lookup);else loadEnd(pr, undefined, undefined, lookup);\r\n      return p;\r\n    }\r\n    scheduled = true;\r\n    queueMicrotask(() => scheduled = false);\r\n    runUpdates(() => {\r\n      setState(resolved ? \"refreshing\" : \"pending\");\r\n      trigger();\r\n    }, false);\r\n    return p.then(v => loadEnd(p, v, undefined, lookup), e => loadEnd(p, undefined, castError(e), lookup));\r\n  }\r\n  Object.defineProperties(read, {\r\n    state: {\r\n      get: () => state()\r\n    },\r\n    error: {\r\n      get: () => error()\r\n    },\r\n    loading: {\r\n      get() {\r\n        const s = state();\r\n        return s === \"pending\" || s === \"refreshing\";\r\n      }\r\n    },\r\n    latest: {\r\n      get() {\r\n        if (!resolved) return read();\r\n        const err = error();\r\n        if (err && !pr) throw err;\r\n        return value();\r\n      }\r\n    }\r\n  });\r\n  if (dynamic) createComputed(() => load(false));else load(false);\r\n  return [read, {\r\n    refetch: load,\r\n    mutate: setValue\r\n  }];\r\n}\r\nfunction createDeferred(source, options) {\r\n  let t,\r\n    timeout = options ? options.timeoutMs : undefined;\r\n  const node = createComputation(() => {\r\n    if (!t || !t.fn) t = requestCallback(() => setDeferred(() => node.value), timeout !== undefined ? {\r\n      timeout\r\n    } : undefined);\r\n    return source();\r\n  }, undefined, true);\r\n  const [deferred, setDeferred] = createSignal(Transition && Transition.running && Transition.sources.has(node) ? node.tValue : node.value, options);\r\n  updateComputation(node);\r\n  setDeferred(() => Transition && Transition.running && Transition.sources.has(node) ? node.tValue : node.value);\r\n  return deferred;\r\n}\r\nfunction createSelector(source, fn = equalFn, options) {\r\n  const subs = new Map();\r\n  const node = createComputation(p => {\r\n    const v = source();\r\n    for (const [key, val] of subs.entries()) if (fn(key, v) !== fn(key, p)) {\r\n      for (const c of val.values()) {\r\n        c.state = STALE;\r\n        if (c.pure) Updates.push(c);else Effects.push(c);\r\n      }\r\n    }\r\n    return v;\r\n  }, undefined, true, STALE);\r\n  updateComputation(node);\r\n  return key => {\r\n    const listener = Listener;\r\n    if (listener) {\r\n      let l;\r\n      if (l = subs.get(key)) l.add(listener);else subs.set(key, l = new Set([listener]));\r\n      onCleanup(() => {\r\n        l.delete(listener);\r\n        !l.size && subs.delete(key);\r\n      });\r\n    }\r\n    return fn(key, Transition && Transition.running && Transition.sources.has(node) ? node.tValue : node.value);\r\n  };\r\n}\r\nfunction batch(fn) {\r\n  return runUpdates(fn, false);\r\n}\r\nfunction untrack(fn) {\r\n  if (!ExternalSourceConfig && Listener === null) return fn();\r\n  const listener = Listener;\r\n  Listener = null;\r\n  try {\r\n    if (ExternalSourceConfig) return ExternalSourceConfig.untrack(fn);\r\n    return fn();\r\n  } finally {\r\n    Listener = listener;\r\n  }\r\n}\r\nfunction on(deps, fn, options) {\r\n  const isArray = Array.isArray(deps);\r\n  let prevInput;\r\n  let defer = options && options.defer;\r\n  return prevValue => {\r\n    let input;\r\n    if (isArray) {\r\n      input = Array(deps.length);\r\n      for (let i = 0; i < deps.length; i++) input[i] = deps[i]();\r\n    } else input = deps();\r\n    if (defer) {\r\n      defer = false;\r\n      return prevValue;\r\n    }\r\n    const result = untrack(() => fn(input, prevInput, prevValue));\r\n    prevInput = input;\r\n    return result;\r\n  };\r\n}\r\nfunction onMount(fn) {\r\n  createEffect(() => untrack(fn));\r\n}\r\nfunction onCleanup(fn) {\r\n  if (Owner === null) ;else if (Owner.cleanups === null) Owner.cleanups = [fn];else Owner.cleanups.push(fn);\r\n  return fn;\r\n}\r\nfunction catchError(fn, handler) {\r\n  ERROR || (ERROR = Symbol(\"error\"));\r\n  Owner = createComputation(undefined, undefined, true);\r\n  Owner.context = {\r\n    ...Owner.context,\r\n    [ERROR]: [handler]\r\n  };\r\n  if (Transition && Transition.running) Transition.sources.add(Owner);\r\n  try {\r\n    return fn();\r\n  } catch (err) {\r\n    handleError(err);\r\n  } finally {\r\n    Owner = Owner.owner;\r\n  }\r\n}\r\nfunction getListener() {\r\n  return Listener;\r\n}\r\nfunction getOwner() {\r\n  return Owner;\r\n}\r\nfunction runWithOwner(o, fn) {\r\n  const prev = Owner;\r\n  const prevListener = Listener;\r\n  Owner = o;\r\n  Listener = null;\r\n  try {\r\n    return runUpdates(fn, true);\r\n  } catch (err) {\r\n    handleError(err);\r\n  } finally {\r\n    Owner = prev;\r\n    Listener = prevListener;\r\n  }\r\n}\r\nfunction enableScheduling(scheduler = requestCallback) {\r\n  Scheduler = scheduler;\r\n}\r\nfunction startTransition(fn) {\r\n  if (Transition && Transition.running) {\r\n    fn();\r\n    return Transition.done;\r\n  }\r\n  const l = Listener;\r\n  const o = Owner;\r\n  return Promise.resolve().then(() => {\r\n    Listener = l;\r\n    Owner = o;\r\n    let t;\r\n    if (Scheduler || SuspenseContext) {\r\n      t = Transition || (Transition = {\r\n        sources: new Set(),\r\n        effects: [],\r\n        promises: new Set(),\r\n        disposed: new Set(),\r\n        queue: new Set(),\r\n        running: true\r\n      });\r\n      t.done || (t.done = new Promise(res => t.resolve = res));\r\n      t.running = true;\r\n    }\r\n    runUpdates(fn, false);\r\n    Listener = Owner = null;\r\n    return t ? t.done : undefined;\r\n  });\r\n}\r\nconst [transPending, setTransPending] = /*@__PURE__*/createSignal(false);\r\nfunction useTransition() {\r\n  return [transPending, startTransition];\r\n}\r\nfunction resumeEffects(e) {\r\n  Effects.push.apply(Effects, e);\r\n  e.length = 0;\r\n}\r\nfunction createContext(defaultValue, options) {\r\n  const id = Symbol(\"context\");\r\n  return {\r\n    id,\r\n    Provider: createProvider(id),\r\n    defaultValue\r\n  };\r\n}\r\nfunction useContext(context) {\r\n  return Owner && Owner.context && Owner.context[context.id] !== undefined ? Owner.context[context.id] : context.defaultValue;\r\n}\r\nfunction children(fn) {\r\n  const children = createMemo(fn);\r\n  const memo = createMemo(() => resolveChildren(children()));\r\n  memo.toArray = () => {\r\n    const c = memo();\r\n    return Array.isArray(c) ? c : c != null ? [c] : [];\r\n  };\r\n  return memo;\r\n}\r\nlet SuspenseContext;\r\nfunction getSuspenseContext() {\r\n  return SuspenseContext || (SuspenseContext = createContext());\r\n}\r\nfunction enableExternalSource(factory, untrack = fn => fn()) {\r\n  if (ExternalSourceConfig) {\r\n    const {\r\n      factory: oldFactory,\r\n      untrack: oldUntrack\r\n    } = ExternalSourceConfig;\r\n    ExternalSourceConfig = {\r\n      factory: (fn, trigger) => {\r\n        const oldSource = oldFactory(fn, trigger);\r\n        const source = factory(x => oldSource.track(x), trigger);\r\n        return {\r\n          track: x => source.track(x),\r\n          dispose() {\r\n            source.dispose();\r\n            oldSource.dispose();\r\n          }\r\n        };\r\n      },\r\n      untrack: fn => oldUntrack(() => untrack(fn))\r\n    };\r\n  } else {\r\n    ExternalSourceConfig = {\r\n      factory,\r\n      untrack\r\n    };\r\n  }\r\n}\r\nfunction readSignal() {\r\n  const runningTransition = Transition && Transition.running;\r\n  if (this.sources && (runningTransition ? this.tState : this.state)) {\r\n    if ((runningTransition ? this.tState : this.state) === STALE) updateComputation(this);else {\r\n      const updates = Updates;\r\n      Updates = null;\r\n      runUpdates(() => lookUpstream(this), false);\r\n      Updates = updates;\r\n    }\r\n  }\r\n  if (Listener) {\r\n    const sSlot = this.observers ? this.observers.length : 0;\r\n    if (!Listener.sources) {\r\n      Listener.sources = [this];\r\n      Listener.sourceSlots = [sSlot];\r\n    } else {\r\n      Listener.sources.push(this);\r\n      Listener.sourceSlots.push(sSlot);\r\n    }\r\n    if (!this.observers) {\r\n      this.observers = [Listener];\r\n      this.observerSlots = [Listener.sources.length - 1];\r\n    } else {\r\n      this.observers.push(Listener);\r\n      this.observerSlots.push(Listener.sources.length - 1);\r\n    }\r\n  }\r\n  if (runningTransition && Transition.sources.has(this)) return this.tValue;\r\n  return this.value;\r\n}\r\nfunction writeSignal(node, value, isComp) {\r\n  let current = Transition && Transition.running && Transition.sources.has(node) ? node.tValue : node.value;\r\n  if (!node.comparator || !node.comparator(current, value)) {\r\n    if (Transition) {\r\n      const TransitionRunning = Transition.running;\r\n      if (TransitionRunning || !isComp && Transition.sources.has(node)) {\r\n        Transition.sources.add(node);\r\n        node.tValue = value;\r\n      }\r\n      if (!TransitionRunning) node.value = value;\r\n    } else node.value = value;\r\n    if (node.observers && node.observers.length) {\r\n      runUpdates(() => {\r\n        for (let i = 0; i < node.observers.length; i += 1) {\r\n          const o = node.observers[i];\r\n          const TransitionRunning = Transition && Transition.running;\r\n          if (TransitionRunning && Transition.disposed.has(o)) continue;\r\n          if (TransitionRunning ? !o.tState : !o.state) {\r\n            if (o.pure) Updates.push(o);else Effects.push(o);\r\n            if (o.observers) markDownstream(o);\r\n          }\r\n          if (!TransitionRunning) o.state = STALE;else o.tState = STALE;\r\n        }\r\n        if (Updates.length > 10e5) {\r\n          Updates = [];\r\n          if (false) ;\r\n          throw new Error();\r\n        }\r\n      }, false);\r\n    }\r\n  }\r\n  return value;\r\n}\r\nfunction updateComputation(node) {\r\n  if (!node.fn) return;\r\n  cleanNode(node);\r\n  const time = ExecCount;\r\n  runComputation(node, Transition && Transition.running && Transition.sources.has(node) ? node.tValue : node.value, time);\r\n  if (Transition && !Transition.running && Transition.sources.has(node)) {\r\n    queueMicrotask(() => {\r\n      runUpdates(() => {\r\n        Transition && (Transition.running = true);\r\n        Listener = Owner = node;\r\n        runComputation(node, node.tValue, time);\r\n        Listener = Owner = null;\r\n      }, false);\r\n    });\r\n  }\r\n}\r\nfunction runComputation(node, value, time) {\r\n  let nextValue;\r\n  const owner = Owner,\r\n    listener = Listener;\r\n  Listener = Owner = node;\r\n  try {\r\n    nextValue = node.fn(value);\r\n  } catch (err) {\r\n    if (node.pure) {\r\n      if (Transition && Transition.running) {\r\n        node.tState = STALE;\r\n        node.tOwned && node.tOwned.forEach(cleanNode);\r\n        node.tOwned = undefined;\r\n      } else {\r\n        node.state = STALE;\r\n        node.owned && node.owned.forEach(cleanNode);\r\n        node.owned = null;\r\n      }\r\n    }\r\n    node.updatedAt = time + 1;\r\n    return handleError(err);\r\n  } finally {\r\n    Listener = listener;\r\n    Owner = owner;\r\n  }\r\n  if (!node.updatedAt || node.updatedAt <= time) {\r\n    if (node.updatedAt != null && \"observers\" in node) {\r\n      writeSignal(node, nextValue, true);\r\n    } else if (Transition && Transition.running && node.pure) {\r\n      Transition.sources.add(node);\r\n      node.tValue = nextValue;\r\n    } else node.value = nextValue;\r\n    node.updatedAt = time;\r\n  }\r\n}\r\nfunction createComputation(fn, init, pure, state = STALE, options) {\r\n  const c = {\r\n    fn,\r\n    state: state,\r\n    updatedAt: null,\r\n    owned: null,\r\n    sources: null,\r\n    sourceSlots: null,\r\n    cleanups: null,\r\n    value: init,\r\n    owner: Owner,\r\n    context: Owner ? Owner.context : null,\r\n    pure\r\n  };\r\n  if (Transition && Transition.running) {\r\n    c.state = 0;\r\n    c.tState = state;\r\n  }\r\n  if (Owner === null) ;else if (Owner !== UNOWNED) {\r\n    if (Transition && Transition.running && Owner.pure) {\r\n      if (!Owner.tOwned) Owner.tOwned = [c];else Owner.tOwned.push(c);\r\n    } else {\r\n      if (!Owner.owned) Owner.owned = [c];else Owner.owned.push(c);\r\n    }\r\n  }\r\n  if (ExternalSourceConfig && c.fn) {\r\n    const [track, trigger] = createSignal(undefined, {\r\n      equals: false\r\n    });\r\n    const ordinary = ExternalSourceConfig.factory(c.fn, trigger);\r\n    onCleanup(() => ordinary.dispose());\r\n    const triggerInTransition = () => startTransition(trigger).then(() => inTransition.dispose());\r\n    const inTransition = ExternalSourceConfig.factory(c.fn, triggerInTransition);\r\n    c.fn = x => {\r\n      track();\r\n      return Transition && Transition.running ? inTransition.track(x) : ordinary.track(x);\r\n    };\r\n  }\r\n  return c;\r\n}\r\nfunction runTop(node) {\r\n  const runningTransition = Transition && Transition.running;\r\n  if ((runningTransition ? node.tState : node.state) === 0) return;\r\n  if ((runningTransition ? node.tState : node.state) === PENDING) return lookUpstream(node);\r\n  if (node.suspense && untrack(node.suspense.inFallback)) return node.suspense.effects.push(node);\r\n  const ancestors = [node];\r\n  while ((node = node.owner) && (!node.updatedAt || node.updatedAt < ExecCount)) {\r\n    if (runningTransition && Transition.disposed.has(node)) return;\r\n    if (runningTransition ? node.tState : node.state) ancestors.push(node);\r\n  }\r\n  for (let i = ancestors.length - 1; i >= 0; i--) {\r\n    node = ancestors[i];\r\n    if (runningTransition) {\r\n      let top = node,\r\n        prev = ancestors[i + 1];\r\n      while ((top = top.owner) && top !== prev) {\r\n        if (Transition.disposed.has(top)) return;\r\n      }\r\n    }\r\n    if ((runningTransition ? node.tState : node.state) === STALE) {\r\n      updateComputation(node);\r\n    } else if ((runningTransition ? node.tState : node.state) === PENDING) {\r\n      const updates = Updates;\r\n      Updates = null;\r\n      runUpdates(() => lookUpstream(node, ancestors[0]), false);\r\n      Updates = updates;\r\n    }\r\n  }\r\n}\r\nfunction runUpdates(fn, init) {\r\n  if (Updates) return fn();\r\n  let wait = false;\r\n  if (!init) Updates = [];\r\n  if (Effects) wait = true;else Effects = [];\r\n  ExecCount++;\r\n  try {\r\n    const res = fn();\r\n    completeUpdates(wait);\r\n    return res;\r\n  } catch (err) {\r\n    if (!wait) Effects = null;\r\n    Updates = null;\r\n    handleError(err);\r\n  }\r\n}\r\nfunction completeUpdates(wait) {\r\n  if (Updates) {\r\n    if (Scheduler && Transition && Transition.running) scheduleQueue(Updates);else runQueue(Updates);\r\n    Updates = null;\r\n  }\r\n  if (wait) return;\r\n  let res;\r\n  if (Transition) {\r\n    if (!Transition.promises.size && !Transition.queue.size) {\r\n      const sources = Transition.sources;\r\n      const disposed = Transition.disposed;\r\n      Effects.push.apply(Effects, Transition.effects);\r\n      res = Transition.resolve;\r\n      for (const e of Effects) {\r\n        \"tState\" in e && (e.state = e.tState);\r\n        delete e.tState;\r\n      }\r\n      Transition = null;\r\n      runUpdates(() => {\r\n        for (const d of disposed) cleanNode(d);\r\n        for (const v of sources) {\r\n          v.value = v.tValue;\r\n          if (v.owned) {\r\n            for (let i = 0, len = v.owned.length; i < len; i++) cleanNode(v.owned[i]);\r\n          }\r\n          if (v.tOwned) v.owned = v.tOwned;\r\n          delete v.tValue;\r\n          delete v.tOwned;\r\n          v.tState = 0;\r\n        }\r\n        setTransPending(false);\r\n      }, false);\r\n    } else if (Transition.running) {\r\n      Transition.running = false;\r\n      Transition.effects.push.apply(Transition.effects, Effects);\r\n      Effects = null;\r\n      setTransPending(true);\r\n      return;\r\n    }\r\n  }\r\n  const e = Effects;\r\n  Effects = null;\r\n  if (e.length) runUpdates(() => runEffects(e), false);\r\n  if (res) res();\r\n}\r\nfunction runQueue(queue) {\r\n  for (let i = 0; i < queue.length; i++) runTop(queue[i]);\r\n}\r\nfunction scheduleQueue(queue) {\r\n  for (let i = 0; i < queue.length; i++) {\r\n    const item = queue[i];\r\n    const tasks = Transition.queue;\r\n    if (!tasks.has(item)) {\r\n      tasks.add(item);\r\n      Scheduler(() => {\r\n        tasks.delete(item);\r\n        runUpdates(() => {\r\n          Transition.running = true;\r\n          runTop(item);\r\n        }, false);\r\n        Transition && (Transition.running = false);\r\n      });\r\n    }\r\n  }\r\n}\r\nfunction runUserEffects(queue) {\r\n  let i,\r\n    userLength = 0;\r\n  for (i = 0; i < queue.length; i++) {\r\n    const e = queue[i];\r\n    if (!e.user) runTop(e);else queue[userLength++] = e;\r\n  }\r\n  if (sharedConfig.context) {\r\n    if (sharedConfig.count) {\r\n      sharedConfig.effects || (sharedConfig.effects = []);\r\n      sharedConfig.effects.push(...queue.slice(0, userLength));\r\n      return;\r\n    } else if (sharedConfig.effects) {\r\n      queue = [...sharedConfig.effects, ...queue];\r\n      userLength += sharedConfig.effects.length;\r\n      delete sharedConfig.effects;\r\n    }\r\n    setHydrateContext();\r\n  }\r\n  for (i = 0; i < userLength; i++) runTop(queue[i]);\r\n}\r\nfunction lookUpstream(node, ignore) {\r\n  const runningTransition = Transition && Transition.running;\r\n  if (runningTransition) node.tState = 0;else node.state = 0;\r\n  for (let i = 0; i < node.sources.length; i += 1) {\r\n    const source = node.sources[i];\r\n    if (source.sources) {\r\n      const state = runningTransition ? source.tState : source.state;\r\n      if (state === STALE) {\r\n        if (source !== ignore && (!source.updatedAt || source.updatedAt < ExecCount)) runTop(source);\r\n      } else if (state === PENDING) lookUpstream(source, ignore);\r\n    }\r\n  }\r\n}\r\nfunction markDownstream(node) {\r\n  const runningTransition = Transition && Transition.running;\r\n  for (let i = 0; i < node.observers.length; i += 1) {\r\n    const o = node.observers[i];\r\n    if (runningTransition ? !o.tState : !o.state) {\r\n      if (runningTransition) o.tState = PENDING;else o.state = PENDING;\r\n      if (o.pure) Updates.push(o);else Effects.push(o);\r\n      o.observers && markDownstream(o);\r\n    }\r\n  }\r\n}\r\nfunction cleanNode(node) {\r\n  let i;\r\n  if (node.sources) {\r\n    while (node.sources.length) {\r\n      const source = node.sources.pop(),\r\n        index = node.sourceSlots.pop(),\r\n        obs = source.observers;\r\n      if (obs && obs.length) {\r\n        const n = obs.pop(),\r\n          s = source.observerSlots.pop();\r\n        if (index < obs.length) {\r\n          n.sourceSlots[s] = index;\r\n          obs[index] = n;\r\n          source.observerSlots[index] = s;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  if (Transition && Transition.running && node.pure) {\r\n    if (node.tOwned) {\r\n      for (i = node.tOwned.length - 1; i >= 0; i--) cleanNode(node.tOwned[i]);\r\n      delete node.tOwned;\r\n    }\r\n    reset(node, true);\r\n  } else if (node.owned) {\r\n    for (i = node.owned.length - 1; i >= 0; i--) cleanNode(node.owned[i]);\r\n    node.owned = null;\r\n  }\r\n  if (node.cleanups) {\r\n    for (i = node.cleanups.length - 1; i >= 0; i--) node.cleanups[i]();\r\n    node.cleanups = null;\r\n  }\r\n  if (Transition && Transition.running) node.tState = 0;else node.state = 0;\r\n}\r\nfunction reset(node, top) {\r\n  if (!top) {\r\n    node.tState = 0;\r\n    Transition.disposed.add(node);\r\n  }\r\n  if (node.owned) {\r\n    for (let i = 0; i < node.owned.length; i++) reset(node.owned[i]);\r\n  }\r\n}\r\nfunction castError(err) {\r\n  if (err instanceof Error) return err;\r\n  return new Error(typeof err === \"string\" ? err : \"Unknown error\", {\r\n    cause: err\r\n  });\r\n}\r\nfunction runErrors(err, fns, owner) {\r\n  try {\r\n    for (const f of fns) f(err);\r\n  } catch (e) {\r\n    handleError(e, owner && owner.owner || null);\r\n  }\r\n}\r\nfunction handleError(err, owner = Owner) {\r\n  const fns = ERROR && owner && owner.context && owner.context[ERROR];\r\n  const error = castError(err);\r\n  if (!fns) {\r\n    console.error(\"solid error\", error);\r\n    return;\r\n  }\r\n  if (Effects) Effects.push({\r\n    fn() {\r\n      runErrors(error, fns, owner);\r\n    },\r\n    state: STALE\r\n  });else runErrors(error, fns, owner);\r\n}\r\nfunction resolveChildren(children) {\r\n  if (typeof children === \"function\" && !children.length) return resolveChildren(children());\r\n  if (Array.isArray(children)) {\r\n    const results = [];\r\n    for (let i = 0; i < children.length; i++) {\r\n      const result = resolveChildren(children[i]);\r\n      Array.isArray(result) ? results.push.apply(results, result) : results.push(result);\r\n    }\r\n    return results;\r\n  }\r\n  return children;\r\n}\r\nfunction createProvider(id, options) {\r\n  return function provider(props) {\r\n    let res;\r\n    createRenderEffect(() => res = untrack(() => {\r\n      Owner.context = {\r\n        ...Owner.context,\r\n        [id]: props.value\r\n      };\r\n      return children(() => props.children);\r\n    }), undefined);\r\n    return res;\r\n  };\r\n}\r\nfunction onError(fn) {\r\n  ERROR || (ERROR = Symbol(\"error\"));\r\n  if (Owner === null) ;else if (Owner.context === null || !Owner.context[ERROR]) {\r\n    Owner.context = {\r\n      ...Owner.context,\r\n      [ERROR]: [fn]\r\n    };\r\n    mutateContext(Owner, ERROR, [fn]);\r\n  } else Owner.context[ERROR].push(fn);\r\n}\r\nfunction mutateContext(o, key, value) {\r\n  if (o.owned) {\r\n    for (let i = 0; i < o.owned.length; i++) {\r\n      if (o.owned[i].context === o.context) mutateContext(o.owned[i], key, value);\r\n      if (!o.owned[i].context) {\r\n        o.owned[i].context = o.context;\r\n        mutateContext(o.owned[i], key, value);\r\n      } else if (!o.owned[i].context[key]) {\r\n        o.owned[i].context[key] = value;\r\n        mutateContext(o.owned[i], key, value);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction observable(input) {\r\n  return {\r\n    subscribe(observer) {\r\n      if (!(observer instanceof Object) || observer == null) {\r\n        throw new TypeError(\"Expected the observer to be an object.\");\r\n      }\r\n      const handler = typeof observer === \"function\" ? observer : observer.next && observer.next.bind(observer);\r\n      if (!handler) {\r\n        return {\r\n          unsubscribe() {}\r\n        };\r\n      }\r\n      const dispose = createRoot(disposer => {\r\n        createEffect(() => {\r\n          const v = input();\r\n          untrack(() => handler(v));\r\n        });\r\n        return disposer;\r\n      });\r\n      if (getOwner()) onCleanup(dispose);\r\n      return {\r\n        unsubscribe() {\r\n          dispose();\r\n        }\r\n      };\r\n    },\r\n    [Symbol.observable || \"@@observable\"]() {\r\n      return this;\r\n    }\r\n  };\r\n}\r\nfunction from(producer) {\r\n  const [s, set] = createSignal(undefined, {\r\n    equals: false\r\n  });\r\n  if (\"subscribe\" in producer) {\r\n    const unsub = producer.subscribe(v => set(() => v));\r\n    onCleanup(() => \"unsubscribe\" in unsub ? unsub.unsubscribe() : unsub());\r\n  } else {\r\n    const clean = producer(set);\r\n    onCleanup(clean);\r\n  }\r\n  return s;\r\n}\r\n\r\nconst FALLBACK = Symbol(\"fallback\");\r\nfunction dispose(d) {\r\n  for (let i = 0; i < d.length; i++) d[i]();\r\n}\r\nfunction mapArray(list, mapFn, options = {}) {\r\n  let items = [],\r\n    mapped = [],\r\n    disposers = [],\r\n    len = 0,\r\n    indexes = mapFn.length > 1 ? [] : null;\r\n  onCleanup(() => dispose(disposers));\r\n  return () => {\r\n    let newItems = list() || [],\r\n      i,\r\n      j;\r\n    newItems[$TRACK];\r\n    return untrack(() => {\r\n      let newLen = newItems.length,\r\n        newIndices,\r\n        newIndicesNext,\r\n        temp,\r\n        tempdisposers,\r\n        tempIndexes,\r\n        start,\r\n        end,\r\n        newEnd,\r\n        item;\r\n      if (newLen === 0) {\r\n        if (len !== 0) {\r\n          dispose(disposers);\r\n          disposers = [];\r\n          items = [];\r\n          mapped = [];\r\n          len = 0;\r\n          indexes && (indexes = []);\r\n        }\r\n        if (options.fallback) {\r\n          items = [FALLBACK];\r\n          mapped[0] = createRoot(disposer => {\r\n            disposers[0] = disposer;\r\n            return options.fallback();\r\n          });\r\n          len = 1;\r\n        }\r\n      }\r\n      else if (len === 0) {\r\n        mapped = new Array(newLen);\r\n        for (j = 0; j < newLen; j++) {\r\n          items[j] = newItems[j];\r\n          mapped[j] = createRoot(mapper);\r\n        }\r\n        len = newLen;\r\n      } else {\r\n        temp = new Array(newLen);\r\n        tempdisposers = new Array(newLen);\r\n        indexes && (tempIndexes = new Array(newLen));\r\n        for (start = 0, end = Math.min(len, newLen); start < end && items[start] === newItems[start]; start++);\r\n        for (end = len - 1, newEnd = newLen - 1; end >= start && newEnd >= start && items[end] === newItems[newEnd]; end--, newEnd--) {\r\n          temp[newEnd] = mapped[end];\r\n          tempdisposers[newEnd] = disposers[end];\r\n          indexes && (tempIndexes[newEnd] = indexes[end]);\r\n        }\r\n        newIndices = new Map();\r\n        newIndicesNext = new Array(newEnd + 1);\r\n        for (j = newEnd; j >= start; j--) {\r\n          item = newItems[j];\r\n          i = newIndices.get(item);\r\n          newIndicesNext[j] = i === undefined ? -1 : i;\r\n          newIndices.set(item, j);\r\n        }\r\n        for (i = start; i <= end; i++) {\r\n          item = items[i];\r\n          j = newIndices.get(item);\r\n          if (j !== undefined && j !== -1) {\r\n            temp[j] = mapped[i];\r\n            tempdisposers[j] = disposers[i];\r\n            indexes && (tempIndexes[j] = indexes[i]);\r\n            j = newIndicesNext[j];\r\n            newIndices.set(item, j);\r\n          } else disposers[i]();\r\n        }\r\n        for (j = start; j < newLen; j++) {\r\n          if (j in temp) {\r\n            mapped[j] = temp[j];\r\n            disposers[j] = tempdisposers[j];\r\n            if (indexes) {\r\n              indexes[j] = tempIndexes[j];\r\n              indexes[j](j);\r\n            }\r\n          } else mapped[j] = createRoot(mapper);\r\n        }\r\n        mapped = mapped.slice(0, len = newLen);\r\n        items = newItems.slice(0);\r\n      }\r\n      return mapped;\r\n    });\r\n    function mapper(disposer) {\r\n      disposers[j] = disposer;\r\n      if (indexes) {\r\n        const [s, set] = createSignal(j);\r\n        indexes[j] = set;\r\n        return mapFn(newItems[j], s);\r\n      }\r\n      return mapFn(newItems[j]);\r\n    }\r\n  };\r\n}\r\nfunction indexArray(list, mapFn, options = {}) {\r\n  let items = [],\r\n    mapped = [],\r\n    disposers = [],\r\n    signals = [],\r\n    len = 0,\r\n    i;\r\n  onCleanup(() => dispose(disposers));\r\n  return () => {\r\n    const newItems = list() || [];\r\n    newItems[$TRACK];\r\n    return untrack(() => {\r\n      if (newItems.length === 0) {\r\n        if (len !== 0) {\r\n          dispose(disposers);\r\n          disposers = [];\r\n          items = [];\r\n          mapped = [];\r\n          len = 0;\r\n          signals = [];\r\n        }\r\n        if (options.fallback) {\r\n          items = [FALLBACK];\r\n          mapped[0] = createRoot(disposer => {\r\n            disposers[0] = disposer;\r\n            return options.fallback();\r\n          });\r\n          len = 1;\r\n        }\r\n        return mapped;\r\n      }\r\n      if (items[0] === FALLBACK) {\r\n        disposers[0]();\r\n        disposers = [];\r\n        items = [];\r\n        mapped = [];\r\n        len = 0;\r\n      }\r\n      for (i = 0; i < newItems.length; i++) {\r\n        if (i < items.length && items[i] !== newItems[i]) {\r\n          signals[i](() => newItems[i]);\r\n        } else if (i >= items.length) {\r\n          mapped[i] = createRoot(mapper);\r\n        }\r\n      }\r\n      for (; i < items.length; i++) {\r\n        disposers[i]();\r\n      }\r\n      len = signals.length = disposers.length = newItems.length;\r\n      items = newItems.slice(0);\r\n      return mapped = mapped.slice(0, len);\r\n    });\r\n    function mapper(disposer) {\r\n      disposers[i] = disposer;\r\n      const [s, set] = createSignal(newItems[i]);\r\n      signals[i] = set;\r\n      return mapFn(s, i);\r\n    }\r\n  };\r\n}\r\n\r\nlet hydrationEnabled = false;\r\nfunction enableHydration() {\r\n  hydrationEnabled = true;\r\n}\r\nfunction createComponent(Comp, props) {\r\n  if (hydrationEnabled) {\r\n    if (sharedConfig.context) {\r\n      const c = sharedConfig.context;\r\n      setHydrateContext(nextHydrateContext());\r\n      const r = untrack(() => Comp(props || {}));\r\n      setHydrateContext(c);\r\n      return r;\r\n    }\r\n  }\r\n  return untrack(() => Comp(props || {}));\r\n}\r\nfunction trueFn() {\r\n  return true;\r\n}\r\nconst propTraps = {\r\n  get(_, property, receiver) {\r\n    if (property === $PROXY) return receiver;\r\n    return _.get(property);\r\n  },\r\n  has(_, property) {\r\n    if (property === $PROXY) return true;\r\n    return _.has(property);\r\n  },\r\n  set: trueFn,\r\n  deleteProperty: trueFn,\r\n  getOwnPropertyDescriptor(_, property) {\r\n    return {\r\n      configurable: true,\r\n      enumerable: true,\r\n      get() {\r\n        return _.get(property);\r\n      },\r\n      set: trueFn,\r\n      deleteProperty: trueFn\r\n    };\r\n  },\r\n  ownKeys(_) {\r\n    return _.keys();\r\n  }\r\n};\r\nfunction resolveSource(s) {\r\n  return !(s = typeof s === \"function\" ? s() : s) ? {} : s;\r\n}\r\nfunction resolveSources() {\r\n  for (let i = 0, length = this.length; i < length; ++i) {\r\n    const v = this[i]();\r\n    if (v !== undefined) return v;\r\n  }\r\n}\r\nfunction mergeProps(...sources) {\r\n  let proxy = false;\r\n  for (let i = 0; i < sources.length; i++) {\r\n    const s = sources[i];\r\n    proxy = proxy || !!s && $PROXY in s;\r\n    sources[i] = typeof s === \"function\" ? (proxy = true, createMemo(s)) : s;\r\n  }\r\n  if (proxy) {\r\n    return new Proxy({\r\n      get(property) {\r\n        for (let i = sources.length - 1; i >= 0; i--) {\r\n          const v = resolveSource(sources[i])[property];\r\n          if (v !== undefined) return v;\r\n        }\r\n      },\r\n      has(property) {\r\n        for (let i = sources.length - 1; i >= 0; i--) {\r\n          if (property in resolveSource(sources[i])) return true;\r\n        }\r\n        return false;\r\n      },\r\n      keys() {\r\n        const keys = [];\r\n        for (let i = 0; i < sources.length; i++) keys.push(...Object.keys(resolveSource(sources[i])));\r\n        return [...new Set(keys)];\r\n      }\r\n    }, propTraps);\r\n  }\r\n  const sourcesMap = {};\r\n  const defined = Object.create(null);\r\n  for (let i = sources.length - 1; i >= 0; i--) {\r\n    const source = sources[i];\r\n    if (!source) continue;\r\n    const sourceKeys = Object.getOwnPropertyNames(source);\r\n    for (let i = sourceKeys.length - 1; i >= 0; i--) {\r\n      const key = sourceKeys[i];\r\n      if (key === \"__proto__\" || key === \"constructor\") continue;\r\n      const desc = Object.getOwnPropertyDescriptor(source, key);\r\n      if (!defined[key]) {\r\n        defined[key] = desc.get ? {\r\n          enumerable: true,\r\n          configurable: true,\r\n          get: resolveSources.bind(sourcesMap[key] = [desc.get.bind(source)])\r\n        } : desc.value !== undefined ? desc : undefined;\r\n      } else {\r\n        const sources = sourcesMap[key];\r\n        if (sources) {\r\n          if (desc.get) sources.push(desc.get.bind(source));else if (desc.value !== undefined) sources.push(() => desc.value);\r\n        }\r\n      }\r\n    }\r\n  }\r\n  const target = {};\r\n  const definedKeys = Object.keys(defined);\r\n  for (let i = definedKeys.length - 1; i >= 0; i--) {\r\n    const key = definedKeys[i],\r\n      desc = defined[key];\r\n    if (desc && desc.get) Object.defineProperty(target, key, desc);else target[key] = desc ? desc.value : undefined;\r\n  }\r\n  return target;\r\n}\r\nfunction splitProps(props, ...keys) {\r\n  if ($PROXY in props) {\r\n    const blocked = new Set(keys.length > 1 ? keys.flat() : keys[0]);\r\n    const res = keys.map(k => {\r\n      return new Proxy({\r\n        get(property) {\r\n          return k.includes(property) ? props[property] : undefined;\r\n        },\r\n        has(property) {\r\n          return k.includes(property) && property in props;\r\n        },\r\n        keys() {\r\n          return k.filter(property => property in props);\r\n        }\r\n      }, propTraps);\r\n    });\r\n    res.push(new Proxy({\r\n      get(property) {\r\n        return blocked.has(property) ? undefined : props[property];\r\n      },\r\n      has(property) {\r\n        return blocked.has(property) ? false : property in props;\r\n      },\r\n      keys() {\r\n        return Object.keys(props).filter(k => !blocked.has(k));\r\n      }\r\n    }, propTraps));\r\n    return res;\r\n  }\r\n  const otherObject = {};\r\n  const objects = keys.map(() => ({}));\r\n  for (const propName of Object.getOwnPropertyNames(props)) {\r\n    const desc = Object.getOwnPropertyDescriptor(props, propName);\r\n    const isDefaultDesc = !desc.get && !desc.set && desc.enumerable && desc.writable && desc.configurable;\r\n    let blocked = false;\r\n    let objectIndex = 0;\r\n    for (const k of keys) {\r\n      if (k.includes(propName)) {\r\n        blocked = true;\r\n        isDefaultDesc ? objects[objectIndex][propName] = desc.value : Object.defineProperty(objects[objectIndex], propName, desc);\r\n      }\r\n      ++objectIndex;\r\n    }\r\n    if (!blocked) {\r\n      isDefaultDesc ? otherObject[propName] = desc.value : Object.defineProperty(otherObject, propName, desc);\r\n    }\r\n  }\r\n  return [...objects, otherObject];\r\n}\r\nfunction lazy(fn) {\r\n  let comp;\r\n  let p;\r\n  const wrap = props => {\r\n    const ctx = sharedConfig.context;\r\n    if (ctx) {\r\n      const [s, set] = createSignal();\r\n      sharedConfig.count || (sharedConfig.count = 0);\r\n      sharedConfig.count++;\r\n      (p || (p = fn())).then(mod => {\r\n        setHydrateContext(ctx);\r\n        sharedConfig.count--;\r\n        set(() => mod.default);\r\n        setHydrateContext();\r\n      });\r\n      comp = s;\r\n    } else if (!comp) {\r\n      const [s] = createResource(() => (p || (p = fn())).then(mod => mod.default));\r\n      comp = s;\r\n    }\r\n    let Comp;\r\n    return createMemo(() => (Comp = comp()) && untrack(() => {\r\n      if (false) ;\r\n      if (!ctx) return Comp(props);\r\n      const c = sharedConfig.context;\r\n      setHydrateContext(ctx);\r\n      const r = Comp(props);\r\n      setHydrateContext(c);\r\n      return r;\r\n    }));\r\n  };\r\n  wrap.preload = () => p || ((p = fn()).then(mod => comp = () => mod.default), p);\r\n  return wrap;\r\n}\r\nlet counter = 0;\r\nfunction createUniqueId() {\r\n  const ctx = sharedConfig.context;\r\n  return ctx ? `${ctx.id}${ctx.count++}` : `cl-${counter++}`;\r\n}\r\n\r\nconst narrowedError = name => `Stale read from <${name}>.`;\r\nfunction For(props) {\r\n  const fallback = \"fallback\" in props && {\r\n    fallback: () => props.fallback\r\n  };\r\n  return createMemo(mapArray(() => props.each, props.children, fallback || undefined));\r\n}\r\nfunction Index(props) {\r\n  const fallback = \"fallback\" in props && {\r\n    fallback: () => props.fallback\r\n  };\r\n  return createMemo(indexArray(() => props.each, props.children, fallback || undefined));\r\n}\r\nfunction Show(props) {\r\n  const keyed = props.keyed;\r\n  const condition = createMemo(() => props.when, undefined, {\r\n    equals: (a, b) => keyed ? a === b : !a === !b\r\n  });\r\n  return createMemo(() => {\r\n    const c = condition();\r\n    if (c) {\r\n      const child = props.children;\r\n      const fn = typeof child === \"function\" && child.length > 0;\r\n      return fn ? untrack(() => child(keyed ? c : () => {\r\n        if (!untrack(condition)) throw narrowedError(\"Show\");\r\n        return props.when;\r\n      })) : child;\r\n    }\r\n    return props.fallback;\r\n  }, undefined, undefined);\r\n}\r\nfunction Switch(props) {\r\n  let keyed = false;\r\n  const equals = (a, b) => (keyed ? a[1] === b[1] : !a[1] === !b[1]) && a[2] === b[2];\r\n  const conditions = children(() => props.children),\r\n    evalConditions = createMemo(() => {\r\n      let conds = conditions();\r\n      if (!Array.isArray(conds)) conds = [conds];\r\n      for (let i = 0; i < conds.length; i++) {\r\n        const c = conds[i].when;\r\n        if (c) {\r\n          keyed = !!conds[i].keyed;\r\n          return [i, c, conds[i]];\r\n        }\r\n      }\r\n      return [-1];\r\n    }, undefined, {\r\n      equals\r\n    });\r\n  return createMemo(() => {\r\n    const [index, when, cond] = evalConditions();\r\n    if (index < 0) return props.fallback;\r\n    const c = cond.children;\r\n    const fn = typeof c === \"function\" && c.length > 0;\r\n    return fn ? untrack(() => c(keyed ? when : () => {\r\n      if (untrack(evalConditions)[0] !== index) throw narrowedError(\"Match\");\r\n      return cond.when;\r\n    })) : c;\r\n  }, undefined, undefined);\r\n}\r\nfunction Match(props) {\r\n  return props;\r\n}\r\nlet Errors;\r\nfunction resetErrorBoundaries() {\r\n  Errors && [...Errors].forEach(fn => fn());\r\n}\r\nfunction ErrorBoundary(props) {\r\n  let err;\r\n  if (sharedConfig.context && sharedConfig.load) err = sharedConfig.load(sharedConfig.context.id + sharedConfig.context.count);\r\n  const [errored, setErrored] = createSignal(err, undefined);\r\n  Errors || (Errors = new Set());\r\n  Errors.add(setErrored);\r\n  onCleanup(() => Errors.delete(setErrored));\r\n  return createMemo(() => {\r\n    let e;\r\n    if (e = errored()) {\r\n      const f = props.fallback;\r\n      return typeof f === \"function\" && f.length ? untrack(() => f(e, () => setErrored())) : f;\r\n    }\r\n    return catchError(() => props.children, setErrored);\r\n  }, undefined, undefined);\r\n}\r\n\r\nconst suspenseListEquals = (a, b) => a.showContent === b.showContent && a.showFallback === b.showFallback;\r\nconst SuspenseListContext = createContext();\r\nfunction SuspenseList(props) {\r\n  let [wrapper, setWrapper] = createSignal(() => ({\r\n      inFallback: false\r\n    })),\r\n    show;\r\n  const listContext = useContext(SuspenseListContext);\r\n  const [registry, setRegistry] = createSignal([]);\r\n  if (listContext) {\r\n    show = listContext.register(createMemo(() => wrapper()().inFallback));\r\n  }\r\n  const resolved = createMemo(prev => {\r\n    const reveal = props.revealOrder,\r\n      tail = props.tail,\r\n      {\r\n        showContent = true,\r\n        showFallback = true\r\n      } = show ? show() : {},\r\n      reg = registry(),\r\n      reverse = reveal === \"backwards\";\r\n    if (reveal === \"together\") {\r\n      const all = reg.every(inFallback => !inFallback());\r\n      const res = reg.map(() => ({\r\n        showContent: all && showContent,\r\n        showFallback\r\n      }));\r\n      res.inFallback = !all;\r\n      return res;\r\n    }\r\n    let stop = false;\r\n    let inFallback = prev.inFallback;\r\n    const res = [];\r\n    for (let i = 0, len = reg.length; i < len; i++) {\r\n      const n = reverse ? len - i - 1 : i,\r\n        s = reg[n]();\r\n      if (!stop && !s) {\r\n        res[n] = {\r\n          showContent,\r\n          showFallback\r\n        };\r\n      } else {\r\n        const next = !stop;\r\n        if (next) inFallback = true;\r\n        res[n] = {\r\n          showContent: next,\r\n          showFallback: !tail || next && tail === \"collapsed\" ? showFallback : false\r\n        };\r\n        stop = true;\r\n      }\r\n    }\r\n    if (!stop) inFallback = false;\r\n    res.inFallback = inFallback;\r\n    return res;\r\n  }, {\r\n    inFallback: false\r\n  });\r\n  setWrapper(() => resolved);\r\n  return createComponent(SuspenseListContext.Provider, {\r\n    value: {\r\n      register: inFallback => {\r\n        let index;\r\n        setRegistry(registry => {\r\n          index = registry.length;\r\n          return [...registry, inFallback];\r\n        });\r\n        return createMemo(() => resolved()[index], undefined, {\r\n          equals: suspenseListEquals\r\n        });\r\n      }\r\n    },\r\n    get children() {\r\n      return props.children;\r\n    }\r\n  });\r\n}\r\nfunction Suspense(props) {\r\n  let counter = 0,\r\n    show,\r\n    ctx,\r\n    p,\r\n    flicker,\r\n    error;\r\n  const [inFallback, setFallback] = createSignal(false),\r\n    SuspenseContext = getSuspenseContext(),\r\n    store = {\r\n      increment: () => {\r\n        if (++counter === 1) setFallback(true);\r\n      },\r\n      decrement: () => {\r\n        if (--counter === 0) setFallback(false);\r\n      },\r\n      inFallback,\r\n      effects: [],\r\n      resolved: false\r\n    },\r\n    owner = getOwner();\r\n  if (sharedConfig.context && sharedConfig.load) {\r\n    const key = sharedConfig.context.id + sharedConfig.context.count;\r\n    let ref = sharedConfig.load(key);\r\n    if (ref) {\r\n      if (typeof ref !== \"object\" || ref.status !== \"success\") p = ref;else sharedConfig.gather(key);\r\n    }\r\n    if (p && p !== \"$$f\") {\r\n      const [s, set] = createSignal(undefined, {\r\n        equals: false\r\n      });\r\n      flicker = s;\r\n      p.then(() => {\r\n        if (sharedConfig.done) return set();\r\n        sharedConfig.gather(key);\r\n        setHydrateContext(ctx);\r\n        set();\r\n        setHydrateContext();\r\n      }, err => {\r\n        error = err;\r\n        set();\r\n      });\r\n    }\r\n  }\r\n  const listContext = useContext(SuspenseListContext);\r\n  if (listContext) show = listContext.register(store.inFallback);\r\n  let dispose;\r\n  onCleanup(() => dispose && dispose());\r\n  return createComponent(SuspenseContext.Provider, {\r\n    value: store,\r\n    get children() {\r\n      return createMemo(() => {\r\n        if (error) throw error;\r\n        ctx = sharedConfig.context;\r\n        if (flicker) {\r\n          flicker();\r\n          return flicker = undefined;\r\n        }\r\n        if (ctx && p === \"$$f\") setHydrateContext();\r\n        const rendered = createMemo(() => props.children);\r\n        return createMemo(prev => {\r\n          const inFallback = store.inFallback(),\r\n            {\r\n              showContent = true,\r\n              showFallback = true\r\n            } = show ? show() : {};\r\n          if ((!inFallback || p && p !== \"$$f\") && showContent) {\r\n            store.resolved = true;\r\n            dispose && dispose();\r\n            dispose = ctx = p = undefined;\r\n            resumeEffects(store.effects);\r\n            return rendered();\r\n          }\r\n          if (!showFallback) return;\r\n          if (dispose) return prev;\r\n          return createRoot(disposer => {\r\n            dispose = disposer;\r\n            if (ctx) {\r\n              setHydrateContext({\r\n                id: ctx.id + \"f\",\r\n                count: 0\r\n              });\r\n              ctx = undefined;\r\n            }\r\n            return props.fallback;\r\n          }, owner);\r\n        });\r\n      });\r\n    }\r\n  });\r\n}\r\n\r\nconst DEV = undefined;\r\n\r\nexport { $DEVCOMP, $PROXY, $TRACK, DEV, ErrorBoundary, For, Index, Match, Show, Suspense, SuspenseList, Switch, batch, cancelCallback, catchError, children, createComponent, createComputed, createContext, createDeferred, createEffect, createMemo, createReaction, createRenderEffect, createResource, createRoot, createSelector, createSignal, createUniqueId, enableExternalSource, enableHydration, enableScheduling, equalFn, from, getListener, getOwner, indexArray, lazy, mapArray, mergeProps, observable, on, onCleanup, onError, onMount, requestCallback, resetErrorBoundaries, runWithOwner, sharedConfig, splitProps, startTransition, untrack, useContext, useTransition };\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type lang from '../lang';\r\nimport type langSign from '../langSign';\r\nimport type {State} from '../config/state';\r\nimport DEBUG, {MOUNT_CLASS_TO} from '../config/debug';\r\nimport {HelpCountriesList, HelpCountry, LangPackDifference, LangPackString} from '../layer';\r\nimport stateStorage from './stateStorage';\r\nimport App from '../config/app';\r\nimport rootScope from './rootScope';\r\nimport {IS_MOBILE} from '../environment/userAgent';\r\nimport deepEqual from '../helpers/object/deepEqual';\r\nimport safeAssign from '../helpers/object/safeAssign';\r\nimport capitalizeFirstLetter from '../helpers/string/capitalizeFirstLetter';\r\nimport matchUrlProtocol from './richTextProcessor/matchUrlProtocol';\r\nimport wrapUrl from './richTextProcessor/wrapUrl';\r\nimport {setDirection} from '../helpers/dom/setInnerHTML';\r\nimport setBlankToAnchor from './richTextProcessor/setBlankToAnchor';\r\nimport {createSignal} from 'solid-js';\r\n\r\nexport const langPack: {[actionType: string]: LangPackKey} = {\r\n  'messageActionChatCreate': 'ActionCreateGroup',\r\n  'messageActionChatCreateYou': 'ActionYouCreateGroup',\r\n  'messageActionChatEditTitle': 'ActionChangedTitle',\r\n  'messageActionChatEditPhoto': 'ActionChangedPhoto',\r\n  'messageActionChatEditVideo': 'ActionChangedVideo',\r\n  'messageActionChatDeletePhoto': 'ActionRemovedPhoto',\r\n  'messageActionChatReturn': 'ActionAddUserSelf',\r\n  'messageActionChatReturnYou': 'ActionAddUserSelfYou',\r\n  'messageActionChatJoined': 'ActionAddUserSelfMega',\r\n  'messageActionChatJoinedYou': 'ChannelMegaJoined',\r\n  'messageActionChatAddUser': 'ActionAddUser',\r\n  'messageActionChatAddUsers': 'ActionAddUser',\r\n  'messageActionChatLeave': 'ActionLeftUser',\r\n  'messageActionChatLeaveYou': 'YouLeft',\r\n  'messageActionChatDeleteUser': 'ActionKickUser',\r\n  'messageActionChatJoinedByLink': 'ActionInviteUser',\r\n  'messageActionPinMessage': 'Chat.Service.Group.UpdatedPinnedMessage',\r\n  'messageActionContactSignUp': 'Chat.Service.PeerJoinedTelegram',\r\n  'messageActionChannelCreate': 'ActionCreateChannel',\r\n  'messageActionChannelEditTitle': 'Chat.Service.Channel.UpdatedTitle',\r\n  'messageActionChannelEditPhoto': 'Chat.Service.Channel.UpdatedPhoto',\r\n  'messageActionChannelEditVideo': 'Chat.Service.Channel.UpdatedVideo',\r\n  'messageActionChannelDeletePhoto': 'Chat.Service.Channel.RemovedPhoto',\r\n  'messageActionHistoryClear': 'HistoryCleared',\r\n  'messageActionDiscussionStarted': 'DiscussionStarted',\r\n  'messageActionGiveawayLaunch': 'BoostingGiveawayJustStarted',\r\n  'messageActionChannelJoined': 'ChannelJoined',\r\n\r\n  'messageActionChannelMigrateFrom': 'ActionMigrateFromGroup',\r\n\r\n  'messageActionPhoneCall.video_in_ok': 'ChatList.Service.VideoCall.incoming',\r\n  'messageActionPhoneCall.video_out_ok': 'ChatList.Service.VideoCall.outgoing',\r\n  'messageActionPhoneCall.video_missed': 'ChatList.Service.VideoCall.Missed',\r\n  'messageActionPhoneCall.video_cancelled': 'ChatList.Service.VideoCall.Cancelled',\r\n  'messageActionPhoneCall.in_ok': 'ChatList.Service.Call.incoming',\r\n  'messageActionPhoneCall.out_ok': 'ChatList.Service.Call.outgoing',\r\n  'messageActionPhoneCall.missed': 'ChatList.Service.Call.Missed',\r\n  'messageActionPhoneCall.cancelled': 'ChatList.Service.Call.Cancelled',\r\n\r\n  'messageActionGroupCall.started': 'Chat.Service.VoiceChatStarted.Channel',\r\n  'messageActionGroupCall.started_by': 'Chat.Service.VoiceChatStarted',\r\n  'messageActionGroupCall.started_byYou': 'Chat.Service.VoiceChatStartedYou',\r\n  'messageActionGroupCall.ended': 'Chat.Service.VoiceChatFinished.Channel',\r\n  'messageActionGroupCall.ended_by': 'Chat.Service.VoiceChatFinished',\r\n  'messageActionGroupCall.ended_byYou': 'Chat.Service.VoiceChatFinishedYou',\r\n\r\n  'messageActionBotAllowed': 'Chat.Service.BotPermissionAllowed'\r\n};\r\n\r\nexport type LangPackKey = /* string |  */keyof typeof lang | keyof typeof langSign;\r\n\r\nexport type FormatterArgument = string | number | Node | FormatterArgument[];\r\nexport type FormatterArguments = FormatterArgument[];\r\n\r\nexport const UNSUPPORTED_LANG_PACK_KEY: LangPackKey = IS_MOBILE ? 'Message.Unsupported.Mobile' : 'Message.Unsupported.Desktop';\r\n\r\nnamespace I18n {\r\n  export const strings: Map<LangPackKey, LangPackString> = new Map();\r\n  export const countriesList: HelpCountry[] = [];\r\n  let pluralRules: Intl.PluralRules;\r\n\r\n  let cacheLangPackPromise: Promise<LangPackDifference>;\r\n  export let lastRequestedLangCode: string;\r\n  export let lastRequestedNormalizedLangCode: string;\r\n  export let lastAppliedLangCode: string;\r\n  export let requestedServerLanguage = false;\r\n  export let timeFormat: State['settings']['timeFormat'];\r\n  export let isRTL = false;\r\n\r\n  export const [langCodeNormalized, setLangCodeNormalized] = createSignal<TranslatableLanguageISO>();\r\n\r\n  export function setRTL(rtl: boolean) {\r\n    isRTL = rtl;\r\n  }\r\n\r\n  function setLangCode(langCode: string) {\r\n    lastRequestedLangCode = langCode;\r\n    lastRequestedNormalizedLangCode = langCode.split('-')[0];\r\n    setLangCodeNormalized(lastRequestedNormalizedLangCode.split('-')[0] as any);\r\n  }\r\n\r\n  export function getCacheLangPack(): Promise<LangPackDifference> {\r\n    if(cacheLangPackPromise) return cacheLangPackPromise;\r\n    return cacheLangPackPromise = Promise.all([\r\n      stateStorage.get('langPack') as Promise<LangPackDifference>,\r\n      polyfillPromise\r\n    ]).then(([langPack]) => {\r\n      if(!langPack/*  || true */) {\r\n        return loadLocalLangPack();\r\n      } else if(DEBUG && false) {\r\n        return getLangPack(langPack.lang_code);\r\n      }/*  else if(langPack.appVersion !== App.langPackVersion) {\r\n        return getLangPack(langPack.lang_code);\r\n      } */\r\n\r\n      if(!lastRequestedLangCode) {\r\n        setLangCode(langPack.lang_code);\r\n      }\r\n\r\n      applyLangPack(langPack);\r\n      return langPack;\r\n    }).finally(() => {\r\n      cacheLangPackPromise = undefined;\r\n    });\r\n  }\r\n\r\n  function updateAmPm() {\r\n    if(timeFormat === 'h12') {\r\n      try {\r\n        const dateTimeFormat = getDateTimeFormat({hour: 'numeric', minute: 'numeric', hour12: true});\r\n        const date = new Date();\r\n        date.setHours(0);\r\n        const amText = dateTimeFormat.format(date);\r\n        amPmCache.am = amText.split(/\\s/)[1];\r\n        date.setHours(12);\r\n        const pmText = dateTimeFormat.format(date);\r\n        amPmCache.pm = pmText.split(/\\s/)[1];\r\n      } catch(err) {\r\n        console.error('cannot get am/pm', err);\r\n        amPmCache = {am: 'AM', pm: 'PM'};\r\n      }\r\n    }\r\n  }\r\n\r\n  export function setTimeFormat(\r\n    format: State['settings']['timeFormat'],\r\n    haveToUpdate = !!timeFormat && timeFormat !== format\r\n  ) {\r\n    timeFormat = format;\r\n\r\n    updateAmPm();\r\n\r\n    if(haveToUpdate) {\r\n      cachedDateTimeFormats.clear();\r\n      const elements = Array.from(document.querySelectorAll(`.i18n`)) as HTMLElement[];\r\n      elements.forEach((element) => {\r\n        const instance = weakMap.get(element);\r\n\r\n        if(instance instanceof IntlDateElement) {\r\n          instance.update();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  export function loadLocalLangPack() {\r\n    const defaultCode = App.langPackCode;\r\n    setLangCode(defaultCode);\r\n    return Promise.all([\r\n      import('../lang'),\r\n      import('../langSign'),\r\n      import('../countries')\r\n    ]).then(([lang, langSign, countries]) => {\r\n      const strings: LangPackString[] = [];\r\n      formatLocalStrings(lang.default, strings);\r\n      formatLocalStrings(langSign.default, strings);\r\n\r\n      const langPack: LangPackDifference = {\r\n        _: 'langPackDifference',\r\n        from_version: 0,\r\n        lang_code: defaultCode,\r\n        strings,\r\n        version: 0,\r\n        local: true,\r\n        countries: countries.default\r\n      };\r\n      return saveLangPack(langPack);\r\n    });\r\n  }\r\n\r\n  export function loadLangPack(langCode: string, web?: boolean) {\r\n    web = true;\r\n    requestedServerLanguage = true;\r\n    const managers = rootScope.managers;\r\n    return Promise.all([\r\n      managers.apiManager.invokeApiCacheable('langpack.getLangPack', {\r\n        lang_code: langCode,\r\n        lang_pack: web ? 'web' : App.langPack\r\n      }),\r\n      !web && managers.apiManager.invokeApiCacheable('langpack.getLangPack', {\r\n        lang_code: langCode,\r\n        lang_pack: 'android'\r\n      }),\r\n      import('../lang'),\r\n      import('../langSign'),\r\n      managers.apiManager.invokeApiCacheable('help.getCountriesList', {\r\n        lang_code: langCode,\r\n        hash: 0\r\n      }) as Promise<HelpCountriesList.helpCountriesList>,\r\n      polyfillPromise\r\n    ]);\r\n  }\r\n\r\n  export function getStrings(langCode: string, strings: string[]) {\r\n    return rootScope.managers.apiManager.invokeApi('langpack.getStrings', {\r\n      lang_pack: App.langPack,\r\n      lang_code: langCode,\r\n      keys: strings\r\n    });\r\n  }\r\n\r\n  export function formatLocalStrings(strings: any, pushTo: LangPackString[] = []) {\r\n    for(const i in strings) {\r\n      // @ts-ignore\r\n      const v = strings[i];\r\n      if(typeof(v) === 'string') {\r\n        pushTo.push({\r\n          _: 'langPackString',\r\n          key: i,\r\n          value: v\r\n        });\r\n      } else {\r\n        pushTo.push({\r\n          _: 'langPackStringPluralized',\r\n          key: i,\r\n          ...v\r\n        });\r\n      }\r\n    }\r\n\r\n    return pushTo;\r\n  }\r\n\r\n  export function getLangPack(langCode: string, web?: boolean) {\r\n    setLangCode(langCode);\r\n    return loadLangPack(langCode, web).then(([langPack1, langPack2, localLangPack1, localLangPack2, countries, _]) => {\r\n      let strings: LangPackString[] = [];\r\n\r\n      [localLangPack1, localLangPack2].forEach((l) => {\r\n        formatLocalStrings(l.default as any, strings);\r\n      });\r\n\r\n      strings = strings.concat(...[langPack1.strings, langPack2.strings].filter(Boolean));\r\n\r\n      langPack1.strings = strings;\r\n      langPack1.countries = countries;\r\n      return saveLangPack(langPack1);\r\n    });\r\n  }\r\n\r\n  export function saveLangPack(langPack: LangPackDifference) {\r\n    langPack.appVersion = App.langPackVersion;\r\n\r\n    return stateStorage.set({langPack}).then(() => {\r\n      applyLangPack(langPack);\r\n      return langPack;\r\n    });\r\n  }\r\n\r\n  export const polyfillPromise = (function checkIfPolyfillNeeded() {\r\n    if(typeof(Intl) !== 'undefined' && typeof(Intl.PluralRules) !== 'undefined'/*  && false */) {\r\n      return Promise.resolve();\r\n    } else {\r\n      return import('./pluralPolyfill').then((_Intl) => {\r\n        (window as any).Intl = Object.assign(typeof(Intl) !== 'undefined' ? Intl : {}, _Intl.default);\r\n      });\r\n    }\r\n  })();\r\n\r\n  export function applyLangPack(langPack: LangPackDifference) {\r\n    const currentLangCode = lastRequestedLangCode;\r\n    if(langPack.lang_code !== currentLangCode) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      pluralRules = new Intl.PluralRules(lastRequestedNormalizedLangCode);\r\n    } catch(err) {\r\n      console.error('pluralRules error', err);\r\n      pluralRules = new Intl.PluralRules(lastRequestedNormalizedLangCode.split('-', 1)[0]);\r\n    }\r\n\r\n    try {\r\n      pluralRules = new Intl.PluralRules(langPack.lang_code);\r\n    } catch(err) {\r\n      console.error('pluralRules error', err);\r\n      pluralRules = new Intl.PluralRules(langPack.lang_code.split('-', 1)[0]);\r\n    }\r\n\r\n    strings.clear();\r\n\r\n    for(const string of langPack.strings) {\r\n      strings.set(string.key as LangPackKey, string);\r\n    }\r\n\r\n    if(langPack.countries) {\r\n      countriesList.length = 0;\r\n      countriesList.push(...langPack.countries.countries);\r\n\r\n      langPack.countries.countries.forEach((country) => {\r\n        if(country.name) {\r\n          const langPackKey: any = country.default_name;\r\n          strings.set(langPackKey, {\r\n            _: 'langPackString',\r\n            key: langPackKey,\r\n            value: country.name\r\n          });\r\n        }\r\n      });\r\n    }\r\n\r\n    if(lastAppliedLangCode !== currentLangCode) {\r\n      if(lastAppliedLangCode && rootScope.myId) {\r\n        rootScope.managers.appReactionsManager.resetAvailableReactions();\r\n        rootScope.managers.appUsersManager.indexMyself();\r\n        rootScope.managers.dialogsStorage.indexMyDialog();\r\n      }\r\n\r\n      lastAppliedLangCode = currentLangCode;\r\n      cachedDateTimeFormats.clear();\r\n      updateAmPm();\r\n      rootScope.dispatchEvent('language_change', currentLangCode);\r\n    }\r\n\r\n    const elements = Array.from(document.querySelectorAll(`.i18n`)) as HTMLElement[];\r\n    elements.forEach((element) => {\r\n      const instance = weakMap.get(element);\r\n\r\n      if(instance) {\r\n        instance.update();\r\n      }\r\n    });\r\n  }\r\n\r\n  function pushNextArgument(out: ReturnType<typeof superFormatter>, args: FormatterArguments, indexHolder: {i: number}, i?: number) {\r\n    const arg = args[i === undefined ? indexHolder.i++ : i];\r\n    if(Array.isArray(arg)) {\r\n      out.push(...arg as any);\r\n    } else {\r\n      out.push(arg);\r\n    }\r\n  }\r\n\r\n  export function superFormatter(input: string, args?: FormatterArguments, indexHolder?: {i: number}): Exclude<FormatterArgument, FormatterArgument[]>[] {\r\n    if(!indexHolder) { // set starting index for arguments without order\r\n      indexHolder = {i: 0};\r\n      const indexes = input.match(/(%|un)\\d+/g);\r\n      if(indexes?.length) {\r\n        indexHolder.i = Math.max(...indexes.map((str) => +str.replace(/\\D/g, '')));\r\n      }\r\n    }\r\n\r\n    const out: ReturnType<typeof superFormatter> = [];\r\n    const regExp = /(\\*\\*|__)(.+?)\\1|(\\n)|(\\[.+?\\]\\(.*?\\))|un\\d|%\\d\\$.|%\\S/g;\r\n\r\n    let lastIndex = 0;\r\n    input.replace(regExp, (match, p1: any, p2: any, p3: any, p4: string, offset: number, string: string) => {\r\n      // console.table({match, p1, p2, offset, string});\r\n\r\n      if(offset > lastIndex) {\r\n        out.push(string.slice(lastIndex, offset));\r\n      }\r\n\r\n      if(p1) {\r\n        // offset += p1.length;\r\n        let element: HTMLElement;\r\n        switch(p1) {\r\n          case '**': {\r\n            element = document.createElement('b');\r\n            break;\r\n          }\r\n\r\n          case '__': {\r\n            element = document.createElement('i');\r\n            break;\r\n          }\r\n        }\r\n\r\n        element.append(...superFormatter(p2, args, indexHolder) as any);\r\n        out.push(element);\r\n      } else if(p3) {\r\n        out.push(document.createElement('br'));\r\n      } else if(p4) {\r\n        const idx = p4.lastIndexOf(']');\r\n        const text = p4.slice(1, idx);\r\n\r\n        const url = p4.slice(idx + 2, p4.length - 1);\r\n        let a: HTMLAnchorElement;\r\n        if(url && matchUrlProtocol(url)) {\r\n          a = document.createElement('a');\r\n          const wrappedUrl = wrapUrl(url);\r\n          a.href = wrappedUrl.url;\r\n          if(wrappedUrl.onclick) a.setAttribute('onclick', wrappedUrl.onclick + '(this)');\r\n          setBlankToAnchor(a);\r\n        } else {\r\n          a = args[indexHolder.i++] as HTMLAnchorElement;\r\n\r\n          if(a instanceof DocumentFragment) { // right after wrapRichText\r\n            a = a.firstChild as any;\r\n          }\r\n\r\n          if(typeof(a) !== 'string') {\r\n            a.textContent = ''; // reset content\r\n          }\r\n        }\r\n\r\n        const formatted = superFormatter(text, args, indexHolder) as any;\r\n        if(typeof(a) === 'string') {\r\n          out.push(...formatted);\r\n        } else {\r\n          a.append(...formatted);\r\n          out.push(a);\r\n        }\r\n      } else if(args) {\r\n        const index = match.replace(/\\D/g, '');\r\n        pushNextArgument(\r\n          out,\r\n          args,\r\n          indexHolder,\r\n          !index || Number.isNaN(+index) ? undefined : Math.min(args.length - 1, +index - 1)\r\n        );\r\n      }\r\n\r\n      lastIndex = offset + match.length;\r\n      return '';\r\n    });\r\n\r\n    if(lastIndex !== input.length) {\r\n      out.push(input.slice(lastIndex));\r\n    }\r\n\r\n    return out;\r\n  }\r\n\r\n  export function format(key: LangPackKey, plain: true, args?: FormatterArguments): string;\r\n  export function format(key: LangPackKey, plain?: false, args?: FormatterArguments): ReturnType<typeof superFormatter>;\r\n  export function format(key: LangPackKey, plain = false, args?: FormatterArguments): ReturnType<typeof superFormatter> | string {\r\n    const str = strings.get(key);\r\n    let input: string;\r\n    if(str) {\r\n      if(str._ === 'langPackStringPluralized' && args?.length) {\r\n        let v = args[0] as number | string;\r\n        if(typeof(v) === 'string') v = +v.replace(/\\D/g, '');\r\n        const s = pluralRules.select(v);\r\n        // @ts-ignore\r\n        input = str[s + '_value'] || str['other_value'];\r\n      } else if(str._ === 'langPackString') {\r\n        input = str.value;\r\n      } else {\r\n        // input = '[' + key + ']';\r\n        input = key;\r\n      }\r\n    } else {\r\n      // input = '[' + key + ']';\r\n      input = key;\r\n    }\r\n\r\n    const result = superFormatter(input, args);\r\n    if(plain) { // * let's try a hack now... (don't want to replace []() entity)\r\n      return result.map((item) => item instanceof Node ? item.textContent : item).join('');\r\n    } else {\r\n      return result;\r\n    }\r\n\r\n    /* if(plain) {\r\n      if(args?.length) {\r\n        const regExp = /un\\d|%\\d\\$.|%./g;\r\n        let i = 0;\r\n        input = input.replace(regExp, (match, offset, string) => {\r\n          return '' + args[i++];\r\n        });\r\n      }\r\n\r\n      return input;\r\n    } else {\r\n      return superFormatter(input, args);\r\n    } */\r\n  }\r\n\r\n  export const weakMap: WeakMap<HTMLElement, IntlElementBase<IntlElementBaseOptions>> = new WeakMap();\r\n\r\n  export type IntlElementBaseOptions = {\r\n    element?: HTMLElement,\r\n    property?: 'innerText' | 'innerHTML' | 'placeholder' | 'textContent',\r\n  };\r\n\r\n  abstract class IntlElementBase<Options extends IntlElementBaseOptions> {\r\n    public element: IntlElementBaseOptions['element'];\r\n    public property: IntlElementBaseOptions['property'];\r\n\r\n    constructor(options?: Options) {\r\n      this.element = options?.element || document.createElement('span');\r\n      this.element.classList.add('i18n');\r\n\r\n      this.property = options?.property;\r\n\r\n      weakMap.set(this.element, this);\r\n    }\r\n\r\n    abstract update(options?: Options): void;\r\n  }\r\n\r\n  export type IntlElementOptions = IntlElementBaseOptions & {\r\n    key?: LangPackKey,\r\n    args?: FormatterArguments\r\n  };\r\n  export class IntlElement extends IntlElementBase<IntlElementOptions> {\r\n    public key: IntlElementOptions['key'];\r\n    public args: IntlElementOptions['args'];\r\n\r\n    constructor(options: IntlElementOptions = {}) {\r\n      super({...options, property: options.property ?? 'innerHTML'});\r\n\r\n      if(options?.key) {\r\n        this.update(options);\r\n      }\r\n    }\r\n\r\n    public update(options?: IntlElementOptions) {\r\n      safeAssign(this, options);\r\n\r\n      if(this.property === 'innerHTML') {\r\n        this.element.replaceChildren(...format(this.key, false, this.args) as any);\r\n        if(this.args?.length) {\r\n          this.element.normalize();\r\n        }\r\n      } else {\r\n        // @ts-ignore\r\n        const v = this.element[this.property];\r\n        const formatted = format(this.key, true, this.args);\r\n\r\n        // * hasOwnProperty won't work here\r\n        if(v === undefined) this.element.dataset[this.property] = formatted;\r\n        else (this.element as HTMLInputElement)[this.property] = formatted;\r\n      }\r\n    }\r\n\r\n    public compareAndUpdate(options?: IntlElementOptions) {\r\n      if(this.key === options.key && deepEqual(this.args, options.args)) {\r\n        return;\r\n      }\r\n\r\n      return this.update(options);\r\n    }\r\n  }\r\n\r\n  const cachedDateTimeFormats: Map<string, Intl.DateTimeFormat> = new Map();\r\n  export function getDateTimeFormat(options: Intl.DateTimeFormatOptions = {}) {\r\n    const json = JSON.stringify(options);\r\n    let dateTimeFormat = cachedDateTimeFormats.get(json);\r\n    if(!dateTimeFormat) {\r\n      dateTimeFormat = new Intl.DateTimeFormat(lastRequestedNormalizedLangCode + '-u-hc-' + timeFormat, options);\r\n      cachedDateTimeFormats.set(json, dateTimeFormat);\r\n    }\r\n\r\n    return dateTimeFormat;\r\n  }\r\n\r\n  export let amPmCache = {am: 'AM', pm: 'PM'};\r\n  export type IntlDateElementOptions = IntlElementBaseOptions & {\r\n    date?: Date,\r\n    options: Intl.DateTimeFormatOptions\r\n  };\r\n  export class IntlDateElement extends IntlElementBase<IntlDateElementOptions> {\r\n    public date: IntlDateElementOptions['date'];\r\n    public options: IntlDateElementOptions['options'];\r\n\r\n    constructor(options: IntlDateElementOptions) {\r\n      super({...options, property: options.property ?? 'textContent'});\r\n      setDirection(this.element);\r\n\r\n      if(options?.date) {\r\n        this.update(options);\r\n      }\r\n    }\r\n\r\n    public update(options?: IntlDateElementOptions) {\r\n      safeAssign(this, options);\r\n\r\n      let text: string;\r\n      if(this.options.hour && this.options.minute && Object.keys(this.options).length === 2/*  && false */) {\r\n        const hours = this.date.getHours();\r\n        text = ('0' + (timeFormat === 'h12' ? (hours % 12) || 12 : hours)).slice(-2) + ':' + ('0' + this.date.getMinutes()).slice(-2);\r\n        // if(this.options.second) {\r\n        //   text += ':' + ('0' + this.date.getSeconds()).slice(-2);\r\n        // }\r\n\r\n        if(timeFormat === 'h12') {\r\n          text += ' ' + (hours < 12 ? amPmCache.am : amPmCache.pm);\r\n        }\r\n      } else {\r\n        // * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/Locale/hourCycle#adding_an_hour_cycle_via_the_locale_string\r\n        const dateTimeFormat = getDateTimeFormat(this.options);\r\n        text = capitalizeFirstLetter(dateTimeFormat.format(this.date));\r\n      }\r\n\r\n      (this.element as any)[this.property] = text;\r\n    }\r\n  }\r\n\r\n  export function i18n(key: LangPackKey, args?: FormatterArguments) {\r\n    return new IntlElement({key, args}).element;\r\n  }\r\n\r\n  export function i18n_(options: IntlElementOptions) {\r\n    return new IntlElement(options).element;\r\n  }\r\n\r\n  export function _i18n(element: HTMLElement, key: LangPackKey, args?: FormatterArguments, property?: IntlElementOptions['property']) {\r\n    return new IntlElement({element, key, args, property}).element;\r\n  }\r\n}\r\n\r\nexport {I18n};\r\nexport default I18n;\r\n\r\nconst i18n = I18n.i18n;\r\nexport {i18n};\r\n\r\nconst i18n_ = I18n.i18n_;\r\nexport {i18n_};\r\n\r\nconst _i18n = I18n._i18n;\r\nexport {_i18n};\r\n\r\nexport function joinElementsWith<T extends Node | string | Array<Node | string>>(\r\n  elements: T[],\r\n  joiner: T | string | ((isLast: boolean) => T)\r\n): T[] {\r\n  const arr = elements.slice(0, 1) as T[];\r\n  for(let i = 1; i < elements.length; ++i) {\r\n    const isLast = (elements.length - 1) === i;\r\n    arr.push(typeof(joiner) === 'function' ? (joiner as any)(isLast) : joiner);\r\n    arr.push(elements[i]);\r\n  }\r\n\r\n  return arr;\r\n}\r\n\r\n\r\nexport function join(elements: (Node | string)[], useLast: boolean, plain: true): string;\r\nexport function join(elements: (Node | string)[], useLast?: boolean, plain?: false): (string | Node)[];\r\nexport function join(elements: (Node | string)[], useLast: boolean, plain: boolean): string | (string | Node)[];\r\nexport function join(elements: (Node | string)[], useLast = true, plain?: boolean): string | (string | Node)[] {\r\n  const joined = joinElementsWith(elements, (isLast) => {\r\n    const langPackKey: LangPackKey = isLast && useLast ? 'AutoDownloadSettings.LastDelimeter' : 'AutoDownloadSettings.Delimeter';\r\n    return plain ? I18n.format(langPackKey, true) : i18n(langPackKey);\r\n  });\r\n\r\n  return plain ? joined.join('') : joined;\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.I18n = I18n);\r\n","export default function isAnyChat(peerId: PeerId) {\r\n  return +peerId < 0;\r\n}\r\n","export default function isUser(peerId: PeerId) {\r\n  return +peerId >= 0;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport isAnyChat from '../lib/appManagers/utils/peers/isAnyChat';\r\nimport isUser from '../lib/appManagers/utils/peers/isUser';\r\n\r\nString.prototype.toUserId = function() {\r\n  return (+this).toUserId();\r\n};\r\n\r\nString.prototype.toChatId = function() {\r\n  return (+this).toChatId();\r\n};\r\n\r\nString.prototype.toPeerId = function(isChat?: boolean) {\r\n  return (+this).toPeerId(isChat);\r\n};\r\n\r\nString.prototype.isPeerId = function() {\r\n  return /^[\\d-]/.test(this.toString());\r\n};\r\n\r\n// * don't return just 'this', because Firefox returns empty `Number` class\r\nNumber.prototype.toUserId = function() {\r\n  return +this;\r\n};\r\n\r\nNumber.prototype.toChatId = function() {\r\n  return Math.abs(this as any);\r\n};\r\n\r\n// * don't return just 'this', because Firefox returns empty `Number` class\r\nNumber.prototype.toPeerId = function(isChat?: boolean) {\r\n  return isChat === undefined ? +this : (isChat ? -Math.abs(this as number) : +this);\r\n};\r\n\r\nNumber.prototype.isPeerId = function() {\r\n  return true;\r\n};\r\n\r\n[\r\n  ['isUser' as const, isUser],\r\n  ['isAnyChat' as const, isAnyChat]\r\n].forEach((value) => {\r\n  const newMethod = Array.isArray(value) ? value[0] : value;\r\n  const originMethod = Array.isArray(value) ? value[1] : value;\r\n  // @ts-ignore\r\n  String.prototype[newMethod] = function() {\r\n    // @ts-ignore\r\n    // eslint-disable-next-line no-useless-call\r\n    return originMethod.call(null, this.toString());\r\n  };\r\n\r\n  // @ts-ignore\r\n  Number.prototype[newMethod] = function() {\r\n    // * don't use just 'this', because Firefox returns empty `Number` class\r\n    // @ts-ignore\r\n    // eslint-disable-next-line no-useless-call\r\n    return originMethod.call(null, +this);\r\n  };\r\n});\r\n\r\ndeclare global {\r\n  interface String {\r\n    toUserId(): UserId;\r\n    toChatId(): ChatId;\r\n    toPeerId(isChat?: boolean): PeerId;\r\n    isPeerId(): this is string;\r\n\r\n    isUser(): boolean;\r\n    isAnyChat(): boolean;\r\n  }\r\n\r\n  interface Number {\r\n    toUserId(): UserId;\r\n    toChatId(): ChatId;\r\n    toPeerId(isChat?: boolean): PeerId;\r\n    isPeerId(): this is PeerId;\r\n\r\n    isUser(): boolean;\r\n    isAnyChat(): boolean;\r\n  }\r\n}\r\n\r\nexport {};\r\n","export default function bufferConcats(...args: (ArrayBuffer | Uint8Array | number[])[]) {\r\n  const length = args.reduce((acc, v) => acc + ((v as ArrayBuffer).byteLength || (v as Uint8Array).length), 0);\r\n\r\n  const tmp = new Uint8Array(length);\r\n\r\n  let lastLength = 0;\r\n  args.forEach((b) => {\r\n    tmp.set(b instanceof ArrayBuffer ? new Uint8Array(b) : b, lastLength);\r\n    lastLength += (b as ArrayBuffer).byteLength || (b as Uint8Array).length;\r\n  });\r\n\r\n  return tmp/* .buffer */;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport bufferConcats from '../helpers/bytes/bufferConcats';\r\n\r\nUint8Array.prototype.concat = function(...args: Array<Uint8Array | ArrayBuffer | number[]>) {\r\n  return bufferConcats(this, ...args);\r\n};\r\n\r\n/* Uint8Array.prototype.toString = function() {\r\n  return String.fromCharCode.apply(null, [...this]);\r\n}; */\r\n\r\nUint8Array.prototype.toJSON = function() {\r\n  return [...this];\r\n  // return {type: 'bytes', value: [...this]};\r\n};\r\n\r\nPromise.prototype.finally = Promise.prototype.finally || function<T>(this: Promise<T>, fn: () => any) {\r\n  const onFinally = (callback: typeof fn) => Promise.resolve(fn()).then(callback);\r\n  return this.then(\r\n    result => onFinally(() => result),\r\n    reason => onFinally(() => Promise.reject(reason))\r\n  );\r\n};\r\n\r\ndeclare global {\r\n  interface Uint8Array {\r\n    concat: (...args: Array<Uint8Array | ArrayBuffer | number[]>) => Uint8Array,\r\n    // toString: () => string,\r\n    toJSON: () => number[],\r\n    // toJSON: () => {type: 'bytes', value: number[]},\r\n  }\r\n\r\n  interface Promise<T> {\r\n    finally: (onfinally?: () => void) => Promise<T>;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport deferredPromise, {CancellablePromise} from '../../helpers/cancellablePromise';\r\nimport {WorkerTaskVoidTemplate} from '../../types';\r\n\r\nexport interface ConvertWebPTask extends WorkerTaskVoidTemplate {\r\n  type: 'convertWebp',\r\n  payload: {\r\n    fileName: string,\r\n    bytes: Uint8Array\r\n  }\r\n};\r\n\r\nexport class WebpWorkerController {\r\n  private worker: Worker;\r\n  private convertPromises: {[fileName: string]: CancellablePromise<Uint8Array>} = {};\r\n\r\n  private init() {\r\n    this.worker = new Worker(new URL('./webp.worker.ts', import.meta.url), {type: 'module'});\r\n    this.worker.addEventListener('message', (e) => {\r\n      const task = e.data as ConvertWebPTask;\r\n      const payload = task.payload;\r\n\r\n      const promise = this.convertPromises[payload.fileName];\r\n      if(promise) {\r\n        payload.bytes ? promise.resolve(payload.bytes) : promise.reject();\r\n        delete this.convertPromises[payload.fileName];\r\n      }\r\n    });\r\n  }\r\n\r\n  private postMessage(data: ConvertWebPTask) {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    this.worker.postMessage(data);\r\n  }\r\n\r\n  public convert(fileName: string, bytes: Uint8Array) {\r\n    if(this.convertPromises.hasOwnProperty(fileName)) {\r\n      return this.convertPromises[fileName];\r\n    }\r\n\r\n    const convertPromise = deferredPromise<Uint8Array>();\r\n\r\n    this.postMessage({type: 'convertWebp', payload: {fileName, bytes}});\r\n\r\n    return this.convertPromises[fileName] = convertPromise;\r\n  }\r\n}\r\n\r\nconst webpWorkerController = new WebpWorkerController();\r\nMOUNT_CLASS_TO.webpWorkerController = webpWorkerController;\r\nexport default webpWorkerController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport Modes from '../config/modes';\r\nimport {IS_WORKER} from '../helpers/context';\r\nimport makeError from '../helpers/makeError';\r\nimport {WorkerTaskTemplate} from '../types';\r\nimport MTProtoMessagePort from './mtproto/mtprotoMessagePort';\r\n// import { stringify } from '../helpers/json';\r\n\r\nclass LocalStorage<Storage extends Record<string, any>> {\r\n  private prefix = '';\r\n  private cache: Partial<Storage> = {};\r\n  private useStorage = true;\r\n\r\n  constructor(/* private preserveKeys: (keyof Storage)[] */) {\r\n    if(Modes.test) {\r\n      this.prefix = 't_';\r\n    }\r\n  }\r\n\r\n  public get<T extends keyof Storage>(key: T, useCache = true): Storage[T] {\r\n    if(this.cache.hasOwnProperty(key) && useCache) {\r\n      return this.cache[key];\r\n    } else if(this.useStorage) {\r\n      let value: Storage[T];\r\n      try {\r\n        value = localStorage.getItem(this.prefix + (key as string)) as any;\r\n      } catch(err) {\r\n        this.useStorage = false;\r\n        throw makeError('STORAGE_OFFLINE');\r\n      }\r\n\r\n      if(value !== null) {\r\n        try {\r\n          value = JSON.parse(value);\r\n        } catch(err) {\r\n          // console.error(err);\r\n        }\r\n      } else {\r\n        value = undefined;\r\n      }\r\n\r\n      return value;\r\n    } else {\r\n      throw makeError('STORAGE_OFFLINE');\r\n    }\r\n  }\r\n\r\n  public set(obj: Partial<Storage>, onlyLocal = false) {\r\n    let lastError: any;\r\n    for(const key in obj) {\r\n      if(obj.hasOwnProperty(key)) {\r\n        const value = obj[key];\r\n        this.cache[key] = value;\r\n\r\n        if(!onlyLocal) {\r\n          try {\r\n            if(!this.useStorage) {\r\n              throw makeError('STORAGE_OFFLINE');\r\n            }\r\n\r\n            const stringified = JSON.stringify(value);\r\n            localStorage.setItem(this.prefix + key, stringified);\r\n          } catch(err) {\r\n            this.useStorage = false;\r\n            lastError = err;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if(lastError) {\r\n      throw lastError;\r\n    }\r\n  }\r\n\r\n  public delete(key: keyof Storage, saveLocal = false) {\r\n    // ! it is needed here\r\n    key = '' + (key as string);\r\n\r\n    if(!saveLocal) {\r\n      delete this.cache[key];\r\n    }\r\n\r\n    // if(this.useStorage) {\r\n    try {\r\n      localStorage.removeItem(this.prefix + (key as string));\r\n    } catch(err) {\r\n\r\n    }\r\n    // }\r\n  }\r\n\r\n  /* public clear(preserveKeys: (keyof Storage)[] = this.preserveKeys) {\r\n    // if(this.useStorage) {\r\n      try {\r\n        let obj: Partial<Storage> = {};\r\n        if(preserveKeys) {\r\n          preserveKeys.forEach((key) => {\r\n            const value = this.get(key);\r\n            if(value !== undefined) {\r\n              obj[key] = value;\r\n            }\r\n          });\r\n        }\r\n\r\n        localStorage.clear();\r\n\r\n        if(preserveKeys) {\r\n          this.set(obj);\r\n        }\r\n      } catch(err) {\r\n\r\n      }\r\n    // }\r\n  } */\r\n\r\n  public clear() {\r\n    const keys: string[] = ['dc', 'server_time_offset', 'xt_instance', 'user_auth', 'state_id', 'k_build'];\r\n    for(let i = 1; i <= 5; ++i) {\r\n      keys.push(`dc${i}_server_salt`);\r\n      keys.push(`dc${i}_auth_key`);\r\n      keys.push(`dc${i}_hash`); // only for WebA\r\n    }\r\n\r\n    for(const key of keys) {\r\n      this.delete(key, true);\r\n    }\r\n  }\r\n\r\n  public toggleStorage(enabled: boolean, clearWrite: boolean) {\r\n    this.useStorage = enabled;\r\n\r\n    if(!clearWrite) {\r\n      return;\r\n    }\r\n\r\n    if(!enabled) {\r\n      this.clear();\r\n    } else {\r\n      return this.set(this.cache);\r\n    }\r\n  }\r\n}\r\n\r\nexport interface LocalStorageProxyTask extends WorkerTaskTemplate {\r\n  type: 'localStorageProxy',\r\n  payload: {\r\n    type: 'set' | 'get' | 'delete' | 'clear' | 'toggleStorage',\r\n    args: any[]\r\n  }\r\n};\r\n\r\nexport interface LocalStorageProxyTaskResponse extends WorkerTaskTemplate {\r\n  type: 'localStorageProxy',\r\n  payload: any\r\n};\r\n\r\nexport default class LocalStorageController<Storage extends Record<string, any>> {\r\n  private static STORAGES: LocalStorageController<any>[] = [];\r\n  // private log = (...args: any[]) => console.log('[SW LS]', ...args);\r\n  // private log = (...args: any[]) => {};\r\n\r\n  private storage: LocalStorage<Storage>;\r\n\r\n  constructor(/* private preserveKeys: (keyof Storage)[] = [] */) {\r\n    LocalStorageController.STORAGES.push(this);\r\n\r\n    if(!IS_WORKER) {\r\n      this.storage = new LocalStorage(/* preserveKeys */);\r\n    }\r\n  }\r\n\r\n  private async proxy<T>(type: LocalStorageProxyTask['payload']['type'], ...args: LocalStorageProxyTask['payload']['args']): Promise<T> {\r\n    if(IS_WORKER) {\r\n      const port = MTProtoMessagePort.getInstance<false>();\r\n      return port.invoke('localStorageProxy', {type, args});\r\n    }\r\n\r\n    args = Array.prototype.slice.call(args);\r\n\r\n    // @ts-ignore\r\n    return this.storage[type].apply(this.storage, args as any);\r\n  }\r\n\r\n  public get<T extends keyof Storage>(key: T, useCache?: boolean) {\r\n    return this.proxy<Storage[T]>('get', key, useCache);\r\n  }\r\n\r\n  public set(obj: Partial<Storage>, onlyLocal?: boolean) {\r\n    return this.proxy<void>('set', obj, onlyLocal);\r\n  }\r\n\r\n  public delete(key: keyof Storage, saveLocal?: boolean) {\r\n    return this.proxy<void>('delete', key, saveLocal);\r\n  }\r\n\r\n  public clear(/* preserveKeys?: (keyof Storage)[] */) {\r\n    return this.proxy<void>('clear'/* , preserveKeys */);\r\n  }\r\n\r\n  public toggleStorage(enabled: boolean, clearWrite: boolean) {\r\n    return this.proxy<void>('toggleStorage', enabled, clearWrite);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {AppInstance} from './mtproto/singleInstance';\r\nimport type {UserAuth} from './mtproto/mtproto_config';\r\nimport type {DcId} from '../types';\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport LocalStorageController from './localStorage';\r\n\r\nconst sessionStorage = new LocalStorageController<{\r\n  dc: DcId,\r\n  user_auth: UserAuth,\r\n  state_id: number,\r\n  dc1_auth_key: string,\r\n  dc2_auth_key: string,\r\n  dc3_auth_key: string,\r\n  dc4_auth_key: string,\r\n  dc5_auth_key: string,\r\n  dc1_server_salt: string,\r\n  dc2_server_salt: string,\r\n  dc3_server_salt: string,\r\n  dc4_server_salt: string,\r\n  dc5_server_salt: string,\r\n  auth_key_fingerprint: string, // = dc${App.baseDcId}_auth_key.slice(0, 8)\r\n  server_time_offset: number,\r\n  xt_instance: AppInstance,\r\n  kz_version: 'K' | 'Z',\r\n  tgme_sync: {\r\n    canRedirect: boolean,\r\n    ts: number\r\n  },\r\n  k_build: number\r\n}>(/* ['kz_version'] */);\r\nMOUNT_CLASS_TO.appStorage = sessionStorage;\r\nexport default sessionStorage;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {IS_MOBILE_SAFARI} from '../../environment/userAgent';\r\n\r\nexport default function isSwipingBackSafari(e: TouchEvent | MouseEvent) {\r\n  return IS_MOBILE_SAFARI && e instanceof TouchEvent && e.touches[0].clientX < 30;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport {IS_MOBILE_SAFARI} from '../environment/userAgent';\r\nimport {logger} from '../lib/logger';\r\nimport blurActiveElement from '../helpers/dom/blurActiveElement';\r\nimport cancelEvent from '../helpers/dom/cancelEvent';\r\nimport isSwipingBackSafari from '../helpers/dom/isSwipingBackSafari';\r\nimport indexOfAndSplice from '../helpers/array/indexOfAndSplice';\r\n\r\nexport type NavigationItem = {\r\n  type: 'left' | 'right' | 'im' | 'chat' | 'popup' | 'media' | 'menu' |\r\n    'esg' | 'multiselect' | 'input-helper' | 'autocomplete-helper' | 'markup' |\r\n    'global-search' | 'voice' | 'mobile-search' | 'filters' | 'global-search-focus' |\r\n    'toast' | 'dropdown' | 'forum' | 'stories' | 'stories-focus' | 'topbar-search',\r\n  onPop: (canAnimate: boolean) => boolean | void,\r\n  onEscape?: () => boolean,\r\n  noHistory?: boolean,\r\n  noBlurOnPop?: boolean,\r\n};\r\n\r\nexport class AppNavigationController {\r\n  private navigations: Array<NavigationItem>;\r\n  private id: number;\r\n  private manual: boolean;\r\n  private log: ReturnType<typeof logger>;\r\n  private debug: boolean;\r\n  private currentHash: string; // have to start with # if not empty\r\n  private overriddenHash: string; // have to start with # if not empty\r\n  private isPossibleSwipe: boolean;\r\n  public onHashChange: () => void;\r\n\r\n  constructor() {\r\n    this.navigations = [];\r\n    this.id = Date.now();\r\n    this.manual = false;\r\n    this.log = logger('NC');\r\n    this.debug = true;\r\n    this.currentHash = window.location.hash;\r\n    this.overriddenHash = '';\r\n    this.isPossibleSwipe = false;\r\n\r\n    window.addEventListener('popstate', this.onPopState);\r\n    window.addEventListener('keydown', this.onKeyDown, {capture: true, passive: false});\r\n\r\n    if(IS_MOBILE_SAFARI) {\r\n      const options = {passive: true};\r\n      window.addEventListener('touchstart', this.onTouchStart, options);\r\n    }\r\n\r\n    history.scrollRestoration = 'manual';\r\n\r\n    this.pushState(); // * push init state\r\n  }\r\n\r\n  private onPopState = (e: PopStateEvent) => {\r\n    const hash = window.location.hash;\r\n    const id: number = e.state;\r\n    this.debug && this.log('popstate', e, this.isPossibleSwipe, hash);\r\n    if(hash !== this.currentHash) {\r\n      this.debug && this.log.warn(`hash changed, new=${hash}, current=${this.currentHash}, overridden=${this.overriddenHash}`);\r\n      // fix for returning to wrong hash (e.g. chat -> archive -> chat -> 3x back)\r\n      if(id === this.id && this.overriddenHash && this.overriddenHash !== hash) {\r\n        this.overrideHash(this.overriddenHash);\r\n      } else if(id/*  === this.id */ && !this.overriddenHash && hash) {\r\n        this.overrideHash();\r\n      } else {\r\n        this.currentHash = hash;\r\n        this.onHashChange && this.onHashChange();\r\n        // this.replaceState();\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(id !== this.id/*  && !this.navigations.length */) {\r\n      this.pushState();\r\n\r\n      if(!this.navigations.length) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    const item = this.navigations.pop();\r\n    if(!item) {\r\n      this.pushState();\r\n      return;\r\n    }\r\n\r\n    this.manual = !this.isPossibleSwipe;\r\n    this.handleItem(item, this.navigations.length);\r\n    // this.pushState(); // * prevent adding forward arrow\r\n  };\r\n\r\n  private onKeyDown = (e: KeyboardEvent) => {\r\n    const item = this.navigations[this.navigations.length - 1];\r\n    if(!item) return;\r\n    if(e.key === 'Escape' && (item.onEscape ? item.onEscape() : true)) {\r\n      cancelEvent(e);\r\n      this.back(item.type);\r\n    }\r\n  };\r\n\r\n  private onTouchStart = (e: TouchEvent) => {\r\n    if(e.touches.length > 1) return;\r\n    this.debug && this.log('touchstart');\r\n\r\n    if(isSwipingBackSafari(e)) {\r\n      this.isPossibleSwipe = true;\r\n\r\n      window.addEventListener('touchend', () => {\r\n        setTimeout(() => {\r\n          this.isPossibleSwipe = false;\r\n        }, 100);\r\n      }, {passive: true, once: true});\r\n    }\r\n\r\n    /* const detach = () => {\r\n      window.removeEventListener('touchend', onTouchEnd);\r\n      window.removeEventListener('touchmove', onTouchMove);\r\n    };\r\n\r\n    let moved = false;\r\n    const onTouchMove = (e: TouchEvent) => {\r\n      this.debug && this.log('touchmove');\r\n      if(e.touches.length > 1) {\r\n        detach();\r\n        return;\r\n      }\r\n\r\n      moved = true;\r\n    };\r\n\r\n    const onTouchEnd = (e: TouchEvent) => {\r\n      this.debug && this.log('touchend');\r\n      if(e.touches.length > 1 || !moved) {\r\n        detach();\r\n        return;\r\n      }\r\n\r\n      isPossibleSwipe = true;\r\n      doubleRaf().then(() => {\r\n        isPossibleSwipe = false;\r\n      });\r\n\r\n      detach();\r\n    };\r\n\r\n    window.addEventListener('touchend', onTouchEnd, options);\r\n    window.addEventListener('touchmove', onTouchMove, options); */\r\n  };\r\n\r\n  public overrideHash(hash: string = '') {\r\n    if(hash && hash[0] !== '#') hash = '#' + hash;\r\n    else if(hash === '#') hash = '';\r\n\r\n    if(this.currentHash === hash) {\r\n      return;\r\n    }\r\n\r\n    this.overriddenHash = this.currentHash = hash;\r\n    this.replaceState();\r\n    this.pushState();\r\n  }\r\n\r\n  private handleItem(item: NavigationItem, wasIndex = this.navigations.indexOf(item)) {\r\n    const good = item.onPop(!this.manual ? false : undefined);\r\n    this.debug && this.log('popstate, navigation:', item, this.navigations);\r\n    if(good === false) { // insert item on the same place, because .push can have different index if new item has appeared\r\n      this.spliceItems(Math.min(this.navigations.length, wasIndex), 0, item);\r\n    } else if(!item.noBlurOnPop) {\r\n      blurActiveElement(); // no better place for it\r\n    }\r\n\r\n    this.manual = false;\r\n  }\r\n\r\n  public findItemByType(type: NavigationItem['type']) {\r\n    for(let i = this.navigations.length - 1; i >= 0; --i) {\r\n      const item = this.navigations[i];\r\n      if(item.type === type) {\r\n        return {item, index: i};\r\n      }\r\n    }\r\n  }\r\n\r\n  public back(type?: NavigationItem['type']) {\r\n    if(type) {\r\n      const ret = this.findItemByType(type);\r\n      if(ret) {\r\n        this.backByItem(ret.item, ret.index);\r\n        return;\r\n      }\r\n    }\r\n\r\n    history.back();\r\n  }\r\n\r\n  public backByItem(item: NavigationItem, index = this.navigations.indexOf(item)) {\r\n    if(index === -1) {\r\n      return;\r\n    }\r\n\r\n    this.manual = true;\r\n    // ! commented because 'popstate' event will be fired with delay\r\n    // if(index !== (this.navigations.length - 1)) {\r\n    this.navigations.splice(index, 1);\r\n    this.handleItem(item, index);\r\n    // }\r\n  }\r\n\r\n  private onItemAdded(item: NavigationItem) {\r\n    this.debug && this.log('onItemAdded', item, this.navigations);\r\n\r\n    if(!item.noHistory) {\r\n      this.pushState();\r\n    }\r\n  }\r\n\r\n  public pushItem(item: NavigationItem) {\r\n    this.navigations.push(item);\r\n    this.onItemAdded(item);\r\n  }\r\n\r\n  public unshiftItem(item: NavigationItem) {\r\n    this.navigations.unshift(item);\r\n    this.onItemAdded(item);\r\n  }\r\n\r\n  public spliceItems(index: number, length: number, ...items: NavigationItem[]) {\r\n    this.navigations.splice(index, length, ...items);\r\n    items.forEach((item) => {\r\n      this.onItemAdded(item);\r\n    });\r\n  }\r\n\r\n  public pushState() {\r\n    this.debug && this.log('push');\r\n    this.manual = false;\r\n    history.pushState(this.id, '');\r\n  }\r\n\r\n  public replaceState() {\r\n    this.debug && this.log.warn('replace');\r\n\r\n    const url = location.origin + location.pathname + location.search + this.overriddenHash;\r\n    history.replaceState(this.id, '', url);\r\n  }\r\n\r\n  public removeItem(item: NavigationItem) {\r\n    if(!item) {\r\n      return;\r\n    }\r\n\r\n    indexOfAndSplice(this.navigations, item);\r\n  }\r\n\r\n  public removeByType(type: NavigationItem['type'], single = false) {\r\n    for(let i = this.navigations.length - 1; i >= 0; --i) {\r\n      const item = this.navigations[i];\r\n      if(item.type === type) {\r\n        this.navigations.splice(i, 1);\r\n\r\n        if(single) {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nconst appNavigationController = new AppNavigationController();\r\nMOUNT_CLASS_TO.appNavigationController = appNavigationController;\r\nexport default appNavigationController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport appNavigationController from '../../components/appNavigationController';\r\n\r\nexport class AppRuntimeManager {\r\n  public reload() {\r\n    try {\r\n      appNavigationController.spliceItems(0, Infinity);\r\n      appNavigationController.overrideHash();\r\n      location.reload();\r\n    } catch(e) {};\r\n\r\n    // if(window.chrome && chrome.runtime && chrome.runtime.reload) {\r\n    //   chrome.runtime.reload();\r\n    // }\r\n  }\r\n\r\n  public close() {\r\n    try {\r\n      window.close();\r\n    } catch(e) {}\r\n  }\r\n\r\n  /**\r\n   * Better to call from event\r\n   */\r\n  public focus() {\r\n    // // @ts-ignore\r\n    // if(window.navigator.mozApps && document.hidden) {\r\n    //   // Get app instance and launch it to bring app to foreground\r\n    //   // @ts-ignore\r\n    //   window.navigator.mozApps.getSelf().onsuccess = function() {\r\n    //     this.result.launch();\r\n    //   };\r\n    // } else {\r\n    //   // @ts-ignore\r\n    //   if(window.chrome && chrome.app && chrome.app.window) {\r\n    //     // @ts-ignore\r\n    //     chrome.app.window.current().focus();\r\n    //   }\r\n\r\n    window.focus();\r\n    // }\r\n  }\r\n}\r\n\r\nconst appRuntimeManager = new AppRuntimeManager();\r\nexport default appRuntimeManager;\r\n","export default function copy<T>(obj: T): T {\r\n  // in case of premitives\r\n  if(obj === null || typeof(obj) !== 'object') {\r\n    return obj;\r\n  }\r\n\r\n  // date objects should be\r\n  if(obj instanceof Date) {\r\n    return new Date(obj.getTime()) as any;\r\n  }\r\n\r\n  // handle Array\r\n  if(Array.isArray(obj)) {\r\n    // @ts-ignore\r\n    const clonedArr: T = obj.map((el) => copy(el)) as any as T;\r\n    return clonedArr;\r\n  }\r\n\r\n  if(ArrayBuffer.isView(obj)) {\r\n    // @ts-ignore\r\n    return obj.slice();\r\n  }\r\n\r\n  // lastly, handle objects\r\n  // @ts-ignore\r\n  const clonedObj = new obj.constructor();\r\n  for(var prop in obj) {\r\n    if(obj.hasOwnProperty(prop)) {\r\n      clonedObj[prop] = copy(obj[prop]);\r\n    }\r\n  }\r\n  return clonedObj;\r\n}\r\n","import Modes from '../config/modes';\r\n\r\nconst IS_SHARED_WORKER_SUPPORTED = typeof(SharedWorker) !== 'undefined' && !Modes.noSharedWorker/*  && false */;\r\n\r\nexport default IS_SHARED_WORKER_SUPPORTED;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from '../environment/touchSupport';\r\nimport EventListenerBase from './eventListenerBase';\r\n\r\nconst FOCUS_EVENT_NAME = IS_TOUCH_SUPPORTED ? 'touchstart' : 'mousemove';\r\nconst DO_NOT_IDLE = false;\r\n\r\nexport class IdleController extends EventListenerBase<{\r\n  change: (idle: boolean) => void\r\n}> {\r\n  private _isIdle: boolean;\r\n\r\n  private focusPromise: Promise<void>;\r\n  private focusResolve: () => void;\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    this._isIdle = true;\r\n    this.focusPromise = Promise.resolve();\r\n    this.focusResolve = () => {};\r\n\r\n    window.addEventListener('blur', () => {\r\n      this.isIdle = true;\r\n\r\n      window.addEventListener('focus', () => {\r\n        this.isIdle = false;\r\n      }, {once: true});\r\n    });\r\n\r\n    // * Prevent setting online after reloading page\r\n    window.addEventListener(FOCUS_EVENT_NAME, () => {\r\n      this.isIdle = false;\r\n    }, {once: true, passive: true});\r\n\r\n    this.addEventListener('change', (idle) => {\r\n      if(idle) {\r\n        this.focusPromise = new Promise((resolve) => {\r\n          this.focusResolve = resolve;\r\n        });\r\n      } else {\r\n        this.focusResolve();\r\n      }\r\n    });\r\n  }\r\n\r\n  public getFocusPromise() {\r\n    return this.focusPromise;\r\n  }\r\n\r\n  public get isIdle() {\r\n    return this._isIdle;\r\n  }\r\n\r\n  public set isIdle(value: boolean) {\r\n    if(this._isIdle === value) {\r\n      return;\r\n    }\r\n\r\n    if(DO_NOT_IDLE && value) {\r\n      return;\r\n    }\r\n\r\n    this._isIdle = value;\r\n    this.dispatchEvent('change', value);\r\n  }\r\n}\r\n\r\nconst idleController = new IdleController();\r\nexport default idleController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport App from '../../config/app';\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport tabId from '../../config/tabId';\r\nimport IS_SHARED_WORKER_SUPPORTED from '../../environment/sharedWorkerSupport';\r\nimport EventListenerBase from '../../helpers/eventListenerBase';\r\nimport idleController from '../../helpers/idleController';\r\nimport {logger} from '../logger';\r\nimport rootScope from '../rootScope';\r\nimport sessionStorage from '../sessionStorage';\r\nimport apiManagerProxy from './mtprotoworker';\r\n\r\nexport type AppInstance = {\r\n  id: number,\r\n  idle: boolean,\r\n  time: number\r\n};\r\n\r\nexport type InstanceDeactivateReason = 'version' | 'tabs';\r\n\r\nconst CHECK_INSTANCE_INTERVAL = 5000;\r\nconst DEACTIVATE_TIMEOUT = 30000;\r\nconst MULTIPLE_TABS_THRESHOLD = 20000;\r\nconst IS_MULTIPLE_TABS_SUPPORTED = IS_SHARED_WORKER_SUPPORTED;\r\n\r\nexport class SingleInstance extends EventListenerBase<{\r\n  activated: () =>  void,\r\n  deactivated: (reason: InstanceDeactivateReason) => void\r\n}> {\r\n  private instanceId: number;\r\n  private started: boolean;\r\n  private masterInstance: boolean;\r\n  private deactivateTimeout: number;\r\n  private deactivated: InstanceDeactivateReason;\r\n  private log = logger('INSTANCE');\r\n\r\n  constructor() {\r\n    super(false);\r\n\r\n    this.log = logger('INSTANCE');\r\n    this.instanceId = tabId;\r\n  }\r\n\r\n  public get deactivatedReason() {\r\n    return this.deactivated;\r\n  }\r\n\r\n  public start() {\r\n    this.reset();\r\n\r\n    if(!this.started/*  && !Config.Navigator.mobile && !Config.Modes.packed */) {\r\n      this.started = true;\r\n\r\n      idleController.addEventListener('change', this.checkInstance);\r\n      setInterval(this.checkInstance, CHECK_INSTANCE_INTERVAL);\r\n      this.checkInstance();\r\n\r\n      try {\r\n        document.documentElement.addEventListener('beforeunload', this.clearInstance);\r\n      } catch(e) {}\r\n    }\r\n  }\r\n\r\n  private reset() {\r\n    this.masterInstance = false;\r\n    this.clearDeactivateTimeout();\r\n    this.deactivated = undefined;\r\n  }\r\n\r\n  private clearInstance = () => {\r\n    if(this.masterInstance && !this.deactivated) {\r\n      this.log.warn('clear master instance');\r\n      sessionStorage.delete('xt_instance');\r\n    }\r\n  };\r\n\r\n  public activateInstance() {\r\n    if(this.deactivated) {\r\n      this.reset();\r\n      this.checkInstance(false);\r\n      this.dispatchEvent('activated');\r\n    }\r\n  }\r\n\r\n  private deactivateInstance(reason: InstanceDeactivateReason) {\r\n    if(this.masterInstance || this.deactivated) {\r\n      return;\r\n    }\r\n\r\n    this.log.warn('deactivate', reason);\r\n    this.clearDeactivateTimeout();\r\n    this.deactivated = reason;\r\n\r\n    this.dispatchEvent('deactivated', reason);\r\n  }\r\n\r\n  private clearDeactivateTimeout() {\r\n    if(this.deactivateTimeout) {\r\n      clearTimeout(this.deactivateTimeout);\r\n      this.deactivateTimeout = 0;\r\n    }\r\n  }\r\n\r\n  private checkInstance = async(idle = idleController.isIdle) => {\r\n    if(this.deactivated) {\r\n      return;\r\n    }\r\n\r\n    const time = Date.now();\r\n    const newInstance: AppInstance = {\r\n      id: this.instanceId,\r\n      idle,\r\n      time\r\n    };\r\n\r\n    const [curInstance, build = App.build] = await Promise.all([\r\n      sessionStorage.get('xt_instance', false),\r\n      sessionStorage.get('k_build', false)\r\n    ]);\r\n\r\n    if(build > App.build) {\r\n      this.masterInstance = false;\r\n      rootScope.managers.networkerFactory.stopAll();\r\n      this.deactivateInstance('version');\r\n      apiManagerProxy.toggleStorages(false, false);\r\n      return;\r\n    } else if(IS_MULTIPLE_TABS_SUPPORTED) {\r\n      sessionStorage.set({xt_instance: newInstance});\r\n      return;\r\n    }\r\n\r\n    // this.log('check instance', newInstance, curInstance)\r\n    if(!idle ||\r\n        !curInstance ||\r\n        curInstance.id === this.instanceId ||\r\n        curInstance.time < (time - MULTIPLE_TABS_THRESHOLD)) {\r\n      sessionStorage.set({xt_instance: newInstance});\r\n\r\n      if(!this.masterInstance) {\r\n        this.masterInstance = true;\r\n        rootScope.managers.networkerFactory.startAll();\r\n        this.log.warn('now master instance', newInstance);\r\n      }\r\n\r\n      this.clearDeactivateTimeout();\r\n    } else if(this.masterInstance) {\r\n      this.masterInstance = false;\r\n      rootScope.managers.networkerFactory.stopAll();\r\n      this.log.warn('now idle instance', newInstance);\r\n      this.deactivateTimeout ||= window.setTimeout(() => this.deactivateInstance('tabs'), DEACTIVATE_TIMEOUT);\r\n    }\r\n  };\r\n}\r\n\r\nconst singleInstance = new SingleInstance();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.singleInstance = singleInstance);\r\nexport default singleInstance;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MESSAGE_ID_OFFSET} from '../../../mtproto/mtproto_config';\r\n\r\nexport default function clearMessageId(messageId: number, toServer?: boolean) {\r\n  if(messageId === undefined) {\r\n    return;\r\n  }\r\n\r\n  messageId = +messageId.toFixed(0);\r\n  if(!toServer) {\r\n    return messageId;\r\n  }\r\n\r\n  return messageId < MESSAGE_ID_OFFSET ? messageId : messageId % MESSAGE_ID_OFFSET;\r\n  // const q = MESSAGE_ID_OFFSET;\r\n  // if(messageId < q) { // id 0 -> mid 0xFFFFFFFF, so 0xFFFFFFFF must convert to 0\r\n  //   return messageId;\r\n  // }\r\n\r\n  // const l = MESSAGE_ID_INCREMENT - 1;\r\n  // const used = messageId & l;\r\n  // if(used !== l) {\r\n  //   messageId -= used + 1;\r\n  // }\r\n\r\n  // return toServer ? (messageId - q) / MESSAGE_ID_INCREMENT : messageId;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport clearMessageId from './clearMessageId';\r\n\r\n/**\r\n * * will ignore outgoing offset\r\n */\r\nexport default function getServerMessageId(messageId: number) {\r\n  return clearMessageId(messageId, true);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport type {PushNotificationObject} from '../serviceWorker/push';\r\nimport type {ServicePushPingTaskPayload} from '../serviceWorker/serviceMessagePort';\r\nimport type {NotificationSettings} from '../appManagers/uiNotificationsManager';\r\nimport type ServiceMessagePort from '../serviceWorker/serviceMessagePort';\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport {logger} from '../logger';\r\nimport I18n, {LangPackKey} from '../langPack';\r\nimport {IS_MOBILE} from '../../environment/userAgent';\r\nimport appRuntimeManager from '../appManagers/appRuntimeManager';\r\nimport copy from '../../helpers/object/copy';\r\nimport singleInstance from './singleInstance';\r\nimport EventListenerBase from '../../helpers/eventListenerBase';\r\nimport getServerMessageId from '../appManagers/utils/messageId/getServerMessageId';\r\n\r\nexport type PushSubscriptionNotifyType = 'init' | 'subscribe' | 'unsubscribe';\r\nexport type PushSubscriptionNotifyEvent = `push_${PushSubscriptionNotifyType}`;\r\n\r\nexport type PushSubscriptionNotify = {\r\n  tokenType: number,\r\n  tokenValue: string\r\n};\r\n\r\nconst PING_PUSH_INTERVAL = 10000;\r\n\r\nexport class WebPushApiManager extends EventListenerBase<{\r\n  push_notification_click: (n: PushNotificationObject) => void,\r\n  push_init: (n: PushSubscriptionNotify) => void,\r\n  push_subscribe: (n: PushSubscriptionNotify) => void,\r\n  push_unsubscribe: (n: PushSubscriptionNotify) => void\r\n}> {\r\n  public isAvailable = true;\r\n  private isPushEnabled = false;\r\n  private localNotificationsAvailable = true;\r\n  private started = false;\r\n  private settings: NotificationSettings & {baseUrl?: string} = {} as any;\r\n  private isAliveTO: any;\r\n  private isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\r\n  private userVisibleOnly = this.isFirefox ? false : true;\r\n  private log = logger('PUSH-API');\r\n\r\n  public serviceMessagePort: ServiceMessagePort<true>;\r\n\r\n  constructor() {\r\n    super(false);\r\n\r\n    if(!('PushManager' in window) ||\r\n      !('Notification' in window) ||\r\n      !('serviceWorker' in navigator)) {\r\n      this.log.warn('Push messaging is not supported.');\r\n      this.isAvailable = false;\r\n      this.localNotificationsAvailable = false;\r\n    }\r\n\r\n    if(this.isAvailable && Notification.permission === 'denied') {\r\n      this.log.warn('The user has blocked notifications.');\r\n    }\r\n  }\r\n\r\n  public start() {\r\n    if(!this.started) {\r\n      this.started = true;\r\n      this.getSubscription();\r\n      this.setUpServiceWorkerChannel();\r\n    }\r\n  }\r\n\r\n  public setLocalNotificationsDisabled() {\r\n    this.localNotificationsAvailable = false;\r\n  }\r\n\r\n  public getSubscription() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.ready.then((reg) => {\r\n      reg.pushManager.getSubscription().then((subscription) => {\r\n        this.isPushEnabled = !!subscription;\r\n        this.pushSubscriptionNotify('init', subscription);\r\n      }).catch((err) => {\r\n        this.log.error('Error during getSubscription()', err);\r\n      });\r\n    });\r\n  }\r\n\r\n  public subscribe = () => {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.ready.then((reg) => {\r\n      reg.pushManager.subscribe({userVisibleOnly: this.userVisibleOnly}).then((subscription) => {\r\n        // The subscription was successful\r\n        this.isPushEnabled = true;\r\n        this.pushSubscriptionNotify('subscribe', subscription);\r\n      }).catch((e) => {\r\n        if(Notification.permission === 'denied') {\r\n          this.log('Permission for Notifications was denied');\r\n        } else {\r\n          this.log('Unable to subscribe to push.', e);\r\n          if(!this.userVisibleOnly) {\r\n            this.userVisibleOnly = true;\r\n            setTimeout(this.subscribe, 0);\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  public unsubscribe() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.ready.then((reg) => {\r\n      reg.pushManager.getSubscription().then((subscription) => {\r\n        this.isPushEnabled = false;\r\n\r\n        if(subscription) {\r\n          this.pushSubscriptionNotify('unsubscribe', subscription);\r\n\r\n          setTimeout(() => {\r\n            subscription.unsubscribe().then((successful) => {\r\n              this.isPushEnabled = false;\r\n            }).catch((e) => {\r\n              this.log.error('Unsubscription error: ', e);\r\n            });\r\n          }, 3000);\r\n        }\r\n      }).catch((e) => {\r\n        this.log.error('Error thrown while unsubscribing from ' +\r\n          'push messaging.', e);\r\n      });\r\n    });\r\n  }\r\n\r\n  public forceUnsubscribe() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.ready.then((reg) => {\r\n      reg.pushManager.getSubscription().then((subscription) => {\r\n        this.log.warn('force unsubscribe', subscription);\r\n        if(!subscription) {\r\n          return;\r\n        }\r\n\r\n        subscription.unsubscribe().then((successful) => {\r\n          this.log.warn('force unsubscribe successful', successful);\r\n          this.isPushEnabled = false;\r\n        }).catch((e) => {\r\n          this.log.error('Unsubscription error: ', e);\r\n        });\r\n      }).catch((e) => {\r\n        this.log.error('Error thrown while unsubscribing from ' +\r\n          'push messaging.', e);\r\n      });\r\n    });\r\n  }\r\n\r\n  public isAliveNotify = () => {\r\n    if(!this.isAvailable || singleInstance.deactivatedReason) {\r\n      return;\r\n    }\r\n\r\n    this.settings.baseUrl = (location.href || '').replace(/#.*$/, '');\r\n\r\n    const lang: ServicePushPingTaskPayload['lang'] = {} as any;\r\n    const ACTIONS_LANG_MAP: Record<keyof ServicePushPingTaskPayload['lang'], LangPackKey> = {\r\n      push_action_mute1d: IS_MOBILE ? 'PushNotification.Action.Mute1d.Mobile' : 'PushNotification.Action.Mute1d',\r\n      push_action_settings: IS_MOBILE ? 'PushNotification.Action.Settings.Mobile' : 'PushNotification.Action.Settings',\r\n      push_message_nopreview: 'PushNotification.Message.NoPreview'\r\n    };\r\n\r\n    for(const action in ACTIONS_LANG_MAP) {\r\n      lang[action as keyof typeof ACTIONS_LANG_MAP] = I18n.format(ACTIONS_LANG_MAP[action as keyof typeof ACTIONS_LANG_MAP], true);\r\n    }\r\n\r\n    this.serviceMessagePort.invokeVoid('pushPing', {\r\n      localNotifications: this.localNotificationsAvailable,\r\n      lang: lang,\r\n      settings: this.settings\r\n    });\r\n\r\n    this.isAliveTO = setTimeout(this.isAliveNotify, PING_PUSH_INTERVAL);\r\n  }\r\n\r\n  public setSettings(newSettings: WebPushApiManager['settings']) {\r\n    this.settings = copy(newSettings);\r\n    clearTimeout(this.isAliveTO);\r\n    this.isAliveNotify();\r\n  }\r\n\r\n  public hidePushNotifications() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    this.serviceMessagePort.invokeVoid('notificationsClear', undefined);\r\n  }\r\n\r\n  public setUpServiceWorkerChannel() {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    this.serviceMessagePort.addEventListener('pushClick', (payload) => {\r\n      if(singleInstance.deactivatedReason) {\r\n        appRuntimeManager.reload();\r\n        return;\r\n      }\r\n\r\n      this.dispatchEvent('push_notification_click', payload);\r\n    });\r\n\r\n    navigator.serviceWorker.ready.then(this.isAliveNotify);\r\n  }\r\n\r\n  public pushSubscriptionNotify(event: PushSubscriptionNotifyType, subscription?: PushSubscription) {\r\n    if(subscription) {\r\n      const subscriptionObj: PushSubscriptionJSON = subscription.toJSON();\r\n      if(!subscriptionObj ||\r\n        !subscriptionObj.endpoint ||\r\n        !subscriptionObj.keys ||\r\n        !subscriptionObj.keys.p256dh ||\r\n        !subscriptionObj.keys.auth) {\r\n        this.log.warn('Invalid push subscription', subscriptionObj);\r\n        this.unsubscribe();\r\n        this.isAvailable = false;\r\n        this.pushSubscriptionNotify(event);\r\n        return;\r\n      }\r\n\r\n      this.log.warn('Push', event, subscriptionObj);\r\n      this.dispatchEvent(('push_' + event) as PushSubscriptionNotifyEvent, {\r\n        tokenType: 10,\r\n        tokenValue: JSON.stringify(subscriptionObj)\r\n      });\r\n    } else {\r\n      this.log.warn('Push', event, false);\r\n      this.dispatchEvent(('push_' + event) as PushSubscriptionNotifyEvent, false as any);\r\n    }\r\n  }\r\n\r\n  public ignorePushByMid(peerId: PeerId, mid: number) {\r\n    if(!this.isAvailable) {\r\n      return;\r\n    }\r\n\r\n    this.serviceMessagePort.invokeVoid('shownNotification', peerId + '_' + getServerMessageId(mid));\r\n  }\r\n}\r\n\r\nconst webPushApiManager = new WebPushApiManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.webPushApiManager = webPushApiManager);\r\nexport default webPushApiManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function loadScript(url: string) {\r\n  const script = document.createElement('script');\r\n  const promise = new Promise<HTMLScriptElement>((resolve) => {\r\n    script.onload = script.onerror = () => {\r\n      resolve(script);\r\n    };\r\n  });\r\n  script.src = url;\r\n  document.body.appendChild(script);\r\n  return promise;\r\n}\r\n","export default function tsNow(seconds?: true) {\r\n  const t = Date.now();\r\n  return seconds ? t / 1000 | 0 : t;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport App from '../../config/app';\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport Modes from '../../config/modes';\r\nimport loadScript from '../../helpers/dom/loadScript';\r\nimport tsNow from '../../helpers/tsNow';\r\nimport sessionStorage from '../sessionStorage';\r\n\r\nexport class TelegramMeWebManager {\r\n  private disabled = /* false &&  */(Modes.test || !App.domains.includes(location.hostname));\r\n\r\n  public setAuthorized(canRedirect: boolean) {\r\n    if(this.disabled) {\r\n      return;\r\n    }\r\n\r\n    return sessionStorage.get('tgme_sync').then((curValue) => {\r\n      const ts = tsNow(true);\r\n      if(\r\n        canRedirect &&\r\n        curValue?.canRedirect === canRedirect &&\r\n        (curValue.ts + 86400) > ts\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      sessionStorage.set({\r\n        tgme_sync: {\r\n          canRedirect,\r\n          ts\r\n        }\r\n      });\r\n\r\n      const path = `_websync_?authed=${canRedirect ? '1' : '0'}&version=${encodeURIComponent(App.version + ' ' + App.suffix)}`;\r\n      const urls = [\r\n        '//telegram.me/' + path,\r\n        '//t.me/' + path\r\n      ];\r\n\r\n      const promises = urls.map((url) => {\r\n        return loadScript(url).then((script) => {\r\n          script.remove();\r\n        });\r\n      });\r\n\r\n      return Promise.all(promises);\r\n    });\r\n  }\r\n}\r\n\r\nconst telegramMeWebManager = new TelegramMeWebManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.telegramMeWebManager = telegramMeWebManager);\r\nexport default telegramMeWebManager;\r\n","import {IS_FIREFOX} from './userAgent';\r\n\r\nconst IS_WEBRTC_SUPPORTED = !!(typeof(RTCPeerConnection) !== 'undefined' && !IS_FIREFOX);\r\n\r\nexport default IS_WEBRTC_SUPPORTED;\r\n","import IS_WEBRTC_SUPPORTED from './webrtcSupport';\r\n\r\nconst IS_CALL_SUPPORTED = IS_WEBRTC_SUPPORTED;\r\n\r\nexport default IS_CALL_SUPPORTED;\r\n","import {IS_SAFARI} from './userAgent';\r\n\r\n/*\r\n * This is used as a workaround for a memory leak in Safari caused by using Transferable objects to\r\n * transfer data between WebWorkers and the main thread.\r\n * https://github.com/mapbox/mapbox-gl-js/issues/8771\r\n *\r\n * This should be removed once the underlying Safari issue is fixed.\r\n */\r\n\r\nlet CAN_USE_TRANSFERABLES: boolean;\r\nif(!IS_SAFARI) CAN_USE_TRANSFERABLES = true;\r\nelse {\r\n  try {\r\n    const match = navigator.userAgent.match(/Version\\/(.+?) /);\r\n    CAN_USE_TRANSFERABLES = +match[1] >= 14;\r\n  } catch(err) {\r\n    CAN_USE_TRANSFERABLES = false;\r\n  }\r\n}\r\n\r\nexport default CAN_USE_TRANSFERABLES;\r\n","const IS_CANVAS_FILTER_SUPPORTED = 'filter' in (document.createElement('canvas').getContext('2d') || {});\r\n\r\nexport default IS_CANVAS_FILTER_SUPPORTED;\r\n","const IS_GEOLOCATION_SUPPORTED = !!navigator?.geolocation?.getCurrentPosition && false;\r\n\r\nexport default IS_GEOLOCATION_SUPPORTED;\r\n","import IS_WEBRTC_SUPPORTED from './webrtcSupport';\r\n\r\nconst IS_GROUP_CALL_SUPPORTED = IS_WEBRTC_SUPPORTED;\r\n\r\nexport default IS_GROUP_CALL_SUPPORTED;\r\n","const IS_WEBP_SUPPORTED = document.createElement('canvas').toDataURL('image/webp').startsWith('data:image/webp');\r\n\r\nexport default IS_WEBP_SUPPORTED;\r\n","import IS_WEBP_SUPPORTED from './webpSupport';\r\n\r\nconst IMAGE_MIME_TYPES_SUPPORTED = new Set([\r\n  'image/jpeg',\r\n  'image/png',\r\n  'image/bmp'\r\n]);\r\n\r\nif(IS_WEBP_SUPPORTED) {\r\n  IMAGE_MIME_TYPES_SUPPORTED.add('image/webp');\r\n}\r\n\r\nconst possible: [string, string][] = [\r\n  ['image/jxl', 'data:image/jxl;base64,/woIAAAMABKIAgC4AF3lEgAAFSqjjBu8nOv58kOHxbSN6wxttW1hSaLIODZJJ3BIEkkaoCUzGM6qJAE='],\r\n  ['image/avif', 'data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A=']\r\n];\r\n\r\nconst promises = possible.map(([mime, data]) => {\r\n  const img = new Image();\r\n  const promise = new Promise<string>((resolve) => {\r\n    img.onload = img.onerror = () => {\r\n      const supported = img.height === 2;\r\n      resolve(supported ? mime : undefined);\r\n    };\r\n  });\r\n  img.src = data;\r\n  return promise;\r\n});\r\n\r\nexport const IMAGE_MIME_TYPES_SUPPORTED_PROMISE = Promise.all(promises).then((mimeTypes) => mimeTypes.filter(Boolean));\r\n\r\nexport default IMAGE_MIME_TYPES_SUPPORTED;\r\n","import {IS_SAFARI, IS_APPLE_MOBILE} from './userAgent';\r\n\r\nconst video = document.createElement('video');\r\nconst IS_WEBM_SUPPORTED = !!video.canPlayType('video/webm') && !IS_SAFARI && !IS_APPLE_MOBILE;\r\n// mov is not supported in Chrome on macOS\r\nconst IS_MOV_SUPPORTED = !!video.canPlayType('video/quicktime') || IS_SAFARI || IS_APPLE_MOBILE;\r\nconst IS_H265_SUPPORTED = !!video.canPlayType('video/mp4; codecs=\"hev1\"');\r\n\r\nexport {\r\n  IS_WEBM_SUPPORTED,\r\n  IS_MOV_SUPPORTED,\r\n  IS_H265_SUPPORTED\r\n};\r\n","import {IS_MOV_SUPPORTED} from './videoSupport';\r\n\r\nexport type VIDEO_MIME_TYPE = 'image/gif' | 'video/mp4' | 'video/webm' | 'video/quicktime';\r\nconst VIDEO_MIME_TYPES_SUPPORTED: Set<VIDEO_MIME_TYPE> = new Set([\r\n  'image/gif', // have to display it as video\r\n  'video/mp4',\r\n  'video/webm'\r\n]);\r\n\r\nif(IS_MOV_SUPPORTED) {\r\n  VIDEO_MIME_TYPES_SUPPORTED.add('video/quicktime');\r\n}\r\n\r\nexport default VIDEO_MIME_TYPES_SUPPORTED;\r\n","import {IS_FIREFOX} from './userAgent';\r\n\r\nconst IS_PARALLAX_SUPPORTED = !IS_FIREFOX && false;\r\n\r\nexport default IS_PARALLAX_SUPPORTED;\r\n","const IS_SCREEN_SHARING_SUPPORTED = !!('getDisplayMedia' in (navigator?.mediaDevices || {}));\r\n\r\nexport default IS_SCREEN_SHARING_SUPPORTED;\r\n","const IS_VIBRATE_SUPPORTED = !!navigator?.vibrate;\r\n\r\nexport default IS_VIBRATE_SUPPORTED;\r\n","const audio = document.createElement('audio');\r\nconst IS_OPUS_SUPPORTED = !!(audio.canPlayType && audio.canPlayType('audio/ogg;').replace(/no/, ''))/*  && false */;\r\n\r\nexport default IS_OPUS_SUPPORTED;\r\n","let IS_APPLE_MX = false;\r\n\r\ntry {\r\n  // Awesome detect from https://stackoverflow.com/a/65412357\r\n  const ctx = document.createElement('canvas').getContext('webgl');\r\n  const extension = ctx.getExtension('WEBGL_debug_renderer_info');\r\n  const renderer: string = extension && ctx.getParameter(extension.UNMASKED_RENDERER_WEBGL) || '';\r\n  if((renderer.match(/Apple/) && !renderer.match(/Apple GPU/)) ||\r\n    ctx.getSupportedExtensions().indexOf('WEBGL_compressed_texture_s3tc_srgb') === -1) {\r\n    IS_APPLE_MX = true;\r\n  }\r\n} catch(err) {\r\n\r\n}\r\n\r\nexport default IS_APPLE_MX;\r\n","const IS_LIVE_STREAM_SUPPORTED = 'serviceWorker' in navigator;\r\n\r\nexport default IS_LIVE_STREAM_SUPPORTED;\r\n","import IS_CALL_SUPPORTED from './callSupport';\r\nimport CAN_USE_TRANSFERABLES from './canUseTransferables';\r\nimport IS_CANVAS_FILTER_SUPPORTED from './canvasFilterSupport';\r\nimport IS_EMOJI_SUPPORTED from './emojiSupport';\r\nimport IS_GEOLOCATION_SUPPORTED from './geolocationSupport';\r\nimport IS_GROUP_CALL_SUPPORTED from './groupCallSupport';\r\nimport IMAGE_MIME_TYPES_SUPPORTED from './imageMimeTypesSupport';\r\nimport MEDIA_MIME_TYPES_SUPPORTED from './mediaMimeTypesSupport';\r\nimport IS_PARALLAX_SUPPORTED from './parallaxSupport';\r\nimport IS_SCREEN_SHARING_SUPPORTED from './screenSharingSupport';\r\nimport IS_TOUCH_SUPPORTED from './touchSupport';\r\nimport IS_VIBRATE_SUPPORTED from './vibrateSupport';\r\nimport VIDEO_MIME_TYPES_SUPPORTED from './videoMimeTypesSupport';\r\nimport IS_WEBP_SUPPORTED from './webpSupport';\r\nimport IS_WEBRTC_SUPPORTED from './webrtcSupport';\r\nimport * as userAgent from './userAgent';\r\nimport IS_OPUS_SUPPORTED from './opusSupport';\r\nimport IS_SHARED_WORKER_SUPPORTED from './sharedWorkerSupport';\r\nimport IS_APPLE_MX from './appleMx';\r\nimport IS_LIVE_STREAM_SUPPORTED from './liveStreamSupport';\r\nimport * as IS_VIDEO_SUPPORTED from './videoSupport';\r\n\r\nconst ENVIRONMENT = {\r\n  CAN_USE_TRANSFERABLES,\r\n  IS_APPLE_MX,\r\n  IS_CALL_SUPPORTED,\r\n  IS_CANVAS_FILTER_SUPPORTED,\r\n  IS_EMOJI_SUPPORTED,\r\n  IS_GEOLOCATION_SUPPORTED,\r\n  IS_GROUP_CALL_SUPPORTED,\r\n  IS_PARALLAX_SUPPORTED,\r\n  IS_SCREEN_SHARING_SUPPORTED,\r\n  IS_TOUCH_SUPPORTED,\r\n  ...IS_VIDEO_SUPPORTED,\r\n  IS_VIBRATE_SUPPORTED,\r\n  IS_OPUS_SUPPORTED,\r\n  IS_SHARED_WORKER_SUPPORTED,\r\n  IS_WEBP_SUPPORTED,\r\n  IS_WEBRTC_SUPPORTED,\r\n  IS_LIVE_STREAM_SUPPORTED,\r\n  IMAGE_MIME_TYPES_SUPPORTED,\r\n  MEDIA_MIME_TYPES_SUPPORTED,\r\n  VIDEO_MIME_TYPES_SUPPORTED,\r\n  ...userAgent\r\n};\r\n\r\nexport default ENVIRONMENT;\r\n","// https://stackoverflow.com/a/61676104\r\nexport default function getTimeFormat(): 'h12' | 'h23' {\r\n  const t = document.createElement('input');\r\n  t.type = 'time';\r\n  t.value = '15:00';\r\n  t.style.visibility = 'hidden';\r\n  document.body.append(t);\r\n  const offsetWidth = t.offsetWidth;\r\n  t.remove();\r\n  const timeFormat = offsetWidth > 110 ? 'h12' : 'h23';\r\n  // console.log('timeFormat', timeFormat, offsetWidth);\r\n  return timeFormat;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nconst arrays = {\r\n  8: new Uint8Array(1),\r\n  16: new Uint16Array(1),\r\n  32: new Uint32Array(1)\r\n};\r\nexport function nextRandomUint(bits: 8 | 16 | 32) {\r\n  const array = arrays[bits];\r\n  crypto.getRandomValues(array);\r\n  return array[0];\r\n}\r\n\r\nexport function randomLong() {\r\n  return '' + nextRandomUint(32) + nextRandomUint(32) % 0xFFFFFF;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {LiteModeKey} from '../helpers/liteMode';\r\nimport type {AppMediaPlaybackController} from '../components/appMediaPlaybackController';\r\nimport type {TopPeerType, MyTopPeer} from '../lib/appManagers/appUsersManager';\r\nimport type {AccountThemes, AutoDownloadSettings, BaseTheme, NotifyPeer, PeerNotifySettings, Theme, ThemeSettings, WallPaper} from '../layer';\r\nimport type DialogsStorage from '../lib/storages/dialogs';\r\nimport type FiltersStorage from '../lib/storages/filters';\r\nimport type {AuthState, Modify} from '../types';\r\nimport {IS_MOBILE} from '../environment/userAgent';\r\nimport getTimeFormat from '../helpers/getTimeFormat';\r\nimport {nextRandomUint} from '../helpers/random';\r\nimport App from './app';\r\nimport {MTAppConfig} from '../lib/mtproto/appConfig';\r\n\r\nconst STATE_VERSION = App.version;\r\nconst BUILD = App.build;\r\n\r\n// ! DEPRECATED\r\nexport type Background = {\r\n  type?: 'color' | 'image' | 'default', // ! DEPRECATED\r\n  blur: boolean,\r\n  highlightingColor?: string,\r\n  color?: string,\r\n  slug?: string,        // image slug\r\n  intensity?: number,   // pattern intensity\r\n  id: string | number,  // wallpaper id\r\n};\r\n\r\nexport type AppTheme = Modify<Theme, {\r\n  name: 'day' | 'night' | 'system',\r\n  settings?: Modify<ThemeSettings, {\r\n    highlightingColor: string\r\n  }>\r\n}>;\r\n\r\nexport type AutoDownloadPeerTypeSettings = {\r\n  contacts: boolean,\r\n  private: boolean,\r\n  groups: boolean,\r\n  channels: boolean\r\n};\r\n\r\nexport type State = {\r\n  allDialogsLoaded: DialogsStorage['allDialogsLoaded'],\r\n  pinnedOrders: DialogsStorage['pinnedOrders'],\r\n  // contactsList: UserId[],\r\n  contactsListCachedTime: number,\r\n  updates: Partial<{\r\n    seq: number,\r\n    pts: number,\r\n    date: number\r\n  }>,\r\n  // filters?: FiltersStorage['filters'], // ! DEPRECATED\r\n  filtersArr?: FiltersStorage['filtersArr'],\r\n  maxSeenMsgId: number,\r\n  stateCreatedTime: number,\r\n  recentEmoji: string[],\r\n  recentCustomEmoji: DocId[],\r\n  topPeersCache: {\r\n    [type in TopPeerType]?: {\r\n      peers: MyTopPeer[],\r\n      cachedTime: number\r\n    }\r\n  },\r\n  recentSearch: PeerId[],\r\n  version: typeof STATE_VERSION,\r\n  build: typeof BUILD,\r\n  authState: AuthState,\r\n  hiddenPinnedMessages: {[peerId: PeerId]: number},\r\n  settings: {\r\n    messagesTextSize: number,\r\n    distanceUnit: 'kilometers' | 'miles',\r\n    sendShortcut: 'enter' | 'ctrlEnter',\r\n    animationsEnabled?: boolean, // ! DEPRECATED\r\n    autoDownload: {\r\n      contacts?: boolean, // ! DEPRECATED\r\n      private?: boolean, // ! DEPRECATED\r\n      groups?: boolean, // ! DEPRECATED\r\n      channels?: boolean, // ! DEPRECATED\r\n      photo: AutoDownloadPeerTypeSettings,\r\n      video: AutoDownloadPeerTypeSettings,\r\n      file: AutoDownloadPeerTypeSettings\r\n    },\r\n    autoDownloadNew: AutoDownloadSettings,\r\n    autoPlay?: { // ! DEPRECATED\r\n      gifs: boolean,\r\n      videos: boolean\r\n    },\r\n    stickers: {\r\n      suggest: 'all' | 'installed' | 'none',\r\n      dynamicPackOrder: boolean,\r\n      loop: boolean\r\n    },\r\n    emoji: {\r\n      suggest: boolean,\r\n      big: boolean\r\n    },\r\n    background?: Background, // ! DEPRECATED\r\n    themes: AppTheme[],\r\n    theme: AppTheme['name'],\r\n    notifications: {\r\n      sound: boolean\r\n    },\r\n    nightTheme?: boolean, // ! DEPRECATED\r\n    timeFormat: 'h12' | 'h23',\r\n    liteMode: {[key in LiteModeKey]: boolean},\r\n    savedAsForum: boolean\r\n  },\r\n  playbackParams: ReturnType<AppMediaPlaybackController['getPlaybackParams']>,\r\n  keepSigned: boolean,\r\n  chatContextMenuHintWasShown: boolean,\r\n  hideChatJoinRequests: {[peerId: PeerId]: number},\r\n  stateId: number,\r\n  notifySettings: {[k in Exclude<NotifyPeer['_'], 'notifyPeer'>]?: PeerNotifySettings.peerNotifySettings},\r\n  confirmedWebViews: BotId[],\r\n  seenTooltips: {\r\n    storySound: boolean\r\n  },\r\n  hiddenSimilarChannels: number[],\r\n  appConfig: MTAppConfig,\r\n  accountThemes: AccountThemes.accountThemes,\r\n  translations: {\r\n    peers: {[peerId: PeerId]: string},\r\n    enabledPeers: {[peerId: PeerId]: boolean},\r\n    enabled: boolean,\r\n    showInMenu: boolean,\r\n    doNotTranslate: TranslatableLanguageISO[]\r\n  },\r\n  shownUploadSpeedTimestamp?: number\r\n};\r\n\r\n// const BACKGROUND_DAY_MOBILE: Background = {\r\n//   blur: false,\r\n//   slug: '',\r\n//   color: '#dbddbb,#6ba587,#d5d88d,#88b884',\r\n//   highlightingColor: 'hsla(86.4, 43.846153%, 45.117647%, .4)',\r\n//   intensity: 0,\r\n//   id: '1'\r\n// };\r\n\r\n// const BACKGROUND_NIGHT_MOBILE: Background = {\r\n//   blur: false,\r\n//   slug: '',\r\n//   color: '#0f0f0f',\r\n//   highlightingColor: 'hsla(0, 0%, 3.82353%, 0.4)',\r\n//   intensity: 0,\r\n//   id: '-1'\r\n// };\r\n\r\nexport const DEFAULT_THEME: Theme = {\r\n  _: 'theme',\r\n  access_hash: '',\r\n  id: '',\r\n  settings: [{\r\n    _: 'themeSettings',\r\n    pFlags: {},\r\n    base_theme: {_: 'baseThemeClassic'},\r\n    accent_color: 0x3390ec,\r\n    message_colors: [0x5CA853],\r\n    wallpaper: {\r\n      _: 'wallPaper',\r\n      pFlags: {\r\n        default: true,\r\n        pattern: true\r\n      },\r\n      access_hash: '',\r\n      document: undefined,\r\n      id: '',\r\n      slug: 'pattern',\r\n      settings: {\r\n        _: 'wallPaperSettings',\r\n        pFlags: {},\r\n        intensity: 50,\r\n        background_color: 0xdbddbb,\r\n        second_background_color: 0x6ba587,\r\n        third_background_color: 0xd5d88d,\r\n        fourth_background_color: 0x88b884\r\n      }\r\n    }\r\n  }, {\r\n    _: 'themeSettings',\r\n    pFlags: {},\r\n    base_theme: {_: 'baseThemeNight'},\r\n    accent_color: 0x8774E1,\r\n    message_colors: [0x8774E1],\r\n    wallpaper: {\r\n      _: 'wallPaper',\r\n      pFlags: {\r\n        default: true,\r\n        pattern: true,\r\n        dark: true\r\n      },\r\n      access_hash: '',\r\n      document: undefined,\r\n      id: '',\r\n      slug: 'pattern',\r\n      settings: {\r\n        _: 'wallPaperSettings',\r\n        pFlags: {},\r\n        intensity: -50,\r\n        background_color: 0xfec496,\r\n        second_background_color: 0xdd6cb9,\r\n        third_background_color: 0x962fbf,\r\n        fourth_background_color: 0x4f5bd5\r\n      }\r\n    }\r\n  }],\r\n  slug: '',\r\n  title: '',\r\n  emoticon: '',\r\n  pFlags: {default: true}\r\n};\r\n\r\nconst makeDefaultAppTheme = (\r\n  name: AppTheme['name'],\r\n  baseTheme: BaseTheme['_'],\r\n  highlightingColor: string\r\n): AppTheme => {\r\n  return {\r\n    ...DEFAULT_THEME,\r\n    name,\r\n    settings: {\r\n      ...DEFAULT_THEME.settings.find((s) => s.base_theme._ === baseTheme),\r\n      highlightingColor\r\n    }\r\n  };\r\n};\r\n\r\nexport const STATE_INIT: State = {\r\n  allDialogsLoaded: {},\r\n  pinnedOrders: {},\r\n  // contactsList: [],\r\n  contactsListCachedTime: 0,\r\n  updates: {},\r\n  filtersArr: [],\r\n  maxSeenMsgId: 0,\r\n  stateCreatedTime: Date.now(),\r\n  recentEmoji: [],\r\n  recentCustomEmoji: [],\r\n  topPeersCache: {},\r\n  recentSearch: [],\r\n  version: STATE_VERSION,\r\n  build: BUILD,\r\n  authState: {\r\n    _: IS_MOBILE ? 'authStateSignIn' : 'authStateSignQr'\r\n  },\r\n  hiddenPinnedMessages: {},\r\n  settings: {\r\n    messagesTextSize: 16,\r\n    distanceUnit: 'kilometers',\r\n    sendShortcut: 'enter',\r\n    autoDownload: {\r\n      photo: {\r\n        contacts: true,\r\n        private: true,\r\n        groups: true,\r\n        channels: true\r\n      },\r\n      video: {\r\n        contacts: true,\r\n        private: true,\r\n        groups: true,\r\n        channels: true\r\n      },\r\n      file: {\r\n        contacts: true,\r\n        private: true,\r\n        groups: true,\r\n        channels: true\r\n      }\r\n    },\r\n    autoDownloadNew: {\r\n      _: 'autoDownloadSettings',\r\n      file_size_max: 3145728,\r\n      pFlags: {\r\n        video_preload_large: true,\r\n        audio_preload_next: true\r\n      },\r\n      photo_size_max: 1048576,\r\n      video_size_max: 15728640,\r\n      video_upload_maxbitrate: 100,\r\n      small_queue_active_operations_max: 0,\r\n      large_queue_active_operations_max: 0\r\n    },\r\n    stickers: {\r\n      suggest: 'all',\r\n      dynamicPackOrder: true,\r\n      loop: true\r\n    },\r\n    emoji: {\r\n      suggest: true,\r\n      big: true\r\n    },\r\n    themes: [\r\n      makeDefaultAppTheme('day', 'baseThemeClassic', 'hsla(86.4, 43.846153%, 45.117647%, .4)'),\r\n      makeDefaultAppTheme('night', 'baseThemeNight', 'hsla(299.142857, 44.166666%, 37.470588%, .4)')\r\n    ],\r\n    theme: 'system',\r\n    notifications: {\r\n      sound: false\r\n    },\r\n    timeFormat: getTimeFormat(),\r\n    liteMode: {\r\n      all: false,\r\n      animations: false,\r\n      chat: false,\r\n      chat_background: false,\r\n      chat_spoilers: false,\r\n      effects: false,\r\n      effects_premiumstickers: false,\r\n      effects_reactions: false,\r\n      effects_emoji: false,\r\n      emoji: false,\r\n      emoji_messages: false,\r\n      emoji_panel: false,\r\n      gif: false,\r\n      stickers: false,\r\n      stickers_chat: false,\r\n      stickers_panel: false,\r\n      video: false\r\n    },\r\n    savedAsForum: false\r\n  },\r\n  playbackParams: {\r\n    volume: 1,\r\n    muted: false,\r\n    playbackRate: 1,\r\n    playbackRates: {\r\n      voice: 1,\r\n      video: 1,\r\n      audio: 1\r\n    },\r\n    loop: false,\r\n    round: false\r\n  },\r\n  keepSigned: true,\r\n  chatContextMenuHintWasShown: false,\r\n  hideChatJoinRequests: {},\r\n  stateId: nextRandomUint(32),\r\n  notifySettings: {},\r\n  confirmedWebViews: [],\r\n  seenTooltips: {\r\n    storySound: false\r\n  },\r\n  hiddenSimilarChannels: [],\r\n  appConfig: {} as any,\r\n  accountThemes: {} as any,\r\n  translations: {\r\n    peers: {},\r\n    enabledPeers: {},\r\n    enabled: true,\r\n    showInMenu: true,\r\n    doNotTranslate: []\r\n  }\r\n};\r\n","export default function compareVersion(v1: string, v2: string): number {\r\n  v1 = v1.split(' ', 1)[0];\r\n  v2 = v2.split(' ', 1)[0];\r\n  const s1 = v1.split('.');\r\n  const s2 = v2.split('.');\r\n\r\n  for(let i = 0; i < s1.length; ++i) {\r\n    const v1 = +s1[i];\r\n    const v2 = +s2[i];\r\n    if(v1 > v2) return 1;\r\n    else if(v1 < v2) return -1;\r\n  }\r\n\r\n  return 0;\r\n}\r\n","export default function isObject<T extends Record<any, any>>(object: any): object is T {\r\n  return typeof(object) === 'object' && object !== null;\r\n}\r\n","import copy from './copy';\r\nimport isObject from './isObject';\r\n\r\nexport default function validateInitObject(\r\n  initObject: any,\r\n  currentObject: any,\r\n  onReplace?: (key: string) => void,\r\n  previousKey?: string,\r\n  ignorePaths?: Set<string>,\r\n  path?: string\r\n) {\r\n  for(const key in initObject) {\r\n    const _path = path ? `${path}.${key}` : key;\r\n    if(ignorePaths?.has(_path)) {\r\n      continue;\r\n    }\r\n\r\n    if(typeof(currentObject[key]) !== typeof(initObject[key])) {\r\n      currentObject[key] = copy(initObject[key]);\r\n      onReplace?.(previousKey || key);\r\n    } else if(isObject(initObject[key])) {\r\n      validateInitObject(initObject[key], currentObject[key], onReplace, previousKey || key, ignorePaths, _path);\r\n    }\r\n  }\r\n}\r\n","import {logger} from '../lib/logger';\r\nimport dT from './dT';\r\n\r\nexport function recordPromise<T extends Promise<any>>(promise: T, description: string, log?: ReturnType<typeof logger> | Console) {\r\n  const perf = performance.now();\r\n  (log || console).warn(dT(), 'start', description);\r\n  promise.then(() => {\r\n    (log || console).warn(dT(), 'end', description, performance.now() - perf);\r\n  });\r\n  return promise;\r\n}\r\n\r\nexport function recordPromiseBound(log: ReturnType<typeof logger> | Console) {\r\n  return (...args: [Parameters<typeof recordPromise>[0], Parameters<typeof recordPromise>[1]]) => {\r\n    return recordPromise(...args, log);\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport App from '../../../../config/app';\r\nimport DEBUG from '../../../../config/debug';\r\nimport {AutoDownloadPeerTypeSettings, State, STATE_INIT, Background, AppTheme} from '../../../../config/state';\r\nimport compareVersion from '../../../../helpers/compareVersion';\r\nimport copy from '../../../../helpers/object/copy';\r\nimport validateInitObject from '../../../../helpers/object/validateInitObject';\r\nimport {UserAuth} from '../../../mtproto/mtproto_config';\r\nimport rootScope from '../../../rootScope';\r\nimport stateStorage from '../../../stateStorage';\r\nimport sessionStorage from '../../../sessionStorage';\r\nimport {recordPromiseBound} from '../../../../helpers/recordPromise';\r\n// import RESET_STORAGES_PROMISE from \"../storages/resetStoragesPromise\";\r\nimport {StoragesResults} from '../storages/loadStorages';\r\nimport {LogTypes, logger} from '../../../logger';\r\nimport {WallPaper} from '../../../../layer';\r\n\r\nconst REFRESH_EVERY = 24 * 60 * 60 * 1000; // 1 day\r\n// const REFRESH_EVERY = 1e3;\r\n// const REFRESH_EVERY_WEEK = 24 * 60 * 60 * 1000 * 7; // 7 days\r\n\r\nconst STATE_VERSION = STATE_INIT.version;\r\nconst BUILD = STATE_INIT.build;\r\n\r\nconst ALL_KEYS = Object.keys(STATE_INIT) as any as Array<keyof State>;\r\n\r\nconst REFRESH_KEYS: Array<keyof State> = [\r\n  'contactsListCachedTime',\r\n  'stateCreatedTime',\r\n  'maxSeenMsgId',\r\n  'filtersArr'\r\n];\r\n\r\n// const REFRESH_KEYS_WEEK = ['dialogs', 'allDialogsLoaded', 'updates', 'pinnedOrders'] as any as Array<keyof State>;\r\n\r\nasync function loadStateInner() {\r\n  const log = logger('STATE-LOADER', LogTypes.Error);\r\n\r\n  const totalPerf = performance.now();\r\n  const recordPromise = recordPromiseBound(log);\r\n\r\n  const promises = ALL_KEYS.map((key) => recordPromise(stateStorage.get(key), 'state ' + key))\r\n  .concat(\r\n    recordPromise(sessionStorage.get('user_auth'), 'auth'),\r\n    recordPromise(sessionStorage.get('state_id'), 'auth'),\r\n    recordPromise(sessionStorage.get('k_build'), 'auth'),\r\n    recordPromise(sessionStorage.get('auth_key_fingerprint'), 'auth'),\r\n    recordPromise(sessionStorage.get(`dc${App.baseDcId}_auth_key`), 'auth')\r\n  )\r\n  .concat( // support old webk format\r\n    recordPromise(stateStorage.get('user_auth'), 'old auth')\r\n  );\r\n\r\n  const arr = await Promise.all(promises);\r\n  log.warn('promises', performance.now() - totalPerf);\r\n  // await new Promise((resolve) => setTimeout(resolve, 3e3));\r\n  /* const self = this;\r\n  const skipHandleKeys = new Set(['isProxy', 'filters', 'drafts']);\r\n  const getHandler = (path?: string) => {\r\n    return {\r\n      get(target: any, key: any) {\r\n        if(key === 'isProxy') {\r\n          return true;\r\n        }\r\n\r\n        const prop = target[key];\r\n\r\n        if(prop !== undefined && !skipHandleKeys.has(key) && !prop.isProxy && typeof(prop) === 'object') {\r\n          target[key] = new Proxy(prop, getHandler(path || key));\r\n          return target[key];\r\n        }\r\n\r\n        return prop;\r\n      },\r\n      set(target: any, key: any, value: any) {\r\n        console.log('Setting', target, `.${key} to equal`, value, path);\r\n\r\n        target[key] = value;\r\n\r\n        // @ts-ignore\r\n        self.pushToState(path || key, path ? self.state[path] : value, false);\r\n\r\n        return true;\r\n      }\r\n    };\r\n  }; */\r\n\r\n  // const pushed: {key: keyof State, value: State[keyof State]}[] = [];\r\n  const pushedKeys: (keyof State)[] = [];\r\n  const pushToState = <T extends keyof State>(key: T, value: State[T]) => {\r\n    // appStateManager.pushToState(key, value);\r\n    state[key] = value;\r\n    // pushed.push({key, value});\r\n    pushedKeys.push(key);\r\n  };\r\n\r\n  const replaceState = (_state: State) => {\r\n    // pushed.length = 0;\r\n    pushedKeys.length = 0;\r\n    state = _state;\r\n    pushedKeys.push(...Object.keys(state) as any as typeof pushedKeys);\r\n    // state = appStateManager.setState(_state);\r\n    // appStateManager.storage.set(state);\r\n  };\r\n\r\n  // let state: State = appStateManager.setState({} as any);\r\n  let state: State = {} as any;\r\n\r\n  // ! then can't store false values\r\n  for(let i = 0, length = ALL_KEYS.length; i < length; ++i) {\r\n    const key = ALL_KEYS[i];\r\n    const value = arr[i];\r\n    if(value !== undefined) {\r\n      // @ts-ignore\r\n      state[key] = value;\r\n    } else {\r\n      pushToState(key, copy(STATE_INIT[key]));\r\n    }\r\n  }\r\n\r\n  arr.splice(0, ALL_KEYS.length);\r\n\r\n  // * Read auth\r\n  let auth = arr.shift() as UserAuth | number;\r\n  const stateId = arr.shift() as number;\r\n  const sessionBuild = arr.shift() as number;\r\n  const authKeyFingerprint = arr.shift() as string;\r\n  const baseDcAuthKey = arr.shift() as string;\r\n  const shiftedWebKAuth = arr.shift() as UserAuth | number;\r\n  if(!auth && shiftedWebKAuth) { // support old webk auth\r\n    auth = shiftedWebKAuth;\r\n    const keys: string[] = ['dc', 'server_time_offset', 'xt_instance'];\r\n    for(let i = 1; i <= 5; ++i) {\r\n      keys.push(`dc${i}_server_salt`);\r\n      keys.push(`dc${i}_auth_key`);\r\n    }\r\n\r\n    const values = await Promise.all(keys.map((key) => stateStorage.get(key as any)));\r\n    keys.push('user_auth');\r\n    values.push(typeof(auth) === 'number' || typeof(auth) === 'string' ? {dcID: values[0] || App.baseDcId, date: Date.now() / 1000 | 0, id: auth.toPeerId(false)} as UserAuth : auth);\r\n\r\n    const obj: any = {};\r\n    keys.forEach((key, idx) => {\r\n      obj[key] = values[idx];\r\n    });\r\n\r\n    await sessionStorage.set(obj);\r\n  }\r\n\r\n  /* if(!auth) { // try to read Webogram's session from localStorage\r\n    try {\r\n      const keys = Object.keys(localStorage);\r\n      for(let i = 0; i < keys.length; ++i) {\r\n        const key = keys[i];\r\n        let value: any;\r\n        try {\r\n          value = localStorage.getItem(key);\r\n          value = JSON.parse(value);\r\n        } catch(err) {\r\n          //console.error(err);\r\n        }\r\n\r\n        sessionStorage.set({\r\n          [key as any]: value\r\n        });\r\n      }\r\n\r\n      auth = sessionStorage.getFromCache('user_auth');\r\n    } catch(err) {\r\n      this.log.error('localStorage import error', err);\r\n    }\r\n  } */\r\n\r\n  if(auth) {\r\n    // ! Warning ! DON'T delete this\r\n    state.authState = {_: 'authStateSignedIn'};\r\n    rootScope.dispatchEvent('user_auth', typeof(auth) === 'number' || typeof(auth) === 'string' ?\r\n      {dcID: 0, date: Date.now() / 1000 | 0, id: auth.toPeerId(false)} :\r\n      auth); // * support old version\r\n  }\r\n\r\n  const resetStorages: Set<keyof StoragesResults> = new Set();\r\n  const resetState = (preserveKeys: (keyof State)[]) => {\r\n    preserveKeys.push('authState', 'stateId');\r\n    const preserve: Map<keyof State, State[keyof State]> = new Map(\r\n      preserveKeys.map((key) => [key, state[key]])\r\n    );\r\n\r\n    state = copy(STATE_INIT);\r\n\r\n    preserve.forEach((value, key) => {\r\n      // @ts-ignore\r\n      state[key] = value;\r\n    });\r\n\r\n    const r: (keyof StoragesResults)[] = ['chats', 'dialogs', 'users'];\r\n    for(const key of r) {\r\n      resetStorages.add(key);\r\n      // this.storagesResults[key as keyof AppStateManager['storagesResults']].length = 0;\r\n    }\r\n\r\n    replaceState(state);\r\n  };\r\n\r\n  if(state.stateId !== stateId) {\r\n    if(stateId !== undefined) {\r\n      resetState([]);\r\n    }\r\n\r\n    await sessionStorage.set({\r\n      state_id: state.stateId\r\n    });\r\n  }\r\n\r\n  if(baseDcAuthKey) {\r\n    const _authKeyFingerprint = baseDcAuthKey.slice(0, 8);\r\n    if(!authKeyFingerprint) { // * migration, preserve settings\r\n      resetState(['settings']);\r\n    } else if(authKeyFingerprint !== _authKeyFingerprint) {\r\n      resetState([]);\r\n    }\r\n\r\n    if(authKeyFingerprint !== _authKeyFingerprint) {\r\n      await sessionStorage.set({\r\n        auth_key_fingerprint: _authKeyFingerprint\r\n      });\r\n    }\r\n  }\r\n\r\n  const time = Date.now();\r\n  if((state.stateCreatedTime + REFRESH_EVERY) < time) {\r\n    if(DEBUG) {\r\n      log('will refresh state', state.stateCreatedTime, time);\r\n    }\r\n\r\n    const r = (keys: typeof REFRESH_KEYS) => {\r\n      keys.forEach((key) => {\r\n        pushToState(key, copy(STATE_INIT[key]));\r\n\r\n        // const s = appStateManager.storagesResults[key as keyof AppStateManager['storagesResults']];\r\n        // if(s?.length) {\r\n        // appStateManager.resetStorages.add(key as keyof AppStateManager['storagesResults']);\r\n        // s.length = 0;\r\n        // }\r\n      });\r\n    };\r\n\r\n    r(REFRESH_KEYS);\r\n\r\n    /* if((state.stateCreatedTime + REFRESH_EVERY_WEEK) < time) {\r\n      if(DEBUG) {\r\n        this.log('will refresh updates');\r\n      }\r\n\r\n      r(REFRESH_KEYS_WEEK);\r\n    } */\r\n  }\r\n\r\n  // state = this.state = new Proxy(state, getHandler());\r\n\r\n  // * migrate auto download settings\r\n  const autoDownloadSettings = state.settings.autoDownload;\r\n  if(autoDownloadSettings?.private !== undefined) {\r\n    const oldTypes = [\r\n      'contacts' as const,\r\n      'private' as const,\r\n      'groups' as const,\r\n      'channels' as const\r\n    ];\r\n\r\n    const mediaTypes = [\r\n      'photo' as const,\r\n      'video' as const,\r\n      'file' as const\r\n    ];\r\n\r\n    mediaTypes.forEach((mediaType) => {\r\n      const peerTypeSettings: AutoDownloadPeerTypeSettings = autoDownloadSettings[mediaType] = {} as any;\r\n      oldTypes.forEach((peerType) => {\r\n        peerTypeSettings[peerType] = autoDownloadSettings[peerType];\r\n      });\r\n    });\r\n\r\n    oldTypes.forEach((peerType) => {\r\n      delete autoDownloadSettings[peerType];\r\n    });\r\n\r\n    pushToState('settings', state.settings);\r\n  }\r\n\r\n  const SKIP_VALIDATING_PATHS: Set<string> = new Set([\r\n    'settings.themes'\r\n  ]);\r\n  validateInitObject(STATE_INIT, state, (missingKey) => {\r\n    pushToState(missingKey as keyof State, state[missingKey as keyof State]);\r\n  }, undefined, SKIP_VALIDATING_PATHS);\r\n\r\n  let newVersion: string, oldVersion: string;\r\n  if(state.version !== STATE_VERSION || state.build !== BUILD/*  || true */) {\r\n    // reset filters and dialogs if version is older\r\n    if(state.build < 322) {\r\n      pushToState('allDialogsLoaded', copy(STATE_INIT.allDialogsLoaded));\r\n      pushToState('pinnedOrders', copy(STATE_INIT.pinnedOrders));\r\n      pushToState('filtersArr', copy(STATE_INIT.filtersArr));\r\n\r\n      resetStorages.add('dialogs');\r\n    }\r\n\r\n    if(compareVersion(state.version, '1.7.1') === -1) {\r\n      let migrated = false;\r\n      // * migrate backgrounds (March 13, 2022; to version 1.3.0)\r\n      if(compareVersion(state.version, '1.3.0') === -1) {\r\n        migrated = true;\r\n        state.settings.theme = copy(STATE_INIT.settings.theme);\r\n        state.settings.themes = copy(STATE_INIT.settings.themes);\r\n      } else if(compareVersion(state.version, '1.7.1') === -1) { // * migrate backgrounds (January 25th, 2023; to version 1.7.1)\r\n        migrated = true;\r\n        const oldThemes = state.settings.themes as any as Array<{\r\n          name: AppTheme['name'],\r\n          background: Background\r\n        }>;\r\n\r\n        state.settings.themes = copy(STATE_INIT.settings.themes);\r\n\r\n        try {\r\n          oldThemes.forEach((oldTheme) => {\r\n            const oldBackground = oldTheme.background;\r\n            if(!oldBackground) {\r\n              return;\r\n            }\r\n\r\n            const newTheme = state.settings.themes.find((t) => t.name === oldTheme.name);\r\n            newTheme.settings.highlightingColor = oldBackground.highlightingColor;\r\n\r\n            const getColorFromHex = (hex: string) => hex && parseInt(hex.slice(1), 16);\r\n\r\n            const colors = (oldBackground.color || '').split(',').map(getColorFromHex);\r\n\r\n            if(oldBackground.color && !oldBackground.slug) {\r\n              newTheme.settings.wallpaper = {\r\n                _: 'wallPaperNoFile',\r\n                id: 0,\r\n                pFlags: {},\r\n                settings: {\r\n                  _: 'wallPaperSettings',\r\n                  pFlags: {}\r\n                }\r\n              };\r\n            } else {\r\n              const wallPaper: WallPaper.wallPaper = {\r\n                _: 'wallPaper',\r\n                id: 0,\r\n                access_hash: 0,\r\n                slug: oldBackground.slug,\r\n                document: {} as any,\r\n                pFlags: {},\r\n                settings: {\r\n                  _: 'wallPaperSettings',\r\n                  pFlags: {}\r\n                }\r\n              };\r\n\r\n              const wallPaperSettings = wallPaper.settings;\r\n              newTheme.settings.wallpaper = wallPaper;\r\n              if(oldBackground.slug && !oldBackground.color) {\r\n                wallPaperSettings.pFlags.blur = oldBackground.blur || undefined;\r\n              } else if(oldBackground.intensity) {\r\n                wallPaperSettings.intensity = oldBackground.intensity;\r\n                wallPaper.pFlags.pattern = true;\r\n                wallPaper.pFlags.dark = oldBackground.intensity < 0 || undefined;\r\n              }\r\n            }\r\n\r\n            if(colors.length) {\r\n              const wallPaperSettings = newTheme.settings.wallpaper.settings;\r\n              wallPaperSettings.background_color = colors[0];\r\n              wallPaperSettings.second_background_color = colors[1];\r\n              wallPaperSettings.third_background_color = colors[2];\r\n              wallPaperSettings.fourth_background_color = colors[3];\r\n            }\r\n          });\r\n        } catch(err) {\r\n          console.error('migrating themes error', err);\r\n        }\r\n      }\r\n\r\n      if(migrated) {\r\n        pushToState('settings', state.settings);\r\n      }\r\n    }\r\n\r\n    if(state.build < 309) {\r\n      state.settings.liteMode.animations = !state.settings.animationsEnabled;\r\n      state.settings.liteMode.video = !state.settings.autoPlay.videos;\r\n      state.settings.liteMode.gif = !state.settings.autoPlay.gifs;\r\n    }\r\n\r\n    if(state.build < 312 && typeof(state.settings.stickers.suggest) === 'boolean') {\r\n      state.settings.stickers.suggest = state.settings.stickers.suggest ? 'all' : 'none';\r\n    }\r\n\r\n    // fix typo\r\n    if(state.build <= 432) {\r\n      let changed = false;\r\n      try {\r\n        for(const theme of state.settings.themes) {\r\n          if(!theme.settings.highlightingColor) {\r\n            theme.settings.highlightingColor = (theme.settings as any).highlightningColor;\r\n            delete (theme.settings as any).highlightningColor;\r\n            changed = true;\r\n          }\r\n        }\r\n      } catch(err) {}\r\n\r\n      if(changed) {\r\n        pushToState('settings', state.settings);\r\n      }\r\n    }\r\n\r\n    state.appConfig = copy(STATE_INIT.appConfig);\r\n\r\n    if(compareVersion(state.version, STATE_VERSION) !== 0) {\r\n      newVersion = STATE_VERSION;\r\n      oldVersion = state.version;\r\n    }\r\n\r\n    pushToState('version', STATE_VERSION);\r\n    pushToState('build', BUILD);\r\n  }\r\n\r\n  if(sessionBuild !== BUILD && (!sessionBuild || sessionBuild < BUILD)) {\r\n    sessionStorage.set({k_build: BUILD});\r\n  }\r\n\r\n  // ! probably there is better place for it\r\n  rootScope.settings = state.settings;\r\n\r\n  if(DEBUG) {\r\n    log('state res', state, copy(state));\r\n  }\r\n\r\n  // return resolve();\r\n\r\n  log.warn('total', performance.now() - totalPerf);\r\n\r\n  // RESET_STORAGES_PROMISE.resolve(appStateManager.resetStorages);\r\n\r\n  return {state, resetStorages, newVersion, oldVersion, pushedKeys};\r\n}\r\n\r\nlet promise: ReturnType<typeof loadStateInner>;\r\nexport default function loadState() {\r\n  return promise ??= loadStateInner();\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport IS_OPUS_SUPPORTED from '../environment/opusSupport';\r\nimport {IS_SAFARI} from '../environment/userAgent';\r\nimport {Modify} from '../types';\r\nimport {logger, LogTypes} from './logger';\r\nimport apiManagerProxy from './mtproto/mtprotoworker';\r\nimport type {ConvertWebPTask} from './webp/webpWorkerController';\r\n\r\ntype Result = {\r\n  bytes: Uint8Array,\r\n  waveform?: Uint8Array\r\n};\r\n\r\ntype Task = {\r\n  pages: Uint8Array,\r\n  withWaveform: boolean,\r\n  waveform?: Uint8Array,\r\n  callback: {resolve: (result: Result) => void, reject: (err: any) => void},\r\n  timeout: number\r\n};\r\n\r\nexport interface ConvertOpusTask extends Modify<ConvertWebPTask, {type: 'convertOpus'}> {\r\n  type: 'convertOpus'\r\n}\r\n\r\nexport class OpusDecodeController {\r\n  private worker: Worker;\r\n  private wavWorker: Worker;\r\n  private sampleRate = 48000;\r\n  private tasks: Array<Task> = [];\r\n  private keepAlive = false;\r\n  private log = logger('OPUS', LogTypes.Error);\r\n\r\n  public isPlaySupported() {\r\n    return IS_OPUS_SUPPORTED;\r\n  }\r\n\r\n  public loadWavWorker() {\r\n    if(this.wavWorker) return;\r\n\r\n    this.wavWorker = new Worker('waveWorker.min.js');\r\n    this.wavWorker.addEventListener('message', (e) => {\r\n      const data = e.data;\r\n\r\n      this.log('[WAV] got message:', data);\r\n      if(data && data.page) {\r\n        const bytes = data.page;\r\n        this.onTaskEnd(this.tasks.shift(), bytes);\r\n      }\r\n    });\r\n  }\r\n\r\n  public loadWorker() {\r\n    if(this.worker) return;\r\n\r\n    this.worker = new Worker('decoderWorker.min.js');\r\n    this.worker.addEventListener('message', (e) => {\r\n      const data = e.data;\r\n\r\n      this.log('[DECODER] got message', data);\r\n      if(data.type === 'done') {\r\n        // this.log('[DECODER] send done to wav');\r\n        this.wavWorker.postMessage({command: 'done'});\r\n\r\n        if(data.waveform) {\r\n          this.tasks[0].waveform = data.waveform;\r\n        }\r\n      } else { // e.data contains decoded buffers as float32 values\r\n        // this.log('[DECODER] send encode to wav');\r\n        this.wavWorker.postMessage({\r\n          command: 'encode',\r\n          buffers: e.data\r\n        }, IS_SAFARI ? undefined : data.map((typedArray: Uint8Array) => typedArray.buffer));\r\n      }\r\n    });\r\n  }\r\n\r\n  public setKeepAlive(keepAlive: boolean) {\r\n    this.keepAlive = keepAlive;\r\n    if(this.keepAlive) {\r\n      this.loadWorker();\r\n      this.loadWavWorker();\r\n    } else if(!this.tasks.length) {\r\n      this.terminateWorkers();\r\n    }\r\n  }\r\n\r\n  public onTaskEnd(task: Task, result?: Uint8Array) {\r\n    if(!result) {\r\n      task.callback.reject('timeout');\r\n    } else {\r\n      clearTimeout(task.timeout);\r\n      task.callback.resolve({bytes: result, waveform: task.waveform});\r\n    }\r\n\r\n    if(this.tasks.length) {\r\n      this.executeNewTask(this.tasks[0]);\r\n    }\r\n\r\n    this.terminateWorkers();\r\n  }\r\n\r\n  public terminateWorkers(kill = false) {\r\n    if((this.keepAlive || this.tasks.length) && !kill) return;\r\n\r\n    if(this.worker) {\r\n      this.worker.terminate();\r\n      this.worker = null;\r\n    }\r\n\r\n    if(this.wavWorker) {\r\n      this.wavWorker.terminate();\r\n      this.wavWorker = null;\r\n    }\r\n  }\r\n\r\n  public executeNewTask(task: Task) {\r\n    this.worker.postMessage({\r\n      command: 'init',\r\n      decoderSampleRate: this.sampleRate,\r\n      outputBufferSampleRate: this.sampleRate\r\n    });\r\n\r\n    this.wavWorker.postMessage({\r\n      command: 'init',\r\n      wavBitDepth: 16,\r\n      wavSampleRate: this.sampleRate\r\n    });\r\n\r\n    // console.log('sending command to worker:', task);\r\n    // setTimeout(() => {\r\n    this.log('[DECODER] send decode');\r\n    this.worker.postMessage({\r\n      command: 'decode',\r\n      pages: task.pages,\r\n      waveform: task.withWaveform\r\n    }, IS_SAFARI ? undefined : [task.pages.buffer]);\r\n    // }, 1e3);\r\n\r\n    task.timeout = window.setTimeout(() => {\r\n      this.log.error('decode timeout'/* , task */);\r\n\r\n      this.terminateWorkers(true);\r\n      if(this.tasks.length) {\r\n        this.loadWorker();\r\n        this.loadWavWorker();\r\n      }\r\n\r\n      this.onTaskEnd(this.tasks.shift());\r\n    }, 10e3);\r\n  }\r\n\r\n  public pushDecodeTask(pages: Uint8Array, withWaveform: boolean) {\r\n    return new Promise<Result>((resolve, reject) => {\r\n      const task = {\r\n        pages,\r\n        withWaveform,\r\n        callback: {resolve, reject},\r\n        timeout: 0\r\n      };\r\n\r\n      this.loadWorker();\r\n      this.loadWavWorker();\r\n\r\n      if(this.tasks.push(task) === 1) {\r\n        this.executeNewTask(task);\r\n      }\r\n    });\r\n  }\r\n\r\n  public async decode(typedArray: Uint8Array, withWaveform = false) {\r\n    return this.pushDecodeTask(typedArray, withWaveform).then(async(result) => {\r\n      const dataBlob = new Blob([result.bytes], {type: 'audio/wav'});\r\n      return {url: await apiManagerProxy.invoke('createObjectURL', dataBlob), waveform: result.waveform};\r\n    });\r\n  }\r\n}\r\n\r\nconst opusDecodeController = new OpusDecodeController();\r\nMOUNT_CLASS_TO.opusDecodeController = opusDecodeController;\r\nexport default opusDecodeController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {CryptoMethods} from './crypto_methods';\r\nimport SuperMessagePort from '../mtproto/superMessagePort';\r\nimport {Awaited} from '../../types';\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport {IS_WORKER} from '../../helpers/context';\r\n\r\ntype CryptoEvent = {\r\n  invoke: <T extends keyof CryptoMethods>(payload: {method: T, args: Parameters<CryptoMethods[T]>}) => ReturnType<CryptoMethods[T]>,\r\n  port: (payload: void, source: MessageEventSource, event: MessageEvent) => void,\r\n  terminate: () => void\r\n};\r\n\r\nexport class CryptoMessagePort<Master extends boolean = false> extends SuperMessagePort<CryptoEvent, CryptoEvent, Master> {\r\n  private lastIndex: number;\r\n\r\n  constructor() {\r\n    super('CRYPTO');\r\n    this.lastIndex = -1;\r\n  }\r\n\r\n  public invokeCryptoNew<T extends keyof CryptoMethods>({method, args, transfer}: {\r\n    method: T,\r\n    args: Parameters<CryptoMethods[T]>,\r\n    transfer?: Transferable[]\r\n  }): Promise<Awaited<ReturnType<CryptoMethods[T]>>> {\r\n    const payload = {method, args};\r\n    const listeners = this.listeners['invoke'];\r\n    if(listeners?.size) { // already in worker\r\n      // try {\r\n      let result: any = listeners.values().next().value.callback(payload);\r\n      if(!IS_WORKER && !(result instanceof Promise)) {\r\n        result = Promise.resolve(result);\r\n      }\r\n\r\n      return result;\r\n      // } catch(err) {\r\n      //   return Promise.reject(err);\r\n      // }\r\n    }\r\n\r\n    const sendPortIndex = method === 'aes-encrypt' || method === 'aes-decrypt' ?\r\n      this.lastIndex = (this.lastIndex + 1) % this.sendPorts.length :\r\n      0;\r\n    // @ts-ignore\r\n    return this.invoke('invoke', payload, undefined, this.sendPorts[sendPortIndex], transfer);\r\n  }\r\n\r\n  public invokeCrypto<T extends keyof CryptoMethods>(method: T, ...args: Parameters<CryptoMethods[T]>): Promise<Awaited<ReturnType<CryptoMethods[T]>>> {\r\n    return this.invokeCryptoNew({method, args});\r\n  }\r\n}\r\n\r\nconst cryptoMessagePort = new CryptoMessagePort<false>();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.cryptoMessagePort = cryptoMessagePort);\r\nexport default cryptoMessagePort;\r\n","export default function toArray<T>(value: T | T[]): T[] {\r\n  return Array.isArray(value) ? value : [value];\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\n// https://www.iana.org/assignments/media-types/media-types.xhtml\r\nexport default function blobSafeMimeType(mimeType: string) {\r\n  if([\r\n    'image/jpeg',\r\n    'image/png',\r\n    'image/gif',\r\n    'image/svg+xml',\r\n    'image/webp',\r\n    'image/bmp',\r\n    'image/avif',\r\n    'image/jxl',\r\n    'video/mp4',\r\n    'video/webm',\r\n    'video/quicktime',\r\n    'audio/ogg',\r\n    'audio/mpeg',\r\n    'audio/mp4',\r\n    'audio/wav', // though it is not in list\r\n    'application/json',\r\n    'application/pdf'\r\n  ].indexOf(mimeType) === -1) {\r\n    return 'application/octet-stream';\r\n  }\r\n\r\n  return mimeType;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport toArray from '../array/toArray';\r\nimport blobSafeMimeType from './blobSafeMimeType';\r\n\r\nexport default function blobConstruct<T extends Uint8Array | string>(blobParts: Array<T> | T, mimeType: string = ''): Blob {\r\n  blobParts = toArray(blobParts);\r\n  const safeMimeType = blobSafeMimeType(mimeType);\r\n  const blob = new Blob(blobParts, {type: safeMimeType});\r\n  return blob;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport blobConstruct from '../../helpers/blob/blobConstruct';\r\nimport StreamWriter from './streamWriter';\r\n\r\nexport default class MemoryWriter implements StreamWriter {\r\n  private bytes: Uint8Array;\r\n\r\n  constructor(\r\n    private mimeType: string,\r\n    private size: number,\r\n    private saveFileCallback?: (blob: Blob) => Promise<Blob>\r\n  ) {\r\n    this.bytes = new Uint8Array(size);\r\n  }\r\n\r\n  public async write(part: Uint8Array, offset: number) {\r\n    // sometimes file size can be bigger than the prov\r\n    const endOffset = offset + part.byteLength;\r\n    if(endOffset > this.bytes.byteLength) {\r\n      const newBytes = new Uint8Array(endOffset);\r\n      newBytes.set(this.bytes, 0);\r\n      this.bytes = newBytes;\r\n    }\r\n\r\n    this.bytes.set(part, offset);\r\n  };\r\n\r\n  public truncate() {\r\n    this.bytes = new Uint8Array();\r\n  }\r\n\r\n  public trim(size: number) {\r\n    this.bytes = this.bytes.slice(0, size);\r\n  }\r\n\r\n  public finalize(saveToStorage = true) {\r\n    const blob = blobConstruct(this.bytes, this.mimeType);\r\n\r\n    if(saveToStorage && this.saveFileCallback) {\r\n      this.saveFileCallback(blob);\r\n    }\r\n\r\n    return blob;\r\n  }\r\n\r\n  public getParts() {\r\n    return this.bytes;\r\n  }\r\n\r\n  public replaceParts(parts: Uint8Array) {\r\n    this.bytes = parts;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Modes from '../../config/modes';\r\nimport blobConstruct from '../../helpers/blob/blobConstruct';\r\nimport MemoryWriter from './memoryWriter';\r\nimport FileManager from './memoryWriter';\r\nimport FileStorage from './fileStorage';\r\nimport makeError from '../../helpers/makeError';\r\nimport deferredPromise from '../../helpers/cancellablePromise';\r\n\r\nexport type CacheStorageDbName = 'cachedFiles' | 'cachedStreamChunks' | 'cachedAssets';\r\n\r\nexport default class CacheStorageController implements FileStorage {\r\n  private static STORAGES: CacheStorageController[] = [];\r\n  private openDbPromise: Promise<Cache>;\r\n\r\n  private useStorage = true;\r\n\r\n  // private log: ReturnType<typeof logger> = logger('CS');\r\n\r\n  constructor(private dbName: CacheStorageDbName) {\r\n    if(Modes.test) {\r\n      this.dbName += '_test';\r\n    }\r\n\r\n    if(CacheStorageController.STORAGES.length) {\r\n      this.useStorage = CacheStorageController.STORAGES[0].useStorage;\r\n    }\r\n\r\n    this.openDatabase();\r\n    CacheStorageController.STORAGES.push(this);\r\n  }\r\n\r\n  private openDatabase(): Promise<Cache> {\r\n    return this.openDbPromise ?? (this.openDbPromise = caches.open(this.dbName));\r\n  }\r\n\r\n  public delete(entryName: string) {\r\n    return this.timeoutOperation((cache) => cache.delete('/' + entryName));\r\n  }\r\n\r\n  public deleteAll() {\r\n    return caches.delete(this.dbName);\r\n  }\r\n\r\n  public get(entryName: string) {\r\n    return this.timeoutOperation((cache) => cache.match('/' + entryName));\r\n  }\r\n\r\n  public save(entryName: string, response: Response) {\r\n    // return new Promise((resolve) => {}); // DEBUG\r\n    return this.timeoutOperation((cache) => cache.put('/' + entryName, response));\r\n  }\r\n\r\n  public getFile(fileName: string, method: 'blob' | 'json' | 'text' = 'blob'): Promise<any> {\r\n    // if(method === 'blob') {\r\n    //   return Promise.reject(makeError('NO_ENTRY_FOUND'));\r\n    // }\r\n\r\n    // const str = `get fileName: ${fileName}`;\r\n    // console.time(str);\r\n    return this.get(fileName).then((response) => {\r\n      if(!response) {\r\n        // console.warn('getFile:', response, fileName);\r\n        throw makeError('NO_ENTRY_FOUND');\r\n      }\r\n\r\n      const promise = response[method]();\r\n      // promise.then(() => {\r\n      //   console.timeEnd(str);\r\n      // });\r\n      return promise;\r\n    });\r\n  }\r\n\r\n  public saveFile(fileName: string, blob: Blob | Uint8Array) {\r\n    // return Promise.resolve(blobConstruct([blob]));\r\n    if(!(blob instanceof Blob)) {\r\n      blob = blobConstruct(blob);\r\n    }\r\n\r\n    const response = new Response(blob, {\r\n      headers: {\r\n        'Content-Length': '' + blob.size\r\n      }\r\n    });\r\n\r\n    return this.save(fileName, response).then(() => blob as Blob);\r\n  }\r\n\r\n  public timeoutOperation<T>(callback: (cache: Cache) => Promise<T>) {\r\n    if(!this.useStorage) {\r\n      return Promise.reject(makeError('STORAGE_OFFLINE'));\r\n    }\r\n\r\n    return new Promise<T>(async(resolve, reject) => {\r\n      let rejected = false;\r\n      const timeout = setTimeout(() => {\r\n        reject();\r\n        // console.warn('CACHESTORAGE TIMEOUT');\r\n        rejected = true;\r\n      }, 15e3);\r\n\r\n      try {\r\n        const cache = await this.openDatabase();\r\n        if(!cache) {\r\n          this.useStorage = false;\r\n          this.openDbPromise = undefined;\r\n          throw 'no cache?';\r\n        }\r\n\r\n        const res = await callback(cache);\r\n\r\n        if(rejected) return;\r\n        resolve(res);\r\n      } catch(err) {\r\n        reject(err);\r\n      }\r\n\r\n      clearTimeout(timeout);\r\n    });\r\n  }\r\n\r\n  public prepareWriting(fileName: string, fileSize: number, mimeType: string) {\r\n    return {\r\n      deferred: deferredPromise<Blob>(),\r\n      getWriter: () => {\r\n        const writer = new MemoryWriter(mimeType, fileSize, (blob) => {\r\n          return this.saveFile(fileName, blob).catch(() => blob);\r\n        });\r\n\r\n        return writer;\r\n      }\r\n    };\r\n  }\r\n\r\n  public static toggleStorage(enabled: boolean, clearWrite: boolean) {\r\n    return Promise.all(this.STORAGES.map((storage) => {\r\n      storage.useStorage = enabled;\r\n\r\n      if(!clearWrite) {\r\n        return;\r\n      }\r\n\r\n      if(!enabled) {\r\n        return storage.deleteAll();\r\n      }\r\n    }));\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport CacheStorageController from '../lib/files/cacheStorage';\r\nimport AppStorage from '../lib/storage';\r\nimport sessionStorage from '../lib/sessionStorage';\r\nimport noop from './noop';\r\n\r\nexport default function toggleStorages(enabled: boolean, clearWrite: boolean) {\r\n  return Promise.all([\r\n    AppStorage.toggleStorage(enabled, clearWrite),\r\n    CacheStorageController.toggleStorage(enabled, clearWrite),\r\n    sessionStorage.toggleStorage(enabled, clearWrite)\r\n  ]).then(noop, noop);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {WebPushApiManager} from '../mtproto/webPushApiManager';\r\nimport type {PushNotificationObject} from './push';\r\nimport type {MyUploadFile} from '../mtproto/apiFileManager';\r\nimport SuperMessagePort from '../mtproto/superMessagePort';\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport {InputFileLocation, InputGroupCall} from '../../layer';\r\nimport {GroupCallRtmpState} from '../appManagers/appGroupCallsManager';\r\n\r\nexport type ServicePushPingTaskPayload = {\r\n  localNotifications: boolean,\r\n  lang: {\r\n    push_action_mute1d: string\r\n    push_action_settings: string\r\n    push_message_nopreview: string\r\n  },\r\n  settings: WebPushApiManager['settings']\r\n};\r\n\r\nexport type ServiceRequestFilePartTaskPayload = {\r\n  docId: DocId,\r\n  dcId: number,\r\n  offset: number,\r\n  limit: number\r\n};\r\n\r\nexport type ServiceRequestRtmpPartTaskPayload = {\r\n  request: InputFileLocation.inputGroupCallStream,\r\n  dcId: number,\r\n};\r\n\r\nexport type ServiceDownloadTaskPayload = {\r\n  headers: any,\r\n  id: string\r\n};\r\n\r\nexport type ServiceEvent = {\r\n  port: (payload: void, source: MessageEventSource, event: MessageEvent) => void\r\n};\r\n\r\nexport default class ServiceMessagePort<Master extends boolean = false> extends SuperMessagePort<{\r\n  // from main thread to service worker\r\n  notificationsClear: () => void,\r\n  toggleStorages: (payload: {enabled: boolean, clearWrite: boolean}) => void,\r\n  pushPing: (payload: ServicePushPingTaskPayload, source: MessageEventSource, event: MessageEvent) => void,\r\n  hello: (payload: void, source: MessageEventSource, event: MessageEvent) => void,\r\n  shownNotification: (payload: string) => void,\r\n  leaveRtmpCall: (payload: [Long, boolean]) => void,\r\n  toggleStreamInUse: (payload: {url: string, inUse: boolean}) => void,\r\n\r\n  // from mtproto worker\r\n  download: (payload: ServiceDownloadTaskPayload) => void,\r\n  downloadChunk: (payload: {id: ServiceDownloadTaskPayload['id'], chunk: Uint8Array}) => void\r\n  downloadFinalize: (payload: ServiceDownloadTaskPayload['id']) => void,\r\n  downloadCancel: (payload: ServiceDownloadTaskPayload['id']) => void\r\n}, {\r\n  // to main thread\r\n  pushClick: (payload: PushNotificationObject) => void,\r\n  hello: (payload: void, source: MessageEventSource) => void,\r\n  share: (payload: ShareData) => void,\r\n  rtmpStreamTime: (payload: {callId: Long, time: string}) => void,\r\n  rtmpStreamDestroyed: (payload: Long) => void,\r\n  downloadRequestReceived: (payload: string) => void,\r\n\r\n  // to mtproto worker\r\n  requestFilePart: (payload: ServiceRequestFilePartTaskPayload) => MaybePromise<MyUploadFile>,\r\n  cancelFilePartRequests: (payload: DocId) => void,\r\n  requestRtmpState: (payload: InputGroupCall) => MaybePromise<GroupCallRtmpState>,\r\n  requestRtmpPart: (payload: ServiceRequestRtmpPartTaskPayload) => MaybePromise<MyUploadFile>,\r\n} & ServiceEvent, Master> {\r\n  constructor() {\r\n    super('SERVICE');\r\n\r\n    MOUNT_CLASS_TO && (MOUNT_CLASS_TO.serviceMessagePort = this);\r\n  }\r\n}\r\n","export const DEEP_PATH_JOINER = '\\x01';\r\n\r\nexport function joinDeepPath(...args: any[]) {\r\n  return args.join(DEEP_PATH_JOINER);\r\n}\r\n\r\nexport function splitDeepPath(path: string) {\r\n  return path.split(DEEP_PATH_JOINER);\r\n}\r\n\r\nexport default function setDeepProperty(\r\n  object: any,\r\n  key: string,\r\n  value?: any,\r\n  deleteIfUndefined?: boolean\r\n) {\r\n  const splitted = key.split(DEEP_PATH_JOINER);\r\n  const length = splitted.length;\r\n  let lastObject = object/* , fractalPart: string */; // fix fractal number key\r\n  for(let i = 0; i < length - 1; ++i) {\r\n    const part = splitted[i];\r\n    // if(fractalPart) {\r\n    //   part = fractalPart + '.' + part;\r\n    //   fractalPart = undefined;\r\n    // } else if(!Number.isNaN(+part)) {\r\n    //   fractalPart = part;\r\n    //   continue;\r\n    // }\r\n    lastObject = lastObject[part] ??= {};\r\n  }\r\n\r\n  const lastKey = /* (fractalPart ? fractalPart + '.' : '') +  */splitted[length - 1];\r\n  if(value === undefined && deleteIfUndefined/*  && arguments.length === 2 */) {\r\n    delete lastObject[lastKey];\r\n  } else {\r\n    lastObject[lastKey] = value;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {InputFileLocation, InputGeoPoint, InputStickerSet, InputWebFileLocation} from '../layer';\r\nimport type {DownloadOptions} from '../lib/mtproto/apiFileManager';\r\n\r\nconst FILENAME_JOINER = '_';\r\n\r\nexport function getFileNameByLocation(location: InputFileLocation | InputWebFileLocation, options?: Partial<{\r\n  fileName: string,\r\n  downloadId: string\r\n}>) {\r\n  const fileName = '';// (options?.fileName || '').split('.');\r\n  const ext = fileName[fileName.length - 1] || '';\r\n\r\n  let str: string;\r\n  switch(location._) {\r\n    case 'inputPhotoFileLocation': {\r\n      str = ['photo', fileName[0], location.id, location.thumb_size].filter(Boolean).join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    case 'inputDocumentFileLocation': {\r\n      str = ['document', fileName[0], location.id, location.thumb_size].filter(Boolean).join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    case 'inputPeerPhotoFileLocation':\r\n      str = ['peerPhoto', location.photo_id, location.pFlags.big ? 'big' : 'small'].join(FILENAME_JOINER);\r\n      break;\r\n\r\n    case 'inputStickerSetThumb': {\r\n      const id = (location.stickerset as InputStickerSet.inputStickerSetID).id ||\r\n        (location.stickerset as InputStickerSet.inputStickerSetShortName).short_name ||\r\n        (location.stickerset as InputStickerSet.inputStickerSetDice).emoticon ||\r\n        location.stickerset._;\r\n      str = ['stickerSetThumb', id, location.thumb_version].join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    case 'inputFileLocation': {\r\n      str = [location.volume_id, location.local_id].join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    case 'inputWebFileLocation': {\r\n      str = ['webFile', location.url].join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    case 'inputWebFileGeoPointLocation': {\r\n      const geoPoint = location.geo_point as InputGeoPoint.inputGeoPoint;\r\n      str = ['geoPoint', geoPoint.lat, geoPoint.long, location.w, location.h, location.zoom, location.scale].join(FILENAME_JOINER);\r\n      break;\r\n    }\r\n\r\n    default: {\r\n      console.error('Unrecognized location:', location);\r\n      str = '';\r\n      break;\r\n    }\r\n  }\r\n\r\n  return str + (options?.downloadId ? '_download' : '') + (ext ? '.' + ext : ext);\r\n}\r\n\r\nexport type FileURLType = 'photo' | 'thumb' | 'document' | 'stream' | 'download';\r\nexport function getFileURL(type: FileURLType, options: DownloadOptions) {\r\n  // console.log('getFileURL', location);\r\n  // const perf = performance.now();\r\n  const encoded = encodeURIComponent(JSON.stringify(options));\r\n  // console.log('getFileURL encode:', performance.now() - perf, encoded);\r\n\r\n  return /* '/' +  */type + '/' + encoded;\r\n}\r\n","import {InputWebFileLocation} from '../../../../layer';\r\n\r\nexport default function isWebFileLocation(location: any): location is InputWebFileLocation {\r\n  return location?._.includes('inputWebFile');\r\n}\r\n","import type {MyPhoto} from '../../../appManagers/appPhotosManager';\r\nimport type {ThumbStorageMedia} from '../../thumbs';\r\nimport type {WebDocument} from '../../../../layer';\r\nimport {getFileNameByLocation} from '../../../../helpers/fileName';\r\nimport isWebFileLocation from '../../../appManagers/utils/webFiles/isWebFileLocation';\r\n\r\nexport default function getThumbKey(media: ThumbStorageMedia) {\r\n  if(isWebFileLocation(media)) {\r\n    return getFileNameByLocation(media);\r\n  }\r\n\r\n  return media._ + ((media as MyPhoto).id ?? (media as WebDocument).url);\r\n}\r\n","import type {ThumbCache} from '../../thumbs';\r\n\r\nexport default function generateEmptyThumb(type: string): ThumbCache {\r\n  return {downloaded: 0, url: '', type};\r\n}\r\n","export default function getStickerThumbKey(docId: DocId, toneIndex?: number | string) {\r\n  return docId + (toneIndex !== undefined ? '-' + toneIndex : '');\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {Awaited} from '../types';\r\n\r\nexport default function callbackify<T extends Awaited<any>, R>(\r\n  smth: T,\r\n  callback: (result: Awaited<T>) => R\r\n): T extends Promise<any> ? Promise<Awaited<R>> : R {\r\n  if(smth instanceof Promise) {\r\n    // @ts-ignore\r\n    return smth.then(callback);\r\n  } else {\r\n    return callback(smth as any) as any;\r\n  }\r\n}\r\n","import {MESSAGE_ID_OFFSET} from '../../../mtproto/mtproto_config';\r\n\r\nexport default function isLegacyMessageId(messageId: number) {\r\n  return typeof(messageId) === 'number' && messageId < MESSAGE_ID_OFFSET;\r\n}\r\n","import { $PROXY, $TRACK, getListener, batch, createSignal } from 'solid-js';\r\n\r\nconst $RAW = Symbol(\"store-raw\"),\r\n  $NODE = Symbol(\"store-node\"),\r\n  $HAS = Symbol(\"store-has\"),\r\n  $SELF = Symbol(\"store-self\");\r\nfunction wrap$1(value) {\r\n  let p = value[$PROXY];\r\n  if (!p) {\r\n    Object.defineProperty(value, $PROXY, {\r\n      value: p = new Proxy(value, proxyTraps$1)\r\n    });\r\n    if (!Array.isArray(value)) {\r\n      const keys = Object.keys(value),\r\n        desc = Object.getOwnPropertyDescriptors(value);\r\n      for (let i = 0, l = keys.length; i < l; i++) {\r\n        const prop = keys[i];\r\n        if (desc[prop].get) {\r\n          Object.defineProperty(value, prop, {\r\n            enumerable: desc[prop].enumerable,\r\n            get: desc[prop].get.bind(p)\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return p;\r\n}\r\nfunction isWrappable(obj) {\r\n  let proto;\r\n  return obj != null && typeof obj === \"object\" && (obj[$PROXY] || !(proto = Object.getPrototypeOf(obj)) || proto === Object.prototype || Array.isArray(obj));\r\n}\r\nfunction unwrap(item, set = new Set()) {\r\n  let result, unwrapped, v, prop;\r\n  if (result = item != null && item[$RAW]) return result;\r\n  if (!isWrappable(item) || set.has(item)) return item;\r\n  if (Array.isArray(item)) {\r\n    if (Object.isFrozen(item)) item = item.slice(0);else set.add(item);\r\n    for (let i = 0, l = item.length; i < l; i++) {\r\n      v = item[i];\r\n      if ((unwrapped = unwrap(v, set)) !== v) item[i] = unwrapped;\r\n    }\r\n  } else {\r\n    if (Object.isFrozen(item)) item = Object.assign({}, item);else set.add(item);\r\n    const keys = Object.keys(item),\r\n      desc = Object.getOwnPropertyDescriptors(item);\r\n    for (let i = 0, l = keys.length; i < l; i++) {\r\n      prop = keys[i];\r\n      if (desc[prop].get) continue;\r\n      v = item[prop];\r\n      if ((unwrapped = unwrap(v, set)) !== v) item[prop] = unwrapped;\r\n    }\r\n  }\r\n  return item;\r\n}\r\nfunction getNodes(target, symbol) {\r\n  let nodes = target[symbol];\r\n  if (!nodes) Object.defineProperty(target, symbol, {\r\n    value: nodes = Object.create(null)\r\n  });\r\n  return nodes;\r\n}\r\nfunction getNode(nodes, property, value) {\r\n  if (nodes[property]) return nodes[property];\r\n  const [s, set] = createSignal(value, {\r\n    equals: false,\r\n    internal: true\r\n  });\r\n  s.$ = set;\r\n  return nodes[property] = s;\r\n}\r\nfunction proxyDescriptor$1(target, property) {\r\n  const desc = Reflect.getOwnPropertyDescriptor(target, property);\r\n  if (!desc || desc.get || !desc.configurable || property === $PROXY || property === $NODE) return desc;\r\n  delete desc.value;\r\n  delete desc.writable;\r\n  desc.get = () => target[$PROXY][property];\r\n  return desc;\r\n}\r\nfunction trackSelf(target) {\r\n  getListener() && getNode(getNodes(target, $NODE), $SELF)();\r\n}\r\nfunction ownKeys(target) {\r\n  trackSelf(target);\r\n  return Reflect.ownKeys(target);\r\n}\r\nconst proxyTraps$1 = {\r\n  get(target, property, receiver) {\r\n    if (property === $RAW) return target;\r\n    if (property === $PROXY) return receiver;\r\n    if (property === $TRACK) {\r\n      trackSelf(target);\r\n      return receiver;\r\n    }\r\n    const nodes = getNodes(target, $NODE);\r\n    const tracked = nodes[property];\r\n    let value = tracked ? tracked() : target[property];\r\n    if (property === $NODE || property === $HAS || property === \"__proto__\") return value;\r\n    if (!tracked) {\r\n      const desc = Object.getOwnPropertyDescriptor(target, property);\r\n      if (getListener() && (typeof value !== \"function\" || target.hasOwnProperty(property)) && !(desc && desc.get)) value = getNode(nodes, property, value)();\r\n    }\r\n    return isWrappable(value) ? wrap$1(value) : value;\r\n  },\r\n  has(target, property) {\r\n    if (property === $RAW || property === $PROXY || property === $TRACK || property === $NODE || property === $HAS || property === \"__proto__\") return true;\r\n    getListener() && getNode(getNodes(target, $HAS), property)();\r\n    return property in target;\r\n  },\r\n  set() {\r\n    return true;\r\n  },\r\n  deleteProperty() {\r\n    return true;\r\n  },\r\n  ownKeys: ownKeys,\r\n  getOwnPropertyDescriptor: proxyDescriptor$1\r\n};\r\nfunction setProperty(state, property, value, deleting = false) {\r\n  if (!deleting && state[property] === value) return;\r\n  const prev = state[property],\r\n    len = state.length;\r\n  if (value === undefined) {\r\n    delete state[property];\r\n    if (state[$HAS] && state[$HAS][property] && prev !== undefined) state[$HAS][property].$();\r\n  } else {\r\n    state[property] = value;\r\n    if (state[$HAS] && state[$HAS][property] && prev === undefined) state[$HAS][property].$();\r\n  }\r\n  let nodes = getNodes(state, $NODE),\r\n    node;\r\n  if (node = getNode(nodes, property, prev)) node.$(() => value);\r\n  if (Array.isArray(state) && state.length !== len) {\r\n    for (let i = state.length; i < len; i++) (node = nodes[i]) && node.$();\r\n    (node = getNode(nodes, \"length\", len)) && node.$(state.length);\r\n  }\r\n  (node = nodes[$SELF]) && node.$();\r\n}\r\nfunction mergeStoreNode(state, value) {\r\n  const keys = Object.keys(value);\r\n  for (let i = 0; i < keys.length; i += 1) {\r\n    const key = keys[i];\r\n    setProperty(state, key, value[key]);\r\n  }\r\n}\r\nfunction updateArray(current, next) {\r\n  if (typeof next === \"function\") next = next(current);\r\n  next = unwrap(next);\r\n  if (Array.isArray(next)) {\r\n    if (current === next) return;\r\n    let i = 0,\r\n      len = next.length;\r\n    for (; i < len; i++) {\r\n      const value = next[i];\r\n      if (current[i] !== value) setProperty(current, i, value);\r\n    }\r\n    setProperty(current, \"length\", len);\r\n  } else mergeStoreNode(current, next);\r\n}\r\nfunction updatePath(current, path, traversed = []) {\r\n  let part,\r\n    prev = current;\r\n  if (path.length > 1) {\r\n    part = path.shift();\r\n    const partType = typeof part,\r\n      isArray = Array.isArray(current);\r\n    if (Array.isArray(part)) {\r\n      for (let i = 0; i < part.length; i++) {\r\n        updatePath(current, [part[i]].concat(path), traversed);\r\n      }\r\n      return;\r\n    } else if (isArray && partType === \"function\") {\r\n      for (let i = 0; i < current.length; i++) {\r\n        if (part(current[i], i)) updatePath(current, [i].concat(path), traversed);\r\n      }\r\n      return;\r\n    } else if (isArray && partType === \"object\") {\r\n      const {\r\n        from = 0,\r\n        to = current.length - 1,\r\n        by = 1\r\n      } = part;\r\n      for (let i = from; i <= to; i += by) {\r\n        updatePath(current, [i].concat(path), traversed);\r\n      }\r\n      return;\r\n    } else if (path.length > 1) {\r\n      updatePath(current[part], path, [part].concat(traversed));\r\n      return;\r\n    }\r\n    prev = current[part];\r\n    traversed = [part].concat(traversed);\r\n  }\r\n  let value = path[0];\r\n  if (typeof value === \"function\") {\r\n    value = value(prev, traversed);\r\n    if (value === prev) return;\r\n  }\r\n  if (part === undefined && value == undefined) return;\r\n  value = unwrap(value);\r\n  if (part === undefined || isWrappable(prev) && isWrappable(value) && !Array.isArray(value)) {\r\n    mergeStoreNode(prev, value);\r\n  } else setProperty(current, part, value);\r\n}\r\nfunction createStore(...[store, options]) {\r\n  const unwrappedStore = unwrap(store || {});\r\n  const isArray = Array.isArray(unwrappedStore);\r\n  const wrappedStore = wrap$1(unwrappedStore);\r\n  function setStore(...args) {\r\n    batch(() => {\r\n      isArray && args.length === 1 ? updateArray(unwrappedStore, args[0]) : updatePath(unwrappedStore, args);\r\n    });\r\n  }\r\n  return [wrappedStore, setStore];\r\n}\r\n\r\nfunction proxyDescriptor(target, property) {\r\n  const desc = Reflect.getOwnPropertyDescriptor(target, property);\r\n  if (!desc || desc.get || desc.set || !desc.configurable || property === $PROXY || property === $NODE) return desc;\r\n  delete desc.value;\r\n  delete desc.writable;\r\n  desc.get = () => target[$PROXY][property];\r\n  desc.set = v => target[$PROXY][property] = v;\r\n  return desc;\r\n}\r\nconst proxyTraps = {\r\n  get(target, property, receiver) {\r\n    if (property === $RAW) return target;\r\n    if (property === $PROXY) return receiver;\r\n    if (property === $TRACK) {\r\n      trackSelf(target);\r\n      return receiver;\r\n    }\r\n    const nodes = getNodes(target, $NODE);\r\n    const tracked = nodes[property];\r\n    let value = tracked ? tracked() : target[property];\r\n    if (property === $NODE || property === $HAS || property === \"__proto__\") return value;\r\n    if (!tracked) {\r\n      const desc = Object.getOwnPropertyDescriptor(target, property);\r\n      const isFunction = typeof value === \"function\";\r\n      if (getListener() && (!isFunction || target.hasOwnProperty(property)) && !(desc && desc.get)) value = getNode(nodes, property, value)();else if (value != null && isFunction && value === Array.prototype[property]) {\r\n        return (...args) => batch(() => Array.prototype[property].apply(receiver, args));\r\n      }\r\n    }\r\n    return isWrappable(value) ? wrap(value) : value;\r\n  },\r\n  has(target, property) {\r\n    if (property === $RAW || property === $PROXY || property === $TRACK || property === $NODE || property === $HAS || property === \"__proto__\") return true;\r\n    getListener() && getNode(getNodes(target, $HAS), property)();\r\n    return property in target;\r\n  },\r\n  set(target, property, value) {\r\n    batch(() => setProperty(target, property, unwrap(value)));\r\n    return true;\r\n  },\r\n  deleteProperty(target, property) {\r\n    batch(() => setProperty(target, property, undefined, true));\r\n    return true;\r\n  },\r\n  ownKeys: ownKeys,\r\n  getOwnPropertyDescriptor: proxyDescriptor\r\n};\r\nfunction wrap(value) {\r\n  let p = value[$PROXY];\r\n  if (!p) {\r\n    Object.defineProperty(value, $PROXY, {\r\n      value: p = new Proxy(value, proxyTraps)\r\n    });\r\n    const keys = Object.keys(value),\r\n      desc = Object.getOwnPropertyDescriptors(value);\r\n    const proto = Object.getPrototypeOf(value);\r\n    const isClass = value !== null && typeof value === \"object\" && !Array.isArray(value) && proto !== Object.prototype;\r\n    if (isClass) {\r\n      const descriptors = Object.getOwnPropertyDescriptors(proto);\r\n      keys.push(...Object.keys(descriptors));\r\n      Object.assign(desc, descriptors);\r\n    }\r\n    for (let i = 0, l = keys.length; i < l; i++) {\r\n      const prop = keys[i];\r\n      if (isClass && prop === \"constructor\") continue;\r\n      if (desc[prop].get) {\r\n        const get = desc[prop].get.bind(p);\r\n        Object.defineProperty(value, prop, {\r\n          get,\r\n          configurable: true\r\n        });\r\n      }\r\n      if (desc[prop].set) {\r\n        const og = desc[prop].set,\r\n          set = v => batch(() => og.call(p, v));\r\n        Object.defineProperty(value, prop, {\r\n          set,\r\n          configurable: true\r\n        });\r\n      }\r\n    }\r\n  }\r\n  return p;\r\n}\r\nfunction createMutable(state, options) {\r\n  const unwrappedStore = unwrap(state || {});\r\n  const wrappedStore = wrap(unwrappedStore);\r\n  return wrappedStore;\r\n}\r\nfunction modifyMutable(state, modifier) {\r\n  batch(() => modifier(unwrap(state)));\r\n}\r\n\r\nconst $ROOT = Symbol(\"store-root\");\r\nfunction applyState(target, parent, property, merge, key) {\r\n  const previous = parent[property];\r\n  if (target === previous) return;\r\n  const isArray = Array.isArray(target);\r\n  if (property !== $ROOT && (!isWrappable(target) || !isWrappable(previous) || isArray !== Array.isArray(previous) || key && target[key] !== previous[key])) {\r\n    setProperty(parent, property, target);\r\n    return;\r\n  }\r\n  if (isArray) {\r\n    if (target.length && previous.length && (!merge || key && target[0] && target[0][key] != null)) {\r\n      let i, j, start, end, newEnd, item, newIndicesNext, keyVal;\r\n      for (start = 0, end = Math.min(previous.length, target.length); start < end && (previous[start] === target[start] || key && previous[start] && target[start] && previous[start][key] === target[start][key]); start++) {\r\n        applyState(target[start], previous, start, merge, key);\r\n      }\r\n      const temp = new Array(target.length),\r\n        newIndices = new Map();\r\n      for (end = previous.length - 1, newEnd = target.length - 1; end >= start && newEnd >= start && (previous[end] === target[newEnd] || key && previous[start] && target[start] && previous[end][key] === target[newEnd][key]); end--, newEnd--) {\r\n        temp[newEnd] = previous[end];\r\n      }\r\n      if (start > newEnd || start > end) {\r\n        for (j = start; j <= newEnd; j++) setProperty(previous, j, target[j]);\r\n        for (; j < target.length; j++) {\r\n          setProperty(previous, j, temp[j]);\r\n          applyState(target[j], previous, j, merge, key);\r\n        }\r\n        if (previous.length > target.length) setProperty(previous, \"length\", target.length);\r\n        return;\r\n      }\r\n      newIndicesNext = new Array(newEnd + 1);\r\n      for (j = newEnd; j >= start; j--) {\r\n        item = target[j];\r\n        keyVal = key && item ? item[key] : item;\r\n        i = newIndices.get(keyVal);\r\n        newIndicesNext[j] = i === undefined ? -1 : i;\r\n        newIndices.set(keyVal, j);\r\n      }\r\n      for (i = start; i <= end; i++) {\r\n        item = previous[i];\r\n        keyVal = key && item ? item[key] : item;\r\n        j = newIndices.get(keyVal);\r\n        if (j !== undefined && j !== -1) {\r\n          temp[j] = previous[i];\r\n          j = newIndicesNext[j];\r\n          newIndices.set(keyVal, j);\r\n        }\r\n      }\r\n      for (j = start; j < target.length; j++) {\r\n        if (j in temp) {\r\n          setProperty(previous, j, temp[j]);\r\n          applyState(target[j], previous, j, merge, key);\r\n        } else setProperty(previous, j, target[j]);\r\n      }\r\n    } else {\r\n      for (let i = 0, len = target.length; i < len; i++) {\r\n        applyState(target[i], previous, i, merge, key);\r\n      }\r\n    }\r\n    if (previous.length > target.length) setProperty(previous, \"length\", target.length);\r\n    return;\r\n  }\r\n  const targetKeys = Object.keys(target);\r\n  for (let i = 0, len = targetKeys.length; i < len; i++) {\r\n    applyState(target[targetKeys[i]], previous, targetKeys[i], merge, key);\r\n  }\r\n  const previousKeys = Object.keys(previous);\r\n  for (let i = 0, len = previousKeys.length; i < len; i++) {\r\n    if (target[previousKeys[i]] === undefined) setProperty(previous, previousKeys[i], undefined);\r\n  }\r\n}\r\nfunction reconcile(value, options = {}) {\r\n  const {\r\n      merge,\r\n      key = \"id\"\r\n    } = options,\r\n    v = unwrap(value);\r\n  return state => {\r\n    if (!isWrappable(state) || !isWrappable(v)) return v;\r\n    const res = applyState(v, {\r\n      [$ROOT]: state\r\n    }, $ROOT, merge, key);\r\n    return res === undefined ? state : res;\r\n  };\r\n}\r\nconst producers = new WeakMap();\r\nconst setterTraps = {\r\n  get(target, property) {\r\n    if (property === $RAW) return target;\r\n    const value = target[property];\r\n    let proxy;\r\n    return isWrappable(value) ? producers.get(value) || (producers.set(value, proxy = new Proxy(value, setterTraps)), proxy) : value;\r\n  },\r\n  set(target, property, value) {\r\n    setProperty(target, property, unwrap(value));\r\n    return true;\r\n  },\r\n  deleteProperty(target, property) {\r\n    setProperty(target, property, undefined, true);\r\n    return true;\r\n  }\r\n};\r\nfunction produce(fn) {\r\n  return state => {\r\n    if (isWrappable(state)) {\r\n      let proxy;\r\n      if (!(proxy = producers.get(state))) {\r\n        producers.set(state, proxy = new Proxy(state, setterTraps));\r\n      }\r\n      fn(proxy);\r\n    }\r\n    return state;\r\n  };\r\n}\r\n\r\nconst DEV = undefined;\r\n\r\nexport { $RAW, DEV, createMutable, createStore, modifyMutable, produce, reconcile, unwrap };\r\n","import {createRoot} from 'solid-js';\r\nimport {createStore, reconcile, unwrap} from 'solid-js/store';\r\nimport {State} from '../config/state';\r\nimport rootScope from '../lib/rootScope';\r\n\r\nconst [appState, _setAppState] = createRoot(() => createStore<State>({} as any));\r\n\r\nconst setAppState: typeof _setAppState = (...args: any[]) => {\r\n  const key = args[0];\r\n  // @ts-ignore\r\n  _setAppState(...args);\r\n  // @ts-ignore\r\n  rootScope.managers.appStateManager.setByKey(key, unwrap(appState[key]));\r\n};\r\n\r\nconst setAppStateSilent = (key: any, value?: any) => {\r\n  if(typeof(key) === 'object') {\r\n    _setAppState(key);\r\n    return;\r\n  }\r\n\r\n  _setAppState(key, reconcile(value));\r\n};\r\n\r\nconst useAppState = () => [appState, setAppState] as const;\r\n\r\nexport {\r\n  appState,\r\n  useAppState,\r\n  setAppState,\r\n  setAppStateSilent\r\n};\r\n","export default function getObjectKeysAndSort(object: {[key: string]: any} | Map<number, any>, sort: 'asc' | 'desc' = 'asc') {\r\n  if(!object) return [];\r\n  const ids = object instanceof Map ? [...object.keys()] : Object.keys(object).map((i) => +i);\r\n  if(sort === 'asc') return ids.sort((a, b) => a - b);\r\n  else return ids.sort((a, b) => b - a);\r\n}\r\n","// import {Accessor, createMemo} from 'solid-js';\r\nimport {Accessor, createMemo} from 'solid-js';\r\nimport {createStore, reconcile} from 'solid-js/store';\r\nimport {Chat, User} from '../layer';\r\n\r\ntype Peer = Chat | User;\r\n\r\nconst [state, setState] = createStore<{[peerId: PeerId]: Peer}>({});\r\n\r\ntype ValueOrGetter<T> = T | Accessor<T>;\r\n\r\nfunction createMemoOrReturn<T extends ValueOrGetter<any>, R, V = T extends Accessor<infer V> ? V : T>(valueOrGetter: T, callback: (value: V) => R): T extends Accessor<any> ? Accessor<R> : R {\r\n  // @ts-ignore\r\n  return typeof(valueOrGetter) === 'function' ? createMemo(() => callback((valueOrGetter as Accessor<T>)())) : callback(valueOrGetter);\r\n}\r\n\r\nexport function usePeer<T extends ValueOrGetter<PeerId>>(peerId: T) {\r\n  return createMemoOrReturn(peerId, (peerId) => state[peerId]);\r\n}\r\n\r\nexport function useChat<T extends ValueOrGetter<ChatId>>(chatId: T) {\r\n  return createMemoOrReturn<T, Chat>(chatId, (chatId) => state[chatId?.toPeerId(true)] as Chat);\r\n}\r\n\r\nexport function useUser<T extends ValueOrGetter<UserId>>(userId: T) {\r\n  return createMemoOrReturn<T, User>(userId, (userId) => state[userId?.toPeerId(false)] as User);\r\n}\r\n\r\nexport function reconcilePeer(peerId: PeerId, peer: Peer) {\r\n  setState(peerId, reconcile(peer));\r\n}\r\n\r\nexport function reconcilePeers(peers: {[peerId: PeerId]: Peer}) {\r\n  setState(/* reconcile */(peers));\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {Awaited} from '../../types';\r\nimport type {CacheStorageDbName} from '../files/cacheStorage';\r\nimport type {State} from '../../config/state';\r\nimport type {Chat, ChatPhoto, Message, MessagePeerReaction, PeerNotifySettings, User, UserProfilePhoto} from '../../layer';\r\nimport type {CryptoMethods} from '../crypto/crypto_methods';\r\nimport type {ThumbStorageMedia} from '../storages/thumbs';\r\nimport type ThumbsStorage from '../storages/thumbs';\r\nimport type {AppReactionsManager} from '../appManagers/appReactionsManager';\r\nimport type {MessagesStorageKey} from '../appManagers/appMessagesManager';\r\nimport type {AppAvatarsManager, PeerPhotoSize} from '../appManagers/appAvatarsManager';\r\nimport rootScope from '../rootScope';\r\nimport webpWorkerController from '../webp/webpWorkerController';\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport sessionStorage from '../sessionStorage';\r\nimport webPushApiManager from './webPushApiManager';\r\nimport appRuntimeManager from '../appManagers/appRuntimeManager';\r\nimport telegramMeWebManager from './telegramMeWebManager';\r\nimport pause from '../../helpers/schedulers/pause';\r\nimport ENVIRONMENT from '../../environment';\r\nimport loadState from '../appManagers/utils/state/loadState';\r\nimport opusDecodeController from '../opusDecodeController';\r\nimport MTProtoMessagePort from './mtprotoMessagePort';\r\nimport cryptoMessagePort from '../crypto/cryptoMessagePort';\r\nimport SuperMessagePort from './superMessagePort';\r\nimport IS_SHARED_WORKER_SUPPORTED from '../../environment/sharedWorkerSupport';\r\nimport toggleStorages from '../../helpers/toggleStorages';\r\nimport idleController from '../../helpers/idleController';\r\nimport ServiceMessagePort from '../serviceWorker/serviceMessagePort';\r\nimport deferredPromise, {CancellablePromise} from '../../helpers/cancellablePromise';\r\nimport {makeWorkerURL} from '../../helpers/setWorkerProxy';\r\nimport ServiceWorkerURL from '../../../sw?worker&url';\r\nimport setDeepProperty, {splitDeepPath} from '../../helpers/object/setDeepProperty';\r\nimport getThumbKey from '../storages/utils/thumbs/getThumbKey';\r\nimport {NULL_PEER_ID, THUMB_TYPE_FULL} from './mtproto_config';\r\nimport generateEmptyThumb from '../storages/utils/thumbs/generateEmptyThumb';\r\nimport getStickerThumbKey from '../storages/utils/thumbs/getStickerThumbKey';\r\nimport callbackify from '../../helpers/callbackify';\r\nimport isLegacyMessageId from '../appManagers/utils/messageId/isLegacyMessageId';\r\nimport {MTAppConfig} from './appConfig';\r\nimport {setAppStateSilent} from '../../stores/appState';\r\nimport getObjectKeysAndSort from '../../helpers/object/getObjectKeysAndSort';\r\nimport {reconcilePeer, reconcilePeers} from '../../stores/peers';\r\n\r\nconst TEST_NO_STREAMING = false;\r\n\r\nexport type Mirrors = {\r\n  state: State,\r\n  thumbs: ThumbsStorage['thumbsCache'],\r\n  stickerThumbs: ThumbsStorage['stickerCachedThumbs'],\r\n  availableReactions: AppReactionsManager['availableReactions'] | Promise<AppReactionsManager['availableReactions']>,\r\n  messages: {\r\n    [type in string]: {\r\n      [mid in number]: Message.message | Message.messageService\r\n    }\r\n  },\r\n  groupedMessages: {\r\n    [groupedId in string]: Map<number, Message.message | Message.messageService>\r\n  },\r\n  peers: {\r\n    [peerId in PeerId]: Exclude<Chat, Chat.chatEmpty> | User.user\r\n  },\r\n  avatars: AppAvatarsManager['savedAvatarURLs']\r\n};\r\n\r\nexport type MirrorTaskPayload<\r\n  T extends keyof Mirrors = keyof Mirrors\r\n  // K extends keyof Mirrors[T] = keyof Mirrors[T],\r\n  // J extends Mirrors[T][K] = Mirrors[T][K]\r\n> = {\r\n  name: T,\r\n  // key?: K,\r\n  key?: string,\r\n  value?: any\r\n};\r\n\r\nexport type NotificationBuildTaskPayload = {\r\n  message: Message.message | Message.messageService,\r\n  fwdCount?: number,\r\n  peerReaction?: MessagePeerReaction,\r\n  peerTypeNotifySettings?: PeerNotifySettings\r\n};\r\n\r\nexport type TabState = {\r\n  chatPeerIds: PeerId[],\r\n  idleStartTime: number,\r\n};\r\n\r\nclass ApiManagerProxy extends MTProtoMessagePort {\r\n  // private worker: /* Window */Worker;\r\n  // private sockets: Map<number, Socket> = new Map();\r\n  private mirrors: Mirrors;\r\n\r\n  public newVersion: string;\r\n  public oldVersion: string;\r\n\r\n  private tabState: TabState;\r\n\r\n  public share: ShareData;\r\n\r\n  public serviceMessagePort: ServiceMessagePort<true>;\r\n  private lastServiceWorker: ServiceWorker;\r\n\r\n  private pingServiceWorkerPromise: CancellablePromise<void>;\r\n\r\n  private processMirrorTaskMap: {\r\n    [type in keyof Mirrors]?: (payload: MirrorTaskPayload) => void\r\n  };\r\n\r\n  private appConfig: MaybePromise<MTAppConfig>;\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    this.mirrors = {\r\n      state: undefined,\r\n      thumbs: {},\r\n      stickerThumbs: {},\r\n      availableReactions: undefined,\r\n      messages: {},\r\n      groupedMessages: {},\r\n      peers: {},\r\n      avatars: {}\r\n    };\r\n\r\n    this.processMirrorTaskMap = {\r\n      messages: (payload) => {\r\n        const message = payload.value as Message.message | Message.messageService;\r\n        let mid: number, groupedId: string;\r\n        if(message) {\r\n          mid = message.mid;\r\n          groupedId = (message as Message.message).grouped_id;\r\n        } else {\r\n          const [key, _mid] = splitDeepPath(payload.key);\r\n          mid = +_mid;\r\n          const previousMessage = this.mirrors.messages[key]?.[mid];\r\n          if(!previousMessage) {\r\n            return;\r\n          }\r\n\r\n          groupedId = (previousMessage as Message.message).grouped_id;\r\n        }\r\n\r\n        if(!groupedId) {\r\n          return;\r\n        }\r\n\r\n        const map = this.mirrors.groupedMessages[groupedId] ??= new Map();\r\n        if(!message) {\r\n          map.delete(mid);\r\n\r\n          if(!map.size) {\r\n            delete this.mirrors.groupedMessages[groupedId];\r\n          }\r\n        } else {\r\n          map.set(mid, message);\r\n        }\r\n      },\r\n\r\n      state: (payload) => {\r\n        if(payload.key) {\r\n          setAppStateSilent(payload.key, payload.value);\r\n        } else {\r\n          console.error(payload);\r\n        }\r\n      },\r\n\r\n      peers: (payload) => {\r\n        if(payload.key) {\r\n          reconcilePeer(payload.key.toPeerId(), payload.value as any);\r\n        } else {\r\n          reconcilePeers(payload.value);\r\n        }\r\n      }\r\n    };\r\n\r\n    this.tabState = {\r\n      chatPeerIds: [],\r\n      idleStartTime: 0\r\n    };\r\n\r\n    this.log('constructor');\r\n\r\n    if(!import.meta.env.VITE_MTPROTO_SW) {\r\n      this.registerWorker();\r\n    }\r\n\r\n    this.registerServiceWorker();\r\n    this.registerCryptoWorker();\r\n\r\n    // const perf = performance.now();\r\n    this.addMultipleEventsListeners({\r\n      convertWebp: ({fileName, bytes}) => {\r\n        return webpWorkerController.convert(fileName, bytes);\r\n      },\r\n\r\n      convertOpus: ({fileName, bytes}) => {\r\n        return opusDecodeController.pushDecodeTask(bytes, false).then((result) => result.bytes);\r\n      },\r\n\r\n      event: ({name, args}) => {\r\n        // @ts-ignore\r\n        rootScope.dispatchEventSingle(name, ...args);\r\n      },\r\n\r\n      localStorageProxy: (payload) => {\r\n        const storageTask = payload;\r\n        return (sessionStorage[storageTask.type] as any)(...storageTask.args);\r\n      },\r\n\r\n      mirror: this.onMirrorTask,\r\n\r\n      receivedServiceMessagePort: () => {\r\n        this.log.warn('mtproto worker received service message port');\r\n      }\r\n\r\n      // hello: () => {\r\n      //   this.log.error('time hello', performance.now() - perf);\r\n      // }\r\n    });\r\n\r\n    // this.addTaskListener('socketProxy', (task) => {\r\n    //   const socketTask = task.payload;\r\n    //   const id = socketTask.id;\r\n    //   //console.log('socketProxy', socketTask, id);\r\n\r\n    //   if(socketTask.type === 'send') {\r\n    //     const socket = this.sockets.get(id);\r\n    //     socket.send(socketTask.payload);\r\n    //   } else if(socketTask.type === 'close') { // will remove from map in onClose\r\n    //     const socket = this.sockets.get(id);\r\n    //     socket.close();\r\n    //   } else if(socketTask.type === 'setup') {\r\n    //     const socket = new Socket(socketTask.payload.dcId, socketTask.payload.url, socketTask.payload.logSuffix);\r\n\r\n    //     const onOpen = () => {\r\n    //       //console.log('socketProxy onOpen');\r\n    //       this.postMessage({\r\n    //         type: 'socketProxy',\r\n    //         payload: {\r\n    //           type: 'open',\r\n    //           id\r\n    //         }\r\n    //       });\r\n    //     };\r\n    //     const onClose = () => {\r\n    //       this.postMessage({\r\n    //         type: 'socketProxy',\r\n    //         payload: {\r\n    //           type: 'close',\r\n    //           id\r\n    //         }\r\n    //       });\r\n\r\n    //       socket.removeEventListener('open', onOpen);\r\n    //       socket.removeEventListener('close', onClose);\r\n    //       socket.removeEventListener('message', onMessage);\r\n    //       this.sockets.delete(id);\r\n    //     };\r\n    //     const onMessage = (buffer: ArrayBuffer) => {\r\n    //       this.postMessage({\r\n    //         type: 'socketProxy',\r\n    //         payload: {\r\n    //           type: 'message',\r\n    //           id,\r\n    //           payload: buffer\r\n    //         }\r\n    //       });\r\n    //     };\r\n\r\n    //     socket.addEventListener('open', onOpen);\r\n    //     socket.addEventListener('close', onClose);\r\n    //     socket.addEventListener('message', onMessage);\r\n    //     this.sockets.set(id, socket);\r\n    //   }\r\n    // });\r\n\r\n    rootScope.addEventListener('language_change', (language) => {\r\n      rootScope.managers.networkerFactory.setLanguage(language);\r\n      rootScope.managers.appAttachMenuBotsManager.onLanguageChange();\r\n    });\r\n\r\n    window.addEventListener('online', () => {\r\n      rootScope.managers.networkerFactory.forceReconnectTimeout();\r\n    });\r\n\r\n    rootScope.addEventListener('logging_out', () => {\r\n      const toClear: CacheStorageDbName[] = ['cachedFiles', 'cachedStreamChunks'];\r\n      Promise.all([\r\n        toggleStorages(false, true),\r\n        sessionStorage.clear(),\r\n        Promise.race([\r\n          telegramMeWebManager.setAuthorized(false),\r\n          pause(3000)\r\n        ]),\r\n        webPushApiManager.forceUnsubscribe(),\r\n        Promise.all(toClear.map((cacheName) => caches.delete(cacheName)))\r\n      ]).finally(() => {\r\n        appRuntimeManager.reload();\r\n      });\r\n    });\r\n\r\n    idleController.addEventListener('change', (idle) => {\r\n      this.updateTabStateIdle(idle);\r\n    });\r\n    this.updateTabStateIdle(idleController.isIdle);\r\n\r\n    // this.sendState();\r\n  }\r\n\r\n  public sendEnvironment() {\r\n    this.log('Passing environment:', ENVIRONMENT);\r\n    this.invoke('environment', ENVIRONMENT);\r\n  }\r\n\r\n  public pingServiceWorkerWithIframe() {\r\n    if(this.pingServiceWorkerPromise) {\r\n      return this.pingServiceWorkerPromise;\r\n    }\r\n\r\n    const promise = this.pingServiceWorkerPromise = deferredPromise<void>();\r\n    const iframe = document.createElement('iframe');\r\n    iframe.hidden = true;\r\n    const onFinish = () => {\r\n      clearTimeout(timeout);\r\n      setTimeout(() => { // ping once in 10 seconds\r\n        this.pingServiceWorkerPromise = undefined;\r\n      }, 10e3);\r\n\r\n      iframe.removeEventListener('load', onLoad);\r\n      iframe.removeEventListener('error', onError);\r\n      iframe.remove();\r\n    };\r\n    const onLoad = () => {\r\n      onFinish();\r\n      promise.resolve();\r\n    };\r\n    const onError = () => {\r\n      onFinish();\r\n      promise.reject();\r\n    };\r\n    iframe.addEventListener('load', onLoad);\r\n    iframe.addEventListener('error', onError);\r\n    iframe.src = 'ping/' + (Math.random() * 0xFFFFFFFF | 0) + '.nocache';\r\n    document.body.append(iframe);\r\n\r\n    const timeout = window.setTimeout(onError, 1500);\r\n    return promise;\r\n  }\r\n\r\n  private attachServiceWorker(serviceWorker: ServiceWorker) {\r\n    if(this.lastServiceWorker === serviceWorker) {\r\n      this.log.warn('trying to attach same service worker');\r\n      return;\r\n    }\r\n\r\n    this.lastServiceWorker && this.serviceMessagePort.detachPort(this.lastServiceWorker);\r\n    this.serviceMessagePort.attachSendPort(this.lastServiceWorker = serviceWorker);\r\n    this.serviceMessagePort.invokeVoid('hello', undefined);\r\n  }\r\n\r\n  private _registerServiceWorker() {\r\n    // if(import.meta.env.DEV && IS_SAFARI) {\r\n    //   return;\r\n    // }\r\n\r\n    navigator.serviceWorker.register(\r\n      // * doesn't work\r\n      // new URL('../../../sw.ts', import.meta.url),\r\n      // '../../../sw',\r\n      ServiceWorkerURL,\r\n      {type: 'module', scope: './'}\r\n    ).then((registration) => {\r\n      if(TEST_NO_STREAMING) {\r\n        throw 1;\r\n      }\r\n\r\n      this.log('SW registered', registration);\r\n\r\n      const url = new URL(window.location.href);\r\n      const FIX_KEY = 'swfix';\r\n      const swfix = +url.searchParams.get(FIX_KEY) || 0;\r\n      if(registration.active && !navigator.serviceWorker.controller) {\r\n        if(swfix >= 3) {\r\n          throw new Error('no controller');\r\n        }\r\n\r\n        // ! doubtful fix for hard refresh\r\n        return registration.unregister().then(() => {\r\n          url.searchParams.set(FIX_KEY, '' + (swfix + 1));\r\n          window.location.href = url.toString();\r\n        });\r\n      }\r\n\r\n      if(swfix) {\r\n        url.searchParams.delete(FIX_KEY);\r\n        history.pushState(undefined, '', url);\r\n      }\r\n\r\n      const sw = registration.installing || registration.waiting || registration.active;\r\n      sw.addEventListener('statechange', (e) => {\r\n        this.log('SW statechange', e);\r\n      });\r\n\r\n      const controller = navigator.serviceWorker.controller || registration.installing || registration.waiting || registration.active;\r\n      this.attachServiceWorker(controller);\r\n\r\n      if(import.meta.env.VITE_MTPROTO_SW) {\r\n        this.onWorkerFirstMessage(controller);\r\n      }\r\n    }).catch((err) => {\r\n      this.log.error('SW registration failed!', err);\r\n\r\n      this.invokeVoid('serviceWorkerOnline', false);\r\n    });\r\n  }\r\n\r\n  private registerServiceWorker() {\r\n    if(!('serviceWorker' in navigator)) return;\r\n\r\n    this.serviceMessagePort = webPushApiManager.serviceMessagePort = new ServiceMessagePort<true>();\r\n\r\n    // this.addMultipleEventsListeners({\r\n    //   hello: () => {\r\n    //     // this.serviceMessagePort.invokeVoid('port', undefined);\r\n    //   }\r\n    // });\r\n\r\n    // ! I hate webpack - it won't load it by using worker.register, only navigator.serviceWorker will do it.\r\n    const worker = navigator.serviceWorker;\r\n    this._registerServiceWorker();\r\n\r\n    // worker.startMessages();\r\n\r\n    worker.addEventListener('controllerchange', () => {\r\n      this.log.warn('controllerchange');\r\n\r\n      const controller = worker.controller;\r\n      this.attachServiceWorker(controller);\r\n\r\n      controller.addEventListener('error', (e) => {\r\n        this.log.error('controller error:', e);\r\n      });\r\n    });\r\n\r\n    if(import.meta.env.VITE_MTPROTO_SW) {\r\n      this.attachListenPort(worker);\r\n    } else {\r\n      this.serviceMessagePort.attachListenPort(worker);\r\n      this.serviceMessagePort.addMultipleEventsListeners({\r\n        port: (payload, source, event) => {\r\n          this.log.warn('got service worker port');\r\n          this.invokeVoid('serviceWorkerPort', undefined, undefined, [event.ports[0]]);\r\n        },\r\n\r\n        hello: (payload, source) => {\r\n          this.serviceMessagePort.resendLockTask(source);\r\n        },\r\n\r\n        share: (payload) => {\r\n          this.log('will try to share something');\r\n          this.share = payload;\r\n        }\r\n      });\r\n    }\r\n\r\n    worker.addEventListener('messageerror', (e) => {\r\n      this.log.error('SW messageerror:', e);\r\n    });\r\n  }\r\n\r\n  private async registerCryptoWorker() {\r\n    const get = (url: string) => {\r\n      return fetch(url).then((response) => response.text()).then((text) => {\r\n        const pathnameSplitted = location.pathname.split('/');\r\n        pathnameSplitted[pathnameSplitted.length - 1] = '';\r\n        const pre = location.origin + pathnameSplitted.join('/');\r\n        text = text.replace(/(import (?:.+? from )?['\"])\\//g, '$1' + pre);\r\n        const blob = new Blob([text], {type: 'application/javascript'});\r\n        return blob;\r\n      });\r\n    };\r\n\r\n    const workerHandler = {\r\n      construct(target: any, args: any): any {\r\n        return {\r\n          url: makeWorkerURL(args[0]).toString()\r\n        };\r\n      }\r\n    };\r\n\r\n    const originals = [\r\n      Worker,\r\n      typeof(SharedWorker) !== 'undefined' && SharedWorker\r\n    ].filter(Boolean);\r\n    originals.forEach((w) => window[w.name as any] = new Proxy(w, workerHandler));\r\n\r\n    const worker: SharedWorker | Worker = new Worker(\r\n      new URL('../crypto/crypto.worker.ts', import.meta.url),\r\n      {type: 'module'}\r\n    );\r\n\r\n    originals.forEach((w) => window[w.name as any] = w as any);\r\n\r\n    const originalUrl = (worker as any).url;\r\n\r\n    const createWorker = (url: string) => new constructor(url, {type: 'module'});\r\n    const attachWorkerToPort = (worker: SharedWorker | Worker) => this.attachWorkerToPort(worker, cryptoMessagePort, 'crypto');\r\n    const constructor = IS_SHARED_WORKER_SUPPORTED ? SharedWorker : Worker;\r\n\r\n    // let cryptoWorkers = workers.length;\r\n    cryptoMessagePort.addEventListener('port', (payload, source, event) => {\r\n      this.invokeVoid('cryptoPort', undefined, undefined, [event.ports[0]]);\r\n      // .then((attached) => {\r\n      //   if(!attached && cryptoWorkers-- > 1) {\r\n      //     this.log.error('terminating unneeded crypto worker');\r\n\r\n      //     cryptoMessagePort.invokeVoid('terminate', undefined, source);\r\n      //     const worker = workers.find((worker) => (worker as SharedWorker).port === source || (worker as any) === source);\r\n      //     if((worker as SharedWorker).port) (worker as SharedWorker).port.close();\r\n      //     else (worker as Worker).terminate();\r\n      //     cryptoMessagePort.detachPort(source);\r\n      //   }\r\n      // });\r\n    });\r\n\r\n    const firstWorker = createWorker(originalUrl);\r\n    attachWorkerToPort(firstWorker);\r\n\r\n    const blob = await get(originalUrl);\r\n    const urlsPromise = await this.invoke('createProxyWorkerURLs', {originalUrl, blob});\r\n    const workers = urlsPromise.slice(1).map(createWorker);\r\n    workers.forEach(attachWorkerToPort);\r\n  }\r\n\r\n  private registerWorker() {\r\n    if(import.meta.env.VITE_MTPROTO_SW) {\r\n      return;\r\n    }\r\n\r\n    let worker: SharedWorker | Worker;\r\n    if(IS_SHARED_WORKER_SUPPORTED) {\r\n      worker = new SharedWorker(\r\n        new URL('./mtproto.worker.ts', import.meta.url),\r\n        {type: 'module'}\r\n      );\r\n    } else {\r\n      worker = new Worker(\r\n        new URL('./mtproto.worker.ts', import.meta.url),\r\n        {type: 'module'}\r\n      );\r\n    }\r\n\r\n    this.onWorkerFirstMessage(worker);\r\n  }\r\n\r\n  private attachWorkerToPort(worker: SharedWorker | Worker, messagePort: SuperMessagePort<any, any, any>, type: string) {\r\n    const port: MessagePort = (worker as SharedWorker).port || worker as any;\r\n    messagePort.attachPort(port);\r\n\r\n    worker.addEventListener('error', (err) => {\r\n      this.log.error(type, 'worker error', err);\r\n    });\r\n  }\r\n\r\n  private onWorkerFirstMessage(worker: any) {\r\n    this.log('set webWorker');\r\n\r\n    // this.worker = worker;\r\n    if(import.meta.env.VITE_MTPROTO_SW) {\r\n      this.attachSendPort(worker);\r\n    } else {\r\n      this.attachWorkerToPort(worker, this, 'mtproto');\r\n    }\r\n  }\r\n\r\n  private loadState() {\r\n    return Promise.all([\r\n      loadState().then((stateResult) => {\r\n        this.newVersion = stateResult.newVersion;\r\n        this.oldVersion = stateResult.oldVersion;\r\n        this.mirrors['state'] = stateResult.state;\r\n        setAppStateSilent(stateResult.state);\r\n        return stateResult;\r\n      })\r\n      // loadStorages(createStorages()),\r\n    ]);\r\n  }\r\n\r\n  public sendState() {\r\n    return this.loadState().then((result) => {\r\n      const [stateResult] = result;\r\n      this.invoke('state', {...stateResult, userId: rootScope.myId.toUserId()});\r\n      return result;\r\n    });\r\n  }\r\n\r\n  public invokeCrypto<Method extends keyof CryptoMethods>(method: Method, ...args: Parameters<CryptoMethods[typeof method]>): Promise<Awaited<ReturnType<CryptoMethods[typeof method]>>> {\r\n    if(!import.meta.env.VITE_MTPROTO_WORKER) {\r\n      return;\r\n    }\r\n\r\n    return cryptoMessagePort.invokeCrypto(method, ...args);\r\n  }\r\n\r\n  public async toggleStorages(enabled: boolean, clearWrite: boolean) {\r\n    await toggleStorages(enabled, clearWrite);\r\n    this.invoke('toggleStorages', {enabled, clearWrite});\r\n    this.serviceMessagePort?.invokeVoid('toggleStorages', {enabled, clearWrite});\r\n  }\r\n\r\n  public async getMirror<T extends keyof Mirrors>(name: T) {\r\n    const mirror = this.mirrors[name];\r\n    return mirror;\r\n  }\r\n\r\n  public getState() {\r\n    return this.getMirror('state');\r\n  }\r\n\r\n  public getCacheContext(\r\n    media: ThumbStorageMedia,\r\n    thumbSize: string = THUMB_TYPE_FULL,\r\n    key = getThumbKey(media)\r\n  ) {\r\n    const cache = this.mirrors.thumbs[key];\r\n    return cache?.[thumbSize] || generateEmptyThumb(thumbSize);\r\n  }\r\n\r\n  public getStickerCachedThumb(docId: DocId, toneIndex: string | number) {\r\n    const key = getStickerThumbKey(docId, toneIndex);\r\n    return this.mirrors.stickerThumbs[key];\r\n  }\r\n\r\n  public getAvailableReactions() {\r\n    return this.mirrors.availableReactions ||= rootScope.managers.appReactionsManager.getAvailableReactions();\r\n  }\r\n\r\n  public getReaction(reaction: string) {\r\n    return callbackify(this.getAvailableReactions(), (availableReactions) => {\r\n      return availableReactions.find((availableReaction) => availableReaction.reaction === reaction);\r\n    });\r\n  }\r\n\r\n  public getMessageFromStorage(key: MessagesStorageKey, mid: number) {\r\n    // * use global storage instead\r\n    if(key.endsWith('history') && isLegacyMessageId(mid)) {\r\n      key = this.getGlobalHistoryMessagesStorage();\r\n    }\r\n\r\n    const cache = this.mirrors.messages[key];\r\n    return cache?.[mid];\r\n  }\r\n\r\n  public getGroupsFirstMessage(message: Message.message) {\r\n    if(!message?.grouped_id) return message;\r\n\r\n    const storage = this.mirrors.groupedMessages[message.grouped_id];\r\n    let minMid = Number.MAX_SAFE_INTEGER;\r\n    for(const [mid, message] of storage) {\r\n      if(message.mid < minMid) {\r\n        minMid = message.mid;\r\n      }\r\n    }\r\n\r\n    return storage.get(minMid);\r\n  }\r\n\r\n  public getMidsByGroupedId(groupedId: string, sort: 'asc' | 'desc' = 'asc') {\r\n    return getObjectKeysAndSort(this.mirrors.groupedMessages[groupedId], sort);\r\n  }\r\n\r\n  public getMessagesByGroupedId(groupedId: string) {\r\n    const mids = this.getMidsByGroupedId(groupedId, 'asc');\r\n    const storage = this.mirrors.groupedMessages[groupedId];\r\n    // return mids.map((mid) => this.getMessageFromStorage(storage, mid) as Message.message);\r\n    return mids.map((mid) => storage.get(mid) as Message.message);\r\n  }\r\n\r\n  public getHistoryMessagesStorage(peerId: PeerId): MessagesStorageKey {\r\n    return `${peerId}_history`;\r\n  }\r\n\r\n  public getGlobalHistoryMessagesStorage(): MessagesStorageKey {\r\n    return this.getHistoryMessagesStorage(NULL_PEER_ID);\r\n  }\r\n\r\n  public getMessageById(messageId: number) {\r\n    if(isLegacyMessageId(messageId)) {\r\n      return this.getMessageFromStorage(this.getGlobalHistoryMessagesStorage(), messageId);\r\n    }\r\n  }\r\n\r\n  public getMessageByPeer(peerId: PeerId, messageId: number) {\r\n    if(!peerId) {\r\n      return this.getMessageById(messageId);\r\n    }\r\n\r\n    return this.getMessageFromStorage(this.getHistoryMessagesStorage(peerId), messageId);\r\n  }\r\n\r\n  public getPeer(peerId: PeerId) {\r\n    return this.mirrors.peers[peerId];\r\n  }\r\n\r\n  public getUser(userId: UserId) {\r\n    return this.mirrors.peers[userId.toPeerId(false)] as User.user;\r\n  }\r\n\r\n  public getChat(chatId: ChatId) {\r\n    return this.mirrors.peers[chatId.toPeerId(true)] as Exclude<Chat, Chat.chatEmpty>;\r\n  }\r\n\r\n  public isForum(peerId: PeerId) {\r\n    const peer = this.getPeer(peerId);\r\n    return !!(peer as Chat.channel)?.pFlags?.forum;\r\n  }\r\n\r\n  public isAvatarCached(peerId: PeerId, size?: PeerPhotoSize) {\r\n    const saved = this.mirrors.avatars[peerId];\r\n    if(size === undefined) {\r\n      return !!saved;\r\n    }\r\n\r\n    return !!(saved && saved[size] && !(saved[size] instanceof Promise));\r\n  }\r\n\r\n  public loadAvatar(peerId: PeerId, photo: UserProfilePhoto.userProfilePhoto | ChatPhoto.chatPhoto, size: PeerPhotoSize) {\r\n    const saved = this.mirrors.avatars[peerId] ??= {};\r\n    return saved[size] ??= rootScope.managers.appAvatarsManager.loadAvatar(peerId, photo, size);\r\n  }\r\n\r\n  public getAppConfig(overwrite?: boolean) {\r\n    if(overwrite) {\r\n      this.appConfig = undefined;\r\n    }\r\n\r\n    if(!this.appConfig) {\r\n      const promise = rootScope.managers.apiManager.getAppConfig().then((appConfig) => {\r\n        if(this.appConfig === promise) {\r\n          this.appConfig = appConfig;\r\n        }\r\n\r\n        return appConfig;\r\n      });\r\n\r\n      return this.appConfig = promise;\r\n    }\r\n\r\n    return this.appConfig;\r\n  }\r\n\r\n  public isPremiumFeaturesHidden(): MaybePromise<boolean> {\r\n    return callbackify(this.isPremiumPurchaseBlocked(), (isPremiumPurchaseBlocked) => {\r\n      return isPremiumPurchaseBlocked && !rootScope.premium;\r\n    });\r\n  }\r\n\r\n  public isPremiumPurchaseBlocked(): MaybePromise<boolean> {\r\n    return callbackify(this.getAppConfig(), (appConfig) => {\r\n      return !!appConfig.premium_purchase_blocked;\r\n    });\r\n  }\r\n\r\n  public updateTabState<T extends keyof TabState>(key: T, value: TabState[T]) {\r\n    this.tabState[key] = value;\r\n    this.invokeVoid('tabState', this.tabState);\r\n  }\r\n\r\n  public updateTabStateIdle(idle: boolean) {\r\n    this.updateTabState('idleStartTime', idle ? Date.now() : 0);\r\n  }\r\n\r\n  private onMirrorTask = (payload: MirrorTaskPayload) => {\r\n    const {name, key, value} = payload;\r\n    this.processMirrorTaskMap[name]?.(payload);\r\n    if(!payload.hasOwnProperty('key')) {\r\n      this.mirrors[name] = value;\r\n      return;\r\n    }\r\n\r\n    const mirror = this.mirrors[name] ??= {} as any;\r\n    setDeepProperty(mirror, key, value, true);\r\n  };\r\n}\r\n\r\ninterface ApiManagerProxy extends MTProtoMessagePort<true> {}\r\n\r\nconst apiManagerProxy = new ApiManagerProxy();\r\nMOUNT_CLASS_TO.apiManagerProxy = apiManagerProxy;\r\nexport default apiManagerProxy;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type createManagers from './createManagers';\r\nimport type {AckedResult} from '../mtproto/superMessagePort';\r\nimport {ModifyFunctionsToAsync} from '../../types';\r\nimport apiManagerProxy from '../mtproto/mtprotoworker';\r\nimport DEBUG from '../../config/debug';\r\nimport dT from '../../helpers/dT';\r\nimport noop from '../../helpers/noop';\r\nimport copy from '../../helpers/object/copy';\r\n\r\n// let stats: {\r\n//   [manager: string]: {\r\n//     [method: string]: {\r\n//       times: number[],\r\n//       byArgs: {\r\n//         [args: string]: number[]\r\n//       }\r\n//     }\r\n//   }\r\n// } = {};\r\n\r\n// let sentCount = 0;\r\n// let sentMethods: {[key: string]: number} = {};\r\n// let sentMethods2: {[key: string]: number} = {};\r\n// function collectStats(manager: string, method: string, args: any[], promise: Promise<any>) {\r\n//   ++sentCount;\r\n\r\n//   const key = [manager, method].join('-');\r\n//   if(!sentMethods[key]) sentMethods[key] = 0;\r\n//   ++sentMethods[key];\r\n\r\n//   const key2 = [('00000' + sentCount).slice(-5), key].join('-');\r\n\r\n//   const byManager = stats[manager] ??= {};\r\n//   const byMethod = byManager[method] ??= {times: [], byArgs: {}};\r\n\r\n//   const perf = performance.now();\r\n//   promise.catch(noop).finally(() => {\r\n//     const time = performance.now() - perf;\r\n//     byMethod.times.push(time);\r\n\r\n//     sentMethods2[key2] = time;\r\n\r\n//     try {\r\n//       const argsString = JSON.stringify(args);\r\n//       byMethod.byArgs[argsString].push(time);\r\n//     } catch(err) {}\r\n//   });\r\n// }\r\n\r\n// setInterval(() => {\r\n//   console.log(\r\n//     dT(),\r\n//     '[PROXY] stats',\r\n//     ...[\r\n//       stats,\r\n//       sentCount,\r\n//       sentMethods,\r\n//       sentMethods2\r\n//     ].map(copy),\r\n//     Object.entries(sentMethods).sort((a, b) => b[1] - a[1])\r\n//   );\r\n//   sentCount = 0;\r\n//   stats = {};\r\n//   sentMethods = {};\r\n//   sentMethods2 = {};\r\n// }, 2000);\r\n\r\nconst DEBUG_MANAGER_REQUESTS: {[managerName: string]: Set<string>} = {\r\n  // appProfileManager: new Set(['getProfile', 'getProfileByPeerId'])\r\n  // appPeersManager: new Set(['getPeer'])\r\n  // appChatsManager: new Set(['getChat'])\r\n  // appMessagesManager: new Set(['getMessageByPeer', 'getGroupsFirstMessage'])\r\n};\r\n\r\nfunction createProxy(/* source: T,  */name: string, ack?: boolean) {\r\n  const proxy = new Proxy({}, {\r\n    get: (target, p, receiver) => {\r\n      // console.log('get', target, p, receiver);\r\n      // @ts-ignore\r\n      // const value = source[p];\r\n      // if(typeof(value) !== 'function') {\r\n      //   return value;\r\n      // }\r\n\r\n      return (...args: any[]) => {\r\n        const promise = apiManagerProxy.invoke('manager', {\r\n          name,\r\n          method: p as string,\r\n          args\r\n        }, ack as any);\r\n\r\n        if(DEBUG) {\r\n          if(DEBUG_MANAGER_REQUESTS[name]?.has(p as any)) {\r\n            console.warn('manager request', name, p, args, ack);\r\n          }\r\n        }\r\n\r\n        // collectStats(name, p as string, args, promise);\r\n\r\n        return promise;\r\n\r\n        // @ts-ignore\r\n        // return Promise.resolve(value.call(source, ...args));\r\n      };\r\n    }\r\n  });\r\n\r\n  return proxy;\r\n}\r\n\r\ntype AA<T> = {\r\n  [key in keyof T]: T[key] extends (...args: infer A) => infer R ? (...args: A) => Promise<AckedResult<Awaited<R>>> : never\r\n};\r\n\r\ntype T = Awaited<ReturnType<typeof createManagers>>;\r\ntype ProxiedManagers = {\r\n  [name in keyof T]?: ModifyFunctionsToAsync<T[name]>;\r\n} & {\r\n  acknowledged?: {\r\n    [name in keyof T]?: AA<T[name]>;\r\n  }\r\n};\r\n\r\nfunction createProxyProxy(proxied: any, ack?: boolean) {\r\n  return new Proxy(proxied, {\r\n    get: (target, p, receiver) => {\r\n      // @ts-ignore\r\n      return target[p] ??= createProxy(p as string, ack);\r\n    }\r\n  });\r\n}\r\n\r\nlet proxied: ProxiedManagers;\r\nexport default function getProxiedManagers() {\r\n  if(proxied) {\r\n    return proxied;\r\n  }\r\n\r\n  proxied = createProxyProxy({}, false);\r\n  proxied.acknowledged = createProxyProxy({}, true);\r\n  return proxied;\r\n}\r\n","export default function clamp(v: number, min: number, max: number): number {\r\n  return Math.min(max, Math.max(min, v));\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {WallPaper} from '../layer';\r\nimport clamp from './number/clamp';\r\n\r\nexport type ColorHsla = {\r\n  h: number,\r\n  s: number,\r\n  l: number,\r\n  a: number\r\n};\r\n\r\nexport type ColorRgba = [number, number, number, number];\r\nexport type ColorRgb = [number, number, number];\r\n\r\n/**\r\n * https://stackoverflow.com/a/54070620/6758968\r\n * r, g, b in [0, 255]\r\n * @returns h in [0,360) and s, v in [0,1]\r\n */\r\nexport function rgbToHsv(r: number, g: number, b: number): [number, number, number] {\r\n  r /= 255, g /= 255, b /= 255;\r\n  const v = Math.max(r, g, b),\r\n    c = v - Math.min(r, g, b);\r\n  const h = c && ((v === r) ? (g - b ) / c : ((v == g) ? 2 + (b - r) / c : 4 + (r - g) / c));\r\n  return [60 * (h < 0 ? h + 6 : h), v && c / v, v];\r\n}\r\n\r\n/**\r\n * https://stackoverflow.com/a/54024653/6758968\r\n * @param h [0, 360]\r\n * @param s [0, 1]\r\n * @param v [0, 1]\r\n * @returns r, g, b in [0, 255]\r\n */\r\nexport function hsvToRgb(h: number, s: number, v: number): ColorRgb {\r\n  const f = (n: number, k: number = (n + h / 60) % 6) => Math.round((v - v * s * Math.max(Math.min(k, 4 - k, 1), 0)) * 255);\r\n  return [f(5), f(3), f(1)];\r\n}\r\n\r\n/**\r\n * @returns h [0, 360], s [0, 100], l [0, 100], a [0, 1]\r\n */\r\nexport function rgbaToHsla(r: number, g: number, b: number, a: number = 1): ColorHsla {\r\n  r /= 255, g /= 255, b /= 255;\r\n  const max = Math.max(r, g, b),\r\n    min = Math.min(r, g, b);\r\n  let h: number, s: number;\r\n  const l = (max + min) / 2;\r\n\r\n  if(max === min) {\r\n    h = s = 0; // achromatic\r\n  } else {\r\n    const d = max - min;\r\n    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);\r\n    switch(max) {\r\n      case r:\r\n        h = (g - b) / d + (g < b ? 6 : 0);\r\n        break;\r\n      case g:\r\n        h = (b - r) / d + 2;\r\n        break;\r\n      case b:\r\n        h = (r - g) / d + 4;\r\n        break;\r\n    }\r\n    h /= 6;\r\n  }\r\n\r\n  return {\r\n    h: h * 360,\r\n    s: s * 100,\r\n    l: l * 100,\r\n    a\r\n  };\r\n}\r\n\r\nexport function hslaToString(hsla: ColorHsla) {\r\n  return `hsla(${hsla.h}, ${hsla.s}%, ${hsla.l}%, ${hsla.a})`;\r\n}\r\n\r\n// * https://stackoverflow.com/a/9493060/6758968\r\n/**\r\n * Converts an HSL color value to RGB. Conversion formula\r\n * adapted from http://en.wikipedia.org/wiki/HSL_color_space.\r\n *\r\n * @param   {number}  h       The hue [0, 360]\r\n * @param   {number}  s       The saturation [0, 1]\r\n * @param   {number}  l       The lightness [0, 1]\r\n * @return  {Array}           The RGB representation [0, 255]\r\n */\r\nexport function hslaToRgba(h: number, s: number, l: number, a: number): ColorRgba {\r\n  h /= 360, s /= 100, l /= 100;\r\n  let r: number, g: number, b: number;\r\n\r\n  if(s === 0) {\r\n    r = g = b = l; // achromatic\r\n  } else {\r\n    const hue2rgb = function hue2rgb(p: number, q: number, t: number) {\r\n      if(t < 0) t += 1;\r\n      if(t > 1) t -= 1;\r\n      if(t < 1/6) return p + (q - p) * 6 * t;\r\n      if(t < 1/2) return q;\r\n      if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;\r\n      return p;\r\n    }\r\n\r\n    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;\r\n    const p = 2 * l - q;\r\n    r = hue2rgb(p, q, h + 1/3);\r\n    g = hue2rgb(p, q, h);\r\n    b = hue2rgb(p, q, h - 1/3);\r\n  }\r\n\r\n  return [r, g, b, a].map((v) => Math.round(v * 255)) as ColorRgba;\r\n}\r\n\r\nexport function hslaStringToRgba(hsla: string) {\r\n  const splitted = hsla.slice(5, -1).split(', ');\r\n  const alpha = +splitted.pop();\r\n  const arr = splitted.map((val) => {\r\n    if(val.endsWith('%')) {\r\n      return +val.slice(0, -1);\r\n    }\r\n\r\n    return +val;\r\n  });\r\n\r\n  return hslaToRgba(arr[0], arr[1], arr[2], alpha);\r\n}\r\n\r\nexport function hexaToRgba(hexa: string) {\r\n  const arr: ColorRgba = [] as any;\r\n  const offset = hexa[0] === '#' ? 1 : 0;\r\n  if(hexa.length === (5 + offset)) {\r\n    hexa = (offset ? '#' : '') + '0' + hexa.slice(offset);\r\n  }\r\n\r\n  if(hexa.length === (3 + offset)) {\r\n    for(let i = offset; i < hexa.length; ++i) {\r\n      arr.push(parseInt(hexa[i] + hexa[i], 16));\r\n    }\r\n  } else if(hexa.length === (4 + offset)) {\r\n    for(let i = offset; i < (hexa.length - 1); ++i) {\r\n      arr.push(parseInt(hexa[i] + hexa[i], 16));\r\n    }\r\n\r\n    arr.push(parseInt(hexa[hexa.length - 1], 16));\r\n  } else {\r\n    for(let i = offset; i < hexa.length; i += 2) {\r\n      arr.push(parseInt(hexa.slice(i, i + 2), 16));\r\n    }\r\n  }\r\n\r\n  return arr;\r\n}\r\n\r\nexport function hexToRgb(hex: string) {\r\n  return hexaToRgba(hex.slice(0, 7)) as any as ColorRgb;\r\n}\r\n\r\nexport function hexaToHsla(hexa: string) {\r\n  const rgba = hexaToRgba(hexa);\r\n  return rgbaToHsla(rgba[0], rgba[1], rgba[2], rgba[3]);\r\n}\r\n\r\nexport function rgbaToHexa(rgba: ColorRgba | ColorRgb) {\r\n  return '#' + rgba.map((v) => ('0' + v.toString(16)).slice(-2)).join('');\r\n}\r\n\r\nexport function hslaStringToHexa(hsla: string) {\r\n  return rgbaToHexa(hslaStringToRgba(hsla));\r\n}\r\n\r\nexport function hslaStringToHex(hsla: string) {\r\n  return hslaStringToHexa(hsla).slice(0, -2);\r\n}\r\n\r\n/**\r\n * @param weight [0, 1]\r\n */\r\nexport function mixColors(color1: ColorRgb, color2: ColorRgb, weight: number) {\r\n  const out = new Array<number>(3) as ColorRgb;\r\n  for(let i = 0; i < 3; ++i) {\r\n    const v1 = color1[i], v2 = color2[i];\r\n    out[i] = Math.floor(v2 + (v1 - v2) * weight);\r\n  }\r\n\r\n  return out;\r\n}\r\n\r\nexport function computePerceivedBrightness(color: ColorRgb) {\r\n  return (color[0] * 0.2126 + color[1] * 0.7152 + color[2] * 0.0722) / 255;\r\n}\r\n\r\nexport function getAverageColor(color1: ColorRgb, color2: ColorRgb): ColorRgb {\r\n  return color1.map((v, i) => Math.round((v + color2[i]) / 2)) as ColorRgb;\r\n}\r\n\r\nexport function getAccentColor(baseHsv: number[], baseColor: ColorRgb, elementColor: ColorRgb): ColorRgb {\r\n  const hsvTemp3 = rgbToHsv(...baseColor);\r\n  const hsvTemp4 = rgbToHsv(...elementColor);\r\n\r\n  const dist = Math.min(1.5 * hsvTemp3[1] / baseHsv[1], 1);\r\n\r\n  hsvTemp3[0] = Math.min(360, hsvTemp4[0] - hsvTemp3[0] + baseHsv[0]);\r\n  hsvTemp3[1] = Math.min(1, hsvTemp4[1] * baseHsv[1] / hsvTemp3[1]);\r\n  hsvTemp3[2] = Math.min(1, (hsvTemp4[2] / hsvTemp3[2] + dist - 1) * baseHsv[2] / dist);\r\n  if(hsvTemp3[2] < 0.3) {\r\n    return elementColor;\r\n  }\r\n  return hsvToRgb(...hsvTemp3);\r\n}\r\n\r\nexport function changeColorAccent(baseHsv: number[], accentHsv: number[], color: ColorRgb, isDarkTheme: boolean) {\r\n  const colorHsv = rgbToHsv(...color);\r\n\r\n  const diffH = Math.min(Math.abs(colorHsv[0] - baseHsv[0]), Math.abs(colorHsv[0] - baseHsv[0] - 360));\r\n  if(diffH > 30) {\r\n    return color;\r\n  }\r\n\r\n  const dist = baseHsv[1] ? Math.min(1.5 * colorHsv[1] / baseHsv[1], 1) : 0;\r\n\r\n  colorHsv[0] = Math.min(360, colorHsv[0] + accentHsv[0] - baseHsv[0]);\r\n  colorHsv[1] = baseHsv[1] ? Math.min(1, colorHsv[1] * accentHsv[1] / baseHsv[1]) : 0;\r\n  colorHsv[2] = baseHsv[2] ? Math.min(1, colorHsv[2] * (1 - dist + dist * accentHsv[2] / baseHsv[2])) : 0;\r\n\r\n  let newColor = hsvToRgb(...colorHsv);\r\n\r\n  const origBrightness = computePerceivedBrightness(color);\r\n  const newBrightness = computePerceivedBrightness(newColor);\r\n\r\n  // We need to keep colors lighter in dark themes and darker in light themes\r\n  const needRevertBrightness = isDarkTheme ? origBrightness > newBrightness : origBrightness < newBrightness;\r\n\r\n  if(needRevertBrightness) {\r\n    const amountOfNew = 0.6;\r\n    const fallbackAmount = (1 - amountOfNew) * origBrightness / newBrightness + amountOfNew;\r\n    newColor = changeBrightness(newColor, fallbackAmount);\r\n  }\r\n\r\n  return newColor;\r\n}\r\n\r\nexport function changeBrightness(color: ColorRgb, amount: number) {\r\n  return color.map((v) => clamp(Math.round(v * amount), 0, 255)) as ColorRgb;\r\n}\r\n\r\nexport function getHexColorFromTelegramColor(color: number) {\r\n  const hex = (color < 0 ? 0xFFFFFF + color : color).toString(16);\r\n  return '#' + (hex.length >= 6 ? hex : '0'.repeat(6 - hex.length) + hex);\r\n}\r\n\r\nexport function getRgbColorFromTelegramColor(color: number) {\r\n  return hexToRgb(getHexColorFromTelegramColor(color));\r\n}\r\n\r\nexport function getColorsFromWallPaper(wallPaper: WallPaper) {\r\n  return wallPaper.settings ? [\r\n    wallPaper.settings.background_color,\r\n    wallPaper.settings.second_background_color,\r\n    wallPaper.settings.third_background_color,\r\n    wallPaper.settings.fourth_background_color\r\n  ].filter(Boolean).map(getHexColorFromTelegramColor).join(',') : '';\r\n}\r\n\r\nexport function rgbaToRgb(rgba: ColorRgba, bg: ColorRgb): ColorRgb {\r\n  const a = rgba[3];\r\n  return rgba.slice(0, 3).map((color, idx) => {\r\n    return clamp(Math.round((a * (color / 255) + (a * (bg[idx] / 255))) * 255), 0, 255);\r\n  }) as ColorRgb;\r\n}\r\n\r\nexport function calculateLuminance(rgb: ColorRgb) {\r\n  const [r, g, b] = rgb;\r\n  const luminance = (0.2126 * r / 255 + 0.7152 * g / 255 + 0.0722 * b / 255);\r\n  return luminance;\r\n}\r\n\r\nexport function getTextColor(luminance: number): ColorRgb {\r\n  return luminance > 0.5 ? [0, 0, 0] : [255, 255, 255];\r\n}\r\n\r\nexport function calculateOpacity(luminance: number, targetContrast: number) {\r\n  const targetTextLuminance = luminance > 0.5 ? 0 : 1;\r\n  const adaptiveOpacity = (luminance - targetTextLuminance + targetContrast) / targetContrast;\r\n  const opacity = +Math.max(0.5, Math.min(0.64, adaptiveOpacity)).toFixed(2);\r\n\r\n  return opacity;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n *\r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport {makeMediaSize} from './mediaSize';\r\n\r\nexport default function calcImageInBox(imageW: number, imageH: number, boxW: number, boxH: number, noZoom = true) {\r\n  if(imageW < boxW && imageH < boxH && noZoom) {\r\n    return makeMediaSize(imageW, imageH);\r\n  }\r\n\r\n  let boxedImageW = boxW;\r\n  let boxedImageH = boxH;\r\n\r\n  if((imageW / imageH) > (boxW / boxH)) {\r\n    boxedImageH = (imageH * boxW / imageW) | 0;\r\n  } else {\r\n    boxedImageW = (imageW * boxH / imageH) | 0;\r\n    if(boxedImageW > boxW) {\r\n      boxedImageH = (boxedImageH * boxW / boxedImageW) | 0;\r\n      boxedImageW = boxW;\r\n    }\r\n  }\r\n\r\n  if(noZoom && boxedImageW >= imageW && boxedImageH >= imageH) {\r\n    boxedImageW = imageW;\r\n    boxedImageH = imageH;\r\n  }\r\n\r\n  return makeMediaSize(boxedImageW, boxedImageH);\r\n}\r\n\r\nMOUNT_CLASS_TO.calcImageInBox = calcImageInBox;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport calcImageInBox from './calcImageInBox';\r\n\r\nexport class MediaSize {\r\n  constructor(public width = 0, public height = width) {\r\n\r\n  }\r\n\r\n  public aspect(boxSize: MediaSize, fitted: boolean) {\r\n    return calcImageInBox(this.width, this.height, boxSize.width, boxSize.height, fitted);\r\n  }\r\n\r\n  public aspectFitted(boxSize: MediaSize) {\r\n    return this.aspect(boxSize, true);\r\n  }\r\n\r\n  public aspectCovered(boxSize: MediaSize) {\r\n    return this.aspect(boxSize, false);\r\n  }\r\n}\r\n\r\nexport function makeMediaSize(width?: number, height?: number): MediaSize {\r\n  return new MediaSize(width, height);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport EventListenerBase from './eventListenerBase';\r\nimport {makeMediaSize, MediaSize} from './mediaSize';\r\n\r\ntype MediaTypeSizes = {\r\n  regular: MediaSize,\r\n  webpage: MediaSize,\r\n  album: MediaSize,\r\n  esgSticker: MediaSize,\r\n  animatedSticker: MediaSize,\r\n  staticSticker: MediaSize,\r\n  emojiSticker: MediaSize,\r\n  poll: MediaSize,\r\n  round: MediaSize,\r\n  documentName: MediaSize,\r\n  invoice: MediaSize,\r\n  extendedInvoice: MediaSize,\r\n  customEmoji: MediaSize,\r\n  esgCustomEmoji: MediaSize,\r\n  emojiStatus: MediaSize,\r\n  popupSticker: MediaSize\r\n};\r\n\r\nexport type MediaSizeType = keyof MediaTypeSizes;\r\n\r\nexport enum ScreenSize {\r\n  mobile,\r\n  medium,\r\n  large\r\n}\r\n\r\nconst MOBILE_SIZE = 600;\r\nconst MEDIUM_SIZE = 1275;\r\nconst LARGE_SIZE = 1680;\r\n\r\nconst CUSTOM_EMOJI_SIZE = makeMediaSize(20, 20);\r\nconst ESG_CUSTOM_EMOJI_SIZE = makeMediaSize(36, 36);\r\nconst EMOJI_STATUS_SIZE = makeMediaSize(18, 18);\r\n\r\nclass MediaSizes extends EventListenerBase<{\r\n  changeScreen: (from: ScreenSize, to: ScreenSize) => void,\r\n  resize: () => void\r\n}> {\r\n  private screenSizes: {key: ScreenSize, value: number}[] = [\r\n    {key: ScreenSize.mobile, value: MOBILE_SIZE},\r\n    {key: ScreenSize.medium, value: MEDIUM_SIZE},\r\n    {key: ScreenSize.large, value: LARGE_SIZE}\r\n  ];\r\n\r\n  private sizes: {[k in 'desktop' | 'handhelds']: MediaTypeSizes} = {\r\n    handhelds: {\r\n      regular: makeMediaSize(340, 340),\r\n      webpage: makeMediaSize(340, 200),\r\n      album: makeMediaSize(340, 0),\r\n      esgSticker: makeMediaSize(68, 68),\r\n      animatedSticker: makeMediaSize(180, 180),\r\n      staticSticker: makeMediaSize(180, 180),\r\n      emojiSticker: makeMediaSize(112, 112),\r\n      poll: makeMediaSize(240, 0),\r\n      round: makeMediaSize(240, 240),\r\n      documentName: makeMediaSize(200, 0),\r\n      invoice: makeMediaSize(340, 340),\r\n      extendedInvoice: makeMediaSize(340, 340),\r\n      customEmoji: CUSTOM_EMOJI_SIZE,\r\n      esgCustomEmoji: ESG_CUSTOM_EMOJI_SIZE,\r\n      emojiStatus: EMOJI_STATUS_SIZE,\r\n      popupSticker: makeMediaSize(68, 68)\r\n    },\r\n    desktop: {\r\n      regular: makeMediaSize(420, 400),\r\n      webpage: makeMediaSize(420, 380),\r\n      album: makeMediaSize(420, 0),\r\n      esgSticker: makeMediaSize(72, 72),\r\n      animatedSticker: makeMediaSize(200, 200),\r\n      staticSticker: makeMediaSize(200, 200),\r\n      emojiSticker: makeMediaSize(112, 112),\r\n      poll: makeMediaSize(330, 0),\r\n      round: makeMediaSize(280, 280),\r\n      documentName: makeMediaSize(240, 0),\r\n      invoice: makeMediaSize(320, 320),\r\n      extendedInvoice: makeMediaSize(420, 400),\r\n      customEmoji: CUSTOM_EMOJI_SIZE,\r\n      esgCustomEmoji: ESG_CUSTOM_EMOJI_SIZE,\r\n      emojiStatus: EMOJI_STATUS_SIZE,\r\n      popupSticker: makeMediaSize(80, 80)\r\n    }\r\n  };\r\n\r\n  public isMobile = false;\r\n  public active: MediaTypeSizes;\r\n  public activeScreen: ScreenSize;\r\n  private rAF: number;\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    window.addEventListener('resize', () => {\r\n      if(this.rAF) window.cancelAnimationFrame(this.rAF);\r\n      this.rAF = window.requestAnimationFrame(() => {\r\n        this.handleResize();\r\n        this.rAF = 0;\r\n      });\r\n    });\r\n    this.handleResize();\r\n  }\r\n\r\n  private handleResize = () => {\r\n    const innerWidth = window.innerWidth;\r\n    // this.isMobile = innerWidth <= 720;\r\n\r\n    let activeScreen = this.screenSizes[0].key;\r\n    for(let i = this.screenSizes.length - 1; i >= 0; --i) {\r\n      if(this.screenSizes[i].value < innerWidth) {\r\n        activeScreen = (this.screenSizes[i + 1] || this.screenSizes[i]).key;\r\n        break;\r\n      }\r\n    }\r\n\r\n    const wasScreen = this.activeScreen;\r\n    this.activeScreen = activeScreen;\r\n    this.isMobile = this.activeScreen === ScreenSize.mobile;\r\n    this.active = this.isMobile ? this.sizes.handhelds : this.sizes.desktop;\r\n\r\n    // console.time('esg');\r\n    // const computedStyle = window.getComputedStyle(document.documentElement);\r\n    // this.active.esgSticker.width = parseFloat(computedStyle.getPropertyValue('--esg-sticker-size'));\r\n    // console.timeEnd('esg');\r\n\r\n    if(wasScreen !== activeScreen) {\r\n      // console.log('changeScreen', this.activeScreen, activeScreen);\r\n\r\n      if(wasScreen !== undefined) {\r\n        this.dispatchEvent('changeScreen', wasScreen, activeScreen);\r\n      }\r\n    }\r\n\r\n    if(wasScreen !== undefined) {\r\n      this.dispatchEvent('resize');\r\n    }\r\n\r\n    /* if(this.isMobile) {\r\n      for(let i in this.active) {\r\n        // @ts-ignore\r\n        let size = this.active[i];\r\n        size.width = innerWidth\r\n      }\r\n    } */\r\n  };\r\n}\r\n\r\nconst mediaSizes = new MediaSizes();\r\nMOUNT_CLASS_TO.mediaSizes = mediaSizes;\r\nexport default mediaSizes;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../../config/debug';\r\nimport rootScope from '../../lib/rootScope';\r\nimport mediaSizes from '../mediaSizes';\r\n\r\nexport type CustomProperty = string;\r\n\r\nexport class CustomProperties {\r\n  private cache: {[k in CustomProperty]?: [string, string]};\r\n  private computedStyle: CSSStyleDeclaration;\r\n  private nightComputedStyle: CSSStyleDeclaration;\r\n  private nightElement: HTMLElement;\r\n\r\n  constructor() {\r\n    this.cache = {};\r\n\r\n    this.nightElement = document.createElement('div');\r\n    this.nightElement.className = 'night';\r\n    this.nightElement.style.display = 'none';\r\n    document.body.append(this.nightElement);\r\n\r\n    rootScope.addEventListener('theme_changed', this.resetCache);\r\n    mediaSizes.addEventListener('resize', this.resetCache);\r\n  }\r\n\r\n  protected resetCache = () => {\r\n    this.computedStyle = undefined;\r\n    const cache = this.cache;\r\n    this.cache = {};\r\n\r\n    for(const i in cache) {\r\n      this.getProperty(i as CustomProperty);\r\n    }\r\n  };\r\n\r\n  public getProperty(name: CustomProperty, night?: boolean) {\r\n    const values = this.cache[name];\r\n    const index = night ? 1 : 0;\r\n    if(values?.[index]) {\r\n      return values[index];\r\n    }\r\n\r\n    this.computedStyle ??= window.getComputedStyle(document.documentElement);\r\n    this.nightComputedStyle ??= window.getComputedStyle(this.nightElement)\r\n\r\n    const value = (night ? this.nightComputedStyle : this.computedStyle).getPropertyValue('--' + name).trim();\r\n    return this.setPropertyCache(name, value, night);\r\n  }\r\n\r\n  public getPropertyAsColor(name: CustomProperty) {\r\n    const value = this.getProperty(name);\r\n    if(value[0] === '#') {\r\n      return value;\r\n    }\r\n\r\n    return `rgb(${value})`;\r\n  }\r\n\r\n  public getPropertyAsSize(name: CustomProperty) {\r\n    const value = this.getProperty(name);\r\n    let size: number;\r\n\r\n    if(value[value.length - 1] === '%') {\r\n\r\n    } else if(value.indexOf('rem')) {\r\n      size = +value.replace('rem', '') * 16;\r\n    } else {\r\n      size = +value.replace('px', '');\r\n    }\r\n\r\n    return size;\r\n  }\r\n\r\n  public setPropertyCache(name: CustomProperty, value: string, night?: boolean) {\r\n    return (this.cache[name] ??= [] as any)[night ? 1 : 0] = value;\r\n  }\r\n}\r\n\r\nconst customProperties = new CustomProperties();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.customProperties = customProperties);\r\nexport default customProperties;\r\n","import {createSignal, Setter} from 'solid-js';\r\n\r\n/**\r\n * do not use getter in JSX\r\n */\r\nexport default function createUnifiedSignal<T = any>(...args: Partial<Parameters<typeof createSignal<T>>>) {\r\n  const [getter, setter] = createSignal<T>(...args);\r\n  return <A extends Parameters<Setter<T>>>(...args: Partial<A>) => {\r\n    // @ts-ignore\r\n    if(args.length === 0) {\r\n      return getter();\r\n    }\r\n\r\n    // @ts-ignore\r\n    return setter(...args);\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport {IS_WORKER} from './context';\r\nimport createUnifiedSignal from './solid/createUnifiedSignal';\r\n\r\nexport class WindowSize {\r\n  private _width: ReturnType<typeof createUnifiedSignal<number>>;\r\n  private _height: ReturnType<typeof createUnifiedSignal<number>>;\r\n  // private rAF: number;\r\n  private viewport: VisualViewport | Window;\r\n\r\n  constructor() {\r\n    if(IS_WORKER) {\r\n      return;\r\n    }\r\n\r\n    this._width = createUnifiedSignal();\r\n    this._height = createUnifiedSignal();\r\n\r\n    this.viewport = /* 'visualViewport' in window ? window.visualViewport :  */window;\r\n    const set = () => {\r\n      this.setDimensions();\r\n\r\n      // if(this.width === undefined) {\r\n      //   this.setDimensions();\r\n      //   return;\r\n      // }\r\n\r\n      // if(this.rAF) window.cancelAnimationFrame(this.rAF);\r\n      // this.rAF = window.requestAnimationFrame(() => {\r\n      //   this.rAF = 0;\r\n\r\n      //   batch(() => {\r\n      //     this.setDimensions();\r\n      //   });\r\n      // });\r\n    };\r\n    this.viewport.addEventListener('resize', set);\r\n    set();\r\n  }\r\n\r\n  private setDimensions() {\r\n    const w = this.viewport;\r\n    this._width((w as VisualViewport).width || (w as Window).innerWidth);\r\n    this._height((w as VisualViewport).height || (w as Window).innerHeight);\r\n  }\r\n\r\n  public get width() {\r\n    return this._width();\r\n  }\r\n\r\n  public get height() {\r\n    return this._height();\r\n  }\r\n}\r\n\r\nconst windowSize = new WindowSize();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.windowSize = windowSize);\r\nexport default windowSize;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport rootScope from '../lib/rootScope';\r\n\r\nexport type LiteModeKey = 'all' | 'gif' | 'video' |\r\n  'emoji' | 'emoji_panel' | 'emoji_messages' |\r\n  'effects' | 'effects_reactions' | 'effects_premiumstickers' | 'effects_emoji' |\r\n  'stickers' | 'stickers_panel' | 'stickers_chat' |\r\n  'chat' | 'chat_background' | 'chat_spoilers' | 'animations';\r\n\r\nexport class LiteMode {\r\n  public isEnabled() {\r\n    return !!(rootScope.settings && rootScope.settings.liteMode.all);\r\n  }\r\n\r\n  public isAvailable(key: LiteModeKey) {\r\n    return !!(rootScope.settings && !rootScope.settings.liteMode.all && !rootScope.settings.liteMode[key]);\r\n  }\r\n}\r\n\r\nconst liteMode = new LiteMode();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.liteMode = liteMode);\r\nexport default liteMode;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type {AppTheme} from '../config/state';\r\nimport type {Theme} from '../layer';\r\nimport type AppBackgroundTab from '../components/sidebarLeft/tabs/background';\r\nimport IS_TOUCH_SUPPORTED from '../environment/touchSupport';\r\nimport rootScope from '../lib/rootScope';\r\nimport {changeColorAccent, ColorRgb, getAccentColor, getAverageColor, getHexColorFromTelegramColor, getRgbColorFromTelegramColor, hexToRgb, hslaStringToHex, hslaStringToRgba, hslaToRgba, hsvToRgb, mixColors, rgbaToHexa, rgbaToHsla, rgbToHsv} from './color';\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport customProperties from './dom/customProperties';\r\nimport {TelegramWebViewTheme} from '../types';\r\nimport {joinDeepPath} from './object/setDeepProperty';\r\nimport windowSize from './windowSize';\r\nimport liteMode from './liteMode';\r\n\r\nexport type AppColorName = 'primary-color' | 'message-out-primary-color' |\r\n  'surface-color' | 'danger-color' | 'primary-text-color' |\r\n  'secondary-text-color' | 'message-out-background-color' |\r\n  'saved-color' | 'message-background-color' | 'green-color';\r\ntype AppColor = {\r\n  rgb?: boolean,\r\n  light?: boolean,\r\n  lightFilled?: boolean,\r\n  dark?: boolean,\r\n  darkRgb?: boolean,\r\n  darkFilled?: boolean\r\n};\r\n\r\nconst appColorMap: {[name in AppColorName]: AppColor} = {\r\n  // 'background-color': {},\r\n  'primary-color': {\r\n    rgb: true,\r\n    light: true,\r\n    lightFilled: true,\r\n    dark: true,\r\n    darkRgb: true\r\n  },\r\n  'message-out-primary-color': {\r\n    lightFilled: true,\r\n    rgb: true\r\n  },\r\n  'surface-color': {\r\n    rgb: true\r\n  },\r\n  'danger-color': {\r\n    rgb: true,\r\n    light: true,\r\n    dark: true\r\n  },\r\n  'primary-text-color': {\r\n    rgb: true\r\n  },\r\n  'secondary-text-color': {\r\n    light: true,\r\n    lightFilled: true,\r\n    rgb: true\r\n  },\r\n  'message-background-color': {\r\n    light: true,\r\n    lightFilled: true,\r\n    dark: true,\r\n    darkFilled: true\r\n  },\r\n  'message-out-background-color': {\r\n    light: true,\r\n    lightFilled: true,\r\n    dark: true,\r\n    darkFilled: true,\r\n    rgb: true\r\n  },\r\n  'saved-color': {\r\n    lightFilled: true\r\n  },\r\n  'green-color': {}\r\n};\r\n\r\nconst colorMap: {\r\n  [name in AppTheme['name']]?: {\r\n    [name in AppColorName]?: string\r\n  }\r\n} = {\r\n  day: {\r\n    // 'background-color': '#f4f4f5',\r\n    'primary-color': '#3390ec',\r\n    'message-out-primary-color': '#5CA853',\r\n    'message-background-color': '#ffffff',\r\n    'surface-color': '#ffffff',\r\n    'danger-color': '#df3f40',\r\n    'primary-text-color': '#000000',\r\n    'secondary-text-color': '#707579',\r\n    'saved-color': '#359AD4',\r\n    'green-color': '#70b768'\r\n  },\r\n  night: {\r\n    // 'background-color': '#181818',\r\n    'primary-color': '#8774E1',\r\n    'message-out-primary-color': '#8774E1',\r\n    'message-background-color': '#212121',\r\n    'surface-color': '#212121',\r\n    'danger-color': '#ff595a',\r\n    'primary-text-color': '#ffffff',\r\n    'secondary-text-color': '#aaaaaa',\r\n    'saved-color': '#8774E1',\r\n    'green-color': '#5CC85E'\r\n  }\r\n};\r\n\r\nexport class ThemeController {\r\n  private themeColor: string;\r\n  private _themeColorElem: Element;\r\n  private systemTheme: AppTheme['name'];\r\n  private styleElement: HTMLStyleElement;\r\n  public AppBackgroundTab: typeof AppBackgroundTab;\r\n  private applied: boolean;\r\n\r\n  constructor() {\r\n    rootScope.addEventListener('theme_change', (coordinates) => {\r\n      this.setTheme(typeof(coordinates) === 'object' ? coordinates : undefined);\r\n    });\r\n\r\n    rootScope.addEventListener('theme_changed', () => {\r\n      this.setWorkerThemeParams();\r\n    });\r\n\r\n    // rootScope.addEventListener('settings_updated', ())\r\n  }\r\n\r\n  private setWorkerThemeParams() {\r\n    rootScope.managers.apiManager.setThemeParams({\r\n      _: 'dataJSON',\r\n      data: JSON.stringify(this.getThemeParamsForWebView())\r\n    });\r\n  }\r\n\r\n  private get themeColorElem() {\r\n    if(this._themeColorElem !== undefined) {\r\n      return this._themeColorElem;\r\n    }\r\n\r\n    return this._themeColorElem = document.head.querySelector('[name=\"theme-color\"]') as Element || null;\r\n  }\r\n\r\n  public setThemeColor(color = this.themeColor) {\r\n    if(!color) {\r\n      color = this.isNight() ? '#212121' : '#ffffff';\r\n    }\r\n\r\n    const themeColorElem = this.themeColorElem;\r\n    if(themeColorElem) {\r\n      themeColorElem.setAttribute('content', color);\r\n    }\r\n  }\r\n\r\n  public setThemeListener() {\r\n    try {\r\n      const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');\r\n      const checkDarkMode = () => {\r\n        // const theme = this.getTheme();\r\n        this.systemTheme = darkModeMediaQuery.matches ? 'night' : 'day';\r\n        // const newTheme = this.getTheme();\r\n\r\n        if(rootScope.myId) {\r\n          rootScope.dispatchEvent('theme_change');\r\n        } else {\r\n          this.setTheme();\r\n        }\r\n      };\r\n\r\n      if('addEventListener' in darkModeMediaQuery) {\r\n        darkModeMediaQuery.addEventListener('change', checkDarkMode);\r\n      } else if('addListener' in darkModeMediaQuery) {\r\n        (darkModeMediaQuery as any).addListener(checkDarkMode);\r\n      }\r\n\r\n      checkDarkMode();\r\n    } catch(err) {\r\n\r\n    }\r\n  }\r\n\r\n  public applyHighlightingColor({\r\n    hsla,\r\n    element = document.documentElement\r\n  }: {\r\n    hsla?: string,\r\n    element?: HTMLElement\r\n  } = {}) {\r\n    if(!hsla) {\r\n      hsla = 'hsla(85.5319, 36.9171%, 40.402%, .4)';\r\n      const theme = this.getTheme();\r\n      if(theme.settings?.highlightingColor) {\r\n        hsla = theme.settings.highlightingColor;\r\n      }\r\n    }\r\n\r\n    const highlightingRgba = hslaStringToRgba(hsla);\r\n    element.style.setProperty('--message-highlighting-color', hsla);\r\n    element.style.setProperty('--message-highlighting-color-rgb', highlightingRgba.slice(0, 3).join(','));\r\n    element.style.setProperty('--message-highlighting-alpha', '' + highlightingRgba[3] / 255);\r\n\r\n    if(!IS_TOUCH_SUPPORTED && hsla) {\r\n      this.themeColor = hslaStringToHex(hsla);\r\n    }\r\n  }\r\n\r\n  public _setTheme(silent?: boolean) {\r\n    const isNight = this.isNight();\r\n    const colorScheme = document.head.querySelector('[name=\"color-scheme\"]');\r\n    colorScheme?.setAttribute('content', isNight ? 'dark' : 'light');\r\n\r\n    document.documentElement.classList.toggle('night', isNight);\r\n    this.setThemeColor();\r\n    const theme = this.getTheme();\r\n    this.applyTheme(theme);\r\n\r\n    let style = this.styleElement;\r\n    if(!style) {\r\n      style = this.styleElement = document.createElement('style');\r\n      document.head.append(style);\r\n    }\r\n\r\n    const e = document.createElement('div');\r\n    this.applyTheme(rootScope.settings.themes.find((theme) => theme.name === 'night'), e, true);\r\n    style.textContent = `.night {${e.style.cssText}}`;\r\n\r\n    this.applyHighlightingColor();\r\n    !silent && rootScope.dispatchEventSingle('theme_changed');\r\n  }\r\n\r\n  public setTheme(coordinates?: {x: number, y: number}) {\r\n    if(!('startViewTransition' in document) || !this.applied) {\r\n      const silent = !this.applied;\r\n      const wasApplied = this.applied;\r\n      this.applied = true;\r\n\r\n      this._setTheme(silent);\r\n      if(!wasApplied) {\r\n        this.setWorkerThemeParams();\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(!liteMode.isAvailable('animations')) {\r\n      coordinates = undefined;\r\n    }\r\n\r\n    const reverse = !this.isNight();\r\n    if(coordinates) {\r\n      document.documentElement.classList.add('no-view-transition');\r\n      document.documentElement.classList.toggle('reverse', reverse);\r\n      void document.documentElement.offsetLeft; // reflow\r\n    }\r\n\r\n    const transition = (document as any).startViewTransition(() => {\r\n      this._setTheme();\r\n    });\r\n\r\n    if(!coordinates) {\r\n      return;\r\n    }\r\n\r\n    const {x, y} = coordinates;\r\n    // Get the distance to the furthest corner\r\n    const endRadius = Math.hypot(\r\n      Math.max(x, windowSize.width - x),\r\n      Math.max(y, windowSize.height - y)\r\n    );\r\n\r\n    transition.ready.then(() => {\r\n      document.documentElement.animate({\r\n        clipPath: [\r\n          `circle(0 at ${x}px ${y}px)`,\r\n          `circle(${endRadius}px at ${x}px ${y}px)`\r\n        ]\r\n      }, {\r\n        duration: 500,\r\n        easing: 'ease-in-out',\r\n        pseudoElement: `::view-transition-${reverse ? 'old' : 'new'}(root)`,\r\n        direction: reverse ? 'reverse' : 'normal'\r\n      });\r\n    });\r\n\r\n    transition.finished.finally(() => {\r\n      document.documentElement.classList.remove('no-view-transition', 'reverse');\r\n    });\r\n  }\r\n\r\n  public async switchTheme(name: AppTheme['name'], coordinates?: {x: number, y: number}) {\r\n    await rootScope.managers.appStateManager.setByKey(joinDeepPath('settings', 'theme'), name);\r\n    rootScope.dispatchEvent('theme_change', coordinates);\r\n  }\r\n\r\n  public isNight() {\r\n    return this.getTheme().name === 'night';\r\n  }\r\n\r\n  public getTheme(name: AppTheme['name'] = rootScope.settings.theme === 'system' ? this.systemTheme : rootScope.settings.theme) {\r\n    return rootScope.settings.themes.find((t) => t.name === name);\r\n  }\r\n\r\n  // theme applier\r\n  private bindColorApplier(options: Pick<Parameters<ThemeController['applyAppColor']>[0], 'element' | 'isNight' | 'saveToCache'>) {\r\n    const appliedColors: Set<AppColorName> = new Set();\r\n    return {\r\n      applyAppColor: (_options: Omit<Parameters<ThemeController['applyAppColor']>[0], keyof typeof options>) => {\r\n        appliedColors.add(_options.name);\r\n        return this.applyAppColor({..._options, ...options});\r\n      },\r\n      finalize: () => {\r\n        const isNight = options.isNight;\r\n        for(const name in appColorMap) {\r\n          if(!appliedColors.has(name as AppColorName)) {\r\n            this.applyAppColor({\r\n              name: name as AppColorName,\r\n              hex: colorMap[isNight ? 'night' : 'day'][name as AppColorName],\r\n              ...options\r\n            });\r\n          }\r\n        }\r\n      }\r\n    };\r\n  };\r\n\r\n  public applyAppColor({\r\n    name,\r\n    hex,\r\n    element,\r\n    lightenAlpha = 0.08,\r\n    darkenAlpha = lightenAlpha,\r\n    mixColor,\r\n    isNight = this.isNight(),\r\n    saveToCache\r\n  }: {\r\n    name: AppColorName,\r\n    hex: string,\r\n    element: HTMLElement,\r\n    lightenAlpha?: number\r\n    darkenAlpha?: number,\r\n    mixColor?: ColorRgb,\r\n    isNight?: boolean,\r\n    saveToCache?: boolean\r\n  }) {\r\n    const appColor = appColorMap[name];\r\n    const rgb = hexToRgb(hex);\r\n    const hsla = rgbaToHsla(...rgb);\r\n\r\n    mixColor ??= hexToRgb(colorMap[isNight ? 'night' : 'day']['surface-color']);\r\n    const lightenedRgb = mixColors(rgb, mixColor, lightenAlpha);\r\n\r\n    const darkenedHsla: typeof hsla = {\r\n      ...hsla,\r\n      l: hsla.l - darkenAlpha * 100\r\n    };\r\n\r\n    const properties: [string, string][] = [\r\n      [name, hex],\r\n      appColor.rgb && [name + '-rgb', rgb.join(',')],\r\n      appColor.light && ['light-' + name, `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${lightenAlpha})`],\r\n      appColor.lightFilled && ['light-filled-' + name, rgbaToHexa(lightenedRgb)],\r\n      appColor.dark && ['dark-' + name, `hsl(${darkenedHsla.h}, ${darkenedHsla.s}%, ${darkenedHsla.l}%)`]\r\n      // appColor.darkFilled && ['dark-' + name, `hsl(${darkenedHsla.h}, ${darkenedHsla.s}%, ${darkenedHsla.l}%)`]\r\n    ];\r\n\r\n    saveToCache ??= element === document.documentElement;\r\n    properties.filter(Boolean).forEach(([name, value]) => {\r\n      element.style.setProperty('--' + name, value);\r\n\r\n      if(saveToCache) {\r\n        customProperties.setPropertyCache(name as AppColorName, value, isNight);\r\n      }\r\n    });\r\n  }\r\n\r\n  public async applyNewTheme(theme: Theme) {\r\n    const isNight = this.isNightTheme(theme);\r\n    const currentTheme = this.getTheme();\r\n    const themes = rootScope.settings.themes;\r\n    const themeSettings = theme.settings.find((themeSettings) => themeSettings.base_theme._ === (isNight ? 'baseThemeNight' : 'baseThemeClassic'));\r\n    const newAppTheme: AppTheme = {\r\n      ...theme,\r\n      name: currentTheme.name,\r\n      settings: {\r\n        ...themeSettings,\r\n        highlightingColor: ''\r\n      }\r\n    };\r\n\r\n    await this.AppBackgroundTab.setBackgroundDocument(themeSettings.wallpaper, newAppTheme.settings);\r\n    themes[themes.indexOf(currentTheme)] = newAppTheme;\r\n    await rootScope.managers.appStateManager.setByKey(joinDeepPath('settings', 'themes'), rootScope.settings.themes);\r\n    rootScope.dispatchEvent('theme_change');\r\n  }\r\n\r\n  private isNightTheme(theme: Theme | AppTheme) {\r\n    return (theme as AppTheme).name === 'night' || this.isNight();\r\n  }\r\n\r\n  public getThemeSettings(theme: Theme | AppTheme, isNight?: boolean) {\r\n    isNight ??= this.isNightTheme(theme);\r\n    const themeSettings = Array.isArray(theme.settings) ?\r\n      theme.settings.find((settings) => settings.base_theme._ === (isNight ? 'baseThemeNight' : 'baseThemeClassic')) :\r\n      theme.settings;\r\n    return themeSettings;\r\n  }\r\n\r\n  public applyTheme(theme: Theme | AppTheme, element = document.documentElement, saveToCache?: boolean) {\r\n    const isNight = this.isNightTheme(theme);\r\n    const themeSettings = this.getThemeSettings(theme, isNight);\r\n    const baseColors = colorMap[isNight ? 'night' : 'day'];\r\n\r\n    let hsvTemp1 = rgbToHsv(...hexToRgb(baseColors['primary-color'])); // primary base\r\n    let hsvTemp2 = rgbToHsv(...getRgbColorFromTelegramColor(themeSettings.accent_color)); // new primary\r\n\r\n    const newAccentRgb = changeColorAccent(\r\n      hsvTemp1,\r\n      hsvTemp2,\r\n      hexToRgb(baseColors['primary-color']),\r\n      !isNight\r\n    );\r\n    const newAccentHex = rgbaToHexa(newAccentRgb);\r\n\r\n    const {applyAppColor, finalize} = this.bindColorApplier({element, isNight, saveToCache});\r\n\r\n    applyAppColor({\r\n      name: 'primary-color',\r\n      hex: newAccentHex,\r\n      darkenAlpha: 0.04\r\n    });\r\n\r\n    applyAppColor({\r\n      name: 'saved-color',\r\n      hex: newAccentHex,\r\n      lightenAlpha: 0.64,\r\n      mixColor: [255, 255, 255]\r\n    });\r\n\r\n    if(!themeSettings.message_colors?.length) {\r\n      return;\r\n    }\r\n\r\n    const messageLightenAlpha = isNight ? 1 : 0.12;\r\n    const baseMessageColor = hexToRgb(baseColors['message-out-primary-color']);\r\n    hsvTemp1 = rgbToHsv(...baseMessageColor);\r\n    const baseMessageOutBackgroundColor = mixColors(baseMessageColor, hexToRgb(baseColors['surface-color']), messageLightenAlpha);\r\n\r\n    const firstColor = getRgbColorFromTelegramColor(themeSettings.message_colors[0]);\r\n\r\n    let myMessagesAccent = firstColor;\r\n    if(themeSettings.message_colors.length > 1) {\r\n      // const w = getAccentColor(hsvTemp1, baseMessageOutBackgroundColor, myMessagesAccent);\r\n\r\n      themeSettings.message_colors.slice(1).forEach((nextColor) => {\r\n        myMessagesAccent = getAverageColor(myMessagesAccent, getRgbColorFromTelegramColor(nextColor));\r\n      });\r\n\r\n      myMessagesAccent = getAccentColor(hsvTemp1, baseMessageOutBackgroundColor, myMessagesAccent);\r\n\r\n      // console.log('www', rgbaToHexa(w), rgbaToHexa(myMessagesAccent));\r\n    }\r\n\r\n    const o = myMessagesAccent;\r\n    hsvTemp2 = rgbToHsv(...o);\r\n\r\n    // const c = changeColorAccent(\r\n    //   hsvTemp1,\r\n    //   hsvTemp2,\r\n    //   baseMessageOutBackgroundColor\r\n    // );\r\n\r\n    // console.log(o, c, rgbaToHexa(o), rgbaToHexa(c));\r\n\r\n    const accentColor2 = themeSettings.outbox_accent_color !== undefined && rgbToHsv(...getRgbColorFromTelegramColor(themeSettings.outbox_accent_color));\r\n\r\n    let newMessageOutBackgroundColor = mixColors(myMessagesAccent, hexToRgb(baseColors['surface-color']), messageLightenAlpha);\r\n\r\n    if(!isNight/*  || true */) {\r\n      const messageOutBackgroundColorHsl = rgbaToHsla(...newMessageOutBackgroundColor);\r\n      messageOutBackgroundColorHsl.s = Math.min(messageOutBackgroundColorHsl.s + (isNight ? 8 : 63), 100);\r\n      newMessageOutBackgroundColor = hslaToRgba(messageOutBackgroundColorHsl.h, messageOutBackgroundColorHsl.s, messageOutBackgroundColorHsl.l, messageOutBackgroundColorHsl.a).slice(0, 3) as ColorRgb;\r\n    }\r\n\r\n    applyAppColor({\r\n      name: 'message-out-background-color',\r\n      hex: rgbaToHexa(newMessageOutBackgroundColor),\r\n      lightenAlpha: messageLightenAlpha\r\n    });\r\n\r\n    applyAppColor({\r\n      name: 'message-out-primary-color',\r\n      hex: isNight ? '#ffffff' : rgbaToHexa(accentColor2 ? hsvToRgb(...accentColor2) : myMessagesAccent),\r\n      mixColor: newMessageOutBackgroundColor\r\n    });\r\n\r\n    // if(accentColor2) {\r\n    //   console.log(rgbaToHexa(myMessagesAccent), rgbaToHexa(hsvToRgb(...accentColor2)));\r\n    // }\r\n\r\n    finalize();\r\n  }\r\n\r\n  public getThemeParamsForWebView() {\r\n    const themePropertiesMap: {[key in keyof TelegramWebViewTheme]: string} = {\r\n      bg_color: 'surface-color',\r\n      button_color: 'primary-color',\r\n      button_text_color: '#ffffff',\r\n      hint_color: 'secondary-text-color',\r\n      link_color: 'link-color',\r\n      secondary_bg_color: 'background-color-true',\r\n      text_color: 'primary-text-color',\r\n      header_bg_color: 'surface-color',\r\n      accent_text_color: 'primary-color',\r\n      section_bg_color: 'surface-color',\r\n      section_header_text_color: 'primary-color',\r\n      subtitle_text_color: 'secondary-text-color',\r\n      destructive_text_color: 'danger-color'\r\n    };\r\n\r\n    const themeParams: TelegramWebViewTheme = {} as any;\r\n    for(const key in themePropertiesMap) {\r\n      const value = themePropertiesMap[key as keyof TelegramWebViewTheme];\r\n      themeParams[key as keyof TelegramWebViewTheme] = value[0] === '#' ? value : customProperties.getProperty(value as AppColorName);\r\n    }\r\n\r\n    return themeParams;\r\n  }\r\n}\r\n\r\nconst themeController = new ThemeController();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.themeController = themeController);\r\nexport default themeController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport EventListenerBase from './eventListenerBase';\r\n\r\nexport class OverlayCounter extends EventListenerBase<{\r\n  change: (isActive: boolean) => void\r\n}> {\r\n  public overlaysActive = 0;\r\n  public hasDarkOverlays = 0;\r\n\r\n  get isOverlayActive() {\r\n    return this.overlaysActive > 0;\r\n  }\r\n\r\n  set isOverlayActive(value: boolean) {\r\n    this.overlaysActive += value ? 1 : -1;\r\n    this.dispatchEvent('change', this.isOverlayActive);\r\n  }\r\n\r\n  get isDarkOverlayActive() {\r\n    return this.hasDarkOverlays > 0;\r\n  }\r\n\r\n  set isDarkOverlayActive(value: boolean) {\r\n    this.hasDarkOverlays += value ? 1 : -1;\r\n    this.isOverlayActive = value;\r\n  }\r\n}\r\n\r\nconst overlayCounter = new OverlayCounter();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.overlayCounter = overlayCounter);\r\nexport default overlayCounter;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function parseUriParams(uri: string, splitted = uri.split('?')) {\r\n  return parseUriParamsLine(splitted?.[1]);\r\n}\r\n\r\nexport function parseUriParamsLine(line: string) {\r\n  const params: any = {};\r\n  if(!line) {\r\n    return params;\r\n  }\r\n\r\n  line.split('&').forEach((item) => {\r\n    const [key, value = ''] = item.split('=');\r\n    params[key] = decodeURIComponent(value);\r\n  });\r\n\r\n  return params;\r\n}\r\n","const IS_INSTALL_PROMPT_SUPPORTED = 'onbeforeinstallprompt' in window;\r\nexport default IS_INSTALL_PROMPT_SUPPORTED;\r\n","let callback: () => Promise<void>;\r\nexport default function cacheInstallPrompt() {\r\n  window.addEventListener('beforeinstallprompt', (deferredPrompt: any) => {\r\n    callback = async() => {\r\n      deferredPrompt.prompt();\r\n      const {outcome} = await deferredPrompt.userChoice;\r\n      const installed = outcome === 'accepted';\r\n      if(installed) {\r\n        callback = undefined;\r\n      }\r\n    };\r\n  });\r\n}\r\n\r\nexport function getInstallPrompt() {\r\n  return callback;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport {MOUNT_CLASS_TO} from '../config/debug';\r\nimport I18n, {i18n} from '../lib/langPack';\r\nimport capitalizeFirstLetter from './string/capitalizeFirstLetter';\r\n\r\nexport const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];\r\nexport const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\r\nexport const monthsLocalized = months.slice();\r\nexport const daysLocalized = days.slice();\r\n\r\nexport const ONE_DAY = 86400;\r\nexport const ONE_DAY_MINUTES = 1440;\r\nexport const ONE_WEEK = 604800;\r\nexport const ONE_WEEK_MINUTES = 10080;\r\n\r\nexport function getWeekDays() {\r\n  const dateTimeFormat = I18n.getDateTimeFormat({weekday: 'long'});\r\n  const date = new Date(Date.UTC(2017, 0, 2));\r\n  const out: string[] = [];\r\n  for(let i = 0; i < 7; ++i) {\r\n    out.push(capitalizeFirstLetter(dateTimeFormat.format(date)));\r\n    date.setDate(date.getDate() + 1);\r\n  }\r\n  return out;\r\n}\r\n\r\nexport function getMonths() {\r\n  const dateTimeFormat = I18n.getDateTimeFormat({month: 'long'});\r\n  const date = new Date(Date.UTC(2017, 0, 1));\r\n  const out: string[] = [];\r\n  for(let i = 0; i < 12; ++i) {\r\n    out.push(capitalizeFirstLetter(dateTimeFormat.format(date)));\r\n    date.setMonth(date.getMonth() + 1);\r\n  }\r\n  return out;\r\n}\r\n\r\nexport function fillLocalizedDates() {\r\n  monthsLocalized.splice(0, monthsLocalized.length, ...getMonths());\r\n  daysLocalized.splice(0, daysLocalized.length, ...getWeekDays());\r\n}\r\n\r\n// https://stackoverflow.com/a/6117889\r\nexport const getWeekNumber = (date: Date) => {\r\n  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\r\n  const dayNum = d.getUTCDay() || 7;\r\n  d.setUTCDate(d.getUTCDate() + 4 - dayNum);\r\n  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\r\n  return Math.ceil((((d.getTime() - yearStart.getTime()) / ONE_DAY) + 1) / 7);\r\n};\r\n\r\nexport function formatDate(date: Date, today?: Date) {\r\n  if(!today) {\r\n    today = new Date();\r\n    today.setHours(0, 0, 0, 0);\r\n  }\r\n\r\n  const options: Intl.DateTimeFormatOptions = {\r\n    day: 'numeric',\r\n    month: 'long'\r\n  };\r\n\r\n  if(date.getFullYear() !== today.getFullYear()) {\r\n    options.year = 'numeric';\r\n  }\r\n\r\n  return new I18n.IntlDateElement({\r\n    date,\r\n    options\r\n  }).element;\r\n}\r\n\r\nexport function formatDateAccordingToTodayNew(time: Date) {\r\n  const today = new Date();\r\n  const now = today.getTime() / 1000 | 0;\r\n  const timestamp = time.getTime() / 1000 | 0;\r\n\r\n  const options: Intl.DateTimeFormatOptions = {};\r\n  if((now - timestamp) < ONE_DAY && today.getDate() === time.getDate()) { // if the same day\r\n    options.hour = options.minute = '2-digit';\r\n  } else if(today.getFullYear() !== time.getFullYear()) { // different year\r\n    options.year = options.day = 'numeric';\r\n    options.month = '2-digit';\r\n  } else if((now - timestamp) < (ONE_DAY * 7) && getWeekNumber(today) === getWeekNumber(time)) { // current week\r\n    options.weekday = 'short';\r\n  } else { // same year\r\n    options.month = 'short';\r\n    options.day = 'numeric';\r\n  }\r\n\r\n  return new I18n.IntlDateElement({\r\n    date: time,\r\n    options\r\n  }).element;\r\n}\r\n\r\nconst formatTimeOptions: Intl.DateTimeFormatOptions = {\r\n  hour: '2-digit',\r\n  minute: '2-digit'\r\n};\r\n\r\nexport function formatFullSentTimeRaw(timestamp: number, options: {\r\n  capitalize?: boolean\r\n  noToday?: boolean,\r\n  combined?: boolean\r\n} = {}) {\r\n  if(options.combined) {\r\n    options.noToday = true;\r\n  }\r\n\r\n  const date = new Date();\r\n  const time = new Date(timestamp * 1000);\r\n  const now = date.getTime() / 1000 | 0;\r\n  const diff = now - timestamp;\r\n\r\n  const timeEl = options.combined ? undefined : formatTime(time);\r\n\r\n  let dateEl: HTMLElement;\r\n  if(!options.noToday && diff < ONE_DAY && date.getDate() === time.getDate()) { // if the same day\r\n    dateEl = i18n(options.capitalize ? 'Date.Today' : 'Peer.Status.Today');\r\n  } else if(!options.noToday && diff > 0 && diff < (ONE_DAY * 2) && new Date(date.getTime() - ONE_DAY * 1000).getDate() === time.getDate()) { // yesterday\r\n    dateEl = i18n(options.capitalize ? 'Yesterday' : 'Peer.Status.Yesterday');\r\n\r\n    if(options.capitalize) {\r\n      dateEl.style.textTransform = 'capitalize';\r\n    }\r\n  } else if(date.getFullYear() !== time.getFullYear()) { // different year\r\n    dateEl = new I18n.IntlDateElement({\r\n      date: time,\r\n      options: {\r\n        month: 'short',\r\n        day: 'numeric',\r\n        year: 'numeric',\r\n        ...(options.combined ? formatTimeOptions: {})\r\n      }\r\n    }).element;\r\n    // dateStr = months[time.getMonth()].slice(0, 3) + ' ' + time.getDate() + ', ' + time.getFullYear();\r\n  } else {\r\n    dateEl = new I18n.IntlDateElement({\r\n      date: time,\r\n      options: {\r\n        month: 'short',\r\n        day: 'numeric',\r\n        ...(options.combined ? formatTimeOptions: {})\r\n      }\r\n    }).element;\r\n    // dateStr = months[time.getMonth()].slice(0, 3) + ' ' + time.getDate();\r\n  }\r\n\r\n  return {dateEl, timeEl};\r\n}\r\n\r\nexport function formatFullSentTime(timestamp: number, capitalize = true, noToday = false) {\r\n  const {dateEl, timeEl} = formatFullSentTimeRaw(timestamp, {\r\n    capitalize,\r\n    noToday\r\n  });\r\n\r\n  const fragment = document.createDocumentFragment();\r\n  fragment.append(dateEl, ' ', i18n('ScheduleController.at'), ' ', timeEl);\r\n  return fragment;\r\n}\r\n\r\nexport function formatTime(date: Date) {\r\n  return new I18n.IntlDateElement({\r\n    date,\r\n    options: formatTimeOptions\r\n  }).element;\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.formatDateAccordingToTodayNew = formatDateAccordingToTodayNew);\r\n\r\nexport const getFullDate = (date: Date, options: Partial<{\r\n  noTime: true,\r\n  noSeconds: true,\r\n  monthAsNumber: true,\r\n  leadingZero: true,\r\n  shortYear: boolean\r\n}> = {}) => {\r\n  const joiner = options.monthAsNumber ? '.' : ' ';\r\n  const time = ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + (options.noSeconds ? '' : ':' + ('0' + date.getSeconds()).slice(-2));\r\n  const fullYear = date.getFullYear();\r\n\r\n  return (options.leadingZero ? ('0' + date.getDate()).slice(-2) : date.getDate()) +\r\n    joiner + (options.monthAsNumber ? ('0' + (date.getMonth() + 1)).slice(-2) : months[date.getMonth()]) +\r\n    joiner + (('' + fullYear).slice(options.shortYear ? 2 : 0)) +\r\n    (options.noTime ? '' : ', ' + time);\r\n};\r\n\r\nexport function formatMonthsDuration(months: number, bold?: boolean) {\r\n  const isYears = months >= 12 && !(months % 12);\r\n  return i18n(\r\n    bold ? (isYears ? 'BoldYears' : 'BoldMonths') : (isYears ? 'Years' : 'Months'),\r\n    [isYears ? months / 12 : months]\r\n  );\r\n}\r\n\r\n// https://github.com/DrKLO/Telegram/blob/d52b2c921abd3c1e8d6368858313ad0cb0468c07/TMessagesProj/src/main/java/org/telegram/ui/Adapters/FiltersView.java\r\nconst minYear = 2013;\r\nconst yearPattern = new RegExp('20[0-9]{1,2}');\r\nconst anyLetterRegExp = `\\\\p{L}`;\r\nconst monthPattern = new RegExp(`(${anyLetterRegExp}{3,})`, 'iu');\r\nconst monthYearOrDayPattern = new RegExp(`(${anyLetterRegExp}{3,}) ([0-9]{0,4})`, 'iu');\r\nconst yearOrDayAndMonthPattern = new RegExp(`([0-9]{0,4}) (${anyLetterRegExp}{2,})`, 'iu');\r\nconst shortDate = new RegExp('^([0-9]{1,4})(\\\\.| |/|\\\\-)([0-9]{1,4})$', 'i');\r\nconst longDate = new RegExp('^([0-9]{1,2})(\\\\.| |/|\\\\-)([0-9]{1,2})(\\\\.| |/|\\\\-)([0-9]{1,4})$', 'i');\r\nconst numberOfDaysEachMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];\r\nexport type DateData = {\r\n  title: string,\r\n  minDate: number,\r\n  maxDate: number,\r\n};\r\nexport function fillTipDates(query: string, dates: DateData[]) {\r\n  const q = query.trim().toLowerCase();\r\n\r\n  if(q.length < 3) {\r\n    return;\r\n  }\r\n\r\n  if(['today', I18n.format('Peer.Status.Today', true)].some((haystack) => haystack.indexOf(q) === 0)) {\r\n    const date = new Date();\r\n    const year = date.getFullYear();\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime();\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 1;\r\n    dates.push({\r\n      title: I18n.format('Date.Today', true),\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  if(['yesterday', I18n.format('Peer.Status.Yesterday', true)].some((haystack) => haystack.indexOf(q) === 0)) {\r\n    const date = new Date();\r\n    const year = date.getFullYear();\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime() - 86400000;\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 86400001;\r\n    dates.push({\r\n      title: capitalizeFirstLetter(I18n.format('Yesterday', true)),\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  const dayOfWeek = getDayOfWeek(q);\r\n  if(dayOfWeek >= 0) {\r\n    const date = new Date();\r\n    const now = date.getTime();\r\n    const currentDay = date.getDay();\r\n    const distance = dayOfWeek - currentDay;\r\n    date.setDate(date.getDate() + distance);\r\n    if(date.getTime() > now) {\r\n      date.setTime(date.getTime() - 604800000);\r\n    }\r\n    const year = date.getFullYear()\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime();\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 1;\r\n    dates.push({\r\n      title: formatWeekLong(minDate),\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  let matches: any[];\r\n  if((matches = shortDate.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[3];\r\n    const k = parseInt(g1);\r\n    const k1 = parseInt(g2);\r\n    if(k > 0 && k <= 31) {\r\n      if(k1 >= minYear && k <= 12) {\r\n        const selectedYear = k1;\r\n        const month = k - 1;\r\n        createForMonthYear(dates, month, selectedYear);\r\n        return;\r\n      } else if(k1 <= 12) {\r\n        const day = k - 1;\r\n        const month = k1 - 1;\r\n        createForDayMonth(dates, day, month);\r\n      }\r\n    } else if(k >= minYear && k1 <= 12) {\r\n      const selectedYear = k;\r\n      const month = k1 - 1;\r\n      createForMonthYear(dates, month, selectedYear);\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = longDate.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[3];\r\n    const g3 = matches[5];\r\n    if(!matches[2] === matches[4]) {\r\n      return;\r\n    }\r\n\r\n    const day = parseInt(g1);\r\n    const month = parseInt(g2) - 1;\r\n    let year = parseInt(g3);\r\n    if(year >= 10 && year <= 99) {\r\n      year += 2000;\r\n    }\r\n\r\n    const currentYear = new Date().getFullYear();\r\n    if(validDateForMonth(day - 1, month) && year >= minYear && year <= currentYear) {\r\n      const date = new Date();\r\n      date.setFullYear(year, month, day);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const minDate = date.getTime();\r\n      date.setFullYear(year, month, day + 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const maxDate = date.getTime() - 1;\r\n      dates.push({\r\n        title: formatterYearMax(minDate),\r\n        minDate,\r\n        maxDate\r\n      });\r\n      return;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = monthYearOrDayPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[2];\r\n    const month = getMonth(g1);\r\n    if(month >= 0) {\r\n      const k = +g2 || new Date().getUTCFullYear();\r\n      if(k > 0 && k <= 31) {\r\n        const day = k - 1;\r\n        createForDayMonth(dates, day, month);\r\n        return;\r\n      } else if(k >= minYear) {\r\n        const selectedYear = k;\r\n        createForMonthYear(dates, month, selectedYear);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  if((matches = yearOrDayAndMonthPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[2];\r\n    const month = getMonth(g2);\r\n    if(month >= 0) {\r\n      const k = +g1;\r\n      if(k > 0 && k <= 31) {\r\n        const day = k - 1;\r\n        createForDayMonth(dates, day, month);\r\n        return;\r\n      } else if(k >= minYear) {\r\n        const selectedYear = k;\r\n        createForMonthYear(dates, month, selectedYear);\r\n      }\r\n    }\r\n  }\r\n\r\n  if((matches = monthPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const month = getMonth(g1);\r\n    if(month >= 0) {\r\n      const currentYear = new Date().getFullYear();\r\n      for(let i = currentYear; i >= minYear; --i) {\r\n        createForMonthYear(dates, month, i);\r\n      }\r\n    }\r\n  }\r\n\r\n  if((matches = yearPattern.exec(q)) !== null) {\r\n    let selectedYear = +matches[0];\r\n    const currentYear = new Date().getFullYear();\r\n    if(selectedYear < minYear) {\r\n      selectedYear = minYear;\r\n      for(let i = currentYear; i >= selectedYear; i--) {\r\n        const date = new Date();\r\n        date.setFullYear(i, 0, 1);\r\n        date.setHours(0, 0, 0);\r\n\r\n        const minDate = date.getTime();\r\n        date.setFullYear(i + 1, 0, 1);\r\n        date.setHours(0, 0, 0);\r\n\r\n        const maxDate = date.getTime() - 1;\r\n        dates.push({\r\n          title: '' + i,\r\n          minDate,\r\n          maxDate\r\n        });\r\n      }\r\n    } else if(selectedYear <= currentYear) {\r\n      const date = new Date();\r\n      date.setFullYear(selectedYear, 0, 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const minDate = date.getTime();\r\n      date.setFullYear(selectedYear + 1, 0, 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const maxDate = date.getTime() - 1;\r\n      dates.push({\r\n        title: '' + selectedYear,\r\n        minDate,\r\n        maxDate\r\n      });\r\n    }\r\n\r\n    return;\r\n  }\r\n}\r\n\r\nfunction createForMonthYear(dates: DateData[], month: number, selectedYear: number) {\r\n  const currentYear = new Date().getFullYear();\r\n  const today = Date.now();\r\n  if(selectedYear >= minYear && selectedYear <= currentYear) {\r\n    const date = new Date();\r\n    date.setFullYear(selectedYear, month, 1);\r\n    date.setHours(0, 0, 0);\r\n    const minDate = date.getTime();\r\n    if(minDate > today) {\r\n      return;\r\n    }\r\n    date.setMonth(date.getMonth() + 1);\r\n    const maxDate = date.getTime() - 1;\r\n\r\n    dates.push({\r\n      title: formatterMonthYear(minDate),\r\n      minDate,\r\n      maxDate\r\n    });\r\n  }\r\n}\r\n\r\nfunction createForDayMonth(dates: DateData[], day: number, month: number) {\r\n  if(validDateForMonth(day, month)) {\r\n    const currentYear = new Date().getFullYear();\r\n    const today = Date.now();\r\n\r\n    for(let i = currentYear; i >= minYear; i--) {\r\n      if(month === 1 && day === 28 && !isLeapYear(i)) {\r\n        continue;\r\n      }\r\n\r\n      const date = new Date();\r\n      date.setFullYear(i, month, day + 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const minDate = date.getTime();\r\n      if(minDate > today) {\r\n        continue;\r\n      }\r\n\r\n      date.setFullYear(i, month, day + 2);\r\n      date.setHours(0, 0, 0);\r\n      const maxDate = date.getTime() - 1;\r\n      if(i === currentYear) {\r\n        dates.push({\r\n          title: formatterDayMonth(minDate),\r\n          minDate,\r\n          maxDate\r\n        });\r\n      } else {\r\n        dates.push({\r\n          title: formatterYearMax(minDate),\r\n          minDate,\r\n          maxDate\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction formatterMonthYear(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return monthsLocalized[date.getMonth()]/* .slice(0, 3) */ + ' ' + date.getFullYear();\r\n}\r\n\r\nfunction formatterDayMonth(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return monthsLocalized[date.getMonth()]/* .slice(0, 3) */ + ' ' + date.getDate();\r\n}\r\n\r\nfunction formatterYearMax(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return ('0' + date.getDate()).slice(-2) + '.' + ('0' + (date.getMonth() + 1)).slice(-2) + '.' + date.getFullYear();\r\n}\r\n\r\nfunction formatWeekLong(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return daysLocalized[date.getDay()];\r\n}\r\n\r\nfunction validDateForMonth(day: number, month: number) {\r\n  if(month >= 0 && month < 12) {\r\n    if(day >= 0 && day < numberOfDaysEachMonth[month]) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction isLeapYear(year: number) {\r\n  return ((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0);\r\n}\r\n\r\nfunction getMonth(q: string) {\r\n  q = q.toLowerCase();\r\n  for(let i = 0; i < 12; i++) {\r\n    if([months[i], monthsLocalized[i]].some((month) => month.toLowerCase().indexOf(q) === 0)) {\r\n      return i;\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nfunction getDayOfWeek(q: string) {\r\n  const c = new Date();\r\n  if(q.length <= 3) {\r\n    return -1;\r\n  }\r\n\r\n  for(let i = 0; i < 7; i++) {\r\n    c.setDate(c.getDate() + 1);\r\n\r\n    if(formatWeekLong(c.getTime()).toLowerCase().indexOf(q) === 0) {\r\n      return c.getDay();\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nMOUNT_CLASS_TO.fillTipDates = fillTipDates;\r\n","import {CHROMIUM_VERSION, IS_CHROMIUM, IS_FIREFOX, IS_MOBILE, IS_MOBILE_SAFARI, IS_SAFARI} from './userAgent';\r\n\r\nexport const USE_NATIVE_SCROLL = /* IS_APPLE ||  */IS_MOBILE/*  || true */;\r\nexport const IS_OVERLAY_SCROLL_SUPPORTED = IS_MOBILE || (!IS_CHROMIUM && (!IS_SAFARI || IS_MOBILE_SAFARI)/*  && !IS_FIREFOX */) || CHROMIUM_VERSION < 113;\r\nexport const USE_CUSTOM_SCROLL = !USE_NATIVE_SCROLL && !IS_OVERLAY_SCROLL_SUPPORTED;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n/* @refresh reload */\r\n\r\nimport App from './config/app';\r\nimport blurActiveElement from './helpers/dom/blurActiveElement';\r\nimport cancelEvent from './helpers/dom/cancelEvent';\r\nimport {IS_STICKY_INPUT_BUGGED} from './helpers/dom/fixSafariStickyInputFocusing';\r\nimport loadFonts from './helpers/dom/loadFonts';\r\nimport IS_EMOJI_SUPPORTED from './environment/emojiSupport';\r\nimport {IS_ANDROID, IS_APPLE, IS_APPLE_MOBILE, IS_FIREFOX, IS_MOBILE, IS_MOBILE_SAFARI, IS_SAFARI} from './environment/userAgent';\r\nimport './materialize.scss';\r\nimport './scss/style.scss';\r\nimport pause from './helpers/schedulers/pause';\r\nimport setWorkerProxy from './helpers/setWorkerProxy';\r\nimport toggleAttributePolyfill from './helpers/dom/toggleAttributePolyfill';\r\nimport rootScope from './lib/rootScope';\r\nimport IS_TOUCH_SUPPORTED from './environment/touchSupport';\r\nimport I18n from './lib/langPack';\r\nimport './helpers/peerIdPolyfill';\r\nimport './lib/polyfill';\r\nimport apiManagerProxy from './lib/mtproto/mtprotoworker';\r\nimport getProxiedManagers from './lib/appManagers/getProxiedManagers';\r\nimport themeController from './helpers/themeController';\r\nimport overlayCounter from './helpers/overlayCounter';\r\nimport singleInstance from './lib/mtproto/singleInstance';\r\nimport {parseUriParamsLine} from './helpers/string/parseUriParams';\r\nimport Modes from './config/modes';\r\nimport {AuthState} from './types';\r\nimport {IS_BETA} from './config/debug';\r\nimport IS_INSTALL_PROMPT_SUPPORTED from './environment/installPrompt';\r\nimport cacheInstallPrompt from './helpers/dom/installPrompt';\r\nimport {fillLocalizedDates} from './helpers/date';\r\nimport {nextRandomUint} from './helpers/random';\r\nimport {IS_OVERLAY_SCROLL_SUPPORTED, USE_CUSTOM_SCROLL, USE_NATIVE_SCROLL} from './environment/overlayScrollSupport';\r\nimport IMAGE_MIME_TYPES_SUPPORTED, {IMAGE_MIME_TYPES_SUPPORTED_PROMISE} from './environment/imageMimeTypesSupport';\r\nimport MEDIA_MIME_TYPES_SUPPORTED from './environment/mediaMimeTypesSupport';\r\n// import appNavigationController from './components/appNavigationController';\r\n\r\nIMAGE_MIME_TYPES_SUPPORTED_PROMISE.then((mimeTypes) => {\r\n  mimeTypes.forEach((mimeType) => {\r\n    IMAGE_MIME_TYPES_SUPPORTED.add(mimeType);\r\n    MEDIA_MIME_TYPES_SUPPORTED.add(mimeType);\r\n  });\r\n\r\n  console.log('Supported image mime types', IMAGE_MIME_TYPES_SUPPORTED);\r\n  apiManagerProxy.sendEnvironment();\r\n});\r\n\r\n/* false &&  */document.addEventListener('DOMContentLoaded', async() => {\r\n  // * Randomly choose a version if user came from google\r\n  try {\r\n    if(\r\n      App.isMainDomain &&\r\n      document.referrer &&\r\n      /(^|\\.)(google|bing|duckduckgo|ya|yandex)\\./i.test(new URL(document.referrer).host)\r\n    ) {\r\n      const version = localStorage.getItem('kz_version');\r\n      if(version === 'Z' || nextRandomUint(8) > 127) {\r\n        localStorage.setItem('kz_version', 'Z');\r\n        location.href = 'https://web.telegram.org/a/';\r\n      } else {\r\n        localStorage.setItem('kz_version', 'K');\r\n      }\r\n    }\r\n  } catch(err) {}\r\n\r\n  toggleAttributePolyfill();\r\n\r\n  // polyfill for replaceChildren\r\n  if((Node as any).prototype.replaceChildren === undefined) {\r\n    (Node as any).prototype.replaceChildren = function(...nodes: any[]) {\r\n      this.textContent = '';\r\n      // while(this.lastChild) {\r\n      //   this.removeChild(this.lastChild);\r\n      // }\r\n      if(nodes) {\r\n        this.append(...nodes);\r\n      }\r\n    }\r\n  }\r\n\r\n  rootScope.managers = getProxiedManagers();\r\n\r\n  const manifest = document.getElementById('manifest') as HTMLLinkElement;\r\n  if(manifest) manifest.href = `site${IS_APPLE && !IS_APPLE_MOBILE ? '_apple' : ''}.webmanifest?v=jw3mK7G9Aq`;\r\n\r\n  singleInstance.start();\r\n\r\n  // We listen to the resize event (https://css-tricks.com/the-trick-to-viewport-units-on-mobile/)\r\n  const w = window.visualViewport || window; // * handle iOS keyboard\r\n  let setViewportVH = false/* , hasFocus = false */;\r\n  let lastVH: number;\r\n  const setVH = () => {\r\n    let vh = (setViewportVH && !overlayCounter.isOverlayActive ? (w as VisualViewport).height || (w as Window).innerHeight : window.innerHeight) * 0.01;\r\n    vh = +vh.toFixed(2);\r\n    if(lastVH === vh) {\r\n      return;\r\n    } else if(IS_TOUCH_SUPPORTED && lastVH < vh && (vh - lastVH) > 1) {\r\n      blurActiveElement(); // (Android) fix blurring inputs when keyboard is being closed (e.g. closing keyboard by back arrow and touching a bubble)\r\n    }\r\n\r\n    lastVH = vh;\r\n\r\n    // const vh = document.documentElement.scrollHeight * 0.01;\r\n    document.documentElement.style.setProperty('--vh', `${vh}px`);\r\n\r\n    // console.log('setVH', vh, setViewportVH ? w : window);\r\n\r\n    /* if(setViewportVH && userAgent.isSafari && touchSupport.isTouchSupported && document.activeElement && (document.activeElement as HTMLElement).blur) {\r\n      const rect = document.activeElement.getBoundingClientRect();\r\n      if(rect.top < 0 || rect.bottom >= (w as any).height) {\r\n        fastSmoothScroll(findUpClassName(document.activeElement, 'scrollable-y') || window as any, document.activeElement as HTMLElement, 'center', 4, undefined, FocusDirection.Static);\r\n      }\r\n    } */\r\n  };\r\n\r\n  setWorkerProxy;\r\n\r\n  // const [_, touchSupport, userAgent, _rootScope, _appStateManager, _I18n, __/* , ___ */] = await Promise.all([\r\n  //   import('./lib/polyfill'),\r\n  //   import('./environment/touchSupport'),\r\n  //   import('./environment/userAgent'),\r\n  //   import('./lib/rootScope'),\r\n  //   import('./lib/appManagers/appStateManager'),\r\n  //   import('./lib/langPack'),\r\n  //   import('./helpers/peerIdPolyfill'),\r\n  //   // import('./helpers/cacheFunctionPolyfill')\r\n  // ]);\r\n\r\n  /* const {IS_TOUCH_SUPPORTED} = touchSupport;\r\n  const {IS_FIREFOX, IS_MOBILE, IS_APPLE, IS_SAFARI, IS_APPLE_MOBILE, IS_ANDROID} = userAgent;\r\n  const rootScope = _rootScope.default;\r\n  const appStateManager = _appStateManager.default;\r\n  const I18n = _I18n.default; */\r\n\r\n  window.addEventListener('resize', setVH);\r\n  setVH();\r\n\r\n  const preparePrint = () => {\r\n    const chat = document.querySelector('.chat.active');\r\n    if(!chat) {\r\n      return;\r\n    }\r\n\r\n    const chatClone = chat.cloneNode(true) as HTMLElement;\r\n    chatClone.querySelectorAll('.chat-input, .chat-background').forEach((element) => element.remove());\r\n    const bubbles = chatClone.querySelector('.bubbles');\r\n    const bubblesInner = bubbles.querySelector('.bubbles-inner');\r\n    bubbles.replaceChildren(bubblesInner);\r\n    const video = bubbles.querySelectorAll<HTMLVideoElement>('video');\r\n    video.forEach((video) => (video.muted = true));\r\n    const printable = document.createElement('div');\r\n    printable.setAttribute('id', 'printable');\r\n    printable.append(chatClone);\r\n    document.body.append(printable);\r\n  };\r\n  const removePrint = () => {\r\n    const printContent = document.getElementById('printable');\r\n    printContent?.remove();\r\n  };\r\n  window.addEventListener('beforeprint', preparePrint);\r\n  window.addEventListener('afterprint', removePrint);\r\n\r\n  if(IS_STICKY_INPUT_BUGGED) {\r\n    const toggleResizeMode = () => {\r\n      setViewportVH = tabId === 1 && IS_STICKY_INPUT_BUGGED && !overlayCounter.isOverlayActive;\r\n      setVH();\r\n\r\n      if(w !== window) {\r\n        if(setViewportVH) {\r\n          window.removeEventListener('resize', setVH);\r\n          w.addEventListener('resize', setVH);\r\n        } else {\r\n          w.removeEventListener('resize', setVH);\r\n          window.addEventListener('resize', setVH);\r\n        }\r\n      }\r\n    };\r\n\r\n    let tabId: number;\r\n    (window as any).onImTabChange = (id: number) => {\r\n      const wasTabId = tabId !== undefined;\r\n      tabId = id;\r\n\r\n      if(wasTabId || tabId === 1) {\r\n        toggleResizeMode();\r\n      }\r\n    };\r\n\r\n    overlayCounter.addEventListener('change', () => {\r\n      toggleResizeMode();\r\n    });\r\n  }\r\n\r\n  if(IS_FIREFOX && !IS_EMOJI_SUPPORTED) {\r\n    document.addEventListener('dragstart', (e) => {\r\n      const target = e.target as HTMLElement;\r\n      if(target.tagName === 'IMG' && target.classList.contains('emoji')) {\r\n        cancelEvent(e);\r\n        return false;\r\n      }\r\n    });\r\n  }\r\n\r\n  if(IS_EMOJI_SUPPORTED) {\r\n    document.documentElement.classList.add('native-emoji');\r\n  }\r\n\r\n  if(USE_NATIVE_SCROLL) {\r\n    document.documentElement.classList.add('native-scroll');\r\n  } else if(IS_OVERLAY_SCROLL_SUPPORTED) {\r\n    document.documentElement.classList.add('overlay-scroll');\r\n  } else if(USE_CUSTOM_SCROLL) {\r\n    document.documentElement.classList.add('custom-scroll');\r\n  }\r\n\r\n  // document.documentElement.style.setProperty('--quote-icon', `\"${getIconContent('quote')}\"`);\r\n\r\n  // prevent firefox image dragging\r\n  document.addEventListener('dragstart', (e) => {\r\n    if((e.target as HTMLElement)?.tagName === 'IMG') {\r\n      e.preventDefault();\r\n      return false;\r\n    }\r\n  });\r\n\r\n  // restrict contextmenu on images (e.g. webp stickers)\r\n  document.addEventListener('contextmenu', (e) => {\r\n    if((e.target as HTMLElement).tagName === 'IMG' && !(window as any).appMediaViewer) {\r\n      cancelEvent(e);\r\n    }\r\n  });\r\n\r\n  if(IS_FIREFOX) {\r\n    document.documentElement.classList.add('is-firefox', 'no-backdrop');\r\n  }\r\n\r\n  if(IS_MOBILE) {\r\n    document.documentElement.classList.add('is-mobile');\r\n  }\r\n\r\n  if(IS_APPLE) {\r\n    if(IS_SAFARI) {\r\n      document.documentElement.classList.add('is-safari');\r\n    }\r\n\r\n    // document.documentElement.classList.add('emoji-supported');\r\n\r\n    if(IS_APPLE_MOBILE) {\r\n      document.documentElement.classList.add('is-ios');\r\n    } else {\r\n      document.documentElement.classList.add('is-mac');\r\n    }\r\n  } else if(IS_ANDROID) {\r\n    document.documentElement.classList.add('is-android');\r\n\r\n    // force losing focus on input blur\r\n    // focusin and focusout are not working on mobile\r\n\r\n    // const onInResize = () => {\r\n    //   hasFocus = true;\r\n    //   window.addEventListener('resize', onOutResize, {once: true});\r\n    // };\r\n\r\n    // const onOutResize = () => {\r\n    //   hasFocus = false;\r\n    //   blurActiveElement();\r\n    // };\r\n\r\n    // let hasFocus = false;\r\n    // document.addEventListener('touchend', (e) => {\r\n    //   const input = (e.target as HTMLElement).closest('[contenteditable=\"true\"], input');\r\n    //   if(!input) {\r\n    //     return;\r\n    //   }\r\n\r\n    //   if(document.activeElement !== input && !hasFocus) {\r\n    //     console.log('input click', e, document.activeElement, input, input.matches(':focus'));\r\n    //     window.addEventListener('resize', onInResize, {once: true});\r\n    //   }\r\n    // });\r\n  }\r\n\r\n  if(!IS_TOUCH_SUPPORTED) {\r\n    document.documentElement.classList.add('no-touch');\r\n  } else {\r\n    document.documentElement.classList.add('is-touch');\r\n    /* document.addEventListener('touchmove', (event: any) => {\r\n      event = event.originalEvent || event;\r\n      if(event.scale && event.scale !== 1) {\r\n        event.preventDefault();\r\n      }\r\n    }, {capture: true, passive: false}); */\r\n  }\r\n\r\n  if(IS_INSTALL_PROMPT_SUPPORTED) {\r\n    cacheInstallPrompt();\r\n  }\r\n\r\n  const perf = performance.now();\r\n\r\n  // await pause(1000000);\r\n\r\n  const langPromise = I18n.getCacheLangPack();\r\n\r\n  const [stateResult, langPack] = await Promise.all([\r\n    // loadState(),\r\n    apiManagerProxy.sendState().then(([stateResult]) => stateResult),\r\n    langPromise\r\n  ]);\r\n  I18n.setTimeFormat(stateResult.state.settings.timeFormat);\r\n\r\n  rootScope.managers.rootScope.getPremium().then((isPremium) => {\r\n    rootScope.premium = isPremium;\r\n  });\r\n\r\n  themeController.setThemeListener();\r\n\r\n  if(langPack.appVersion !== App.langPackVersion) {\r\n    I18n.getLangPack(langPack.lang_code);\r\n  } else {\r\n    fillLocalizedDates();\r\n  }\r\n\r\n  rootScope.addEventListener('language_change', () => {\r\n    fillLocalizedDates();\r\n  });\r\n\r\n  /**\r\n   * won't fire if font is loaded too fast\r\n   */\r\n  function fadeInWhenFontsReady(elem: HTMLElement, promise: Promise<any>) {\r\n    elem.style.opacity = '0';\r\n\r\n    promise.then(() => {\r\n      window.requestAnimationFrame(() => {\r\n        elem.style.opacity = '';\r\n      });\r\n    });\r\n  }\r\n\r\n  console.log('got state, time:', performance.now() - perf);\r\n\r\n  await IMAGE_MIME_TYPES_SUPPORTED_PROMISE;\r\n\r\n  if(langPack.lang_code === 'ar' || langPack.lang_code === 'fa' && IS_BETA && false) {\r\n    document.documentElement.classList.add('is-rtl');\r\n    document.documentElement.dir = 'rtl';\r\n    document.documentElement.lang = langPack.lang_code;\r\n    I18n.setRTL(true);\r\n  } else {\r\n    document.documentElement.dir = 'ltr';\r\n  }\r\n\r\n  let authState = stateResult.state.authState;\r\n\r\n  const hash = location.hash;\r\n  const splitted = hash.split('?');\r\n  const params = parseUriParamsLine(splitted[1] ?? splitted[0].slice(1));\r\n  if(params.tgWebAuthToken && authState._ !== 'authStateSignedIn') {\r\n    const data: AuthState.signImport['data'] = {\r\n      token: params.tgWebAuthToken,\r\n      dcId: +params.tgWebAuthDcId,\r\n      userId: params.tgWebAuthUserId.toUserId(),\r\n      isTest: params.tgWebAuthTest !== undefined && !!+params.tgWebAuthTest,\r\n      tgAddr: params.tgaddr\r\n    };\r\n\r\n    if(data.isTest !== Modes.test) {\r\n      const urlSearchParams = new URLSearchParams(location.search);\r\n      if(+params.tgWebAuthTest) {\r\n        urlSearchParams.set('test', '1');\r\n      } else {\r\n        urlSearchParams.delete('test');\r\n      }\r\n\r\n      location.search = urlSearchParams.toString();\r\n      return;\r\n    }\r\n\r\n    rootScope.managers.appStateManager.pushToState('authState', authState = {_: 'authStateSignImport', data});\r\n\r\n    // appNavigationController.overrideHash('?tgaddr=' + encodeURIComponent(params.tgaddr));\r\n  }\r\n\r\n  if(authState._ !== 'authStateSignedIn'/*  || 1 === 1 */) {\r\n    console.log('Will mount auth page:', authState._, Date.now() / 1000);\r\n\r\n    const el = document.getElementById('auth-pages');\r\n    let scrollable: HTMLElement;\r\n    if(el) {\r\n      scrollable = el.querySelector('.scrollable') as HTMLElement;\r\n      if((!IS_TOUCH_SUPPORTED || IS_MOBILE_SAFARI)) {\r\n        scrollable.classList.add('no-scrollbar');\r\n      }\r\n\r\n      // * don't remove this line\r\n      scrollable.style.opacity = '0';\r\n\r\n      const placeholder = document.createElement('div');\r\n      placeholder.classList.add('auth-placeholder');\r\n\r\n      scrollable.prepend(placeholder);\r\n      scrollable.append(placeholder.cloneNode());\r\n    }\r\n\r\n    try {\r\n      await Promise.all([\r\n        import('./lib/mtproto/telegramMeWebManager'),\r\n        import('./lib/mtproto/webPushApiManager')\r\n      ]).then(([meModule, pushModule]) => {\r\n        meModule.default.setAuthorized(false);\r\n        pushModule.default.forceUnsubscribe();\r\n      });\r\n    } catch(err) {\r\n\r\n    }\r\n\r\n    let pagePromise: Promise<void>;\r\n    // langPromise.then(async() => {\r\n    switch(authState._) {\r\n      case 'authStateSignIn':\r\n        pagePromise = (await import('./pages/pageSignIn')).default.mount();\r\n        break;\r\n      case 'authStateSignQr':\r\n        pagePromise = (await import('./pages/pageSignQR')).default.mount();\r\n        break;\r\n      case 'authStateAuthCode':\r\n        pagePromise = (await import('./pages/pageAuthCode')).default.mount(authState.sentCode);\r\n        break;\r\n      case 'authStatePassword':\r\n        pagePromise = (await import('./pages/pagePassword')).default.mount();\r\n        break;\r\n      case 'authStateSignUp':\r\n        pagePromise = (await import('./pages/pageSignUp')).default.mount(authState.authCode);\r\n        break;\r\n      case 'authStateSignImport':\r\n        pagePromise = (await import('./pages/pageSignImport')).default.mount(authState.data);\r\n        break;\r\n    }\r\n    // });\r\n\r\n    if(scrollable) {\r\n      // wait for text appear\r\n      if(pagePromise) {\r\n        await pagePromise;\r\n      }\r\n\r\n      const promise = 'fonts' in document ?\r\n        Promise.race([\r\n          pause(1000),\r\n          document.fonts.ready\r\n        ]) :\r\n        Promise.resolve();\r\n      fadeInWhenFontsReady(scrollable, promise);\r\n    }\r\n\r\n    /* setTimeout(async() => {\r\n      (await import('./pages/pageAuthCode')).default.mount({\r\n        \"_\": \"auth.sentCode\",\r\n        \"pFlags\": {},\r\n        \"flags\": 6,\r\n        \"type\": {\r\n          \"_\": \"auth.sentCodeTypeSms\",\r\n          \"length\": 5\r\n        },\r\n        \"phone_code_hash\": \"\",\r\n        \"next_type\": {\r\n          \"_\": \"auth.codeTypeCall\"\r\n        },\r\n        \"timeout\": 120,\r\n        \"phone_number\": \"\"\r\n      });\r\n\r\n      (await import('./pages/pageSignQR')).default.mount();\r\n\r\n      (await import('./pages/pagePassword')).default.mount();\r\n\r\n      (await import('./pages/pageSignUp')).default.mount({\r\n        \"phone_code_hash\": \"\",\r\n        \"phone_number\": \"\"\r\n      });\r\n    }, 500); */\r\n  } else {\r\n    console.log('Will mount IM page:', Date.now() / 1000);\r\n    fadeInWhenFontsReady(document.getElementById('main-columns'), loadFonts());\r\n    (await import('./pages/pageIm')).default.mount();\r\n  }\r\n});\r\n"],"file":"index-thw_O1vh.js"}